<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Hugo Zhu's Blog</title>
<meta name=description content="
StreamPi - StreamDeck with Raspberry Pi
"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"All about Raspberry Pi","url":"https:\/\/blog.hugozhu.site\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/blog.hugozhu.site\/"}</script><meta property="og:title" content="All about Raspberry Pi"><meta property="og:description" content="
StreamPi - StreamDeck with Raspberry Pi
"><meta property="og:image" content="https://blog.hugozhu.site/img/pi.png"><meta property="og:url" content="https://blog.hugozhu.site/"><meta property="og:type" content="website"><meta property="og:site_name" content="All about Raspberry Pi"><meta name=twitter:title content="All about Raspberry Pi"><meta name=twitter:description content="
StreamPi - StreamDeck with Raspberry Pi
"><meta name=twitter:image content="https://blog.hugozhu.site/img/pi.png"><meta name=twitter:card content="summary_large_image"><link href=https://blog.hugozhu.site/img/pi.ico rel=icon type=image/x-icon><meta name=generator content="Hugo 0.142.0"><link rel=alternate href=https://blog.hugozhu.site/index.xml type=application/rss+xml title="All about Raspberry Pi"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css integrity=sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v6.6.0/css/all.css integrity=sha384-h/hnnw1Bi4nbpD6kE7nYfCXzovi622sY5WBxww8ARKwpdLj5kUWjRuyiXaD1U2JT crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css integrity=sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu crossorigin=anonymous><link rel=stylesheet href=https://blog.hugozhu.site/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://blog.hugozhu.site/css/highlight.min.css><link rel=stylesheet href=https://blog.hugozhu.site/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><script async src="https://www.googletagmanager.com/gtag/js?id=GTM-W88HDMN"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","GTM-W88HDMN")}</script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=https://blog.hugozhu.site/>All about Raspberry Pi</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Blog href=/>Blog</a></li><li class=navlinks-container><a class=navlinks-parent role=button tabindex=0>Tools</a><div class=navlinks-children><a href=https://nddapp.com/json-encoder.html>HTML Tools</a>
<a href=https://www.birme.net/>Imaeg Resizing</a>
<a href=https://jwt.io/>JWT Token Tool</a></div></li><li><a title=About href=/page/about/>About</a></li><li><a title=Tags href=/tags>Tags</a></li><li><a href=#modalSearch data-toggle=modal data-target=#modalSearch style=outline:none><span class="hidden-sm hidden-md hidden-lg">Search</span> <span id=searchGlyph class="glyphicon glyphicon-search"></span></a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title="All about Raspberry Pi" href=https://blog.hugozhu.site/><img class=avatar-img src=https://blog.hugozhu.site/img/pi.png alt="All about Raspberry Pi"></a></div></div></div></nav><div id=modalSearch class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><button type=button class=close data-dismiss=modal>&#215;</button><h4 class=modal-title>Search All about Raspberry Pi</h4></div><div class=modal-body><gcse:search></gcse:search></div><div class=modal-footer><button type=button class="btn btn-default" data-dismiss=modal>Close</button></div></div></div></div><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=page-heading><h1>Hugo Zhu's Blog</h1><hr class=small></div></div></div></div></div></header><div role=main class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=well><div align=center><a href=/post/2025/81-streamdeck-streamdock-with-raspberry-pi/><img src=https://blog.hugozhu.site/img/streampi_demo.jpg></a>
<a href=/post/2025/81-streamdeck-streamdock-with-raspberry-pi/>StreamPi - StreamDeck with Raspberry Pi</a></div></div><div class=posts-list><article class=post-preview><a href=https://blog.hugozhu.site/post/2013/27-interrupts-with-gpio-pins/><h2 class=post-title>Raspberry Pi的GPIO中断编程</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on April 8, 2013
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;3&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;503&nbsp;words</span></p><div class=post-entry><h1 id=背景介绍>背景介绍</h1><p>树莓派的GPIO引脚不仅可以输出高低电平，也可以当做输入端口（可以想象成键盘输入），当GPIO接入的是高电平，GPIO的值可以认为是1，如果是低电平则是0。如下图所示，可以使用一个Push Button开关按键来控制GPIO 25（BCM Numbering）的高低电平以达到控制的目的。</p><img src="https://www.evernote.com/shard/s26/sh/bd720803-1b71-454d-98a2-cf0e907df688/649d6eb30376f8a378ef3e8a7cc3c552/deep/0/Screenshot%204/8/13%2011:25%20PM.jpg?noteKey=649d6eb30376f8a378ef3e8a7cc3c552&suffix=deep%2F0%2FScreenshot+4%2F8%2F13+11%3A25+PM.jpg&noteGuid=bd720803-1b71-454d-98a2-cf0e907df688"><p>GPIO 25和VCC（3.3V）之间通过R1（10K欧姆）和R2（1K欧姆）<a href=https://zh.wikipedia.org/zh/%E4%B8%8A%E6%8B%89%E7%94%B5%E9%98%BB>上拉电阻</a>相连，当按键未被按下时，GPIO 25上拉到VCC，程序可以读到1，当按键按下时，GPIO 25被下拉电阻R2拉到GND（0V），程序可以读到0。如果不加R1，而GPIO 25不小心被设置成输出低电平时，将直接和VCC相连而造成短路，这样可能会烧掉这个引脚，所以加上限流电阻R1后，即使发生这样的情况，也不会出现短路情况。</p><h1 id=应用>应用</h1><p>如果我们需要根据GPIO 25的值来控制树莓派，比如按下按钮时希望点亮某个LED或在液晶上显示当前时间，就需要通过程序来获取状态的变化。</p><p>一种常见的做法是在循环里不断读取该引脚的状态，当发生对应的变化的时执行控制逻辑，但显而易见，这种做法很消耗CPU，如果在循环增加<code>sleep(1000)</code>这样的调用，又很容易错过按键变化。较好的做法则是通过<a href=http://zh.wikipedia.org/wiki/%E4%B8%AD%E6%96%AD>中断</a>来实现。</p><p>最新的树莓派Raspbian和Arch Linux内核都已经包含了GPIO的中断处理支持。但使用前需要将指定GPIO引脚输出，方法如下：</p><p>首先可以通过命令<code>echo 25 > /sys/class/gpio/export</code>导出GPIO 25端口，执行成功后在相应的目录下看到以下文件，得益于Linux下<strong>一切都是文件</strong>的设计理念，GPIO的状态可以通过<code>value</code>文件来获取，这样就可以利用Linux的poll/epoll来获取<code>value</code>文件的变化(这点和Linux高性能网络编程是类似的)。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@raspberrypi2 ~/projects/interrupt_test # ls -l /sys/class/gpio/gpio25/
</span></span><span class=line><span class=cl>total 0
</span></span><span class=line><span class=cl>-rw-r--r-- 1 root root 4096 Apr  8 23:56 active_low
</span></span><span class=line><span class=cl>-rw-r--r-- 1 root root 4096 Apr  8 22:29 direction
</span></span><span class=line><span class=cl>-rw-r--r-- 1 root root 4096 Apr  8 22:29 edge
</span></span><span class=line><span class=cl>drwxr-xr-x 2 root root    0 Apr  8 23:56 power
</span></span><span class=line><span class=cl>lrwxrwxrwx 1 root root    0 Apr  8 23:56 subsystem -&gt; ../../../../class/gpio
</span></span><span class=line><span class=cl>-rw-r--r-- 1 root root 4096 Apr  8 22:08 uevent
</span></span><span class=line><span class=cl>-rw-r--r-- 1 root root 4096 Apr  8 22:29 value
</span></span><span class=line><span class=cl>root@raspberrypi2 ~/projects/interrupt_test # 
</span></span></code></pre></div><h1 id=wiringpi>wiringPi</h1><p><a href=https://projects.drogon.net/raspberry-pi/wiringpi/functions/>wiringPi</a>库封装了一个简单的接口，传入一个回调函数，当事件发生时传入的函数将被调用。</p><a href=https://blog.hugozhu.site/post/2013/27-interrupts-with-gpio-pins/ class=post-read-more>[Read More]</a></div><div class=blog-tags><a href=https://blog.hugozhu.site/tags/raspberry-pi/>Raspberry Pi</a>&nbsp;</div></article><article class=post-preview><a href=https://blog.hugozhu.site/post/2013/26-backup-raspberry-pi/><h2 class=post-title>备份Raspberry Pi</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on April 8, 2013
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;1&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;194&nbsp;words</span></p><div class=post-entry><p>树莓派的操作系统安装在SD卡，使用一段时间后还是很有必要备份一下，以防哪天SD卡就坏了。</p><p>备份的目的地最方便的还是使用网络存储，我使用的是西部数据的<a href="http://detail.tmall.com/item.htm?spm=a220m.1000858.1000725.1.Cz5Mlq&amp;id=13865367896&amp;is_b=1&amp;cat_id=50099232&amp;q=mybooklive&amp;rn=638aa11bdda81f8d589bb0e052c57187">MyBooklive</a>3T网络硬盘。挺不错的一个产品，功能基本满足我的需求。</p><p>准备好备份目标盘，将Nas的备份目录mount到树莓派:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>mkdir /mnt/backup
</span></span><span class=line><span class=cl>mount -t cifs //mybooklive/Public/Backup /mnt/backup -o guest
</span></span></code></pre></div><h1 id=完整备份>完整备份</h1><p>确定相应的SD卡设备ID</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@raspberrypi2 ~/bin # fdisk -l
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Disk /dev/mmcblk0: 1973 MB, 1973420032 bytes, 3854336 sectors
</span></span><span class=line><span class=cl>Units = sectors of 1 * 512 = 512 bytes
</span></span><span class=line><span class=cl>Sector size (logical/physical): 512 bytes / 512 bytes
</span></span><span class=line><span class=cl>I/O size (minimum/optimal): 512 bytes / 512 bytes
</span></span><span class=line><span class=cl>Disk identifier: 0x0004f23a
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        Device Boot      Start         End      Blocks   Id  System
</span></span><span class=line><span class=cl>/dev/mmcblk0p1   *        2048      186367       92160    c  W95 FAT32 (LBA)
</span></span><span class=line><span class=cl>/dev/mmcblk0p2          186368     3667967     1740800   83  Linux
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Disk /dev/sda: 2107 MB, 2107637760 bytes, 4116480 sectors
</span></span><span class=line><span class=cl>Units = sectors of 1 * 512 = 512 bytes
</span></span><span class=line><span class=cl>Sector size (logical/physical): 512 bytes / 512 bytes
</span></span><span class=line><span class=cl>I/O size (minimum/optimal): 512 bytes / 512 bytes
</span></span></code></pre></div><p>执行备份</p><a href=https://blog.hugozhu.site/post/2013/26-backup-raspberry-pi/ class=post-read-more>[Read More]</a></div><div class=blog-tags><a href=https://blog.hugozhu.site/tags/rasperry-pi/>Rasperry Pi</a>&nbsp;</div></article><article class=post-preview><a href=https://blog.hugozhu.site/post/2013/25-get-spi-working-on-raspberry-pi-spi/><h2 class=post-title>在Raspberry Pi上使用硬件SPI</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on April 5, 2013
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;4&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;846&nbsp;words</span></p><div class=post-entry><h1 id=什么是spi>什么是SPI</h1><p>SPI (Serial Peripheral Interface)，是一种高速，全双工，同步的通信总线协议，基于SPI的设备需要4根线：</p><p><img src=https://www.evernote.com/shard/s26/sh/61dba789-b17b-4570-b124-03925a97a4bf/4e64405c3b1a486f7aa4b9451e142b32/deep/0/Screenshot%204/5/13%204:27%20PM.jpg></p><ol><li>SDO / MOSI - 主设备数据输出，从设备数据输入</li><li>SDI / MISO - 主设备数据输入，从设备数据输出</li><li>SCLK / CLK - 时钟信号，由主设备产生</li><li>CS / SS - 从设备使能信号，由主设备控制</li></ol><p>通过CS，主设备可以控制和哪个从设备通信。</p><h2 id=bit-banging>Bit Banging</h2><p>Bit-banging是一种用软件替代专职硬件的串行通信的技术。软件直接对微处理器的管脚的状态进行设置和采样，其功能涵盖诸如：时钟，电平，同步等所有参数。与此不同的是（传统的串行通信技术中），专职硬件诸如 modem、UART 或者 位移寄存器等一般是用来处理这些参数并且提供一个（缓存）的数据接口，软件在这种情况下同信号处理无关。</p><p>bit-banging 具有明显优点诸如：让相同的设备运行不同的协议而只需很小的（甚至不需）硬件的改动。借助很少的额外设备，我们也许可以从数字管脚（数字终端）可以得到视频信号。</p><p>bit-banging 也有一些明显的缺点。在软件仿真的过程中消耗的能量比同样功能的专职硬件大。微处理器过忙地从管脚采样和发送采样信号到管脚。在同等微处理器处理能力下，系统常常会有些噪音。</p><p>在Rasperry Pi上使用Bit Banging在实际情况下有可能因为操作系统调度造成时钟信号不稳定而使设备收到错误的消息，具体的表现就是Nokia 5110屏在长时间运行过程中出现白屏或花屏现象，如下图：</p><img src=http://ww2.sinaimg.cn/bmiddle/6bc40342jw1e3dzvsfxblj.jpg><p>采用硬件SPI，由Pi的管脚14号Pin（左边倒数第二个）SCLK发出一定频率的时钟信号。经过测试，这种方法产生的时钟信号比Bit Banging软件模拟产生的信号要稳定很多。</p><img src=http://ww1.sinaimg.cn/small/6bc40342jw1e3f1s62pnuj.jpg>
软件模拟时钟信号波形
<img src=http://ww1.sinaimg.cn/small/6bc40342jw1e3f6d4wsjij.jpg>
硬件SPI时钟信号波形<h1 id=测试pi的硬件spi>测试Pi的硬件SPI</h1><h2 id=确认内核支持>确认内核支持</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@raspberrypi2 ~/projects/spi_test # ls -la /dev/spi*
</span></span><span class=line><span class=cl>crw------- 1 root root 153, 0 Jan  1  1970 /dev/spidev0.0
</span></span><span class=line><span class=cl>crw------- 1 root root 153, 1 Jan  1  1970 /dev/spidev0.1
</span></span></code></pre></div><h2 id=测试代码>测试代码</h2><p>下载 <a href=http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/plain/Documentation/spi/spidev_test.c>spidev_test.c</a> 或拷贝下面的代码：</p><a href=https://blog.hugozhu.site/post/2013/25-get-spi-working-on-raspberry-pi-spi/ class=post-read-more>[Read More]</a></div><div class=blog-tags><a href=https://blog.hugozhu.site/tags/rasperry-pi/>Rasperry Pi</a>&nbsp;</div></article><article class=post-preview><a href=https://blog.hugozhu.site/post/2013/24-google-channel-service/><h2 class=post-title>在Raspberry Pi上使用Google Channel服务搭建实时应用</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on April 3, 2013
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;3&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;521&nbsp;words</span></p><div class=post-entry><p>前面提到了有关个人网站的<a href=http://hugozhu.myalert.info/2013/03/27/21-realtime-online-user-counter.html>实时在线人数</a>问题，本文要讨论的是如何自己来实现一个这样的统计服务。因为网站也同时部署在Github上，海外用户访问Github镜像网站的访问日志Pi是拿不到的，这怎么办？</p><h1 id=google-channel-service>Google Channel Service</h1><p><a href=https://developers.google.com/appengine/docs/go/channel/overview>Google Channel Service</a>允许应用和<a href=http://appengine.google.com/>GAE (Google App Engine)</a> 保持一个长连接，允许应用实时发送消息给JavaScript客户端，而不用让客户端用效率很低的定时轮询获取新消息。这个服务是允许有多个发布者和多个订阅者，也能创建多个主题来关联发布者和订阅者。</p><p>使用这个服务分两步：</p><ol><li><p>客户端请求服务器端（部署在GAE上）获取一个Channel的Token：
<img src=https://developers.google.com/appengine/images/channel_overview01.png></p></li><li><p>客户端根据Channel Token和服务器建立长连接，并开始接收消息，这时其它的客户端（或服务器端）可以想这个通道发送消息
<img src=https://developers.google.com/appengine/images/channel_overview02.png></p></li></ol><h1 id=在线人数统计实现>在线人数统计实现</h1><h2 id=在页面上部署beacon>在页面上部署beacon</h2><p>通常的网站流量统计是依赖部署在页面上的beacon（Javascript或图片标签）来实现的，这样做的好处是可以直接过滤掉一些机器流量，并且可以将日志集中存储在日志收集服务器上，和网站分离开。</p><p>于是可以利用GAE实现一个简单的Beacon服务，这里采用Go语言来实现，用Java或Python也是可以的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>package</span> <span class=n>counter</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;encoding/base64&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;appengine&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;appengine/channel&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>var</span> <span class=n>GIF</span> <span class=p>[]</span><span class=n>byte</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=n>TOPIC</span> <span class=o>=</span> <span class=s2>&#34;counter&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>GIF</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>StdEncoding</span><span class=o>.</span><span class=n>DecodeString</span><span class=p>(</span><span class=s2>&#34;R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=n>http</span><span class=o>.</span><span class=n>HandleFunc</span><span class=p>(</span><span class=s2>&#34;/beacon.gif&#34;</span><span class=p>,</span> <span class=n>handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>http</span><span class=o>.</span><span class=n>HandleFunc</span><span class=p>(</span><span class=s2>&#34;/new_token&#34;</span><span class=p>,</span> <span class=n>handler_new_token</span><span class=p>)</span>	
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>handler</span><span class=p>(</span><span class=n>w</span> <span class=n>http</span><span class=o>.</span><span class=n>ResponseWriter</span><span class=p>,</span> <span class=n>r</span> <span class=o>*</span><span class=n>http</span><span class=o>.</span><span class=n>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>context</span> <span class=p>:</span><span class=o>=</span> <span class=n>appengine</span><span class=o>.</span><span class=n>NewContext</span><span class=p>(</span><span class=n>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>now</span> <span class=p>:</span><span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=n>expire</span> <span class=p>:</span><span class=o>=</span> <span class=n>now</span><span class=o>.</span><span class=n>AddDate</span><span class=p>(</span><span class=mi>30</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>zcookie</span><span class=p>,</span> <span class=n>_</span> <span class=p>:</span><span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>Cookie</span><span class=p>(</span><span class=s2>&#34;z&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>zcookie</span> <span class=o>==</span> <span class=n>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>zcookie</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>http</span><span class=o>.</span><span class=n>Cookie</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>		<span class=n>zcookie</span><span class=o>.</span><span class=n>Name</span> <span class=o>=</span> <span class=s2>&#34;z&#34;</span>
</span></span><span class=line><span class=cl>		<span class=n>zcookie</span><span class=o>.</span><span class=n>Value</span> <span class=o>=</span> <span class=n>make_hash</span><span class=p>(</span><span class=s2>&#34;&lt;your_salt&gt;&#34;</span><span class=p>,</span> <span class=n>r</span><span class=o>.</span><span class=n>RemoteAddr</span><span class=p>,</span> <span class=n>now</span><span class=o>.</span><span class=n>UnixNano</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=n>zcookie</span><span class=o>.</span><span class=n>Expires</span> <span class=o>=</span> <span class=n>expire</span>
</span></span><span class=line><span class=cl>		<span class=n>zcookie</span><span class=o>.</span><span class=n>Path</span> <span class=o>=</span> <span class=s2>&#34;/&#34;</span>
</span></span><span class=line><span class=cl>		<span class=n>http</span><span class=o>.</span><span class=n>SetCookie</span><span class=p>(</span><span class=n>w</span><span class=p>,</span> <span class=n>zcookie</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>w</span><span class=o>.</span><span class=n>Header</span><span class=p>()</span><span class=o>.</span><span class=n>Set</span><span class=p>(</span><span class=s2>&#34;Content-type&#34;</span><span class=p>,</span> <span class=s2>&#34;image/gif&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>w</span><span class=o>.</span><span class=n>Header</span><span class=p>()</span><span class=o>.</span><span class=n>Set</span><span class=p>(</span><span class=s2>&#34;Cache-control&#34;</span><span class=p>,</span> <span class=s2>&#34;no-cache, must-revalidate&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>w</span><span class=o>.</span><span class=n>Header</span><span class=p>()</span><span class=o>.</span><span class=n>Set</span><span class=p>(</span><span class=s2>&#34;Expires&#34;</span><span class=p>,</span> <span class=s2>&#34;Sat, 26 Jul 1997 05:00:00 GMT&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>fmt</span><span class=o>.</span><span class=n>Fprintf</span><span class=p>(</span><span class=n>w</span><span class=p>,</span> <span class=s2>&#34;</span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>GIF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>channel</span><span class=o>.</span><span class=n>Send</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>TOPIC</span><span class=p>,</span> <span class=n>zcookie</span><span class=o>.</span><span class=n>Value</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=o>+</span><span class=n>r</span><span class=o>.</span><span class=n>RemoteAddr</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=o>+</span><span class=n>r</span><span class=o>.</span><span class=n>Referer</span><span class=p>()</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=o>+</span><span class=n>r</span><span class=o>.</span><span class=n>UserAgent</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>handler_new_token</span><span class=p>(</span><span class=n>w</span> <span class=n>http</span><span class=o>.</span><span class=n>ResponseWriter</span><span class=p>,</span> <span class=n>r</span> <span class=o>*</span><span class=n>http</span><span class=o>.</span><span class=n>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>c</span> <span class=p>:</span><span class=o>=</span> <span class=n>appengine</span><span class=o>.</span><span class=n>NewContext</span><span class=p>(</span><span class=n>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>tok</span><span class=p>,</span> <span class=n>err</span> <span class=p>:</span><span class=o>=</span> <span class=n>channel</span><span class=o>.</span><span class=n>Create</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>TOPIC</span><span class=p>)</span>	
</span></span><span class=line><span class=cl>	<span class=n>callback</span> <span class=p>:</span><span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>FormValue</span><span class=p>(</span><span class=s2>&#34;callback&#34;</span><span class=p>)</span>	
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>err</span> <span class=o>!=</span> <span class=n>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>http</span><span class=o>.</span><span class=n>Error</span><span class=p>(</span><span class=n>w</span><span class=p>,</span> <span class=s2>&#34;Couldn&#39;t create Channel&#34;</span><span class=p>,</span> <span class=n>http</span><span class=o>.</span><span class=n>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>c</span><span class=o>.</span><span class=n>Errorf</span><span class=p>(</span><span class=s2>&#34;channel.Create: %v&#34;</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>callback</span> <span class=o>==</span> <span class=s2>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>w</span><span class=o>.</span><span class=n>Header</span><span class=p>()</span><span class=o>.</span><span class=n>Set</span><span class=p>(</span><span class=s2>&#34;Content-type&#34;</span><span class=p>,</span> <span class=s2>&#34;text/javascript&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>fmt</span><span class=o>.</span><span class=n>Fprintf</span><span class=p>(</span><span class=n>w</span><span class=p>,</span> <span class=s2>&#34;</span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>tok</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>fmt</span><span class=o>.</span><span class=n>Fprintf</span><span class=p>(</span><span class=n>w</span><span class=p>,</span> <span class=n>callback</span><span class=o>+</span><span class=s2>&#34;(&#39;</span><span class=si>%s</span><span class=s2>&#39;)&#34;</span><span class=p>,</span> <span class=n>tok</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>代码最后一行是将访问日志实时通过Channel发送出去，该通道有一个指定的主题，这样订阅该主题的客户端都可以收到相应的消息。</p><a href=https://blog.hugozhu.site/post/2013/24-google-channel-service/ class=post-read-more>[Read More]</a></div><div class=blog-tags><a href=https://blog.hugozhu.site/tags/golang/>Golang</a>&nbsp;</div></article><article class=post-preview><a href=https://blog.hugozhu.site/post/2013/23-arduino-1st-day/><h2 class=post-title>Arduino初试</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on March 28, 2013
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;1&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;142&nbsp;words</span></p><div class=post-entry><p>今天拿到一块Arduino UNO R3板，迫不及待就开始试用了。相比Raspberry Pi是一个全能的电脑，Arduino则是个硬件开源的单片机，因为开源，资料和配件网上就很很多了，也就容易让初学者上手了。</p><p>Arduino特点:</p><ol><li>开源，硬件标准化，配套传感器等模块很多；</li><li>结构简单</li><li>实时系统，稳定，启动只要0.5秒</li></ol><h1 id=arduino-ide>Arduino IDE</h1><p><a href=http://arduino.cc/en/Main/Software>下载Arduino IDE</a></p><h1 id=上电测试>上电测试</h1><p>用USB线接在电脑USB口，然后在GND和PIN 13上插一个二极管，注意二极管正极插在PIN 13上, 如下图：
<img src=http://ww1.sinaimg.cn/bmiddle/6bc40342jw1e35tmsg0tjj.jpg></p><p>(注：还应该串联一个300欧姆的限流电阻才保险！)</p><h1 id=上传代码>上传代码</h1><p>在Arduino IDE编辑好下面的代码，然后点Upload后就会运行了，会看到LED一闪一闪。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/*
</span></span><span class=line><span class=cl>  Blink
</span></span><span class=line><span class=cl>  Turns on an LED on for one second, then off for one second, repeatedly.
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>  This example code is in the public domain.
</span></span><span class=line><span class=cl> */
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>// Pin 13 has an LED connected on most Arduino boards.
</span></span><span class=line><span class=cl>// give it a name:
</span></span><span class=line><span class=cl>int led = 13;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// the setup routine runs once when you press reset:
</span></span><span class=line><span class=cl>void setup() {                
</span></span><span class=line><span class=cl>  // initialize the digital pin as an output.
</span></span><span class=line><span class=cl>  pinMode(led, OUTPUT);     
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// the loop routine runs over and over again forever:
</span></span><span class=line><span class=cl>void loop() {
</span></span><span class=line><span class=cl>  digitalWrite(led, HIGH);   // turn the LED on (HIGH is the voltage level)
</span></span><span class=line><span class=cl>  delay(1000);               // wait for a second
</span></span><span class=line><span class=cl>  digitalWrite(led, LOW);    // turn the LED off by making the voltage LOW
</span></span><span class=line><span class=cl>  delay(1000);               // wait for a second
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><h1 id=参考链接>参考链接</h1><ol><li><a href=http://arduino.cc/en/Tutorial/Blink>http://arduino.cc/en/Tutorial/Blink</a></li></ol></div><div class=blog-tags><a href=https://blog.hugozhu.site/tags/arduino/>Arduino</a>&nbsp;</div></article><article class=post-preview><a href=https://blog.hugozhu.site/post/2013/22-memory-barriers-or-fences/><h2 class=post-title>并发编程之内存屏障</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on March 28, 2013
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;1&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;149&nbsp;words</span></p><div class=post-entry><p>原文地址：<a href=http://mechanical-sympathy.blogspot.com/2011/07/memory-barriersfences.html><code>http://mechanical-sympathy.blogspot.com/2011/07/memory-barriersfences.html</code></a> 或 <a href=http://ifeve.com/memory-barriersfences/><code>http://ifeve.com/memory-barriersfences/</code></a></p><p>关键词：Load Barrier, Store Barrier, Full Barrier</p><p>本文我将和大家讨论并发编程中最基础的一项技术：内存屏障或内存栅栏，也就是让一个CPU处理单元中的内存状态对其它处理单元可见的一项技术。</p><p>CPU使用了很多优化技术来达成一个事实：CPU执行单元的速度要远超主存访问速度。在我上一篇文章 &ldquo;Write Combing - 合并写"中我已经介绍了其中的一项技术。CPU避免内存访问延迟最常见的技术是将指令管道化，然后尽量重排这些管道的执行以最大利用缓存而把因为缓存未命中引起的延迟降到最小。</p><p>当一个程序执行时指令是否被重排并不重要，只要最终的结果是一样的。例如，在一个循环里，如果循环体内没用到这个计数器，循环的计数器什么时候更新（在循环开始，中间还是最后）并不重要。编译器和CPU可以自由的重排指令以最佳的利用CPU，只要下一次循环前更新该计数器即可。并且在循环执行中，这个变量可能一直存在寄存器上，并没有被推到缓存或主存，这样这个变量对其他CPU来说一直都是不可见的。</p><p>CPU核内部包含了多个执行单元。例如，现代Intel CPU包含了6个执行单元，可以组合进行算术运算，逻辑条件判断及内存操作。每个执行单元可以执行上述任务的某种组合。这些执行单元是并行执行的，这样指令也就是在并行执行。但如果站在另一个CPU角度看，这也就产生了程序顺序的另一种不确定性。</p><p>最后，当一个缓存失效发生时，现代CPU可以先假设一个内存载入的值并根据这个假设值继续执行，直到内存载入返回确切的值。</p><img src=http://ifeve.com/wp-content/uploads/2013/03/cpu.png><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>CPU核
</span></span><span class=line><span class=cl>  |
</span></span><span class=line><span class=cl>  V
</span></span><span class=line><span class=cl>寄存器
</span></span><span class=line><span class=cl>  |
</span></span><span class=line><span class=cl>  V
</span></span><span class=line><span class=cl>执行单元 -&gt; Load/Store缓冲区-&gt;L1 Cache ---&gt;L3 Cache--&gt;内存控制器--&gt;主存
</span></span><span class=line><span class=cl>       |                                   |
</span></span><span class=line><span class=cl>       +-&gt; Write Combine缓冲区-&gt;L2 Cache ---+
</span></span></code></pre></div><p>代码顺序并不是真正的执行顺序，CPU和编译器可以各种优化只要有空间提高性能。缓存和主存的读取会利用load, store和write-combining缓冲区来缓冲和重排。这些缓冲区是查找速度很快的关联队列，当一个后来发生的load需要读取上一个store的值，而该值还没有到达缓存，查找是必需的，上图描绘的是一个简化的现代多核CPU，从上图可以看出执行单元可以利用本地寄存器和缓冲区来管理和缓存子系统的交互。</p><p>在多线程环境里需要使用技术来使得程序结果尽快可见。这篇文章里我不会涉及到 Cache Conherence 的概念。请先假定一个事实：一旦内存数据被推送到缓存，就会有消息协议来确保所有的缓存会对所有的共享数据同步并保持一致。这个使内存数据对CPU核可见的技术被称为内存屏障或内存栅栏。</p><p>内存屏障提供了两个功能。首先，它们通过确保从另一个CPU来看屏障的两边的所有指令都是正确的程序顺序，而保持程序顺序的外部可见性；其次它们可以实现内存数据可见性，确保内存数据会同步到CPU缓存子系统。</p><p>大多数的内存屏障都是复杂的话题。在不同的CPU架构上内存屏障的实现非常不一样。相对来说Intel CPU的强内存模型比DEC Alpha的弱复杂内存模型（缓存不仅分层了，还分区了）更简单。因为x86处理器是在多线程编程中最常见的，下面我尽量用x86的架构来阐述。</p><h1 id=store-barrier>Store Barrier</h1><p>Store屏障，是x86的&rdquo;<strong>sfence</strong>&ldquo;指令，强制所有在store屏障指令之前的store指令，都在该store屏障指令执行之前被执行，并把store缓冲区的数据都刷到CPU缓存。这会使得程序状态对其它CPU可见，这样其它CPU可以根据需要介入。一个实际的好例子是Disruptor中的<a href=http://code.google.com/p/disruptor/source/browse/trunk/code/src/main/com/lmax/disruptor/BatchEventProcessor.java>BatchEventProcessor</a>。当序列Sequence被一个消费者更新时，其它消费者(Consumers)和生产者（Producers）知道该消费者的进度，因此可以采取合适的动作。所以屏障之前发生的内存更新都可见了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private volatile long sequence = RingBuffer.INITIAL_CURSOR_VALUE;
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>// from inside the run() method
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>T event = null;
</span></span><span class=line><span class=cl>long nextSequence = sequence.get() + 1L;
</span></span><span class=line><span class=cl>while (running)
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    try
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl>        final long availableSequence = barrier.waitFor(nextSequence);
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        while (nextSequence &lt;= availableSequence)
</span></span><span class=line><span class=cl>        {
</span></span><span class=line><span class=cl>            event = ringBuffer.get(nextSequence);
</span></span><span class=line><span class=cl>            boolean endOfBatch = nextSequence == availableSequence;
</span></span><span class=line><span class=cl>            eventHandler.onEvent(event, nextSequence, endOfBatch);
</span></span><span class=line><span class=cl>            nextSequence++;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        sequence.set(nextSequence - 1L); 
</span></span><span class=line><span class=cl>        // store barrier inserted here !!!
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    catch (final Exception ex)
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl>        exceptionHandler.handle(ex, nextSequence, event);
</span></span><span class=line><span class=cl>        sequence.set(nextSequence);
</span></span><span class=line><span class=cl>        // store barrier inserted here !!!
</span></span><span class=line><span class=cl>        nextSequence++;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><h1 id=load-barrier>Load Barrier</h1><p>Load屏障，是x86上的&rdquo;<strong>ifence</strong>&ldquo;指令，强制所有在load屏障指令之后的load指令，都在该load屏障指令执行之后被执行，并且一直等到load缓冲区被该CPU读完才能执行之后的load指令。这使得从其它CPU暴露出来的程序状态对该CPU可见，这之后CPU可以进行后续处理。一个好例子是上面的BatchEventProcessor的sequence对象是放在屏障后被生产者或消费者使用。</p><a href=https://blog.hugozhu.site/post/2013/22-memory-barriers-or-fences/ class=post-read-more>[Read More]</a></div><div class=blog-tags><a href=https://blog.hugozhu.site/tags/java/>Java</a>&nbsp;
<a href=https://blog.hugozhu.site/tags/concurrent-programming/>Concurrent Programming</a>&nbsp;
<a href=https://blog.hugozhu.site/tags/%E6%96%87%E7%AB%A0%E7%BF%BB%E8%AF%91/>文章翻译</a>&nbsp;</div></article><article class=post-preview><a href=https://blog.hugozhu.site/post/2013/21-realtime-online-user-counter/><h2 class=post-title>个人网站实时在线人数接口</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on March 27, 2013
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;1&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;26&nbsp;words</span></p><div class=post-entry><p>感觉把个人网站正在访问的在线人数显示在Nokia 5110液晶屏挺好玩，就稍微研究了一下如何提取实时在线人数。</p><h1 id=实现方法>实现方法</h1><h2 id=google-analytics>Google Analytics</h2><p>Google Analytics具有很强大的实时流量分析功能，不过网站主必须登陆到后台才能看，但并没有提供Open API，所以就不能用这个服务了。</p><h2 id=日志分析>日志分析</h2><p>不修改网站通过web服务器的日志分析，用一个脚本统计15分钟内日志的Unique IP可以粗略的获得一个在线人数。
但多个用户可能通过一个IP过来，这种做法肯定不精确。一般我们可以通过在页面上部署Javascript脚本，由Javascript为每一个浏览器产生一个独特的持久化Cookie，用这个Cookie代替IP来统计。但用Raspberry Pi来做这件事情会拖慢网站，于是一种方案是采用免费的Google App Engine来实现，打算有空来实现一个。</p><h2 id=cnzz>CNZZ</h2><p>CNZZ也提供了15分钟内的在线人数统计功能。分析CNZZ的计数器代码后发现如下方法可以提取到在线人数:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>curl -s &#34;http://online.cnzz.com/online/online.php?id=[your_cnzz_id]&amp;h=[your_cnzz_server_id].cnzz.com&amp;on=1&amp;s=line&#34; | sed -e &#39;s/.*当前在线\[\([0-9]\).*/\1/g&#39;
</span></span></code></pre></div><p>于是先通过上面的脚本提取在线人数并上传到<a href=https://cosm.com/feeds/92372>Cosm</a>，Cosm有个触发器功能可以当在线人数超过某个值后发Twitter或HTTP Post到指定URL，并通过程序显示在液晶屏上。</p></div></article><article class=post-preview><a href=https://blog.hugozhu.site/post/2013/20-raspberry-pi-drive-nokia-5110/><h2 class=post-title>升级版电子钟 - 如何使用Raspberry Pi驱动Nokia 5110液晶屏</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on March 24, 2013
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;3&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;620&nbsp;words</span></p><div class=post-entry><p>Nokia 5110屏比前面介绍过的<a href=http://hugozhu.myalert.info/2013/03/23/19-raspberry-pi-drive-1602-lcd.html>1602液晶屏</a>功能好很多，淘宝上买价格相差不大（二手5110 12块左右, 全新1602 8块左右），Nokia 5110最少只需要占用4个GPIO引脚：</p><ol><li>带蓝色背光</li><li>使用Philips PCD8544 LCD控制器（通过SPI接口）</li><li>84x48点阵，可显示100多个字符</li></ol><h1 id=硬件准备>硬件准备</h1><ol><li><a href="http://detail.tmall.com/item.htm?spm=a220m.1000858.1000725.6.nGxekg&amp;id=17337394004&amp;is_b=1&amp;cat_id=2&amp;q=%CA%F7%DD%AE%C5%C9&amp;rn=4004716f9ba818c1d69b5eb7818891b5">树莓派</a></li><li><a href="http://item.taobao.com/item.htm?id=3125173573&amp;ali_trackid=2:mm_12926928_3484851_11423954:1364118594_4k1_653822857&amp;clk1=0b755dfca67112cd1b605914b40146e7&amp;spm=a230z.1.5634029.2.foR1Yu">Nokia 5110 拆机屏</a> 或 <a href="http://item.taobao.com/item.htm?spm=a230r.1.10.154.SdjftL&amp;id=13361097288&_u=oqa31997">焊好的？</a> 注意不要买裸屏，需要带电路板的</li><li><a href="http://list.tmall.com/search_product.htm?q=%B6%C5%B0%EE%CF%DF&amp;user_action=initiative&amp;at_topsearch=1&amp;sort=st&amp;type=p&amp;cat=&amp;style=">杜邦线</a> 母对母8条</li><li>8P排针 用来焊接5110屏幕PCB板</li><li><a href="http://detail.tmall.com/item.htm?id=22096296909&amp;ali_trackid=2:mm_12926928_3484851_11423954:1364118800_4k4_1229281314&amp;clk1=c7335b2dcbad93f47eaf5cd4d1cc140b&amp;spm=a230z.1.5634029.66.6xxdfN">电烙铁</a></li></ol><h1 id=电路>电路</h1><p>5110电路板有8个引脚，使用排针（如下图）将其焊上，方便后面用杜邦线连接，如果不会焊也可以买焊接好的。</p><img src=http://img01.taobaocdn.com/bao/uploaded/i1/13130028971464406/T1v5oAXd0XXXXXXXXX_!!0-item_pic.jpg_600x600.jpg><ol><li>RST —— 复位 接GPIO 0</li><li>CE —— 片选 接GPIO 1 或 不接</li><li>DC —— 数据/指令选择 接GPIO 2</li><li>DIN —— 串行数据线 接GPIO 3</li><li>CLK —— 串行时钟线 接GPIO 5 （因为我的GPIO 4已经接了一个DHT11传感器）</li><li>VCC —— 电源输入 接3.3v</li><li>BL —— 背光控制端 接3.3v</li><li>GND —— 地线 接地</li></ol><p>PS. 编号规范看<a href=http://hugozhu.myalert.info/2013/03/22/19-raspberry-pi-gpio-port-naming.html>这里</a> VCC, BK, GND可以接在面包板电源上</p><a href=https://blog.hugozhu.site/post/2013/20-raspberry-pi-drive-nokia-5110/ class=post-read-more>[Read More]</a></div><div class=blog-tags><a href=https://blog.hugozhu.site/tags/raspberry-pi/>Raspberry Pi</a>&nbsp;</div></article><article class=post-preview><a href=https://blog.hugozhu.site/post/2013/19-raspberry-pi-drive-1602-lcd/><h2 class=post-title>如何使用Raspberry Pi在1602液晶屏上显示当前时间--电子钟</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on March 23, 2013
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;4&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;793&nbsp;words</span></p><div class=post-entry><h1 id=硬件准备>硬件准备</h1><p>需要以下硬件：</p><ol><li><a href="http://detail.tmall.com/item.htm?spm=a220m.1000858.1000725.6.nGxekg&amp;id=17337394004&amp;is_b=1&amp;cat_id=2&amp;q=%CA%F7%DD%AE%C5%C9&amp;rn=4004716f9ba818c1d69b5eb7818891b5">树莓派</a></li><li><a href="http://list.tmall.com//search_product.htm?q=%C3%E6%B0%FC%B0%E5&amp;type=p&amp;style=&amp;cat=all">面包板</a></li><li><a href="http://s.taobao.com/search?spm=a230r.1.8.2.RvXL2p&amp;q=1602+%D2%BA%BE%A7&amp;commend=all&amp;source=haiwaigou&amp;ssid=s5-e&amp;pid=mm_14507416_2297358_8935934&amp;newpre=null&amp;tab=mall">1602液晶屏</a>一块</li><li><a href="http://s.taobao.com/search?source=suggest&amp;haiwaifrom=1&amp;q=%B5%E7%CE%BB%C6%F7+10k&amp;initiative_id=staobaoz_20130323&amp;suggest_query=%B5%E7%CE%BB%C6%F7+10k&amp;sb_id=10&amp;suggest=0_2&amp;wq=%B5%E7%CE%BB%C6%F7&amp;tab=mall">10K电位器</a></li><li><a href="http://list.tmall.com/search_product.htm?q=%B6%C5%B0%EE%CF%DF&amp;user_action=initiative&amp;at_topsearch=1&amp;sort=st&amp;type=p&amp;cat=&amp;style=">杜邦线</a></li><li><a href="http://s.taobao.com/search?source=haiwaigou&amp;haiwaifrom=1&amp;q=%C5%C5%D5%EB&amp;initiative_id=staobaoz_20130323&amp;tab=mall">排针</a></li><li><a href="http://list.tmall.com//search_product.htm?q=%C3%E6%B0%FC%B0%E5+%B5%E7%D4%B4&amp;type=p&amp;style=&amp;cat=all">面包板电源</a></li></ol><h1 id=1602-lcd液晶屏>1602 LCD液晶屏</h1><p>LCD1602液晶屏提供了16列x2行的ASCII字符显示能力，工作电压5V，提供4位数据与8位数据两种工作模式，因为Raspberry Pi的GPIO口数量很有限，所以使用4位数据模式。LCD1602液晶屏模块提供了16个引脚，我们只需接其中的12个即可&ndash;请参考<a href=http://hugozhu.myalert.info/2013/03/22/19-raspberry-pi-gpio-port-naming.html>GPIO命名规则</a>：</p><ol><li>VSS，接地，RPi PIN 6</li><li>VDD，接5V电源，PRi PIN 2</li><li>VO，液晶对比度调节，接电位器中间的引脚</li><li>RS，寄存器选择，接GPIO 14，RPi PIN 8</li><li>RW，读写选择，接地，表示写模式，PRi PIN 6</li><li>EN，使能信号，接GPIO 15，RPi PIN 10</li><li>D0，数据位0，4位工作模式下不用，不接</li><li>D1，数据位1，4位工作模式下不用，不接</li><li>D2，数据位2，4位工作模式下不用，不接</li><li>D3，数据位3，4位工作模式下不用，不接</li><li>D4，数据位4，接GPIO 17，RPi PIN 11</li><li>D5，数据位5，接GPIO 18，RPi PIN 12</li><li>D6，数据位6，接GPIO 27，RPi PIN 13</li><li>D7，数据位7，接GPIO 22，RPi PIN 15</li><li>A，液晶屏背光+，接5V，RPi PIN 2</li><li>K，液晶屏背光-，接地，RPi PIN 6</li></ol><h1 id=注意事项>注意事项</h1><ol><li>电源VDD最后接上</li><li>排针焊接在液晶屏时注意不要虚焊，也可以用万用表测量一下</li><li>RW脚注意一定要接地</li><li>调节电位器可以调节液晶对比度</li></ol><h1 id=电路图>电路图</h1><img src=http://learn.adafruit.com/system/assets/assets/000/001/729/medium640/pi-char-lcd.gif?1345220594><h1 id=代码>代码</h1><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>#!/usr/bin/python
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>#
</span></span><span class=line><span class=cl># based on code from lrvick and LiquidCrystal
</span></span><span class=line><span class=cl># lrvic - https://github.com/lrvick/raspi-hd44780/blob/master/hd44780.py
</span></span><span class=line><span class=cl># LiquidCrystal - https://github.com/arduino/Arduino/blob/master/libraries/LiquidCrystal/LiquidCrystal.cpp
</span></span><span class=line><span class=cl>#
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>from time import sleep
</span></span><span class=line><span class=cl>from datetime import datetime
</span></span><span class=line><span class=cl>from time import sleep
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>class Adafruit_CharLCD:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    # commands
</span></span><span class=line><span class=cl>    LCD_CLEARDISPLAY 		= 0x01
</span></span><span class=line><span class=cl>    LCD_RETURNHOME 		    = 0x02
</span></span><span class=line><span class=cl>    LCD_ENTRYMODESET 		= 0x04
</span></span><span class=line><span class=cl>    LCD_DISPLAYCONTROL 		= 0x08
</span></span><span class=line><span class=cl>    LCD_CURSORSHIFT 		= 0x10
</span></span><span class=line><span class=cl>    LCD_FUNCTIONSET 		= 0x20
</span></span><span class=line><span class=cl>    LCD_SETCGRAMADDR 		= 0x40
</span></span><span class=line><span class=cl>    LCD_SETDDRAMADDR 		= 0x80
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    # flags for display entry mode
</span></span><span class=line><span class=cl>    LCD_ENTRYRIGHT 		= 0x00
</span></span><span class=line><span class=cl>    LCD_ENTRYLEFT 		= 0x02
</span></span><span class=line><span class=cl>    LCD_ENTRYSHIFTINCREMENT 	= 0x01
</span></span><span class=line><span class=cl>    LCD_ENTRYSHIFTDECREMENT 	= 0x00
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    # flags for display on/off control
</span></span><span class=line><span class=cl>    LCD_DISPLAYON 		= 0x04
</span></span><span class=line><span class=cl>    LCD_DISPLAYOFF 		= 0x00
</span></span><span class=line><span class=cl>    LCD_CURSORON 		= 0x02
</span></span><span class=line><span class=cl>    LCD_CURSOROFF 		= 0x00
</span></span><span class=line><span class=cl>    LCD_BLINKON 		= 0x01
</span></span><span class=line><span class=cl>    LCD_BLINKOFF 		= 0x00
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    # flags for display/cursor shift
</span></span><span class=line><span class=cl>    LCD_DISPLAYMOVE 		= 0x08
</span></span><span class=line><span class=cl>    LCD_CURSORMOVE 		= 0x00
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    # flags for display/cursor shift
</span></span><span class=line><span class=cl>    LCD_DISPLAYMOVE 		= 0x08
</span></span><span class=line><span class=cl>    LCD_CURSORMOVE 		= 0x00
</span></span><span class=line><span class=cl>    LCD_MOVERIGHT 		= 0x04
</span></span><span class=line><span class=cl>    LCD_MOVELEFT 		= 0x00
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    # flags for function set
</span></span><span class=line><span class=cl>    LCD_8BITMODE 		= 0x10
</span></span><span class=line><span class=cl>    LCD_4BITMODE 		= 0x00
</span></span><span class=line><span class=cl>    LCD_2LINE 			= 0x08
</span></span><span class=line><span class=cl>    LCD_1LINE 			= 0x00
</span></span><span class=line><span class=cl>    LCD_5x10DOTS 		= 0x04
</span></span><span class=line><span class=cl>    LCD_5x8DOTS 		= 0x00
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    def __init__(self, pin_rs=8, pin_e=10, pins_db=[11,12,13,15], GPIO = None):
</span></span><span class=line><span class=cl>	# Emulate the old behavior of using RPi.GPIO if we haven&#39;t been given
</span></span><span class=line><span class=cl>	# an explicit GPIO interface to use
</span></span><span class=line><span class=cl>	if not GPIO:
</span></span><span class=line><span class=cl>	    import RPi.GPIO as GPIO
</span></span><span class=line><span class=cl>        GPIO.setwarnings(False)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   	self.GPIO = GPIO
</span></span><span class=line><span class=cl>        self.pin_rs = pin_rs
</span></span><span class=line><span class=cl>        self.pin_e = pin_e
</span></span><span class=line><span class=cl>        self.pins_db = pins_db
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        self.GPIO.setmode(GPIO.BOARD)
</span></span><span class=line><span class=cl>        self.GPIO.setup(self.pin_e, GPIO.OUT)
</span></span><span class=line><span class=cl>        self.GPIO.setup(self.pin_rs, GPIO.OUT)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        for pin in self.pins_db:
</span></span><span class=line><span class=cl>            self.GPIO.setup(pin, GPIO.OUT)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	self.write4bits(0x33) # initialization
</span></span><span class=line><span class=cl>	self.write4bits(0x32) # initialization
</span></span><span class=line><span class=cl>	self.write4bits(0x28) # 2 line 5x7 matrix
</span></span><span class=line><span class=cl>	self.write4bits(0x0C) # turn cursor off 0x0E to enable cursor
</span></span><span class=line><span class=cl>	self.write4bits(0x06) # shift cursor right
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	self.displaycontrol = self.LCD_DISPLAYON | self.LCD_CURSOROFF | self.LCD_BLINKOFF
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	self.displayfunction = self.LCD_4BITMODE | self.LCD_1LINE | self.LCD_5x8DOTS
</span></span><span class=line><span class=cl>	self.displayfunction |= self.LCD_2LINE
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	&#34;&#34;&#34; Initialize to default text direction (for romance languages) &#34;&#34;&#34;
</span></span><span class=line><span class=cl>	self.displaymode =  self.LCD_ENTRYLEFT | self.LCD_ENTRYSHIFTDECREMENT
</span></span><span class=line><span class=cl>	self.write4bits(self.LCD_ENTRYMODESET | self.displaymode) #  set the entry mode
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        self.clear()
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    def begin(self, cols, lines):
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	if (lines &gt; 1):
</span></span><span class=line><span class=cl>		self.numlines = lines
</span></span><span class=line><span class=cl>    		self.displayfunction |= self.LCD_2LINE
</span></span><span class=line><span class=cl>		self.currline = 0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    def home(self):
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	self.write4bits(self.LCD_RETURNHOME) # set cursor position to zero
</span></span><span class=line><span class=cl>	self.delayMicroseconds(3000) # this command takes a long time!
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    def clear(self):
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	self.write4bits(self.LCD_CLEARDISPLAY) # command to clear display
</span></span><span class=line><span class=cl>	self.delayMicroseconds(3000)	# 3000 microsecond sleep, clearing the display takes a long time
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    def setCursor(self, col, row):
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	self.row_offsets = [ 0x00, 0x40, 0x14, 0x54 ]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	if ( row &gt; self.numlines ): 
</span></span><span class=line><span class=cl>		row = self.numlines - 1 # we count rows starting w/0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	self.write4bits(self.LCD_SETDDRAMADDR | (col + self.row_offsets[row]))
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    def noDisplay(self): 
</span></span><span class=line><span class=cl>	&#34;&#34;&#34; Turn the display off (quickly) &#34;&#34;&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	self.displaycontrol &amp;= ~self.LCD_DISPLAYON
</span></span><span class=line><span class=cl>	self.write4bits(self.LCD_DISPLAYCONTROL | self.displaycontrol)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    def display(self):
</span></span><span class=line><span class=cl>	&#34;&#34;&#34; Turn the display on (quickly) &#34;&#34;&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	self.displaycontrol |= self.LCD_DISPLAYON
</span></span><span class=line><span class=cl>	self.write4bits(self.LCD_DISPLAYCONTROL | self.displaycontrol)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    def noCursor(self):
</span></span><span class=line><span class=cl>	&#34;&#34;&#34; Turns the underline cursor on/off &#34;&#34;&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	self.displaycontrol &amp;= ~self.LCD_CURSORON
</span></span><span class=line><span class=cl>	self.write4bits(self.LCD_DISPLAYCONTROL | self.displaycontrol)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    def cursor(self):
</span></span><span class=line><span class=cl>	&#34;&#34;&#34; Cursor On &#34;&#34;&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	self.displaycontrol |= self.LCD_CURSORON
</span></span><span class=line><span class=cl>	self.write4bits(self.LCD_DISPLAYCONTROL | self.displaycontrol)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    def noBlink(self):
</span></span><span class=line><span class=cl>	&#34;&#34;&#34; Turn on and off the blinking cursor &#34;&#34;&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	self.displaycontrol &amp;= ~self.LCD_BLINKON
</span></span><span class=line><span class=cl>	self.write4bits(self.LCD_DISPLAYCONTROL | self.displaycontrol)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    def noBlink(self):
</span></span><span class=line><span class=cl>	&#34;&#34;&#34; Turn on and off the blinking cursor &#34;&#34;&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	self.displaycontrol &amp;= ~self.LCD_BLINKON
</span></span><span class=line><span class=cl>	self.write4bits(self.LCD_DISPLAYCONTROL | self.displaycontrol)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    def DisplayLeft(self):
</span></span><span class=line><span class=cl>	&#34;&#34;&#34; These commands scroll the display without changing the RAM &#34;&#34;&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	self.write4bits(self.LCD_CURSORSHIFT | self.LCD_DISPLAYMOVE | self.LCD_MOVELEFT)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    def scrollDisplayRight(self):
</span></span><span class=line><span class=cl>	&#34;&#34;&#34; These commands scroll the display without changing the RAM &#34;&#34;&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	self.write4bits(self.LCD_CURSORSHIFT | self.LCD_DISPLAYMOVE | self.LCD_MOVERIGHT);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    def leftToRight(self):
</span></span><span class=line><span class=cl>	&#34;&#34;&#34; This is for text that flows Left to Right &#34;&#34;&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	self.displaymode |= self.LCD_ENTRYLEFT
</span></span><span class=line><span class=cl>	self.write4bits(self.LCD_ENTRYMODESET | self.displaymode);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    def rightToLeft(self):
</span></span><span class=line><span class=cl>	&#34;&#34;&#34; This is for text that flows Right to Left &#34;&#34;&#34;
</span></span><span class=line><span class=cl>	self.displaymode &amp;= ~self.LCD_ENTRYLEFT
</span></span><span class=line><span class=cl>	self.write4bits(self.LCD_ENTRYMODESET | self.displaymode)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    def autoscroll(self):
</span></span><span class=line><span class=cl>	&#34;&#34;&#34; This will &#39;right justify&#39; text from the cursor &#34;&#34;&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	self.displaymode |= self.LCD_ENTRYSHIFTINCREMENT
</span></span><span class=line><span class=cl>	self.write4bits(self.LCD_ENTRYMODESET | self.displaymode)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    def noAutoscroll(self): 
</span></span><span class=line><span class=cl>	&#34;&#34;&#34; This will &#39;left justify&#39; text from the cursor &#34;&#34;&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	self.displaymode &amp;= ~self.LCD_ENTRYSHIFTINCREMENT
</span></span><span class=line><span class=cl>	self.write4bits(self.LCD_ENTRYMODESET | self.displaymode)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    def write4bits(self, bits, char_mode=False):
</span></span><span class=line><span class=cl>        &#34;&#34;&#34; Send command to LCD &#34;&#34;&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	self.delayMicroseconds(1000) # 1000 microsecond sleep
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        bits=bin(bits)[2:].zfill(8)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        self.GPIO.output(self.pin_rs, char_mode)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        for pin in self.pins_db:
</span></span><span class=line><span class=cl>            self.GPIO.output(pin, False)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        for i in range(4):
</span></span><span class=line><span class=cl>            if bits[i] == &#34;1&#34;:
</span></span><span class=line><span class=cl>                self.GPIO.output(self.pins_db[::-1][i], True)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	self.pulseEnable()
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        for pin in self.pins_db:
</span></span><span class=line><span class=cl>            self.GPIO.output(pin, False)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        for i in range(4,8):
</span></span><span class=line><span class=cl>            if bits[i] == &#34;1&#34;:
</span></span><span class=line><span class=cl>                self.GPIO.output(self.pins_db[::-1][i-4], True)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	self.pulseEnable()
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    def delayMicroseconds(self, microseconds):
</span></span><span class=line><span class=cl>	seconds = microseconds / float(1000000)	# divide microseconds by 1 million for seconds
</span></span><span class=line><span class=cl>	sleep(seconds)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    def pulseEnable(self):
</span></span><span class=line><span class=cl>	self.GPIO.output(self.pin_e, False)
</span></span><span class=line><span class=cl>	self.delayMicroseconds(1)		# 1 microsecond pause - enable pulse must be &gt; 450ns 
</span></span><span class=line><span class=cl>	self.GPIO.output(self.pin_e, True)
</span></span><span class=line><span class=cl>	self.delayMicroseconds(1)		# 1 microsecond pause - enable pulse must be &gt; 450ns 
</span></span><span class=line><span class=cl>	self.GPIO.output(self.pin_e, False)
</span></span><span class=line><span class=cl>	self.delayMicroseconds(1)		# commands need &gt; 37us to settle
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    def message(self, text):
</span></span><span class=line><span class=cl>        &#34;&#34;&#34; Send string to LCD. Newline wraps to second line&#34;&#34;&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        for char in text:
</span></span><span class=line><span class=cl>            if char == &#39;\n&#39;:
</span></span><span class=line><span class=cl>                self.write4bits(0xC0) # next line
</span></span><span class=line><span class=cl>            else:
</span></span><span class=line><span class=cl>                self.write4bits(ord(char),True)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>if __name__ == &#39;__main__&#39;:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    lcd = Adafruit_CharLCD()
</span></span><span class=line><span class=cl>    lcd.noBlink()
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    while True:
</span></span><span class=line><span class=cl>        sleep(1)
</span></span><span class=line><span class=cl>        lcd.clear()        
</span></span><span class=line><span class=cl>        lcd.message(datetime.now().strftime(&#39;  %I : %M : %S \n%a %b %d %Y&#39;))
</span></span><span class=line><span class=cl>        
</span></span></code></pre></div><h1 id=完成后的效果>完成后的效果</h1><img src=http://ww3.sinaimg.cn/mw690/6bc40342jw1e2xngyc634j.jpg><h1 id=参考链接>参考链接</h1><ol><li><a href=http://learn.adafruit.com/drive-a-16x2-lcd-directly-with-a-raspberry-pi/wiring>http://learn.adafruit.com/drive-a-16x2-lcd-directly-with-a-raspberry-pi/wiring</a></li><li><a href=http://www.freemindworld.com/blog/tag/>http://www.freemindworld.com/blog/tag/</a>树莓派</li></ol></div><div class=blog-tags><a href=https://blog.hugozhu.site/tags/raspberry-pi/>Raspberry Pi</a>&nbsp;</div></article><article class=post-preview><a href=https://blog.hugozhu.site/post/2013/19-raspberry-pi-gpio-port-naming/><h2 class=post-title>Raspberry Pi GPIO的编号规范</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on March 22, 2013
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;2&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;281&nbsp;words</span></p><div class=post-entry><p>树莓派和普通电脑不一样的地方在于它还带了17个可编程的<a href=http://en.wikipedia.org/wiki/General_Purpose_Input/Output>GPIO</a>（General Purpose Input/Output），可以用来驱动各种外设（如传感器，步进电机等）。但GPIO的编号方法有些混乱，不同的API（如wiringPi，RPi.GPIO等）对GPIO的端口号编号并不一样，下面则用图表标明了对应的叫法，这样在看程序例子的时候可以确定物理是哪个接口。</p><h1 id=gpio库>GPIO库</h1><ol><li><a href=https://github.com/WiringPi/WiringPi>wiringPi</a> C，有Perl, PHP, Ruby, Node.JS和**<a href=http://github.com/hugozhu/rpi>Golang</a>**的扩展，支持wiringPi Pin和BCM GPIO两种编号</li><li><a href=https://pypi.python.org/pypi/RPi.GPIO>RPi.GPIO</a> Python，支持Board Pin和BCM GPIO两种编号</li><li><a href=http://code.google.com/p/webiopi/>Webiopi</a>，Python, 使用BCM GPIO编号</li><li><a href=http://github.com/hugozhu/rpi>WiringPi-Go</a>, Go语言，支持以上三种编号</li></ol><h1 id=编号规范>编号规范</h1><ol><li>第一列是wiringPi API中的缺省编号，<code>wiringPiSetup()</code>采用这列编号</li><li>第二列（Name）往往是转接板的编号</li><li>第三列是树莓派板子上的自然编号（左边引脚为1-15，右边引脚为2-26），<code>RPi.GPIO.setmode(GPIO.BOARD)</code>采用这列编号</li><li>树莓派主芯片提供商Broadcom的编号方法，相当于调用了<code>WiringPiSetupGpio()</code>或<code>RPi.GPIO.setmode(GPIO.BCM)</code>采用这列编号</li></ol><table><thead><tr><th>wiringPi Pin</th><th>Name</th><th>Board Pin</th><th>BCM GPIO</th></tr></thead><tbody><tr><td>0</td><td>GPIO 0</td><td>11</td><td>17</td></tr><tr><td>1</td><td>GPIO 1</td><td>12</td><td>18</td></tr><tr><td>2</td><td>GPIO 2</td><td>13</td><td>21</td></tr><tr><td>3</td><td>GPIO 3</td><td>15</td><td>22</td></tr><tr><td>4</td><td>GPIO 4</td><td>16</td><td>23</td></tr><tr><td>5</td><td>GPIO 5</td><td>18</td><td>24</td></tr><tr><td>6</td><td>GPIO 6</td><td>22</td><td>25</td></tr><tr><td>7</td><td>GPIO 7</td><td>7</td><td>4</td></tr><tr><td>8</td><td>SDA</td><td>3</td><td>0</td></tr><tr><td>9</td><td>SCL</td><td>5</td><td>1</td></tr><tr><td>10</td><td>CE0</td><td>24</td><td>8</td></tr><tr><td>11</td><td>CE1</td><td>26</td><td>7</td></tr><tr><td>12</td><td>MOSI</td><td>19</td><td>10</td></tr><tr><td>13</td><td>MISO</td><td>21</td><td>9</td></tr><tr><td>14</td><td>SCLK</td><td>23</td><td>11</td></tr><tr><td>15</td><td>TXD</td><td>8</td><td>14</td></tr><tr><td>16</td><td>RXD</td><td>10</td><td>15</td></tr></tbody></table><p>Rev.2 新增的引脚：</p><a href=https://blog.hugozhu.site/post/2013/19-raspberry-pi-gpio-port-naming/ class=post-read-more>[Read More]</a></div><div class=blog-tags><a href=https://blog.hugozhu.site/tags/raspberry-pi/>Raspberry Pi</a>&nbsp;</div></article></div><ul class="pager main-pager"><li class=previous><a href=https://blog.hugozhu.site/page/6/>&larr; Newer Posts</a></li><li class=next><a href=https://blog.hugozhu.site/page/8/>Older Posts &rarr;</a></li></ul></div></div></div><div class=page-meta></div><footer><div class=container><div class=row><div class=disclaimer><b>Disclaimer:</b> The opinions expressed herein are my own personal opinions and do not represent my company’s view in any way.</div></div><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=/index.xml title=RSS><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted">&nbsp;&bull;&nbsp;&copy;
2025
&nbsp;&bull;&nbsp;
<a href=https://blog.hugozhu.site/>All about Raspberry Pi</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.142.0</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js integrity=sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script><script src=https://code.jquery.com/jquery-3.7.0.slim.min.js integrity=sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js integrity=sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd crossorigin=anonymous></script><script src=https://blog.hugozhu.site/js/main.js></script><script src=https://blog.hugozhu.site/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0")})</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://blog.hugozhu.site/js/load-photoswipe.js></script><script>(function(){var t,n="617d351a633194d48",e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://cse.google.com/cse.js?cx="+n,t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script><script type=text/javascript>$(function(){$("#show-comments").on("click",function(){var e="hugozhu";(function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="//"+e+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(t)})(),$(this).hide()})})</script><script id=dsq-count-scr src=//hugozhu.disqus.com/count.js async></script></body></html>