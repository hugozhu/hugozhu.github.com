<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Hugo Zhu's Blog</title>
<meta name=description content="
StreamPi - StreamDeck with Raspberry Pi
"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"All about Raspberry Pi","url":"https:\/\/blog.hugozhu.site\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/blog.hugozhu.site\/"}</script><meta property="og:title" content="All about Raspberry Pi"><meta property="og:description" content="
StreamPi - StreamDeck with Raspberry Pi
"><meta property="og:image" content="https://blog.hugozhu.site/img/pi.png"><meta property="og:url" content="https://blog.hugozhu.site/"><meta property="og:type" content="website"><meta property="og:site_name" content="All about Raspberry Pi"><meta name=twitter:title content="All about Raspberry Pi"><meta name=twitter:description content="
StreamPi - StreamDeck with Raspberry Pi
"><meta name=twitter:image content="https://blog.hugozhu.site/img/pi.png"><meta name=twitter:card content="summary_large_image"><link href=https://blog.hugozhu.site/img/pi.ico rel=icon type=image/x-icon><meta name=generator content="Hugo 0.142.0"><link rel=alternate href=https://blog.hugozhu.site/index.xml type=application/rss+xml title="All about Raspberry Pi"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css integrity=sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v6.6.0/css/all.css integrity=sha384-h/hnnw1Bi4nbpD6kE7nYfCXzovi622sY5WBxww8ARKwpdLj5kUWjRuyiXaD1U2JT crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css integrity=sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu crossorigin=anonymous><link rel=stylesheet href=https://blog.hugozhu.site/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://blog.hugozhu.site/css/highlight.min.css><link rel=stylesheet href=https://blog.hugozhu.site/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><script async src="https://www.googletagmanager.com/gtag/js?id=GTM-W88HDMN"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","GTM-W88HDMN")}</script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=https://blog.hugozhu.site/>All about Raspberry Pi</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Blog href=/>Blog</a></li><li class=navlinks-container><a class=navlinks-parent role=button tabindex=0>Tools</a><div class=navlinks-children><a href=https://nddapp.com/json-encoder.html>HTML Tools</a>
<a href=https://www.birme.net/>Imaeg Resizing</a>
<a href=https://jwt.io/>JWT Token Tool</a></div></li><li><a title=About href=/page/about/>About</a></li><li><a title=Tags href=/tags>Tags</a></li><li><a href=#modalSearch data-toggle=modal data-target=#modalSearch style=outline:none><span class="hidden-sm hidden-md hidden-lg">Search</span> <span id=searchGlyph class="glyphicon glyphicon-search"></span></a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title="All about Raspberry Pi" href=https://blog.hugozhu.site/><img class=avatar-img src=https://blog.hugozhu.site/img/pi.png alt="All about Raspberry Pi"></a></div></div></div></nav><div id=modalSearch class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><button type=button class=close data-dismiss=modal>&#215;</button><h4 class=modal-title>Search All about Raspberry Pi</h4></div><div class=modal-body><gcse:search></gcse:search></div><div class=modal-footer><button type=button class="btn btn-default" data-dismiss=modal>Close</button></div></div></div></div><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=page-heading><h1>Hugo Zhu's Blog</h1><hr class=small></div></div></div></div></div></header><div role=main class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=well><div align=center><a href=/post/2025/81-streamdeck-streamdock-with-raspberry-pi/><img src=https://blog.hugozhu.site/img/streampi_demo.jpg></a>
<a href=/post/2025/81-streamdeck-streamdock-with-raspberry-pi/>StreamPi - StreamDeck with Raspberry Pi</a></div></div><div class=posts-list><article class=post-preview><a href=https://blog.hugozhu.site/post/2013/34-use-74hc595-8-bit-shift-register-with-raspberry-pi/><h2 class=post-title>使用8位移位寄存器74HC595扩展树莓派的IO端口</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on May 13, 2013
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;2&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;305&nbsp;words</span></p><div class=post-entry><p>树莓派的GPIO接口数目有限，驱动一个步进电机需要占用4个， 一个Nokia 5110液晶也要占4个， 传感器输入至少需要一个，多玩几个外设后接口就不够用了。如果接口可以复用就可以让树莓派驱动更多的外设了，本文讨论如何使用74HC595集成电路芯片来扩展树莓派的I/O接口。</p><h1 id=芯片介绍>芯片介绍</h1><p>SN74HC595N是德州仪器公司生产的集成电路芯片，是一个8位串行输入变串行输出或并行输出移位寄存器，具有高阻关断，高电平和低电平三态输出。在IO扩充上，可以最多串联15片，也就是高达120个IO扩充。</p><img src=https://www.evernote.com/shard/s26/sh/b90034cc-cdf8-426d-a79d-16bbbcbb49b2/0ba3371f3039afa71a17bad845eede7a/deep/0/Screenshot%205/12/13%2010:42%20PM.png><p>（注意到芯片上的小凹槽了吗，拿芯片的时候以这个为参考物就不会搞反了）</p><p>接口的常用命名方式有以下两种：</p><table><thead><tr><th>接口代号(编号)</th><th>说明</th><th>接口代号(编号)</th><th>说明</th></tr></thead><tbody><tr><td>Q7&rsquo;(9)</td><td>serial data output</td><td>QH&rsquo; (9)</td><td>serial data output</td></tr><tr><td>MR (10)</td><td>Master Reset (Active Low)</td><td>SRCLR (10)</td><td>Shift register CLeaR</td></tr><tr><td>SH_CP (11)</td><td>shift register clock input</td><td>SRCLK (11)</td><td>Shift Register CLocK input</td></tr><tr><td>ST_CP (12)</td><td>storage register clock input</td><td>RCLK (12)</td><td>storage Register CLocK input</td></tr><tr><td>OE (13)</td><td>output enable input (Active Low)</td><td>OE (13)</td><td>Output Enable</td></tr><tr><td>DS (14)</td><td>serial data input</td><td>SER (14)</td><td>SERial data input</td></tr><tr><td>Qx (15，1-7)</td><td>data output</td><td>Qx (15，1-7)</td><td>data output</td></tr></tbody></table><h1 id=控制流程>控制流程</h1><p>如果要在8个引脚输出01010101</p><a href=https://blog.hugozhu.site/post/2013/34-use-74hc595-8-bit-shift-register-with-raspberry-pi/ class=post-read-more>[Read More]</a></div><div class=blog-tags><a href=https://blog.hugozhu.site/tags/raspberry-pi/>Raspberry Pi</a>&nbsp;</div></article><article class=post-preview><a href=https://blog.hugozhu.site/post/2013/33-use-google-app-engine-failover-your-blog-between-raspberrypi-and-github/><h2 class=post-title>树莓派网站容灾：利用DNSPod，Google App Engine和Github</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on April 22, 2013
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;2&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;286&nbsp;words</span></p><div class=post-entry><h1 id=背景介绍>背景介绍</h1><p><a href=http://hugozhu.myalert.info/2013/02/27/%E5%9C%A8Pi%E5%92%8CGithub%E4%B8%8A%E6%90%AD%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.html>把网站托管在树莓派上</a>后如果家里停电或是宽带故障，会造成网站中断。本文提供一个免费的解决方案（前提是你需要有自己的一个域名，并由DNSPod解析）</p><h1 id=dnspod>DNSPod</h1><p>首先需要在DNSPod里设置好需要failover的域名CNAME：比如<code>hugozhu.myalert.info</code></p><img src=https://www.evernote.com/shard/s26/sh/95d90628-5c74-4773-aaff-c2110e1863a6/6b592609ef02c42e46664d1fa1493e1c/deep/0/Screenshot%204/22/13%204:57%20PM.png width=528><p>其中<code>默认</code>指向<code>pi.myalert.info</code>, 这是一个域名的A Record，会由运行在树莓派上的<a href=http://hugozhu.myalert.info/2013/02/26/dynamic-dns-script.html>脚本</a>来更新动态IP，<code>国外</code>则指向github。当停电时我们需要自动把｀默认｀这条纪录修改成github。</p><p>使用下面命令获得相应CNAME的domain_id：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>curl -k https://dnsapi.cn/Domain.List -d &#34;login_email=xxx&amp;login_password=xxx&#34; 
</span></span></code></pre></div><p>使用下面命令获得相应CNAME的record_id：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>curl -k https://dnsapi.cn/Record.List -d &#34;login_email=xxx&amp;login_password=xxx&amp;domain_id=xxx&#34;
</span></span></code></pre></div><h1 id=google-app-engine>Google App Engine</h1><h2 id=切换dns脚本>切换DNS脚本</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>package</span> <span class=n>dnspod</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;io/ioutil&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;net/url&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;strings&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=n>login_email</span>    <span class=o>=</span> <span class=s2>&#34;&lt;your_login_email&gt;&#34;</span>
</span></span><span class=line><span class=cl>	<span class=n>login_password</span> <span class=o>=</span> <span class=s2>&#34;&lt;your_login_password&gt;&#34;</span>
</span></span><span class=line><span class=cl>	<span class=n>format</span>         <span class=o>=</span> <span class=s2>&#34;json&#34;</span>
</span></span><span class=line><span class=cl>	<span class=n>domain_id</span>      <span class=o>=</span> <span class=s2>&#34;&lt;domain_id&gt;&#34;</span>
</span></span><span class=line><span class=cl>	<span class=n>record_id</span>      <span class=o>=</span> <span class=s2>&#34;&lt;record_id&gt;&#34;</span>
</span></span><span class=line><span class=cl>	<span class=n>sub_domain</span>     <span class=o>=</span> <span class=s2>&#34;&lt;your_subdomain&gt;&#34;</span>
</span></span><span class=line><span class=cl>	<span class=n>record_type</span>    <span class=o>=</span> <span class=s2>&#34;CNAME&#34;</span>
</span></span><span class=line><span class=cl>	<span class=n>record_line</span>    <span class=o>=</span> <span class=s2>&#34;默认&#34;</span>
</span></span><span class=line><span class=cl>	<span class=n>ttl</span>            <span class=o>=</span> <span class=s2>&#34;600&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>Update</span><span class=p>(</span><span class=n>client</span> <span class=o>*</span><span class=n>http</span><span class=o>.</span><span class=n>Client</span><span class=p>,</span> <span class=n>cname</span> <span class=n>string</span><span class=p>)</span> <span class=n>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>body</span> <span class=p>:</span><span class=o>=</span> <span class=n>url</span><span class=o>.</span><span class=n>Values</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=s2>&#34;login_email&#34;</span><span class=p>:</span>    <span class=p>{</span><span class=n>login_email</span><span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=s2>&#34;login_password&#34;</span><span class=p>:</span> <span class=p>{</span><span class=n>login_password</span><span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=s2>&#34;format&#34;</span><span class=p>:</span>         <span class=p>{</span><span class=n>format</span><span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=s2>&#34;domain_id&#34;</span><span class=p>:</span>      <span class=p>{</span><span class=n>domain_id</span><span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=s2>&#34;record_id&#34;</span><span class=p>:</span>      <span class=p>{</span><span class=n>record_id</span><span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=s2>&#34;sub_domain&#34;</span><span class=p>:</span>     <span class=p>{</span><span class=n>sub_domain</span><span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=s2>&#34;record_type&#34;</span><span class=p>:</span>    <span class=p>{</span><span class=n>record_type</span><span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=s2>&#34;record_line&#34;</span><span class=p>:</span>    <span class=p>{</span><span class=n>record_line</span><span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=s2>&#34;value&#34;</span><span class=p>:</span>          <span class=p>{</span><span class=n>cname</span><span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=s2>&#34;ttl&#34;</span><span class=p>:</span>            <span class=p>{</span><span class=n>ttl</span><span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>req</span><span class=p>,</span> <span class=n>err</span> <span class=p>:</span><span class=o>=</span> <span class=n>http</span><span class=o>.</span><span class=n>NewRequest</span><span class=p>(</span><span class=s2>&#34;POST&#34;</span><span class=p>,</span> <span class=s2>&#34;https://dnsapi.cn/Record.Modify&#34;</span><span class=p>,</span> <span class=n>strings</span><span class=o>.</span><span class=n>NewReader</span><span class=p>(</span><span class=n>body</span><span class=o>.</span><span class=n>Encode</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>	<span class=n>req</span><span class=o>.</span><span class=n>Header</span><span class=o>.</span><span class=n>Set</span><span class=p>(</span><span class=s2>&#34;Accept&#34;</span><span class=p>,</span> <span class=s2>&#34;text/json&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>req</span><span class=o>.</span><span class=n>Header</span><span class=o>.</span><span class=n>Set</span><span class=p>(</span><span class=s2>&#34;Content-type&#34;</span><span class=p>,</span> <span class=s2>&#34;application/x-www-form-urlencoded&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>resp</span><span class=p>,</span> <span class=n>err</span> <span class=p>:</span><span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>Do</span><span class=p>(</span><span class=n>req</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>err</span> <span class=o>!=</span> <span class=n>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>err</span><span class=o>.</span><span class=n>Error</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>defer</span> <span class=n>resp</span><span class=o>.</span><span class=n>Body</span><span class=o>.</span><span class=n>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=n>bytes</span><span class=p>,</span> <span class=n>_</span> <span class=p>:</span><span class=o>=</span> <span class=n>ioutil</span><span class=o>.</span><span class=n>ReadAll</span><span class=p>(</span><span class=n>resp</span><span class=o>.</span><span class=n>Body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>string</span><span class=p>(</span><span class=n>bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=检测接口>检测接口</h2><p>部署一个web应用到Google App Engine上，该应用接受树莓派上的一个URL（注意这里不应该用需failver的域名），并请求该域名以检查网站是否正常。这里也可以使用监控宝来监控，但只有付费专业版才支持出错后回调URL。</p><a href=https://blog.hugozhu.site/post/2013/33-use-google-app-engine-failover-your-blog-between-raspberrypi-and-github/ class=post-read-more>[Read More]</a></div><div class=blog-tags><a href=https://blog.hugozhu.site/tags/golang/>Golang</a>&nbsp;
<a href=https://blog.hugozhu.site/tags/google-app-engine/>Google App Engine</a>&nbsp;</div></article><article class=post-preview><a href=https://blog.hugozhu.site/post/2013/32-use-goroutine-and-channel-to-implement-interaction-with-timeout/><h2 class=post-title>使用Goroutine和Channel实现按键超时交互</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on April 21, 2013
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;1&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;201&nbsp;words</span></p><div class=post-entry><h1 id=背景介绍>背景介绍</h1><p>前面的文章（见<a href=#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5>参考链接</a>）已经介绍了如何使用按键作为树莓派的输入。在实际应用中可以通过按下按键循环显示预先设定的脚本输出到显示屏幕，需求如下：</p><ol><li>如果按键不被触动，则定时5秒执行脚本获取最新内容显示；</li><li>因为不同的脚本获取内容速度会不一样，我们要求如果超过500ms脚本还未返回，需要在屏幕上显示“loading…”这样的过渡内容，如果脚本在500ms内返回，则不显示。</li></ol><p>使用Goroutine和Channel可以很方便的实现这个需求。</p><h1 id=代码>代码</h1><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>var</span> <span class=n>screen_chan</span> <span class=n>chan</span> <span class=ne>int</span>
</span></span><span class=line><span class=cl><span class=k>var</span> <span class=n>switch_chan</span> <span class=o>=</span> <span class=n>make</span><span class=p>(</span><span class=n>chan</span> <span class=ne>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>//</span><span class=n>a</span> <span class=n>goroutine</span><span class=err>：</span> <span class=err>检查按键是否被按</span>
</span></span><span class=line><span class=cl>	<span class=n>go</span> <span class=k>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>last_time</span> <span class=p>:</span><span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>Now</span><span class=p>()</span><span class=o>.</span><span class=n>UnixNano</span><span class=p>()</span> <span class=o>/</span> <span class=mi>1000000</span>
</span></span><span class=line><span class=cl>		<span class=n>btn_pushed</span> <span class=p>:</span><span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>		<span class=n>total_mode</span> <span class=p>:</span><span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=n>msg</span> <span class=p>:</span><span class=o>=</span> <span class=nb>range</span> <span class=n>WiringPiISR</span><span class=p>(</span><span class=n>PIN_GPIO_6</span><span class=p>,</span> <span class=n>INT_EDGE_FALLING</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=n>msg</span> <span class=o>&gt;</span> <span class=o>-</span><span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>n</span> <span class=p>:</span><span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>Now</span><span class=p>()</span><span class=o>.</span><span class=n>UnixNano</span><span class=p>()</span> <span class=o>/</span> <span class=mi>1000000</span>
</span></span><span class=line><span class=cl>				<span class=n>delta</span> <span class=p>:</span><span class=o>=</span> <span class=n>n</span> <span class=o>-</span> <span class=n>last_time</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=n>delta</span> <span class=o>&gt;</span> <span class=mi>300</span> <span class=p>{</span> <span class=o>//</span><span class=err>如果两次按键变化的间隔时间</span><span class=o>&lt;</span><span class=mi>300</span><span class=n>ms</span><span class=err>，是因为接触信号不稳定可以忽略掉</span>
</span></span><span class=line><span class=cl>					<span class=n>last_time</span> <span class=o>=</span> <span class=n>n</span>
</span></span><span class=line><span class=cl>					<span class=n>btn_pushed</span><span class=o>++</span>
</span></span><span class=line><span class=cl>					<span class=n>screen_chan</span> <span class=o>&lt;-</span> <span class=n>btn_pushed</span> <span class=o>%</span> <span class=n>total_mode</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>//</span><span class=n>a</span> <span class=n>goroutine</span><span class=err>：</span> <span class=err>根据管道消息刷新屏幕</span>
</span></span><span class=line><span class=cl>	<span class=n>go</span> <span class=n>loop_update_display</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>//</span><span class=err>选择确实的屏幕内容脚本编号</span>
</span></span><span class=line><span class=cl>	<span class=n>screen_chan</span> <span class=o>&lt;-</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>//</span><span class=n>a</span> <span class=n>goroutine</span><span class=p>:</span> <span class=err>定时</span><span class=mi>5</span><span class=n>s向管道发送更新屏幕内容的信号</span>
</span></span><span class=line><span class=cl>	<span class=n>ticker</span> <span class=p>:</span><span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>NewTicker</span><span class=p>(</span><span class=mi>5</span> <span class=o>*</span> <span class=n>time</span><span class=o>.</span><span class=n>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>go</span> <span class=k>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=o>&lt;-</span><span class=n>ticker</span><span class=o>.</span><span class=n>C</span>
</span></span><span class=line><span class=cl>			<span class=n>screen_chan</span> <span class=o>&lt;-</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=o>...</span>	
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>loop_update_display</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>current_screen</span> <span class=p>:</span><span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=n>msg</span> <span class=p>:</span><span class=o>=</span> <span class=nb>range</span> <span class=n>screen_chan</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>switch_screen</span> <span class=p>:</span><span class=o>=</span> <span class=bp>false</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>msg</span> <span class=o>&gt;=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		   <span class=o>//</span><span class=err>说明是按钮触发的消息，而不是定时器触发的</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=n>msg</span> <span class=o>!=</span> <span class=n>current_screen</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=o>//</span><span class=n>btn</span> <span class=n>pushed</span>
</span></span><span class=line><span class=cl>				<span class=n>current_screen</span> <span class=o>=</span> <span class=n>msg</span>
</span></span><span class=line><span class=cl>				<span class=n>switch_screen</span> <span class=o>=</span> <span class=bp>true</span>
</span></span><span class=line><span class=cl>				<span class=n>go</span> <span class=k>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>case</span> <span class=o>&lt;-</span><span class=n>time</span><span class=o>.</span><span class=n>After</span><span class=p>(</span><span class=mi>500</span> <span class=o>*</span> <span class=n>time</span><span class=o>.</span><span class=n>Millisecond</span><span class=p>):</span>
</span></span><span class=line><span class=cl>						<span class=n>display_loading</span><span class=p>()</span>
</span></span><span class=line><span class=cl>						<span class=o>&lt;-</span><span class=n>switch_chan</span>
</span></span><span class=line><span class=cl>					<span class=k>case</span> <span class=o>&lt;-</span><span class=n>switch_chan</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}()</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>switch</span> <span class=n>current_screen</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>display_screen0</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>display_screen1</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>display_screen2</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>switch_screen</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>switch_chan</span> <span class=o>&lt;-</span> <span class=bp>true</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>go</span> <span class=k>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>&lt;-</span><span class=n>time</span><span class=o>.</span><span class=n>After</span><span class=p>(</span><span class=mi>500</span> <span class=o>*</span> <span class=n>time</span><span class=o>.</span><span class=n>Millisecond</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=n>display_loading</span><span class=p>(</span><span class=n>current_screen</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=o>&lt;-</span><span class=n>switch_chan</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>&lt;-</span><span class=n>switch_chan</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}()</span>
</span></span></code></pre></div><p>超时控制的代码就是上面几行了。首先如果是按键触发，主goroutine会创建一个检查超时的goroutine，该goroutine执行<code>select</code>语句时会试图从两个管道里获取消息，先获取到消息的管道会继续执行相应分支的代码。</p><a href=https://blog.hugozhu.site/post/2013/32-use-goroutine-and-channel-to-implement-interaction-with-timeout/ class=post-read-more>[Read More]</a></div><div class=blog-tags><a href=https://blog.hugozhu.site/tags/golang/>Golang</a>&nbsp;</div></article><article class=post-preview><a href=https://blog.hugozhu.site/post/2013/31-golang-memory-model/><h2 class=post-title>Go语言内存模型</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on April 20, 2013
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;2&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;424&nbsp;words</span></p><div class=post-entry><h1 id=名词定义>名词定义</h1><p>执行体 - Go里的Goroutine或Java中的Thread</p><h1 id=背景介绍>背景介绍</h1><p>内存模型的目的是为了定义清楚变量的读写在不同执行体里的可见性。理解内存模型在并发编程中非常重要，因为代码的执行顺序和书写的逻辑顺序并不会完全一致，甚至在编译期间编译器也有可能重排代码以最优化CPU执行, 另外还因为有CPU缓存的存在，内存的数据不一定会及时更新，这样对内存中的同一个变量读和写也不一定和期望一样。</p><p>和<a href=http://ifeve.com/java-memory-model-1/>Java的内存模型规范</a>类似，Go语言也有一个内存模型，相对JMM来说，Go的内存模型比较简单，Go的并发模型是基于CSP（<a href=http://en.wikipedia.org/wiki/Communicating_sequential_processes>Communicating Sequential Process</a>）的，不同的Goroutine通过一种叫Channel的数据结构来通信；Java的并发模型则基于多线程和共享内存，有较多的概念（violatie, lock, final, construct, thread, atomic等）和场景，当然java.util.concurrent并发工具包大大简化了Java并发编程。</p><p>Go内存模型规范了在什么条件下一个Goroutine对某个变量的修改一定对其它Goroutine可见。</p><h1 id=happens-before>Happens Before</h1><p>在一个单独的Goroutine里，对变量的读写和代码的书写顺序一致。比如以下的代码:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>package</span> <span class=n>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;log&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>var</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span> <span class=ne>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>a</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=n>b</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>	<span class=n>c</span> <span class=o>=</span> <span class=n>a</span> <span class=o>+</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>	<span class=nb>log</span><span class=o>.</span><span class=n>Println</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>尽管在编译期和执行期，编译器和CPU都有可能重排代码，比如，先执行b=2，再执行a=1，但c=a+2是保证在a=1后执行的。这样最后的执行结果一定是<code>1 2 3</code>，不会是<code>1 2 2</code>。但下面的代码则可能会输出<code>0 0 0</code>，<code>1 2 2</code>, <code>0 2 3</code> (b=2比a=1先执行), <code>1 2 3</code>等各种可能。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>package</span> <span class=n>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;log&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>var</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span> <span class=ne>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>go</span> <span class=k>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>a</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>		<span class=n>b</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>	<span class=n>go</span> <span class=k>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>c</span> <span class=o>=</span> <span class=n>a</span> <span class=o>+</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>	<span class=nb>log</span><span class=o>.</span><span class=n>Println</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=happens-before-定义>Happens-before 定义</h2><p>Happens-before用来指明Go程序里的内存操作的局部顺序。如果一个内存操作事件e1 happens-before e2，则e2 happens-after e1也成立；如果e1不是happens-before e2,也不是happens-after e2，则e1和e2是并发的。</p><a href=https://blog.hugozhu.site/post/2013/31-golang-memory-model/ class=post-read-more>[Read More]</a></div><div class=blog-tags><a href=https://blog.hugozhu.site/tags/golang/>Golang</a>&nbsp;
<a href=https://blog.hugozhu.site/tags/concurrent-programming/>Concurrent Programming</a>&nbsp;</div></article><article class=post-preview><a href=https://blog.hugozhu.site/post/2013/30-raspberrypi-i2c-programming/><h2 class=post-title>树莓派I2C编程</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on April 18, 2013
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;1&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;7&nbsp;words</span></p><div class=post-entry><p>(！未完！)</p><p>除了<a href=http://hugozhu.myalert.info/2013/04/05/25-get-spi-working-on-raspberry-pi-spi.html>SPI</a>协议外，树莓派还支持<a href=http://zh.wikipedia.org/wiki/I%C2%B2C>I2C</a>。I2C是为了连接低速周边装置设计的，只需要用两根线（SDA和SCL，也就是树莓派的端口8和9-wiringPi编号）。</p><h1 id=i2c>I2C</h1><img src=http://upload.wikimedia.org/wikipedia/commons/thumb/3/3e/I2C.svg/350px-I2C.svg.png><p>上图是一个主控使用I2C驱动3个设备的示意图</p><h1 id=参考链接>参考链接</h1><ol><li><a href=http://zh.wikipedia.org/wiki/I>http://zh.wikipedia.org/wiki/I</a>²C</li><li><a href=https://projects.drogon.net/raspberry-pi/wiringpi/i2c-library/>https://projects.drogon.net/raspberry-pi/wiringpi/i2c-library/</a></li></ol></div><div class=blog-tags><a href=https://blog.hugozhu.site/tags/raspberry-pi/>Raspberry Pi</a>&nbsp;</div></article><article class=post-preview><a href=https://blog.hugozhu.site/post/2013/29-use-wiringpi-go-binding/><h2 class=post-title>使用Go语言在树莓派上编程</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on April 14, 2013
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;2&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;316&nbsp;words</span></p><div class=post-entry><p><a href=https://projects.drogon.net/raspberry-pi/wiringpi/>WiringPi</a>是树莓派上比较好的一个开发库，是用C语言写的。使用cgo，我们可以在Go语言里方便的调用WiringPI的函数，于是我包装了一个<a href=https://github.com/hugozhu/rpi>WiringPi-Go</a>，目前支持wiringPi的基本功能，硬件SPI协议驱动Nokia 5110屏幕，以及中断，未来还会增加PWM和I2C协议的支持。</p><p>下面是一个完整的使用例子，结合了之前的两个电路：<a href=http://hugozhu.myalert.info/2013/04/08/27-interrupts-with-gpio-pins.html>链接1</a>，<a href=http://hugozhu.myalert.info/2013/04/05/25-get-spi-working-on-raspberry-pi-spi.html>链接2</a></p><p>通过push button可以切换液晶屏显示不同脚本的输出内容。</p><p>lcd_switch.go</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>package</span> <span class=n>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span> <span class=s2>&#34;github.com/hugozhu/rpi&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;github.com/hugozhu/rpi/pcd8544&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;os/exec&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;time&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=n>DIN</span>        <span class=o>=</span> <span class=n>PIN_MOSI</span>
</span></span><span class=line><span class=cl>	<span class=n>SCLK</span>       <span class=o>=</span> <span class=n>PIN_SCLK</span>
</span></span><span class=line><span class=cl>	<span class=n>DC</span>         <span class=o>=</span> <span class=n>PIN_GPIO_2</span>
</span></span><span class=line><span class=cl>	<span class=n>RST</span>        <span class=o>=</span> <span class=n>PIN_GPIO_0</span>
</span></span><span class=line><span class=cl>	<span class=n>CS</span>         <span class=o>=</span> <span class=n>PIN_CE0</span>
</span></span><span class=line><span class=cl>	<span class=n>PUSHBUTTON</span> <span class=o>=</span> <span class=n>PIN_GPIO_6</span>
</span></span><span class=line><span class=cl>	<span class=n>CONTRAST</span>   <span class=o>=</span> <span class=mi>40</span> <span class=o>//</span><span class=n>may</span> <span class=n>need</span> <span class=n>tweak</span> <span class=k>for</span> <span class=n>each</span> <span class=n>Nokia</span> <span class=mi>5110</span> <span class=n>screen</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>var</span> <span class=n>screen_chan</span> <span class=n>chan</span> <span class=ne>int</span>
</span></span><span class=line><span class=cl><span class=k>var</span> <span class=n>TOTAL_MODES</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>WiringPiSetup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=n>pcd8544</span><span class=o>.</span><span class=n>LCDInit</span><span class=p>(</span><span class=n>SCLK</span><span class=p>,</span> <span class=n>DIN</span><span class=p>,</span> <span class=n>DC</span><span class=p>,</span> <span class=n>CS</span><span class=p>,</span> <span class=n>RST</span><span class=p>,</span> <span class=n>CONTRAST</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>screen_chan</span> <span class=o>=</span> <span class=n>make</span><span class=p>(</span><span class=n>chan</span> <span class=ne>int</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>//</span><span class=n>a</span> <span class=n>goroutine</span> <span class=n>to</span> <span class=n>check</span> <span class=n>button</span> <span class=n>push</span> <span class=n>event</span>
</span></span><span class=line><span class=cl>	<span class=n>go</span> <span class=k>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>last_time</span> <span class=p>:</span><span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>Now</span><span class=p>()</span><span class=o>.</span><span class=n>UnixNano</span><span class=p>()</span> <span class=o>/</span> <span class=mi>1000000</span>
</span></span><span class=line><span class=cl>		<span class=n>btn_pushed</span> <span class=p>:</span><span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=n>pin</span> <span class=p>:</span><span class=o>=</span> <span class=nb>range</span> <span class=n>WiringPiISR</span><span class=p>(</span><span class=n>PUSHBUTTON</span><span class=p>,</span> <span class=n>INT_EDGE_FALLING</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=n>pin</span> <span class=o>&gt;</span> <span class=o>-</span><span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>n</span> <span class=p>:</span><span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>Now</span><span class=p>()</span><span class=o>.</span><span class=n>UnixNano</span><span class=p>()</span> <span class=o>/</span> <span class=mi>1000000</span>
</span></span><span class=line><span class=cl>				<span class=n>delta</span> <span class=p>:</span><span class=o>=</span> <span class=n>n</span> <span class=o>-</span> <span class=n>last_time</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=n>delta</span> <span class=o>&gt;</span> <span class=mi>300</span> <span class=p>{</span> <span class=o>//</span><span class=n>software</span> <span class=n>debouncing</span>
</span></span><span class=line><span class=cl>					<span class=nb>log</span><span class=o>.</span><span class=n>Println</span><span class=p>(</span><span class=s2>&#34;btn pushed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=n>last_time</span> <span class=o>=</span> <span class=n>n</span>
</span></span><span class=line><span class=cl>					<span class=n>btn_pushed</span><span class=o>++</span>
</span></span><span class=line><span class=cl>					<span class=n>screen_chan</span> <span class=o>&lt;-</span> <span class=n>btn_pushed</span> <span class=o>%</span> <span class=n>TOTAL_MODES</span> <span class=o>//</span><span class=k>switch</span> <span class=n>the</span> <span class=n>screen</span> <span class=n>display</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>//</span><span class=n>a</span> <span class=n>groutine</span> <span class=n>to</span> <span class=n>update</span> <span class=n>display</span> <span class=n>every</span> <span class=mi>5</span> <span class=n>seconds</span>
</span></span><span class=line><span class=cl>	<span class=n>go</span> <span class=n>loop_update_display</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>//</span><span class=n>set</span> <span class=n>screen</span> <span class=mi>0</span> <span class=n>to</span> <span class=n>be</span> <span class=n>default</span> <span class=n>display</span>
</span></span><span class=line><span class=cl>	<span class=n>screen_chan</span> <span class=o>&lt;-</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>ticker</span> <span class=p>:</span><span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>NewTicker</span><span class=p>(</span><span class=mi>5</span> <span class=o>*</span> <span class=n>time</span><span class=o>.</span><span class=n>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=o>&lt;-</span><span class=n>ticker</span><span class=o>.</span><span class=n>C</span>
</span></span><span class=line><span class=cl>		<span class=n>screen_chan</span> <span class=o>&lt;-</span> <span class=o>-</span><span class=mi>1</span> <span class=o>//</span><span class=n>refresh</span> <span class=n>current</span> <span class=n>screen</span> <span class=n>every</span> <span class=mi>5</span> <span class=n>seconds</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>loop_update_display</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>current_screen</span> <span class=p>:</span><span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=n>screen</span> <span class=p>:</span><span class=o>=</span> <span class=nb>range</span> <span class=n>screen_chan</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>screen</span> <span class=o>&gt;=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=n>screen</span> <span class=o>!=</span> <span class=n>current_screen</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=o>//</span><span class=n>btn</span> <span class=n>pushed</span>
</span></span><span class=line><span class=cl>				<span class=n>current_screen</span> <span class=o>=</span> <span class=n>screen</span>
</span></span><span class=line><span class=cl>				<span class=n>display_loading</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>switch</span> <span class=n>current_screen</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>display_screen0</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>display_screen1</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>display_screen2</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>display_loading</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>pcd8544</span><span class=o>.</span><span class=n>LCDclear</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=n>pcd8544</span><span class=o>.</span><span class=n>LCDdrawstring</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=s2>&#34;Loading ...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>pcd8544</span><span class=o>.</span><span class=n>LCDdisplay</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>display_screen0</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>out</span><span class=p>,</span> <span class=n>err</span> <span class=p>:</span><span class=o>=</span> <span class=n>exec</span><span class=o>.</span><span class=n>Command</span><span class=p>(</span><span class=s2>&#34;/bin/screen_0.sh&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>CombinedOutput</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>err</span> <span class=o>!=</span> <span class=n>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>out</span> <span class=o>=</span> <span class=p>[]</span><span class=n>byte</span><span class=p>(</span><span class=n>err</span><span class=o>.</span><span class=n>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>pcd8544</span><span class=o>.</span><span class=n>LCDclear</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=n>pcd8544</span><span class=o>.</span><span class=n>LCDdrawstring</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>string</span><span class=p>(</span><span class=n>out</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=n>pcd8544</span><span class=o>.</span><span class=n>LCDdisplay</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>display_screen1</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>out</span><span class=p>,</span> <span class=n>err</span> <span class=p>:</span><span class=o>=</span> <span class=n>exec</span><span class=o>.</span><span class=n>Command</span><span class=p>(</span><span class=s2>&#34;/bin/screen_1.sh&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>CombinedOutput</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>err</span> <span class=o>!=</span> <span class=n>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>out</span> <span class=o>=</span> <span class=p>[]</span><span class=n>byte</span><span class=p>(</span><span class=n>err</span><span class=o>.</span><span class=n>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>pcd8544</span><span class=o>.</span><span class=n>LCDclear</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=n>pcd8544</span><span class=o>.</span><span class=n>LCDdrawstring</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>string</span><span class=p>(</span><span class=n>out</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=n>pcd8544</span><span class=o>.</span><span class=n>LCDdisplay</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>display_screen2</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>out</span><span class=p>,</span> <span class=n>err</span> <span class=p>:</span><span class=o>=</span> <span class=n>exec</span><span class=o>.</span><span class=n>Command</span><span class=p>(</span><span class=s2>&#34;/bin/screen_2.sh&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>CombinedOutput</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>err</span> <span class=o>!=</span> <span class=n>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>out</span> <span class=o>=</span> <span class=p>[]</span><span class=n>byte</span><span class=p>(</span><span class=n>err</span><span class=o>.</span><span class=n>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>pcd8544</span><span class=o>.</span><span class=n>LCDclear</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=n>pcd8544</span><span class=o>.</span><span class=n>LCDdrawstring</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>string</span><span class=p>(</span><span class=n>out</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=n>pcd8544</span><span class=o>.</span><span class=n>LCDdisplay</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>/bin/screen_2.sh</p><a href=https://blog.hugozhu.site/post/2013/29-use-wiringpi-go-binding/ class=post-read-more>[Read More]</a></div><div class=blog-tags><a href=https://blog.hugozhu.site/tags/raspberry-pi/>Raspberry Pi</a>&nbsp;</div></article><article class=post-preview><a href=https://blog.hugozhu.site/post/2013/28-use-tsar-to-monitor-raspberry-pi/><h2 class=post-title>使用tsar记录和监控树莓派CPU温度</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on April 13, 2013
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;3&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;509&nbsp;words</span></p><div class=post-entry><p>夏天到了，树莓派的CPU温度也开始节节攀升，虽然我们也可以用云服务<a href=https://cosm.com>cosm</a>来监控，但每5分钟采样一次精度不够高，每分钟采样一次则上传次数又太多了点。最好的方法还是使用<a href=http://github.com/alibaba/tsar>tsar</a>这样的工具本地高频（如每1分钟）采样，然后再定时将5分钟的均值上传到cosm绘图。</p><p>Tsar是淘宝的一个用来收集服务器系统和应用信息的采集报告工具，如收集服务器的系统信息（cpu，mem等），以及应用数据（nginx、swift等），收集到的数据存储在服务器磁盘上，可以随时查询历史信息，也可以将数据发送到nagios报警。Tsar能够比较方便的增加模块，只需要按照tsar的要求编写数据的采集函数和展现函数，就可以把自定义的模块加入到tsar中。</p><h1 id=更新><strong>更新</strong></h1><p>[2013-04-14] mod_rpi已经被合并到了主干代码：<a href=https://github.com/alibaba/tsar/blob/master/modules/mod_rpi.c>https://github.com/alibaba/tsar/blob/master/modules/mod_rpi.c</a> 只需要增加文件：<code>/etc/tsar/conf.d/rpi.conf</code>，内容为以下即可开始使用mod_rpi模块：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>mod_rpi on
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>####add it to tsar default output
</span></span><span class=line><span class=cl>output_stdio_mod mod_rpi
</span></span></code></pre></div><h1 id=mod_rpi模块开发方法>mod_rpi模块开发方法</h1><p>首先按照安装说明，见<a href=https://github.com/alibaba/tsar>https://github.com/alibaba/tsar</a>将tsar和tsardevel安装好。</p><p>首先运行下面的命令生成mod_rpi模块：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>hugo@raspberrypi2 ~/projects/tsardevel $ tsardevel rpi 
</span></span><span class=line><span class=cl>build:make
</span></span><span class=line><span class=cl>install:make install
</span></span><span class=line><span class=cl>uninstall:make uninstall
</span></span><span class=line><span class=cl>hugo@raspberrypi2 ~/projects/tsardevel $ ls rpi
</span></span><span class=line><span class=cl>Makefile  mod_rpi.c  mod_rpi.conf
</span></span></code></pre></div><p>然后修改mod_rpi.c，增加读取CPU温度的逻辑：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/*
</span></span><span class=line><span class=cl> * (C) 2010-2011 Alibaba Group Holding Limited
</span></span><span class=line><span class=cl> *
</span></span><span class=line><span class=cl> * Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
</span></span><span class=line><span class=cl> * you may not use this file except in compliance with the License.
</span></span><span class=line><span class=cl> * You may obtain a copy of the License at
</span></span><span class=line><span class=cl> *
</span></span><span class=line><span class=cl> *     http://www.apache.org/licenses/LICENSE-2.0
</span></span><span class=line><span class=cl> *
</span></span><span class=line><span class=cl> * Unless required by applicable law or agreed to in writing, software
</span></span><span class=line><span class=cl> * distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
</span></span><span class=line><span class=cl> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span></span><span class=line><span class=cl> * See the License for the specific language governing permissions and
</span></span><span class=line><span class=cl> * limitations under the License.
</span></span><span class=line><span class=cl> *
</span></span><span class=line><span class=cl> */
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>#include &#34;tsar.h&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/*
</span></span><span class=line><span class=cl> * Structure for rpi infomation.
</span></span><span class=line><span class=cl> */
</span></span><span class=line><span class=cl>struct stats_rpi {
</span></span><span class=line><span class=cl>	unsigned int cpu_temp;
</span></span><span class=line><span class=cl>};
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>#define STATS_TEST_SIZE (sizeof(struct stats_rpi))
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>static char *rpi_usage = &#34;    --rpi               Rapsberry Pi information (CPU temprature ...)&#34;;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>static void read_rpi_stats(struct module *mod, char *parameter)
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>	FILE *fp;
</span></span><span class=line><span class=cl>	char buf[64];
</span></span><span class=line><span class=cl>	memset(buf, 0, sizeof(buf));
</span></span><span class=line><span class=cl>	struct stats_rpi st_rpi;
</span></span><span class=line><span class=cl>	memset(&amp;st_rpi, 0, sizeof(struct stats_rpi));
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	if ((fp = fopen(&#34;/sys/class/thermal/thermal_zone0/temp&#34;, &#34;r&#34;)) == NULL) {
</span></span><span class=line><span class=cl>		return;
</span></span><span class=line><span class=cl>	}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	int cpu_temp;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	fscanf(fp, &#34;%d&#34;, &amp;cpu_temp);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	st_rpi.cpu_temp = cpu_temp;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	int pos = sprintf(buf, &#34;%u&#34;,
</span></span><span class=line><span class=cl>			/* the store order is not same as read procedure */
</span></span><span class=line><span class=cl>			st_rpi.cpu_temp);
</span></span><span class=line><span class=cl>	buf[pos] = &#39;\0&#39;;
</span></span><span class=line><span class=cl>	set_mod_record(mod, buf);
</span></span><span class=line><span class=cl>	fclose(fp);
</span></span><span class=line><span class=cl>	return;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>static struct mod_info rpi_info[] = {
</span></span><span class=line><span class=cl>	{&#34;  temp&#34;, SUMMARY_BIT,  0,  STATS_NULL}
</span></span><span class=line><span class=cl>};
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>static void set_rpi_record(struct module *mod, double st_array[],
</span></span><span class=line><span class=cl>		U_64 pre_array[], U_64 cur_array[], int inter)
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>	st_array[0] = cur_array[0]/1000.0;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>void mod_register(struct module *mod)
</span></span><span class=line><span class=cl>{	
</span></span><span class=line><span class=cl>	register_mod_fileds(mod, &#34;--rpi&#34;, rpi_usage, rpi_info, 1, read_rpi_stats, set_rpi_record);
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>最后<code>make && sudo make install</code>将mod_rpi自定义tsar模块安装好。</p><a href=https://blog.hugozhu.site/post/2013/28-use-tsar-to-monitor-raspberry-pi/ class=post-read-more>[Read More]</a></div><div class=blog-tags><a href=https://blog.hugozhu.site/tags/raspberry-pi/>Raspberry Pi</a>&nbsp;</div></article><article class=post-preview><a href=https://blog.hugozhu.site/post/2013/27-interrupts-with-gpio-pins/><h2 class=post-title>Raspberry Pi的GPIO中断编程</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on April 8, 2013
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;3&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;503&nbsp;words</span></p><div class=post-entry><h1 id=背景介绍>背景介绍</h1><p>树莓派的GPIO引脚不仅可以输出高低电平，也可以当做输入端口（可以想象成键盘输入），当GPIO接入的是高电平，GPIO的值可以认为是1，如果是低电平则是0。如下图所示，可以使用一个Push Button开关按键来控制GPIO 25（BCM Numbering）的高低电平以达到控制的目的。</p><img src="https://www.evernote.com/shard/s26/sh/bd720803-1b71-454d-98a2-cf0e907df688/649d6eb30376f8a378ef3e8a7cc3c552/deep/0/Screenshot%204/8/13%2011:25%20PM.jpg?noteKey=649d6eb30376f8a378ef3e8a7cc3c552&suffix=deep%2F0%2FScreenshot+4%2F8%2F13+11%3A25+PM.jpg&noteGuid=bd720803-1b71-454d-98a2-cf0e907df688"><p>GPIO 25和VCC（3.3V）之间通过R1（10K欧姆）和R2（1K欧姆）<a href=https://zh.wikipedia.org/zh/%E4%B8%8A%E6%8B%89%E7%94%B5%E9%98%BB>上拉电阻</a>相连，当按键未被按下时，GPIO 25上拉到VCC，程序可以读到1，当按键按下时，GPIO 25被下拉电阻R2拉到GND（0V），程序可以读到0。如果不加R1，而GPIO 25不小心被设置成输出低电平时，将直接和VCC相连而造成短路，这样可能会烧掉这个引脚，所以加上限流电阻R1后，即使发生这样的情况，也不会出现短路情况。</p><h1 id=应用>应用</h1><p>如果我们需要根据GPIO 25的值来控制树莓派，比如按下按钮时希望点亮某个LED或在液晶上显示当前时间，就需要通过程序来获取状态的变化。</p><p>一种常见的做法是在循环里不断读取该引脚的状态，当发生对应的变化的时执行控制逻辑，但显而易见，这种做法很消耗CPU，如果在循环增加<code>sleep(1000)</code>这样的调用，又很容易错过按键变化。较好的做法则是通过<a href=http://zh.wikipedia.org/wiki/%E4%B8%AD%E6%96%AD>中断</a>来实现。</p><p>最新的树莓派Raspbian和Arch Linux内核都已经包含了GPIO的中断处理支持。但使用前需要将指定GPIO引脚输出，方法如下：</p><p>首先可以通过命令<code>echo 25 > /sys/class/gpio/export</code>导出GPIO 25端口，执行成功后在相应的目录下看到以下文件，得益于Linux下<strong>一切都是文件</strong>的设计理念，GPIO的状态可以通过<code>value</code>文件来获取，这样就可以利用Linux的poll/epoll来获取<code>value</code>文件的变化(这点和Linux高性能网络编程是类似的)。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@raspberrypi2 ~/projects/interrupt_test # ls -l /sys/class/gpio/gpio25/
</span></span><span class=line><span class=cl>total 0
</span></span><span class=line><span class=cl>-rw-r--r-- 1 root root 4096 Apr  8 23:56 active_low
</span></span><span class=line><span class=cl>-rw-r--r-- 1 root root 4096 Apr  8 22:29 direction
</span></span><span class=line><span class=cl>-rw-r--r-- 1 root root 4096 Apr  8 22:29 edge
</span></span><span class=line><span class=cl>drwxr-xr-x 2 root root    0 Apr  8 23:56 power
</span></span><span class=line><span class=cl>lrwxrwxrwx 1 root root    0 Apr  8 23:56 subsystem -&gt; ../../../../class/gpio
</span></span><span class=line><span class=cl>-rw-r--r-- 1 root root 4096 Apr  8 22:08 uevent
</span></span><span class=line><span class=cl>-rw-r--r-- 1 root root 4096 Apr  8 22:29 value
</span></span><span class=line><span class=cl>root@raspberrypi2 ~/projects/interrupt_test # 
</span></span></code></pre></div><h1 id=wiringpi>wiringPi</h1><p><a href=https://projects.drogon.net/raspberry-pi/wiringpi/functions/>wiringPi</a>库封装了一个简单的接口，传入一个回调函数，当事件发生时传入的函数将被调用。</p><a href=https://blog.hugozhu.site/post/2013/27-interrupts-with-gpio-pins/ class=post-read-more>[Read More]</a></div><div class=blog-tags><a href=https://blog.hugozhu.site/tags/raspberry-pi/>Raspberry Pi</a>&nbsp;</div></article><article class=post-preview><a href=https://blog.hugozhu.site/post/2013/26-backup-raspberry-pi/><h2 class=post-title>备份Raspberry Pi</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on April 8, 2013
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;1&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;194&nbsp;words</span></p><div class=post-entry><p>树莓派的操作系统安装在SD卡，使用一段时间后还是很有必要备份一下，以防哪天SD卡就坏了。</p><p>备份的目的地最方便的还是使用网络存储，我使用的是西部数据的<a href="http://detail.tmall.com/item.htm?spm=a220m.1000858.1000725.1.Cz5Mlq&amp;id=13865367896&amp;is_b=1&amp;cat_id=50099232&amp;q=mybooklive&amp;rn=638aa11bdda81f8d589bb0e052c57187">MyBooklive</a>3T网络硬盘。挺不错的一个产品，功能基本满足我的需求。</p><p>准备好备份目标盘，将Nas的备份目录mount到树莓派:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>mkdir /mnt/backup
</span></span><span class=line><span class=cl>mount -t cifs //mybooklive/Public/Backup /mnt/backup -o guest
</span></span></code></pre></div><h1 id=完整备份>完整备份</h1><p>确定相应的SD卡设备ID</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@raspberrypi2 ~/bin # fdisk -l
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Disk /dev/mmcblk0: 1973 MB, 1973420032 bytes, 3854336 sectors
</span></span><span class=line><span class=cl>Units = sectors of 1 * 512 = 512 bytes
</span></span><span class=line><span class=cl>Sector size (logical/physical): 512 bytes / 512 bytes
</span></span><span class=line><span class=cl>I/O size (minimum/optimal): 512 bytes / 512 bytes
</span></span><span class=line><span class=cl>Disk identifier: 0x0004f23a
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        Device Boot      Start         End      Blocks   Id  System
</span></span><span class=line><span class=cl>/dev/mmcblk0p1   *        2048      186367       92160    c  W95 FAT32 (LBA)
</span></span><span class=line><span class=cl>/dev/mmcblk0p2          186368     3667967     1740800   83  Linux
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Disk /dev/sda: 2107 MB, 2107637760 bytes, 4116480 sectors
</span></span><span class=line><span class=cl>Units = sectors of 1 * 512 = 512 bytes
</span></span><span class=line><span class=cl>Sector size (logical/physical): 512 bytes / 512 bytes
</span></span><span class=line><span class=cl>I/O size (minimum/optimal): 512 bytes / 512 bytes
</span></span></code></pre></div><p>执行备份</p><a href=https://blog.hugozhu.site/post/2013/26-backup-raspberry-pi/ class=post-read-more>[Read More]</a></div><div class=blog-tags><a href=https://blog.hugozhu.site/tags/rasperry-pi/>Rasperry Pi</a>&nbsp;</div></article><article class=post-preview><a href=https://blog.hugozhu.site/post/2013/25-get-spi-working-on-raspberry-pi-spi/><h2 class=post-title>在Raspberry Pi上使用硬件SPI</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on April 5, 2013
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;4&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;846&nbsp;words</span></p><div class=post-entry><h1 id=什么是spi>什么是SPI</h1><p>SPI (Serial Peripheral Interface)，是一种高速，全双工，同步的通信总线协议，基于SPI的设备需要4根线：</p><p><img src=https://www.evernote.com/shard/s26/sh/61dba789-b17b-4570-b124-03925a97a4bf/4e64405c3b1a486f7aa4b9451e142b32/deep/0/Screenshot%204/5/13%204:27%20PM.jpg></p><ol><li>SDO / MOSI - 主设备数据输出，从设备数据输入</li><li>SDI / MISO - 主设备数据输入，从设备数据输出</li><li>SCLK / CLK - 时钟信号，由主设备产生</li><li>CS / SS - 从设备使能信号，由主设备控制</li></ol><p>通过CS，主设备可以控制和哪个从设备通信。</p><h2 id=bit-banging>Bit Banging</h2><p>Bit-banging是一种用软件替代专职硬件的串行通信的技术。软件直接对微处理器的管脚的状态进行设置和采样，其功能涵盖诸如：时钟，电平，同步等所有参数。与此不同的是（传统的串行通信技术中），专职硬件诸如 modem、UART 或者 位移寄存器等一般是用来处理这些参数并且提供一个（缓存）的数据接口，软件在这种情况下同信号处理无关。</p><p>bit-banging 具有明显优点诸如：让相同的设备运行不同的协议而只需很小的（甚至不需）硬件的改动。借助很少的额外设备，我们也许可以从数字管脚（数字终端）可以得到视频信号。</p><p>bit-banging 也有一些明显的缺点。在软件仿真的过程中消耗的能量比同样功能的专职硬件大。微处理器过忙地从管脚采样和发送采样信号到管脚。在同等微处理器处理能力下，系统常常会有些噪音。</p><p>在Rasperry Pi上使用Bit Banging在实际情况下有可能因为操作系统调度造成时钟信号不稳定而使设备收到错误的消息，具体的表现就是Nokia 5110屏在长时间运行过程中出现白屏或花屏现象，如下图：</p><img src=http://ww2.sinaimg.cn/bmiddle/6bc40342jw1e3dzvsfxblj.jpg><p>采用硬件SPI，由Pi的管脚14号Pin（左边倒数第二个）SCLK发出一定频率的时钟信号。经过测试，这种方法产生的时钟信号比Bit Banging软件模拟产生的信号要稳定很多。</p><img src=http://ww1.sinaimg.cn/small/6bc40342jw1e3f1s62pnuj.jpg>
软件模拟时钟信号波形
<img src=http://ww1.sinaimg.cn/small/6bc40342jw1e3f6d4wsjij.jpg>
硬件SPI时钟信号波形<h1 id=测试pi的硬件spi>测试Pi的硬件SPI</h1><h2 id=确认内核支持>确认内核支持</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@raspberrypi2 ~/projects/spi_test # ls -la /dev/spi*
</span></span><span class=line><span class=cl>crw------- 1 root root 153, 0 Jan  1  1970 /dev/spidev0.0
</span></span><span class=line><span class=cl>crw------- 1 root root 153, 1 Jan  1  1970 /dev/spidev0.1
</span></span></code></pre></div><h2 id=测试代码>测试代码</h2><p>下载 <a href=http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/plain/Documentation/spi/spidev_test.c>spidev_test.c</a> 或拷贝下面的代码：</p><a href=https://blog.hugozhu.site/post/2013/25-get-spi-working-on-raspberry-pi-spi/ class=post-read-more>[Read More]</a></div><div class=blog-tags><a href=https://blog.hugozhu.site/tags/rasperry-pi/>Rasperry Pi</a>&nbsp;</div></article></div><ul class="pager main-pager"><li class=previous><a href=https://blog.hugozhu.site/page/5/>&larr; Newer Posts</a></li><li class=next><a href=https://blog.hugozhu.site/page/7/>Older Posts &rarr;</a></li></ul></div></div></div><div class=page-meta></div><footer><div class=container><div class=row><div class=disclaimer><b>Disclaimer:</b> The opinions expressed herein are my own personal opinions and do not represent my company’s view in any way.</div></div><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=/index.xml title=RSS><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted">&nbsp;&bull;&nbsp;&copy;
2025
&nbsp;&bull;&nbsp;
<a href=https://blog.hugozhu.site/>All about Raspberry Pi</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.142.0</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js integrity=sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script><script src=https://code.jquery.com/jquery-3.7.0.slim.min.js integrity=sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js integrity=sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd crossorigin=anonymous></script><script src=https://blog.hugozhu.site/js/main.js></script><script src=https://blog.hugozhu.site/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0")})</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://blog.hugozhu.site/js/load-photoswipe.js></script><script>(function(){var t,n="617d351a633194d48",e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://cse.google.com/cse.js?cx="+n,t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script><script type=text/javascript>$(function(){$("#show-comments").on("click",function(){var e="hugozhu";(function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="//"+e+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(t)})(),$(this).hide()})})</script><script id=dsq-count-scr src=//hugozhu.disqus.com/count.js async></script></body></html>