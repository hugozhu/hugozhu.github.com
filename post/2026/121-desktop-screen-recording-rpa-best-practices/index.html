<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>通过桌面录屏实现自动化 RPA 的最佳实践 - Hugo Zhu's Blog</title>
<meta name=description content="从屏幕录制到 AI 驱动的智能自动化流程构建"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"All about Raspberry Pi","url":"https:\/\/hugozhu.site\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/hugozhu.site\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/hugozhu.site\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/hugozhu.site\/post\/2026\/121-desktop-screen-recording-rpa-best-practices\/","name":"通过桌面录屏实现自动化 rpa 的最佳实践"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":""},"headline":"通过桌面录屏实现自动化 RPA 的最佳实践","description":"传统的 RPA（Robotic Process Automation）工具通常需要手动编写脚本或使用可视化编排工具，学习成本高且维护困难。随着多模态 AI 的发展，一种新的范式正在兴起：通过录制用户的桌面操作，让 AI 自动理解并复现这些操作。这种方式大大降低了自动化的门槛，让业务人员也能快速构建自动化流程。\n","inLanguage":"en","wordCount":3520,"datePublished":"2026-02-09T00:00:00\u002b00:00","dateModified":"2026-02-09T00:00:00\u002b00:00","image":"https:\/\/hugozhu.site\/img\/pi.png","keywords":["RPA, AI, automation, computer-vision, multimodal, screen-recording"],"mainEntityOfPage":"https:\/\/hugozhu.site\/post\/2026\/121-desktop-screen-recording-rpa-best-practices\/","publisher":{"@type":"Organization","name":"https:\/\/hugozhu.site\/","logo":{"@type":"ImageObject","url":"https:\/\/hugozhu.site\/img\/pi.png","height":60,"width":60}}}</script><meta property="og:title" content="通过桌面录屏实现自动化 RPA 的最佳实践"><meta property="og:description" content="从屏幕录制到 AI 驱动的智能自动化流程构建"><meta property="og:image" content="https://hugozhu.site/img/pi.png"><meta property="og:url" content="https://hugozhu.site/post/2026/121-desktop-screen-recording-rpa-best-practices/"><meta property="og:type" content="website"><meta property="og:site_name" content="All about Raspberry Pi"><meta name=twitter:title content="通过桌面录屏实现自动化 RPA 的最佳实践"><meta name=twitter:description content="从屏幕录制到 AI 驱动的智能自动化流程构建"><meta name=twitter:image content="https://hugozhu.site/img/pi.png"><meta name=twitter:card content="summary_large_image"><link href=https://hugozhu.site/img/pi.ico rel=icon type=image/x-icon><meta name=generator content="Hugo 0.145.0"><link rel=alternate href=https://hugozhu.site/index.xml type=application/rss+xml title="All about Raspberry Pi"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css integrity=sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v6.6.0/css/all.css integrity=sha384-h/hnnw1Bi4nbpD6kE7nYfCXzovi622sY5WBxww8ARKwpdLj5kUWjRuyiXaD1U2JT crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css integrity=sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu crossorigin=anonymous><link rel=stylesheet href=https://hugozhu.site/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://hugozhu.site/css/highlight.min.css><link rel=stylesheet href=https://hugozhu.site/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><script async src="https://www.googletagmanager.com/gtag/js?id=GTM-W88HDMN"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","GTM-W88HDMN")}</script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=https://hugozhu.site/>All about Raspberry Pi</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Blog href=/>Blog</a></li><li class=navlinks-container><a class=navlinks-parent role=button tabindex=0>Tools</a><div class=navlinks-children><a href=https://nddapp.com/json-encoder.html>HTML Tools</a>
<a href=https://www.birme.net/>Imaeg Resizing</a>
<a href=https://jwt.io/>JWT Token Tool</a></div></li><li><a title=About href=/page/about/>About</a></li><li><a title=Tags href=/tags>Tags</a></li><li><a href=#modalSearch data-toggle=modal data-target=#modalSearch style=outline:none><span class="hidden-sm hidden-md hidden-lg">Search</span> <span id=searchGlyph class="glyphicon glyphicon-search"></span></a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title="All about Raspberry Pi" href=https://hugozhu.site/><img class=avatar-img src=https://hugozhu.site/img/pi.png alt="All about Raspberry Pi"></a></div></div></div></nav><div id=modalSearch class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><button type=button class=close data-dismiss=modal>&#215;</button><h4 class=modal-title>Search All about Raspberry Pi</h4></div><div class=modal-body><gcse:search></gcse:search></div><div class=modal-footer><button type=button class="btn btn-default" data-dismiss=modal>Close</button></div></div></div></div><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>通过桌面录屏实现自动化 RPA 的最佳实践</h1><h2 class=post-subheading>从屏幕录制到 AI 驱动的智能自动化流程构建</h2><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on February 9, 2026
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;17&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;3520&nbsp;words</span></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><h4><i>目录:</i></h4><nav id=TableOfContents><ul><li><a href=#为什么选择录屏驱动的-rpa>为什么选择录屏驱动的 RPA？</a><ul><li><a href=#传统-rpa-的痛点>传统 RPA 的痛点</a></li><li><a href=#录屏--ai-的优势>录屏 + AI 的优势</a></li></ul></li><li><a href=#整体架构设计>整体架构设计</a></li><li><a href=#step-1-构建录制模块>Step 1: 构建录制模块</a><ul><li><a href=#11-屏幕录制>1.1 屏幕录制</a></li><li><a href=#12-关键帧提取>1.2 关键帧提取</a></li></ul></li><li><a href=#step-2-使用多模态-ai-理解操作>Step 2: 使用多模态 AI 理解操作</a><ul><li><a href=#21-构建分析-prompt>2.1 构建分析 Prompt</a></li><li><a href=#22-流程优化与验证>2.2 流程优化与验证</a></li></ul></li><li><a href=#step-3-智能执行引擎>Step 3: 智能执行引擎</a><ul><li><a href=#31-视觉元素定位>3.1 视觉元素定位</a></li><li><a href=#32-动作执行器>3.2 动作执行器</a></li></ul></li><li><a href=#step-4-工作流编排与调度>Step 4: 工作流编排与调度</a><ul><li><a href=#41-工作流运行器>4.1 工作流运行器</a></li><li><a href=#42-调度器>4.2 调度器</a></li></ul></li><li><a href=#完整使用示例>完整使用示例</a></li><li><a href=#最佳实践总结>最佳实践总结</a><ul><li><a href=#录制阶段>录制阶段</a></li><li><a href=#分析阶段>分析阶段</a></li><li><a href=#执行阶段>执行阶段</a></li><li><a href=#运维阶段>运维阶段</a></li></ul></li><li><a href=#结语>结语</a></li></ul></nav><p>传统的 RPA（Robotic Process Automation）工具通常需要手动编写脚本或使用可视化编排工具，学习成本高且维护困难。随着多模态 AI 的发展，一种新的范式正在兴起：通过录制用户的桌面操作，让 AI 自动理解并复现这些操作。这种方式大大降低了自动化的门槛，让业务人员也能快速构建自动化流程。</p><h2 id=为什么选择录屏驱动的-rpa>为什么选择录屏驱动的 RPA？</h2><h3 id=传统-rpa-的痛点>传统 RPA 的痛点</h3><ol><li><strong>高技术门槛</strong>：需要编写代码或学习复杂的可视化工具</li><li><strong>维护成本高</strong>：UI 变化时脚本经常失效</li><li><strong>场景覆盖有限</strong>：难以处理动态内容和异常情况</li><li><strong>缺乏智能</strong>：无法理解操作的语义，只是机械重复</li></ol><h3 id=录屏--ai-的优势>录屏 + AI 的优势</h3><ul><li><strong>零代码上手</strong>：只需录制一次操作，AI 自动学习</li><li><strong>语义理解</strong>：AI 理解操作意图，而非死记硬背坐标</li><li><strong>智能适应</strong>：界面变化时能自动调整</li><li><strong>异常处理</strong>：可以识别并处理意外情况</li></ul><h2 id=整体架构设计>整体架构设计</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>┌──────────────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│                   Screen Recording RPA System                     │
</span></span><span class=line><span class=cl>├──────────────────────────────────────────────────────────────────┤
</span></span><span class=line><span class=cl>│  Layer 1: 录制层                                                   │
</span></span><span class=line><span class=cl>│  ├── 屏幕录制模块 (视频 + 音频)                                      │
</span></span><span class=line><span class=cl>│  ├── 鼠标/键盘事件捕获                                              │
</span></span><span class=line><span class=cl>│  └── 时间戳同步                                                    │
</span></span><span class=line><span class=cl>├──────────────────────────────────────────────────────────────────┤
</span></span><span class=line><span class=cl>│  Layer 2: 理解层                                                   │
</span></span><span class=line><span class=cl>│  ├── 视频帧提取与关键帧检测                                          │
</span></span><span class=line><span class=cl>│  ├── 多模态 LLM 分析 (GPT-4V / Claude Vision / Gemini)             │
</span></span><span class=line><span class=cl>│  └── 操作序列抽象                                                  │
</span></span><span class=line><span class=cl>├──────────────────────────────────────────────────────────────────┤
</span></span><span class=line><span class=cl>│  Layer 3: 执行层                                                   │
</span></span><span class=line><span class=cl>│  ├── 元素定位引擎 (视觉 + 语义)                                      │
</span></span><span class=line><span class=cl>│  ├── 动作执行器 (pyautogui / playwright)                           │
</span></span><span class=line><span class=cl>│  └── 验证与重试机制                                                 │
</span></span><span class=line><span class=cl>├──────────────────────────────────────────────────────────────────┤
</span></span><span class=line><span class=cl>│  Layer 4: 编排层                                                   │
</span></span><span class=line><span class=cl>│  ├── 流程定义与管理                                                 │
</span></span><span class=line><span class=cl>│  ├── 调度与触发器                                                  │
</span></span><span class=line><span class=cl>│  └── 监控与日志                                                    │
</span></span><span class=line><span class=cl>└──────────────────────────────────────────────────────────────────┘
</span></span></code></pre></div><h2 id=step-1-构建录制模块>Step 1: 构建录制模块</h2><h3 id=11-屏幕录制>1.1 屏幕录制</h3><p>我们需要同时录制屏幕画面和用户的输入事件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>cv2</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pyautogui</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pynput</span> <span class=kn>import</span> <span class=n>mouse</span><span class=p>,</span> <span class=n>keyboard</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span><span class=p>,</span> <span class=n>field</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>Tuple</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>InputEvent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;表示一个输入事件&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>timestamp</span><span class=p>:</span> <span class=nb>float</span>          <span class=c1># 相对于录制开始的时间（秒）</span>
</span></span><span class=line><span class=cl>    <span class=n>event_type</span><span class=p>:</span> <span class=nb>str</span>          <span class=c1># &#34;click&#34;, &#34;scroll&#34;, &#34;key_press&#34;, &#34;key_release&#34;, &#34;move&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>position</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>int</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># 鼠标位置</span>
</span></span><span class=line><span class=cl>    <span class=n>button</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>                 <span class=c1># 鼠标按钮</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>                    <span class=c1># 按键</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=p>:</span> <span class=nb>dict</span> <span class=o>=</span> <span class=n>field</span><span class=p>(</span><span class=n>default_factory</span><span class=o>=</span><span class=nb>dict</span><span class=p>)</span>     <span class=c1># 额外数据</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RecordingSession</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;录制会话&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>video_path</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>events</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>InputEvent</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>start_time</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>end_time</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>screen_size</span><span class=p>:</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>int</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>fps</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ScreenRecorder</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    屏幕录制器
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    同时捕获：
</span></span></span><span class=line><span class=cl><span class=s2>    1. 屏幕视频
</span></span></span><span class=line><span class=cl><span class=s2>    2. 鼠标点击、移动、滚动
</span></span></span><span class=line><span class=cl><span class=s2>    3. 键盘输入
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>output_dir</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;./recordings&#34;</span><span class=p>,</span> <span class=n>fps</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>output_dir</span> <span class=o>=</span> <span class=n>output_dir</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fps</span> <span class=o>=</span> <span class=n>fps</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>is_recording</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>InputEvent</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>start_time</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>screen_size</span> <span class=o>=</span> <span class=n>pyautogui</span><span class=o>.</span><span class=n>size</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 录制线程</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_video_thread</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_video_writer</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>cv2</span><span class=o>.</span><span class=n>VideoWriter</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 输入监听器</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_mouse_listener</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>mouse</span><span class=o>.</span><span class=n>Listener</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_keyboard_listener</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>keyboard</span><span class=o>.</span><span class=n>Listener</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_on_mouse_click</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>y</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>button</span><span class=p>,</span> <span class=n>pressed</span><span class=p>:</span> <span class=nb>bool</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;鼠标点击回调&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_recording</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>event</span> <span class=o>=</span> <span class=n>InputEvent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>timestamp</span><span class=o>=</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>start_time</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>event_type</span><span class=o>=</span><span class=s2>&#34;click&#34;</span> <span class=k>if</span> <span class=n>pressed</span> <span class=k>else</span> <span class=s2>&#34;release&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>position</span><span class=o>=</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>button</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=n>button</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;pressed&#34;</span><span class=p>:</span> <span class=n>pressed</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_on_mouse_scroll</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>y</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>dx</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>dy</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;鼠标滚动回调&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_recording</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>event</span> <span class=o>=</span> <span class=n>InputEvent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>timestamp</span><span class=o>=</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>start_time</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>event_type</span><span class=o>=</span><span class=s2>&#34;scroll&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>position</span><span class=o>=</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;dx&#34;</span><span class=p>:</span> <span class=n>dx</span><span class=p>,</span> <span class=s2>&#34;dy&#34;</span><span class=p>:</span> <span class=n>dy</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_on_key_press</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;键盘按下回调&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_recording</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>key_str</span> <span class=o>=</span> <span class=n>key</span><span class=o>.</span><span class=n>char</span> <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=s1>&#39;char&#39;</span><span class=p>)</span> <span class=k>else</span> <span class=nb>str</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>AttributeError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>key_str</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>event</span> <span class=o>=</span> <span class=n>InputEvent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>timestamp</span><span class=o>=</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>start_time</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>event_type</span><span class=o>=</span><span class=s2>&#34;key_press&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>key</span><span class=o>=</span><span class=n>key_str</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_record_video</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>output_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;视频录制线程&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>fourcc</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>VideoWriter_fourcc</span><span class=p>(</span><span class=o>*</span><span class=s1>&#39;mp4v&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_video_writer</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>VideoWriter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>output_path</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>fourcc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>fps</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>screen_size</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>interval</span> <span class=o>=</span> <span class=mf>1.0</span> <span class=o>/</span> <span class=bp>self</span><span class=o>.</span><span class=n>fps</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_recording</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>frame_start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 截取屏幕</span>
</span></span><span class=line><span class=cl>            <span class=n>screenshot</span> <span class=o>=</span> <span class=n>pyautogui</span><span class=o>.</span><span class=n>screenshot</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>frame</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>screenshot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>frame</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>cvtColor</span><span class=p>(</span><span class=n>frame</span><span class=p>,</span> <span class=n>cv2</span><span class=o>.</span><span class=n>COLOR_RGB2BGR</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 在帧上绘制鼠标位置（用于调试）</span>
</span></span><span class=line><span class=cl>            <span class=n>mouse_pos</span> <span class=o>=</span> <span class=n>pyautogui</span><span class=o>.</span><span class=n>position</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>cv2</span><span class=o>.</span><span class=n>circle</span><span class=p>(</span><span class=n>frame</span><span class=p>,</span> <span class=n>mouse_pos</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>255</span><span class=p>),</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_video_writer</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>frame</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 控制帧率</span>
</span></span><span class=line><span class=cl>            <span class=n>elapsed</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>frame_start</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>elapsed</span> <span class=o>&lt;</span> <span class=n>interval</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>interval</span> <span class=o>-</span> <span class=n>elapsed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_video_writer</span><span class=o>.</span><span class=n>release</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>start_recording</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>session_name</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        开始录制
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            session_name: 会话名称，用于生成文件名
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            录制文件路径
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_recording</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=s2>&#34;Already recording&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>output_dir</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>session_name</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>session_name</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&#34;%Y%m</span><span class=si>%d</span><span class=s2>_%H%M%S&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>video_path</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>output_dir</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>session_name</span><span class=si>}</span><span class=s2>.mp4&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>is_recording</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 启动视频录制线程</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_video_thread</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>target</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_record_video</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>video_path</span><span class=p>,)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_video_thread</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 启动输入监听</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_mouse_listener</span> <span class=o>=</span> <span class=n>mouse</span><span class=o>.</span><span class=n>Listener</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>on_click</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_on_mouse_click</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>on_scroll</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_on_mouse_scroll</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_keyboard_listener</span> <span class=o>=</span> <span class=n>keyboard</span><span class=o>.</span><span class=n>Listener</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>on_press</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_on_key_press</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_mouse_listener</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_keyboard_listener</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Recording started: </span><span class=si>{</span><span class=n>video_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>video_path</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>stop_recording</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>RecordingSession</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        停止录制
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            RecordingSession 对象
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_recording</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=s2>&#34;Not recording&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>is_recording</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=n>end_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 停止监听器</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_mouse_listener</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_mouse_listener</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_keyboard_listener</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_keyboard_listener</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 等待视频线程结束</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_video_thread</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_video_thread</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 获取视频路径</span>
</span></span><span class=line><span class=cl>        <span class=n>video_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_video_writer</span><span class=o>.</span><span class=n>getfilename</span><span class=p>()</span> <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_video_writer</span> <span class=k>else</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>session</span> <span class=o>=</span> <span class=n>RecordingSession</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>video_path</span><span class=o>=</span><span class=n>video_path</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>events</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>start_time</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>start_time</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>end_time</span><span class=o>=</span><span class=n>end_time</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>screen_size</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>screen_size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>fps</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>fps</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 保存事件数据</span>
</span></span><span class=line><span class=cl>        <span class=n>events_path</span> <span class=o>=</span> <span class=n>video_path</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;.mp4&#39;</span><span class=p>,</span> <span class=s1>&#39;_events.json&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_save_events</span><span class=p>(</span><span class=n>events_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Recording stopped. Duration: </span><span class=si>{</span><span class=n>end_time</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>start_time</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>s&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Captured </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=p>)</span><span class=si>}</span><span class=s2> input events&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>session</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_save_events</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>path</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;保存事件到 JSON 文件&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>events_data</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;timestamp&#34;</span><span class=p>:</span> <span class=n>e</span><span class=o>.</span><span class=n>timestamp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;event_type&#34;</span><span class=p>:</span> <span class=n>e</span><span class=o>.</span><span class=n>event_type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;position&#34;</span><span class=p>:</span> <span class=n>e</span><span class=o>.</span><span class=n>position</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;button&#34;</span><span class=p>:</span> <span class=n>e</span><span class=o>.</span><span class=n>button</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=n>e</span><span class=o>.</span><span class=n>key</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;data&#34;</span><span class=p>:</span> <span class=n>e</span><span class=o>.</span><span class=n>data</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>events</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>events_data</span><span class=p>,</span> <span class=n>f</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by hugo&#39;s coding agent</span>
</span></span></code></pre></div><h3 id=12-关键帧提取>1.2 关键帧提取</h3><p>录制完成后，我们需要从视频中提取关键帧，用于后续的 AI 分析。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>cv2</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Tuple</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>KeyFrame</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;关键帧&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>frame_index</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>timestamp</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>image</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span>
</span></span><span class=line><span class=cl>    <span class=n>associated_events</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>InputEvent</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>change_score</span><span class=p>:</span> <span class=nb>float</span>  <span class=c1># 与前一帧的变化程度</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>KeyFrameExtractor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    关键帧提取器
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    策略：
</span></span></span><span class=line><span class=cl><span class=s2>    1. 基于画面变化检测
</span></span></span><span class=line><span class=cl><span class=s2>    2. 基于输入事件（点击、按键）
</span></span></span><span class=line><span class=cl><span class=s2>    3. 固定间隔采样
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>change_threshold</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>min_interval</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>event_window</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            change_threshold: 画面变化阈值（0-1）
</span></span></span><span class=line><span class=cl><span class=s2>            min_interval: 关键帧最小间隔（秒）
</span></span></span><span class=line><span class=cl><span class=s2>            event_window: 事件关联时间窗口（秒）
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>change_threshold</span> <span class=o>=</span> <span class=n>change_threshold</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>min_interval</span> <span class=o>=</span> <span class=n>min_interval</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_window</span> <span class=o>=</span> <span class=n>event_window</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>extract</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>video_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>events</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>InputEvent</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>KeyFrame</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        从视频中提取关键帧
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            video_path: 视频文件路径
</span></span></span><span class=line><span class=cl><span class=s2>            events: 输入事件列表
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            关键帧列表
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>cap</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>VideoCapture</span><span class=p>(</span><span class=n>video_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>fps</span> <span class=o>=</span> <span class=n>cap</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>cv2</span><span class=o>.</span><span class=n>CAP_PROP_FPS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>keyframes</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>prev_frame</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=n>prev_keyframe_time</span> <span class=o>=</span> <span class=o>-</span><span class=nb>float</span><span class=p>(</span><span class=s1>&#39;inf&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>frame_index</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>ret</span><span class=p>,</span> <span class=n>frame</span> <span class=o>=</span> <span class=n>cap</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>ret</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>timestamp</span> <span class=o>=</span> <span class=n>frame_index</span> <span class=o>/</span> <span class=n>fps</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 计算与前一帧的变化</span>
</span></span><span class=line><span class=cl>            <span class=n>change_score</span> <span class=o>=</span> <span class=mf>0.0</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>prev_frame</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>change_score</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_compute_change</span><span class=p>(</span><span class=n>prev_frame</span><span class=p>,</span> <span class=n>frame</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 判断是否为关键帧</span>
</span></span><span class=line><span class=cl>            <span class=n>is_keyframe</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 条件1：画面变化超过阈值</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>change_score</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>change_threshold</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>is_keyframe</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 条件2：有关联的点击事件</span>
</span></span><span class=line><span class=cl>            <span class=n>associated</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_find_associated_events</span><span class=p>(</span><span class=n>timestamp</span><span class=p>,</span> <span class=n>events</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>click_events</span> <span class=o>=</span> <span class=p>[</span><span class=n>e</span> <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>associated</span> <span class=k>if</span> <span class=n>e</span><span class=o>.</span><span class=n>event_type</span> <span class=o>==</span> <span class=s2>&#34;click&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>click_events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>is_keyframe</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 条件3：满足最小间隔</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>is_keyframe</span> <span class=ow>and</span> <span class=p>(</span><span class=n>timestamp</span> <span class=o>-</span> <span class=n>prev_keyframe_time</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>min_interval</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>keyframe</span> <span class=o>=</span> <span class=n>KeyFrame</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>frame_index</span><span class=o>=</span><span class=n>frame_index</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>timestamp</span><span class=o>=</span><span class=n>timestamp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>image</span><span class=o>=</span><span class=n>frame</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                    <span class=n>associated_events</span><span class=o>=</span><span class=n>associated</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>change_score</span><span class=o>=</span><span class=n>change_score</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>keyframes</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>keyframe</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>prev_keyframe_time</span> <span class=o>=</span> <span class=n>timestamp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>prev_frame</span> <span class=o>=</span> <span class=n>frame</span>
</span></span><span class=line><span class=cl>            <span class=n>frame_index</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>cap</span><span class=o>.</span><span class=n>release</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Extracted </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>keyframes</span><span class=p>)</span><span class=si>}</span><span class=s2> keyframes from </span><span class=si>{</span><span class=n>frame_index</span><span class=si>}</span><span class=s2> frames&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>keyframes</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_compute_change</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>frame1</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>frame2</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算两帧之间的变化程度&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 转换为灰度图</span>
</span></span><span class=line><span class=cl>        <span class=n>gray1</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>cvtColor</span><span class=p>(</span><span class=n>frame1</span><span class=p>,</span> <span class=n>cv2</span><span class=o>.</span><span class=n>COLOR_BGR2GRAY</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>gray2</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>cvtColor</span><span class=p>(</span><span class=n>frame2</span><span class=p>,</span> <span class=n>cv2</span><span class=o>.</span><span class=n>COLOR_BGR2GRAY</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 计算结构相似性</span>
</span></span><span class=line><span class=cl>        <span class=n>diff</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>absdiff</span><span class=p>(</span><span class=n>gray1</span><span class=p>,</span> <span class=n>gray2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>change_ratio</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>diff</span><span class=p>)</span> <span class=o>/</span> <span class=mf>255.0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>change_ratio</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_find_associated_events</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                 <span class=n>timestamp</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                 <span class=n>events</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>InputEvent</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>InputEvent</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;找到时间窗口内的关联事件&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span> <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>events</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>abs</span><span class=p>(</span><span class=n>e</span><span class=o>.</span><span class=n>timestamp</span> <span class=o>-</span> <span class=n>timestamp</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>event_window</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by hugo&#39;s coding agent</span>
</span></span></code></pre></div><h2 id=step-2-使用多模态-ai-理解操作>Step 2: 使用多模态 AI 理解操作</h2><h3 id=21-构建分析-prompt>2.1 构建分析 Prompt</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>io</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>PIL</span> <span class=kn>import</span> <span class=n>Image</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OperationAnalyzer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    使用多模态 LLM 分析操作序列
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    支持的模型：
</span></span></span><span class=line><span class=cl><span class=s2>    - OpenAI GPT-4 Vision
</span></span></span><span class=line><span class=cl><span class=s2>    - Anthropic Claude 3
</span></span></span><span class=line><span class=cl><span class=s2>    - Google Gemini Pro Vision
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ANALYSIS_PROMPT</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;你是一个 RPA 自动化专家。请分析以下屏幕截图序列，理解用户正在执行的操作。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>对于每个截图：
</span></span></span><span class=line><span class=cl><span class=s2>1. 描述当前屏幕的状态
</span></span></span><span class=line><span class=cl><span class=s2>2. 识别用户点击/操作的元素
</span></span></span><span class=line><span class=cl><span class=s2>3. 推断用户的意图
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>最后，请将整个操作序列抽象为一个可重复执行的自动化流程。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>输出格式（JSON）：
</span></span></span><span class=line><span class=cl><span class=s2>{
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;workflow_name&#34;: &#34;流程名称&#34;,
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;description&#34;: &#34;流程描述&#34;,
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;steps&#34;: [
</span></span></span><span class=line><span class=cl><span class=s2>        {
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;step_id&#34;: 1,
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;action&#34;: &#34;click|type|scroll|wait|verify&#34;,
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;target&#34;: {
</span></span></span><span class=line><span class=cl><span class=s2>                &#34;description&#34;: &#34;目标元素的描述&#34;,
</span></span></span><span class=line><span class=cl><span class=s2>                &#34;visual_features&#34;: [&#34;视觉特征1&#34;, &#34;特征2&#34;],
</span></span></span><span class=line><span class=cl><span class=s2>                &#34;text_content&#34;: &#34;元素包含的文本（如有）&#34;,
</span></span></span><span class=line><span class=cl><span class=s2>                &#34;relative_position&#34;: &#34;相对位置描述&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            },
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;parameters&#34;: {
</span></span></span><span class=line><span class=cl><span class=s2>                &#34;text&#34;: &#34;要输入的文本（type 操作）&#34;,
</span></span></span><span class=line><span class=cl><span class=s2>                &#34;direction&#34;: &#34;滚动方向（scroll 操作）&#34;,
</span></span></span><span class=line><span class=cl><span class=s2>                &#34;condition&#34;: &#34;验证条件（verify 操作）&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            },
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;expected_result&#34;: &#34;执行后的预期结果&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        }
</span></span></span><span class=line><span class=cl><span class=s2>    ],
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;preconditions&#34;: [&#34;前置条件1&#34;, &#34;前置条件2&#34;],
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;error_handling&#34;: {
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;timeout&#34;: &#34;超时处理策略&#34;,
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;element_not_found&#34;: &#34;元素未找到处理策略&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    }
</span></span></span><span class=line><span class=cl><span class=s2>}
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>model_provider</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;openai&#34;</span><span class=p>,</span> <span class=n>api_key</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>model_provider</span> <span class=o>=</span> <span class=n>model_provider</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>api_key</span> <span class=o>=</span> <span class=n>api_key</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_encode_image</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>image</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;将图像编码为 base64&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 转换为 PIL Image</span>
</span></span><span class=line><span class=cl>        <span class=n>image_rgb</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>cvtColor</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=n>cv2</span><span class=o>.</span><span class=n>COLOR_BGR2RGB</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>pil_image</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>fromarray</span><span class=p>(</span><span class=n>image_rgb</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 压缩并编码</span>
</span></span><span class=line><span class=cl>        <span class=n>buffer</span> <span class=o>=</span> <span class=n>io</span><span class=o>.</span><span class=n>BytesIO</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>pil_image</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span> <span class=nb>format</span><span class=o>=</span><span class=s2>&#34;JPEG&#34;</span><span class=p>,</span> <span class=n>quality</span><span class=o>=</span><span class=mi>85</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>buffer</span><span class=o>.</span><span class=n>getvalue</span><span class=p>())</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_build_messages</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>keyframes</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>KeyFrame</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;构建多模态消息&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>messages</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;system&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>ANALYSIS_PROMPT</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 构建用户消息，包含所有关键帧</span>
</span></span><span class=line><span class=cl>        <span class=n>content</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>kf</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>keyframes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># 添加图像</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;image_url&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;image_url&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;url&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;data:image/jpeg;base64,</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>_encode_image</span><span class=p>(</span><span class=n>kf</span><span class=o>.</span><span class=n>image</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 添加事件信息</span>
</span></span><span class=line><span class=cl>            <span class=n>events_desc</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_describe_events</span><span class=p>(</span><span class=n>kf</span><span class=o>.</span><span class=n>associated_events</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;text&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;[截图 </span><span class=si>{</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2>] 时间: </span><span class=si>{</span><span class=n>kf</span><span class=o>.</span><span class=n>timestamp</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>s</span><span class=se>\n</span><span class=s2>用户操作: </span><span class=si>{</span><span class=n>events_desc</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>messages</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>content</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>messages</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_describe_events</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>events</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>InputEvent</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;描述事件列表&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;无操作&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>descriptions</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>e</span><span class=o>.</span><span class=n>event_type</span> <span class=o>==</span> <span class=s2>&#34;click&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>descriptions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;点击 (</span><span class=si>{</span><span class=n>e</span><span class=o>.</span><span class=n>position</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>e</span><span class=o>.</span><span class=n>position</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>e</span><span class=o>.</span><span class=n>event_type</span> <span class=o>==</span> <span class=s2>&#34;key_press&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>descriptions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;按键 &#39;</span><span class=si>{</span><span class=n>e</span><span class=o>.</span><span class=n>key</span><span class=si>}</span><span class=s2>&#39;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>e</span><span class=o>.</span><span class=n>event_type</span> <span class=o>==</span> <span class=s2>&#34;scroll&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>dy</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;dy&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>direction</span> <span class=o>=</span> <span class=s2>&#34;向上&#34;</span> <span class=k>if</span> <span class=n>dy</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=s2>&#34;向下&#34;</span>
</span></span><span class=line><span class=cl>                <span class=n>descriptions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;滚动 </span><span class=si>{</span><span class=n>direction</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;; &#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>descriptions</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>analyze</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>keyframes</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>KeyFrame</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        分析关键帧序列，生成自动化流程
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            keyframes: 关键帧列表
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            解析后的流程定义
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>messages</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_build_messages</span><span class=p>(</span><span class=n>keyframes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>model_provider</span> <span class=o>==</span> <span class=s2>&#34;openai&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_call_openai</span><span class=p>(</span><span class=n>messages</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=bp>self</span><span class=o>.</span><span class=n>model_provider</span> <span class=o>==</span> <span class=s2>&#34;anthropic&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_call_anthropic</span><span class=p>(</span><span class=n>messages</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Unsupported provider: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>model_provider</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_call_openai</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>messages</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;调用 OpenAI API&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>client</span> <span class=o>=</span> <span class=n>OpenAI</span><span class=p>(</span><span class=n>api_key</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>api_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4-vision-preview&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>messages</span><span class=o>=</span><span class=n>messages</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>max_tokens</span><span class=o>=</span><span class=mi>4096</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>response_format</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;json_object&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>choices</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_call_anthropic</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>messages</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;调用 Anthropic API&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>anthropic</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>client</span> <span class=o>=</span> <span class=n>anthropic</span><span class=o>.</span><span class=n>Anthropic</span><span class=p>(</span><span class=n>api_key</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>api_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 转换消息格式</span>
</span></span><span class=line><span class=cl>        <span class=n>claude_messages</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_convert_to_claude_format</span><span class=p>(</span><span class=n>messages</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>messages</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=s2>&#34;claude-3-opus-20240229&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>max_tokens</span><span class=o>=</span><span class=mi>4096</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>messages</span><span class=o>=</span><span class=n>claude_messages</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 提取 JSON</span>
</span></span><span class=line><span class=cl>        <span class=n>content</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>content</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>        <span class=c1># 尝试解析 JSON</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>        <span class=n>json_match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;\{[\s\S]*\}&#39;</span><span class=p>,</span> <span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>json_match</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>json_match</span><span class=o>.</span><span class=n>group</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;Failed to parse response&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_convert_to_claude_format</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>messages</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;转换为 Claude 消息格式&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>claude_messages</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>msg</span> <span class=ow>in</span> <span class=n>messages</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>msg</span><span class=p>[</span><span class=s2>&#34;role&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;system&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># Claude 使用 system 参数而非消息</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>msg</span><span class=p>[</span><span class=s2>&#34;role&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;user&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>content</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>msg</span><span class=p>[</span><span class=s2>&#34;content&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>item</span><span class=p>[</span><span class=s2>&#34;type&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;text&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>content</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;text&#34;</span><span class=p>,</span> <span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=n>item</span><span class=p>[</span><span class=s2>&#34;text&#34;</span><span class=p>]})</span>
</span></span><span class=line><span class=cl>                    <span class=k>elif</span> <span class=n>item</span><span class=p>[</span><span class=s2>&#34;type&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;image_url&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=c1># 提取 base64 数据</span>
</span></span><span class=line><span class=cl>                        <span class=n>url</span> <span class=o>=</span> <span class=n>item</span><span class=p>[</span><span class=s2>&#34;image_url&#34;</span><span class=p>][</span><span class=s2>&#34;url&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                        <span class=n>data</span> <span class=o>=</span> <span class=n>url</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;,&#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                        <span class=n>content</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;image&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;source&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;base64&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                <span class=s2>&#34;media_type&#34;</span><span class=p>:</span> <span class=s2>&#34;image/jpeg&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                <span class=s2>&#34;data&#34;</span><span class=p>:</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span>
</span></span><span class=line><span class=cl>                        <span class=p>})</span>
</span></span><span class=line><span class=cl>                <span class=n>claude_messages</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>content</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>claude_messages</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by hugo&#39;s coding agent</span>
</span></span></code></pre></div><h3 id=22-流程优化与验证>2.2 流程优化与验证</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>WorkflowStep</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;工作流步骤&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>step_id</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>action</span><span class=p>:</span> <span class=nb>str</span>  <span class=c1># click, type, scroll, wait, verify</span>
</span></span><span class=line><span class=cl>    <span class=n>target</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>parameters</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>expected_result</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>confidence</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>1.0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Workflow</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;自动化工作流&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>steps</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>WorkflowStep</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>preconditions</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>error_handling</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>str</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>WorkflowOptimizer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    工作流优化器
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    功能：
</span></span></span><span class=line><span class=cl><span class=s2>    1. 合并冗余步骤
</span></span></span><span class=line><span class=cl><span class=s2>    2. 添加智能等待
</span></span></span><span class=line><span class=cl><span class=s2>    3. 验证流程完整性
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>optimize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>raw_workflow</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Workflow</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;优化原始工作流&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>steps</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>step_data</span> <span class=ow>in</span> <span class=n>raw_workflow</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;steps&#34;</span><span class=p>,</span> <span class=p>[]):</span>
</span></span><span class=line><span class=cl>            <span class=n>step</span> <span class=o>=</span> <span class=n>WorkflowStep</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>step_id</span><span class=o>=</span><span class=n>step_data</span><span class=p>[</span><span class=s2>&#34;step_id&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>action</span><span class=o>=</span><span class=n>step_data</span><span class=p>[</span><span class=s2>&#34;action&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>target</span><span class=o>=</span><span class=n>step_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;target&#34;</span><span class=p>,</span> <span class=p>{}),</span>
</span></span><span class=line><span class=cl>                <span class=n>parameters</span><span class=o>=</span><span class=n>step_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;parameters&#34;</span><span class=p>,</span> <span class=p>{}),</span>
</span></span><span class=line><span class=cl>                <span class=n>expected_result</span><span class=o>=</span><span class=n>step_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;expected_result&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>steps</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 优化步骤</span>
</span></span><span class=line><span class=cl>        <span class=n>steps</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_merge_typing_steps</span><span class=p>(</span><span class=n>steps</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>steps</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_add_implicit_waits</span><span class=p>(</span><span class=n>steps</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>steps</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_add_verification_steps</span><span class=p>(</span><span class=n>steps</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Workflow</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>name</span><span class=o>=</span><span class=n>raw_workflow</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;workflow_name&#34;</span><span class=p>,</span> <span class=s2>&#34;Unnamed&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>description</span><span class=o>=</span><span class=n>raw_workflow</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;description&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>steps</span><span class=o>=</span><span class=n>steps</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>preconditions</span><span class=o>=</span><span class=n>raw_workflow</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;preconditions&#34;</span><span class=p>,</span> <span class=p>[]),</span>
</span></span><span class=line><span class=cl>            <span class=n>error_handling</span><span class=o>=</span><span class=n>raw_workflow</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;error_handling&#34;</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_merge_typing_steps</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>steps</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>WorkflowStep</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>WorkflowStep</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;合并连续的打字步骤&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>merged</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>typing_buffer</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>step</span> <span class=ow>in</span> <span class=n>steps</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>step</span><span class=o>.</span><span class=n>action</span> <span class=o>==</span> <span class=s2>&#34;type&#34;</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>step</span><span class=o>.</span><span class=n>parameters</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;text&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>))</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>typing_buffer</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>step</span><span class=o>.</span><span class=n>parameters</span><span class=p>[</span><span class=s2>&#34;text&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>typing_buffer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># 创建合并后的打字步骤</span>
</span></span><span class=line><span class=cl>                    <span class=n>merged_step</span> <span class=o>=</span> <span class=n>WorkflowStep</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>step_id</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>merged</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>action</span><span class=o>=</span><span class=s2>&#34;type&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>target</span><span class=o>=</span><span class=n>steps</span><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=n>merged</span><span class=p>)]</span><span class=o>.</span><span class=n>target</span> <span class=k>if</span> <span class=n>merged</span> <span class=k>else</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>                        <span class=n>parameters</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>typing_buffer</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>                        <span class=n>expected_result</span><span class=o>=</span><span class=s2>&#34;Text entered&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>merged</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>merged_step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>typing_buffer</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>                <span class=n>merged</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>typing_buffer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>merged_step</span> <span class=o>=</span> <span class=n>WorkflowStep</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>step_id</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>merged</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>action</span><span class=o>=</span><span class=s2>&#34;type&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>target</span><span class=o>=</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>                <span class=n>parameters</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>typing_buffer</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>                <span class=n>expected_result</span><span class=o>=</span><span class=s2>&#34;Text entered&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>merged</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>merged_step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>merged</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_add_implicit_waits</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>steps</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>WorkflowStep</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>WorkflowStep</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;在可能导致页面变化的操作后添加等待&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>step</span> <span class=ow>in</span> <span class=n>steps</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 点击操作后可能需要等待</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>step</span><span class=o>.</span><span class=n>action</span> <span class=o>==</span> <span class=s2>&#34;click&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>wait_step</span> <span class=o>=</span> <span class=n>WorkflowStep</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>step_id</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>result</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>action</span><span class=o>=</span><span class=s2>&#34;wait&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>target</span><span class=o>=</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>                    <span class=n>parameters</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;smart&#34;</span><span class=p>,</span>  <span class=c1># 智能等待</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;max_timeout&#34;</span><span class=p>:</span> <span class=mf>5.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;condition&#34;</span><span class=p>:</span> <span class=n>step</span><span class=o>.</span><span class=n>expected_result</span>
</span></span><span class=line><span class=cl>                    <span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=n>expected_result</span><span class=o>=</span><span class=s2>&#34;Page loaded&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>wait_step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_add_verification_steps</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>steps</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>WorkflowStep</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>WorkflowStep</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;添加关键验证步骤&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>step</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>steps</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 在最后一步后添加验证</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>i</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>steps</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>verify_step</span> <span class=o>=</span> <span class=n>WorkflowStep</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>step_id</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>result</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>action</span><span class=o>=</span><span class=s2>&#34;verify&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>target</span><span class=o>=</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>                    <span class=n>parameters</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;condition&#34;</span><span class=p>:</span> <span class=s2>&#34;workflow_completed&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;expected_state&#34;</span><span class=p>:</span> <span class=n>step</span><span class=o>.</span><span class=n>expected_result</span>
</span></span><span class=line><span class=cl>                    <span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=n>expected_result</span><span class=o>=</span><span class=s2>&#34;Workflow verified&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>verify_step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by hugo&#39;s coding agent</span>
</span></span></code></pre></div><h2 id=step-3-智能执行引擎>Step 3: 智能执行引擎</h2><h3 id=31-视觉元素定位>3.1 视觉元素定位</h3><p>传统 RPA 依赖固定坐标或 DOM 结构，而我们使用视觉+语义的方式定位元素。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>cv2</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>Tuple</span><span class=p>,</span> <span class=n>List</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>VisualElementLocator</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    视觉元素定位器
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    结合多种策略定位 UI 元素：
</span></span></span><span class=line><span class=cl><span class=s2>    1. 模板匹配
</span></span></span><span class=line><span class=cl><span class=s2>    2. OCR 文本定位
</span></span></span><span class=line><span class=cl><span class=s2>    3. 特征点匹配
</span></span></span><span class=line><span class=cl><span class=s2>    4. AI 语义定位
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>ocr_model</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>vision_model</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ocr_model</span> <span class=o>=</span> <span class=n>ocr_model</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>vision_model</span> <span class=o>=</span> <span class=n>vision_model</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>locate</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=n>screenshot</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=n>target</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>],</span>
</span></span><span class=line><span class=cl>               <span class=n>reference_image</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>int</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        在屏幕截图中定位目标元素
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            screenshot: 当前屏幕截图
</span></span></span><span class=line><span class=cl><span class=s2>            target: 目标描述（来自流程定义）
</span></span></span><span class=line><span class=cl><span class=s2>            reference_image: 参考图像（录制时的截图）
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            元素中心坐标 (x, y) 或 None
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>strategies</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=s2>&#34;text&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_locate_by_text</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=s2>&#34;template&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_locate_by_template</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=s2>&#34;features&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_locate_by_features</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=s2>&#34;ai&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_locate_by_ai</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>strategy_name</span><span class=p>,</span> <span class=n>strategy_func</span> <span class=ow>in</span> <span class=n>strategies</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span> <span class=o>=</span> <span class=n>strategy_func</span><span class=p>(</span><span class=n>screenshot</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=n>reference_image</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>result</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Located element using </span><span class=si>{</span><span class=n>strategy_name</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Strategy </span><span class=si>{</span><span class=n>strategy_name</span><span class=si>}</span><span class=s2> failed: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_locate_by_text</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>screenshot</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>target</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                        <span class=n>reference</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>int</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;通过 OCR 文本定位&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>text_content</span> <span class=o>=</span> <span class=n>target</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;text_content&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>text_content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 使用 OCR 识别屏幕文字</span>
</span></span><span class=line><span class=cl>        <span class=c1># 这里假设使用 PaddleOCR 或 EasyOCR</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>ocr_model</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ocr_model</span><span class=o>.</span><span class=n>ocr</span><span class=p>(</span><span class=n>screenshot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>word_info</span> <span class=ow>in</span> <span class=n>line</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>box</span><span class=p>,</span> <span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=n>confidence</span><span class=p>)</span> <span class=o>=</span> <span class=n>word_info</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>text_content</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=ow>in</span> <span class=n>text</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=ow>and</span> <span class=n>confidence</span> <span class=o>&gt;</span> <span class=mf>0.8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># 计算中心点</span>
</span></span><span class=line><span class=cl>                    <span class=n>x</span> <span class=o>=</span> <span class=nb>int</span><span class=p>((</span><span class=n>box</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=n>box</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>0</span><span class=p>])</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>y</span> <span class=o>=</span> <span class=nb>int</span><span class=p>((</span><span class=n>box</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>box</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>1</span><span class=p>])</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_locate_by_template</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=n>screenshot</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=n>target</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                            <span class=n>reference</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>int</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;通过模板匹配定位&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>reference</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 从参考图像中提取目标区域</span>
</span></span><span class=line><span class=cl>        <span class=c1># 这里简化处理，实际应该根据 target 信息提取</span>
</span></span><span class=line><span class=cl>        <span class=n>template</span> <span class=o>=</span> <span class=n>reference</span>  <span class=c1># 应该是裁剪后的目标区域</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 模板匹配</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>matchTemplate</span><span class=p>(</span><span class=n>screenshot</span><span class=p>,</span> <span class=n>template</span><span class=p>,</span> <span class=n>cv2</span><span class=o>.</span><span class=n>TM_CCOEFF_NORMED</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>min_val</span><span class=p>,</span> <span class=n>max_val</span><span class=p>,</span> <span class=n>min_loc</span><span class=p>,</span> <span class=n>max_loc</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>minMaxLoc</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>max_val</span> <span class=o>&gt;</span> <span class=mf>0.8</span><span class=p>:</span>  <span class=c1># 相似度阈值</span>
</span></span><span class=line><span class=cl>            <span class=n>h</span><span class=p>,</span> <span class=n>w</span> <span class=o>=</span> <span class=n>template</span><span class=o>.</span><span class=n>shape</span><span class=p>[:</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>x</span> <span class=o>=</span> <span class=n>max_loc</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=n>w</span> <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>            <span class=n>y</span> <span class=o>=</span> <span class=n>max_loc</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>h</span> <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_locate_by_features</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=n>screenshot</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=n>target</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                            <span class=n>reference</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>int</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;通过特征点匹配定位&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>reference</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 使用 ORB 特征</span>
</span></span><span class=line><span class=cl>        <span class=n>orb</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>ORB_create</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>kp1</span><span class=p>,</span> <span class=n>des1</span> <span class=o>=</span> <span class=n>orb</span><span class=o>.</span><span class=n>detectAndCompute</span><span class=p>(</span><span class=n>reference</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>kp2</span><span class=p>,</span> <span class=n>des2</span> <span class=o>=</span> <span class=n>orb</span><span class=o>.</span><span class=n>detectAndCompute</span><span class=p>(</span><span class=n>screenshot</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>des1</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>or</span> <span class=n>des2</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 匹配特征点</span>
</span></span><span class=line><span class=cl>        <span class=n>bf</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>BFMatcher</span><span class=p>(</span><span class=n>cv2</span><span class=o>.</span><span class=n>NORM_HAMMING</span><span class=p>,</span> <span class=n>crossCheck</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>matches</span> <span class=o>=</span> <span class=n>bf</span><span class=o>.</span><span class=k>match</span><span class=p>(</span><span class=n>des1</span><span class=p>,</span> <span class=n>des2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>matches</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 计算匹配区域的中心</span>
</span></span><span class=line><span class=cl>        <span class=n>good_matches</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>matches</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=o>.</span><span class=n>distance</span><span class=p>)[:</span><span class=mi>20</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>points</span> <span class=o>=</span> <span class=p>[</span><span class=n>kp2</span><span class=p>[</span><span class=n>m</span><span class=o>.</span><span class=n>trainIdx</span><span class=p>]</span><span class=o>.</span><span class=n>pt</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>good_matches</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>([</span><span class=n>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>points</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>([</span><span class=n>p</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>points</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_locate_by_ai</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                      <span class=n>screenshot</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                      <span class=n>target</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                      <span class=n>reference</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>int</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;通过 AI 视觉模型定位&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>vision_model</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>description</span> <span class=o>=</span> <span class=n>target</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;description&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>visual_features</span> <span class=o>=</span> <span class=n>target</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;visual_features&#34;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;在这张屏幕截图中，请找到以下元素并返回其坐标：
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>元素描述：</span><span class=si>{</span><span class=n>description</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>视觉特征：</span><span class=si>{</span><span class=s1>&#39;, &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>visual_features</span><span class=p>)</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>请返回元素中心点的坐标，格式：</span><span class=se>{{</span><span class=s2>&#34;x&#34;: 数字, &#34;y&#34;: 数字</span><span class=se>}}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>如果找不到，返回：</span><span class=se>{{</span><span class=s2>&#34;x&#34;: null, &#34;y&#34;: null</span><span class=se>}}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 调用视觉模型（简化示例）</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>vision_model</span><span class=o>.</span><span class=n>analyze</span><span class=p>(</span><span class=n>screenshot</span><span class=p>,</span> <span class=n>prompt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>response</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;x&#34;</span><span class=p>)</span> <span class=ow>and</span> <span class=n>response</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;y&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>response</span><span class=p>[</span><span class=s2>&#34;x&#34;</span><span class=p>]),</span> <span class=nb>int</span><span class=p>(</span><span class=n>response</span><span class=p>[</span><span class=s2>&#34;y&#34;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by hugo&#39;s coding agent</span>
</span></span></code></pre></div><h3 id=32-动作执行器>3.2 动作执行器</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pyautogui</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ActionExecutor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    动作执行器
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    支持的动作类型：
</span></span></span><span class=line><span class=cl><span class=s2>    - click: 点击
</span></span></span><span class=line><span class=cl><span class=s2>    - double_click: 双击
</span></span></span><span class=line><span class=cl><span class=s2>    - right_click: 右键点击
</span></span></span><span class=line><span class=cl><span class=s2>    - type: 输入文本
</span></span></span><span class=line><span class=cl><span class=s2>    - scroll: 滚动
</span></span></span><span class=line><span class=cl><span class=s2>    - wait: 等待
</span></span></span><span class=line><span class=cl><span class=s2>    - hotkey: 组合键
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>locator</span><span class=p>:</span> <span class=n>VisualElementLocator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>default_timeout</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>10.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>retry_interval</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>locator</span> <span class=o>=</span> <span class=n>locator</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>default_timeout</span> <span class=o>=</span> <span class=n>default_timeout</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>retry_interval</span> <span class=o>=</span> <span class=n>retry_interval</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 配置 pyautogui</span>
</span></span><span class=line><span class=cl>        <span class=n>pyautogui</span><span class=o>.</span><span class=n>PAUSE</span> <span class=o>=</span> <span class=mf>0.1</span>  <span class=c1># 动作间隔</span>
</span></span><span class=line><span class=cl>        <span class=n>pyautogui</span><span class=o>.</span><span class=n>FAILSAFE</span> <span class=o>=</span> <span class=kc>True</span>  <span class=c1># 启用故障安全</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>execute</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>step</span><span class=p>:</span> <span class=n>WorkflowStep</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        执行单个工作流步骤
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            step: 工作流步骤
</span></span></span><span class=line><span class=cl><span class=s2>            context: 执行上下文
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            执行是否成功
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>action</span> <span class=o>=</span> <span class=n>step</span><span class=o>.</span><span class=n>action</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>action_handlers</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;click&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_execute_click</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;double_click&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_execute_double_click</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;right_click&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_execute_right_click</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_execute_type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;scroll&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_execute_scroll</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;wait&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_execute_wait</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;hotkey&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_execute_hotkey</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;verify&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_execute_verify</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>handler</span> <span class=o>=</span> <span class=n>action_handlers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>action</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>handler</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Unknown action: </span><span class=si>{</span><span class=n>action</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>handler</span><span class=p>(</span><span class=n>step</span><span class=p>,</span> <span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Action </span><span class=si>{</span><span class=n>action</span><span class=si>}</span><span class=s2> failed: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_locate_with_retry</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                           <span class=n>target</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                           <span class=n>timeout</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=kc>None</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>int</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;带重试的元素定位&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>timeout</span> <span class=o>=</span> <span class=n>timeout</span> <span class=ow>or</span> <span class=bp>self</span><span class=o>.</span><span class=n>default_timeout</span>
</span></span><span class=line><span class=cl>        <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span> <span class=o>&lt;</span> <span class=n>timeout</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>screenshot</span> <span class=o>=</span> <span class=n>pyautogui</span><span class=o>.</span><span class=n>screenshot</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>screenshot</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>screenshot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>screenshot</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>cvtColor</span><span class=p>(</span><span class=n>screenshot</span><span class=p>,</span> <span class=n>cv2</span><span class=o>.</span><span class=n>COLOR_RGB2BGR</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>position</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>locator</span><span class=o>.</span><span class=n>locate</span><span class=p>(</span><span class=n>screenshot</span><span class=p>,</span> <span class=n>target</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>position</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>position</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>retry_interval</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_execute_click</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>step</span><span class=p>:</span> <span class=n>WorkflowStep</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;执行点击&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>position</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_locate_with_retry</span><span class=p>(</span><span class=n>step</span><span class=o>.</span><span class=n>target</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>position</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Cannot locate element for click: </span><span class=si>{</span><span class=n>step</span><span class=o>.</span><span class=n>target</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>pyautogui</span><span class=o>.</span><span class=n>click</span><span class=p>(</span><span class=n>position</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>position</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_execute_double_click</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>step</span><span class=p>:</span> <span class=n>WorkflowStep</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;执行双击&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>position</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_locate_with_retry</span><span class=p>(</span><span class=n>step</span><span class=o>.</span><span class=n>target</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>position</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>pyautogui</span><span class=o>.</span><span class=n>doubleClick</span><span class=p>(</span><span class=n>position</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>position</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_execute_right_click</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>step</span><span class=p>:</span> <span class=n>WorkflowStep</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;执行右键点击&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>position</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_locate_with_retry</span><span class=p>(</span><span class=n>step</span><span class=o>.</span><span class=n>target</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>position</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>pyautogui</span><span class=o>.</span><span class=n>rightClick</span><span class=p>(</span><span class=n>position</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>position</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_execute_type</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>step</span><span class=p>:</span> <span class=n>WorkflowStep</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;执行输入&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>text</span> <span class=o>=</span> <span class=n>step</span><span class=o>.</span><span class=n>parameters</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;text&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 支持变量替换</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>context</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>{{</span><span class=si>{</span><span class=n>key</span><span class=si>}</span><span class=se>}}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>value</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 如果有目标元素，先点击</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>step</span><span class=o>.</span><span class=n>target</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>position</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_locate_with_retry</span><span class=p>(</span><span class=n>step</span><span class=o>.</span><span class=n>target</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>position</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>pyautogui</span><span class=o>.</span><span class=n>click</span><span class=p>(</span><span class=n>position</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>position</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 使用 pyperclip 处理中文</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>pyperclip</span>
</span></span><span class=line><span class=cl>        <span class=n>pyperclip</span><span class=o>.</span><span class=n>copy</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>pyautogui</span><span class=o>.</span><span class=n>hotkey</span><span class=p>(</span><span class=s1>&#39;ctrl&#39;</span><span class=p>,</span> <span class=s1>&#39;v&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_execute_scroll</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>step</span><span class=p>:</span> <span class=n>WorkflowStep</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;执行滚动&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>direction</span> <span class=o>=</span> <span class=n>step</span><span class=o>.</span><span class=n>parameters</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;direction&#34;</span><span class=p>,</span> <span class=s2>&#34;down&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>amount</span> <span class=o>=</span> <span class=n>step</span><span class=o>.</span><span class=n>parameters</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;amount&#34;</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>direction</span> <span class=o>==</span> <span class=s2>&#34;up&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>pyautogui</span><span class=o>.</span><span class=n>scroll</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>pyautogui</span><span class=o>.</span><span class=n>scroll</span><span class=p>(</span><span class=o>-</span><span class=n>amount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_execute_wait</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>step</span><span class=p>:</span> <span class=n>WorkflowStep</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;执行等待&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>wait_type</span> <span class=o>=</span> <span class=n>step</span><span class=o>.</span><span class=n>parameters</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;type&#34;</span><span class=p>,</span> <span class=s2>&#34;fixed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>wait_type</span> <span class=o>==</span> <span class=s2>&#34;fixed&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>duration</span> <span class=o>=</span> <span class=n>step</span><span class=o>.</span><span class=n>parameters</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;duration&#34;</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>wait_type</span> <span class=o>==</span> <span class=s2>&#34;smart&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 智能等待：等待页面稳定</span>
</span></span><span class=line><span class=cl>            <span class=n>max_timeout</span> <span class=o>=</span> <span class=n>step</span><span class=o>.</span><span class=n>parameters</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;max_timeout&#34;</span><span class=p>,</span> <span class=mf>5.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_wait_for_stable</span><span class=p>(</span><span class=n>max_timeout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>wait_type</span> <span class=o>==</span> <span class=s2>&#34;element&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 等待元素出现</span>
</span></span><span class=line><span class=cl>            <span class=n>target</span> <span class=o>=</span> <span class=n>step</span><span class=o>.</span><span class=n>parameters</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;target&#34;</span><span class=p>,</span> <span class=n>step</span><span class=o>.</span><span class=n>target</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>max_timeout</span> <span class=o>=</span> <span class=n>step</span><span class=o>.</span><span class=n>parameters</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;max_timeout&#34;</span><span class=p>,</span> <span class=mf>10.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_locate_with_retry</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=n>max_timeout</span><span class=p>)</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_wait_for_stable</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>timeout</span><span class=p>:</span> <span class=nb>float</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;等待页面稳定（画面不再变化）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>prev_screenshot</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=n>stable_count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span> <span class=o>&lt;</span> <span class=n>timeout</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>screenshot</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>pyautogui</span><span class=o>.</span><span class=n>screenshot</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>prev_screenshot</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 比较两帧</span>
</span></span><span class=line><span class=cl>                <span class=n>diff</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>screenshot</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>float</span><span class=p>)</span> <span class=o>-</span> <span class=n>prev_screenshot</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>float</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>change_ratio</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>diff</span><span class=p>)</span> <span class=o>/</span> <span class=mf>255.0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>change_ratio</span> <span class=o>&lt;</span> <span class=mf>0.01</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>stable_count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>stable_count</span> <span class=o>&gt;=</span> <span class=mi>3</span><span class=p>:</span>  <span class=c1># 连续3次稳定</span>
</span></span><span class=line><span class=cl>                        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>stable_count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>prev_screenshot</span> <span class=o>=</span> <span class=n>screenshot</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>  <span class=c1># 超时也返回 True，继续执行</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_execute_hotkey</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>step</span><span class=p>:</span> <span class=n>WorkflowStep</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;执行组合键&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>keys</span> <span class=o>=</span> <span class=n>step</span><span class=o>.</span><span class=n>parameters</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;keys&#34;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>keys</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>pyautogui</span><span class=o>.</span><span class=n>hotkey</span><span class=p>(</span><span class=o>*</span><span class=n>keys</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_execute_verify</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>step</span><span class=p>:</span> <span class=n>WorkflowStep</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;执行验证&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>condition</span> <span class=o>=</span> <span class=n>step</span><span class=o>.</span><span class=n>parameters</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;condition&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>condition</span> <span class=o>==</span> <span class=s2>&#34;element_exists&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>target</span> <span class=o>=</span> <span class=n>step</span><span class=o>.</span><span class=n>parameters</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;target&#34;</span><span class=p>,</span> <span class=n>step</span><span class=o>.</span><span class=n>target</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_locate_with_retry</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mf>3.0</span><span class=p>)</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>condition</span> <span class=o>==</span> <span class=s2>&#34;text_visible&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>expected_text</span> <span class=o>=</span> <span class=n>step</span><span class=o>.</span><span class=n>parameters</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;expected_text&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 使用 OCR 验证文本</span>
</span></span><span class=line><span class=cl>            <span class=n>screenshot</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>pyautogui</span><span class=o>.</span><span class=n>screenshot</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=c1># ... OCR 验证逻辑</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by hugo&#39;s coding agent</span>
</span></span></code></pre></div><h2 id=step-4-工作流编排与调度>Step 4: 工作流编排与调度</h2><h3 id=41-工作流运行器>4.1 工作流运行器</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>enum</span> <span class=kn>import</span> <span class=n>Enum</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span><span class=p>,</span> <span class=n>field</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Callable</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span><span class=p>,</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ExecutionStatus</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>PENDING</span> <span class=o>=</span> <span class=s2>&#34;pending&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>RUNNING</span> <span class=o>=</span> <span class=s2>&#34;running&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>SUCCESS</span> <span class=o>=</span> <span class=s2>&#34;success&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>FAILED</span> <span class=o>=</span> <span class=s2>&#34;failed&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>CANCELLED</span> <span class=o>=</span> <span class=s2>&#34;cancelled&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ExecutionResult</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;执行结果&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>workflow_name</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span><span class=p>:</span> <span class=n>ExecutionStatus</span>
</span></span><span class=line><span class=cl>    <span class=n>steps_completed</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>total_steps</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>error_message</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>execution_time</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.0</span>
</span></span><span class=line><span class=cl>    <span class=n>step_results</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]</span> <span class=o>=</span> <span class=n>field</span><span class=p>(</span><span class=n>default_factory</span><span class=o>=</span><span class=nb>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>WorkflowRunner</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    工作流运行器
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    功能：
</span></span></span><span class=line><span class=cl><span class=s2>    - 执行工作流
</span></span></span><span class=line><span class=cl><span class=s2>    - 错误处理与重试
</span></span></span><span class=line><span class=cl><span class=s2>    - 断点恢复
</span></span></span><span class=line><span class=cl><span class=s2>    - 执行日志
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>executor</span><span class=p>:</span> <span class=n>ActionExecutor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>max_retries</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>screenshot_on_error</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>executor</span> <span class=o>=</span> <span class=n>executor</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>max_retries</span> <span class=o>=</span> <span class=n>max_retries</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>screenshot_on_error</span> <span class=o>=</span> <span class=n>screenshot_on_error</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=s2>&#34;WorkflowRunner&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_callbacks</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>List</span><span class=p>[</span><span class=n>Callable</span><span class=p>]]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;on_step_start&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;on_step_complete&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;on_step_error&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;on_workflow_complete&#34;</span><span class=p>:</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>register_callback</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>callback</span><span class=p>:</span> <span class=n>Callable</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;注册回调函数&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>event</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_callbacks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_callbacks</span><span class=p>[</span><span class=n>event</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>callback</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_emit</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;触发事件&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>callback</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_callbacks</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=p>[]):</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>callback</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Callback error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>workflow</span><span class=p>:</span> <span class=n>Workflow</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>start_from</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ExecutionResult</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        运行工作流
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            workflow: 工作流定义
</span></span></span><span class=line><span class=cl><span class=s2>            context: 执行上下文（变量）
</span></span></span><span class=line><span class=cl><span class=s2>            start_from: 从第几步开始（用于断点恢复）
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            执行结果
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span> <span class=o>=</span> <span class=n>context</span> <span class=ow>or</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>step_results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Starting workflow: </span><span class=si>{</span><span class=n>workflow</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 检查前置条件</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>_check_preconditions</span><span class=p>(</span><span class=n>workflow</span><span class=o>.</span><span class=n>preconditions</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>ExecutionResult</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>workflow_name</span><span class=o>=</span><span class=n>workflow</span><span class=o>.</span><span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>status</span><span class=o>=</span><span class=n>ExecutionStatus</span><span class=o>.</span><span class=n>FAILED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>steps_completed</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>total_steps</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>workflow</span><span class=o>.</span><span class=n>steps</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>error_message</span><span class=o>=</span><span class=s2>&#34;Preconditions not met&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 执行步骤</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>step</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>workflow</span><span class=o>.</span><span class=n>steps</span><span class=p>[</span><span class=n>start_from</span><span class=p>:],</span> <span class=n>start</span><span class=o>=</span><span class=n>start_from</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>step_start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_emit</span><span class=p>(</span><span class=s2>&#34;on_step_start&#34;</span><span class=p>,</span> <span class=n>step</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>success</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            <span class=n>error_msg</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 重试逻辑</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>attempt</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>max_retries</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>success</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>executor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>step</span><span class=p>,</span> <span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>success</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=k>break</span>
</span></span><span class=line><span class=cl>                <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>error_msg</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Step </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2> attempt </span><span class=si>{</span><span class=n>attempt</span> <span class=o>+</span> <span class=mi>1</span><span class=si>}</span><span class=s2> failed: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>attempt</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_retries</span> <span class=o>-</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>1.0</span><span class=p>)</span>  <span class=c1># 重试前等待</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>step_result</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;step_id&#34;</span><span class=p>:</span> <span class=n>step</span><span class=o>.</span><span class=n>step_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;action&#34;</span><span class=p>:</span> <span class=n>step</span><span class=o>.</span><span class=n>action</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;success&#34;</span><span class=p>:</span> <span class=n>success</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;duration&#34;</span><span class=p>:</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>step_start</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=n>error_msg</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>step_results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>step_result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>success</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>_emit</span><span class=p>(</span><span class=s2>&#34;on_step_complete&#34;</span><span class=p>,</span> <span class=n>step</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>step_result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Step </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2> completed: </span><span class=si>{</span><span class=n>step</span><span class=o>.</span><span class=n>action</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>_emit</span><span class=p>(</span><span class=s2>&#34;on_step_error&#34;</span><span class=p>,</span> <span class=n>step</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>error_msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Step </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2> failed: </span><span class=si>{</span><span class=n>step</span><span class=o>.</span><span class=n>action</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 保存错误截图</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>screenshot_on_error</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>_save_error_screenshot</span><span class=p>(</span><span class=n>workflow</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 应用错误处理策略</span>
</span></span><span class=line><span class=cl>                <span class=n>should_continue</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_handle_error</span><span class=p>(</span><span class=n>workflow</span><span class=p>,</span> <span class=n>step</span><span class=p>,</span> <span class=n>error_msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=ow>not</span> <span class=n>should_continue</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>ExecutionResult</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>workflow_name</span><span class=o>=</span><span class=n>workflow</span><span class=o>.</span><span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>status</span><span class=o>=</span><span class=n>ExecutionStatus</span><span class=o>.</span><span class=n>FAILED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>steps_completed</span><span class=o>=</span><span class=n>i</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>total_steps</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>workflow</span><span class=o>.</span><span class=n>steps</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                        <span class=n>error_message</span><span class=o>=</span><span class=n>error_msg</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>execution_time</span><span class=o>=</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>step_results</span><span class=o>=</span><span class=n>step_results</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>ExecutionResult</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>workflow_name</span><span class=o>=</span><span class=n>workflow</span><span class=o>.</span><span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>status</span><span class=o>=</span><span class=n>ExecutionStatus</span><span class=o>.</span><span class=n>SUCCESS</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>steps_completed</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>workflow</span><span class=o>.</span><span class=n>steps</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>total_steps</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>workflow</span><span class=o>.</span><span class=n>steps</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>execution_time</span><span class=o>=</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>step_results</span><span class=o>=</span><span class=n>step_results</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_emit</span><span class=p>(</span><span class=s2>&#34;on_workflow_complete&#34;</span><span class=p>,</span> <span class=n>workflow</span><span class=p>,</span> <span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Workflow completed: </span><span class=si>{</span><span class=n>workflow</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_check_preconditions</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>preconditions</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;检查前置条件&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 简化实现，实际应该有更复杂的条件检查</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_handle_error</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                      <span class=n>workflow</span><span class=p>:</span> <span class=n>Workflow</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                      <span class=n>step</span><span class=p>:</span> <span class=n>WorkflowStep</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                      <span class=n>error</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理错误，返回是否继续执行&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>error_handling</span> <span class=o>=</span> <span class=n>workflow</span><span class=o>.</span><span class=n>error_handling</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34;element_not_found&#34;</span> <span class=ow>in</span> <span class=n>error</span><span class=o>.</span><span class=n>lower</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>strategy</span> <span class=o>=</span> <span class=n>error_handling</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;element_not_found&#34;</span><span class=p>,</span> <span class=s2>&#34;stop&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=s2>&#34;timeout&#34;</span> <span class=ow>in</span> <span class=n>error</span><span class=o>.</span><span class=n>lower</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>strategy</span> <span class=o>=</span> <span class=n>error_handling</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;timeout&#34;</span><span class=p>,</span> <span class=s2>&#34;stop&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>strategy</span> <span class=o>=</span> <span class=n>error_handling</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;default&#34;</span><span class=p>,</span> <span class=s2>&#34;stop&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>strategy</span> <span class=o>==</span> <span class=s2>&#34;skip&#34;</span> <span class=ow>or</span> <span class=n>strategy</span> <span class=o>==</span> <span class=s2>&#34;continue&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_save_error_screenshot</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>workflow_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>step_index</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;保存错误截图&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=s2>&#34;error_screenshots&#34;</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>timestamp</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&#34;%Y%m</span><span class=si>%d</span><span class=s2>_%H%M%S&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>path</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;error_screenshots/</span><span class=si>{</span><span class=n>workflow_name</span><span class=si>}</span><span class=s2>_</span><span class=si>{</span><span class=n>step_index</span><span class=si>}</span><span class=s2>_</span><span class=si>{</span><span class=n>timestamp</span><span class=si>}</span><span class=s2>.png&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>screenshot</span> <span class=o>=</span> <span class=n>pyautogui</span><span class=o>.</span><span class=n>screenshot</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>screenshot</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error screenshot saved: </span><span class=si>{</span><span class=n>path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by hugo&#39;s coding agent</span>
</span></span></code></pre></div><h3 id=42-调度器>4.2 调度器</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>apscheduler.schedulers.background</span> <span class=kn>import</span> <span class=n>BackgroundScheduler</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>apscheduler.triggers.cron</span> <span class=kn>import</span> <span class=n>CronTrigger</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>apscheduler.triggers.interval</span> <span class=kn>import</span> <span class=n>IntervalTrigger</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>WorkflowScheduler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    工作流调度器
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    支持：
</span></span></span><span class=line><span class=cl><span class=s2>    - Cron 表达式调度
</span></span></span><span class=line><span class=cl><span class=s2>    - 间隔调度
</span></span></span><span class=line><span class=cl><span class=s2>    - 事件触发
</span></span></span><span class=line><span class=cl><span class=s2>    - 手动触发
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>runner</span><span class=p>:</span> <span class=n>WorkflowRunner</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>runner</span> <span class=o>=</span> <span class=n>runner</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>scheduler</span> <span class=o>=</span> <span class=n>BackgroundScheduler</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>workflows</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Workflow</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>register_workflow</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>workflow</span><span class=p>:</span> <span class=n>Workflow</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;注册工作流&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>workflows</span><span class=p>[</span><span class=n>workflow</span><span class=o>.</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=n>workflow</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>schedule_cron</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                      <span class=n>workflow_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                      <span class=n>cron_expression</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                      <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        使用 Cron 表达式调度
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            workflow_name: 工作流名称
</span></span></span><span class=line><span class=cl><span class=s2>            cron_expression: Cron 表达式（如 &#34;0 9 * * *&#34; 每天9点）
</span></span></span><span class=line><span class=cl><span class=s2>            context: 执行上下文
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>workflow</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>workflows</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>workflow_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>workflow</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Workflow not found: </span><span class=si>{</span><span class=n>workflow_name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>parts</span> <span class=o>=</span> <span class=n>cron_expression</span><span class=o>.</span><span class=n>split</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>trigger</span> <span class=o>=</span> <span class=n>CronTrigger</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>minute</span><span class=o>=</span><span class=n>parts</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>hour</span><span class=o>=</span><span class=n>parts</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>day</span><span class=o>=</span><span class=n>parts</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>month</span><span class=o>=</span><span class=n>parts</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>day_of_week</span><span class=o>=</span><span class=n>parts</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>scheduler</span><span class=o>.</span><span class=n>add_job</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>func</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_run_workflow</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>trigger</span><span class=o>=</span><span class=n>trigger</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>args</span><span class=o>=</span><span class=p>[</span><span class=n>workflow_name</span><span class=p>,</span> <span class=n>context</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=nb>id</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;cron_</span><span class=si>{</span><span class=n>workflow_name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>replace_existing</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>schedule_interval</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                          <span class=n>workflow_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                          <span class=n>hours</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                          <span class=n>minutes</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                          <span class=n>seconds</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                          <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        间隔调度
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            workflow_name: 工作流名称
</span></span></span><span class=line><span class=cl><span class=s2>            hours, minutes, seconds: 间隔时间
</span></span></span><span class=line><span class=cl><span class=s2>            context: 执行上下文
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>workflow</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>workflows</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>workflow_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>workflow</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Workflow not found: </span><span class=si>{</span><span class=n>workflow_name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>trigger</span> <span class=o>=</span> <span class=n>IntervalTrigger</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>hours</span><span class=o>=</span><span class=n>hours</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>minutes</span><span class=o>=</span><span class=n>minutes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>seconds</span><span class=o>=</span><span class=n>seconds</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>scheduler</span><span class=o>.</span><span class=n>add_job</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>func</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_run_workflow</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>trigger</span><span class=o>=</span><span class=n>trigger</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>args</span><span class=o>=</span><span class=p>[</span><span class=n>workflow_name</span><span class=p>,</span> <span class=n>context</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=nb>id</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;interval_</span><span class=si>{</span><span class=n>workflow_name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>replace_existing</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_run_workflow</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>workflow_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;执行工作流&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>workflow</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>workflows</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>workflow_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>workflow</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>runner</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>workflow</span><span class=p>,</span> <span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Workflow </span><span class=si>{</span><span class=n>workflow_name</span><span class=si>}</span><span class=s2> completed: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>status</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>start</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;启动调度器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>scheduler</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Scheduler started&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>stop</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;停止调度器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>scheduler</span><span class=o>.</span><span class=n>shutdown</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Scheduler stopped&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run_now</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>workflow_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;立即运行工作流&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_run_workflow</span><span class=p>(</span><span class=n>workflow_name</span><span class=p>,</span> <span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by hugo&#39;s coding agent</span>
</span></span></code></pre></div><h2 id=完整使用示例>完整使用示例</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;完整的录屏 RPA 使用示例&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 1. 录制用户操作</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== 步骤 1: 录制操作 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>recorder</span> <span class=o>=</span> <span class=n>ScreenRecorder</span><span class=p>(</span><span class=n>output_dir</span><span class=o>=</span><span class=s2>&#34;./recordings&#34;</span><span class=p>,</span> <span class=n>fps</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;按 Enter 开始录制，再次按 Enter 停止...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>video_path</span> <span class=o>=</span> <span class=n>recorder</span><span class=o>.</span><span class=n>start_recording</span><span class=p>(</span><span class=s2>&#34;demo_workflow&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;正在录制... 按 Enter 停止&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>session</span> <span class=o>=</span> <span class=n>recorder</span><span class=o>.</span><span class=n>stop_recording</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 2. 提取关键帧</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 步骤 2: 提取关键帧 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>extractor</span> <span class=o>=</span> <span class=n>KeyFrameExtractor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>keyframes</span> <span class=o>=</span> <span class=n>extractor</span><span class=o>.</span><span class=n>extract</span><span class=p>(</span><span class=n>session</span><span class=o>.</span><span class=n>video_path</span><span class=p>,</span> <span class=n>session</span><span class=o>.</span><span class=n>events</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 3. AI 分析操作</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 步骤 3: AI 分析 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>analyzer</span> <span class=o>=</span> <span class=n>OperationAnalyzer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>model_provider</span><span class=o>=</span><span class=s2>&#34;openai&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>api_key</span><span class=o>=</span><span class=s2>&#34;your-api-key&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>raw_workflow</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>analyze</span><span class=p>(</span><span class=n>keyframes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 4. 优化工作流</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 步骤 4: 优化工作流 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>optimizer</span> <span class=o>=</span> <span class=n>WorkflowOptimizer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>workflow</span> <span class=o>=</span> <span class=n>optimizer</span><span class=o>.</span><span class=n>optimize</span><span class=p>(</span><span class=n>raw_workflow</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;工作流: </span><span class=si>{</span><span class=n>workflow</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;步骤数: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>workflow</span><span class=o>.</span><span class=n>steps</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>step</span> <span class=ow>in</span> <span class=n>workflow</span><span class=o>.</span><span class=n>steps</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>step</span><span class=o>.</span><span class=n>step_id</span><span class=si>}</span><span class=s2>. </span><span class=si>{</span><span class=n>step</span><span class=o>.</span><span class=n>action</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>step</span><span class=o>.</span><span class=n>target</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;description&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 5. 保存工作流</span>
</span></span><span class=line><span class=cl>    <span class=n>workflow_path</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;./workflows/</span><span class=si>{</span><span class=n>workflow</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>.json&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>save_workflow</span><span class=p>(</span><span class=n>workflow</span><span class=p>,</span> <span class=n>workflow_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 6. 执行工作流</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 步骤 5: 执行工作流 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>locator</span> <span class=o>=</span> <span class=n>VisualElementLocator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>executor</span> <span class=o>=</span> <span class=n>ActionExecutor</span><span class=p>(</span><span class=n>locator</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>runner</span> <span class=o>=</span> <span class=n>WorkflowRunner</span><span class=p>(</span><span class=n>executor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 添加回调</span>
</span></span><span class=line><span class=cl>    <span class=n>runner</span><span class=o>.</span><span class=n>register_callback</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;on_step_complete&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=k>lambda</span> <span class=n>step</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>result</span><span class=p>:</span> <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  ✓ Step </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>step</span><span class=o>.</span><span class=n>action</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>runner</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>workflow</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>执行结果: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>status</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;完成步骤: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>steps_completed</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>total_steps</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;耗时: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>execution_time</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>s&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 7. 设置定时任务（可选）</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 步骤 6: 设置调度 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>scheduler</span> <span class=o>=</span> <span class=n>WorkflowScheduler</span><span class=p>(</span><span class=n>runner</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>scheduler</span><span class=o>.</span><span class=n>register_workflow</span><span class=p>(</span><span class=n>workflow</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 每天早上9点执行</span>
</span></span><span class=line><span class=cl>    <span class=n>scheduler</span><span class=o>.</span><span class=n>schedule_cron</span><span class=p>(</span><span class=n>workflow</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=s2>&#34;0 9 * * *&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>scheduler</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;调度已启动，按 Ctrl+C 退出&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>KeyboardInterrupt</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>scheduler</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by hugo&#39;s coding agent</span>
</span></span></code></pre></div><h2 id=最佳实践总结>最佳实践总结</h2><h3 id=录制阶段>录制阶段</h3><ol><li><strong>稳定的操作节奏</strong>：录制时保持适度的操作速度，避免过快</li><li><strong>明确的等待</strong>：在页面加载后稍作停顿，让系统捕获完整状态</li><li><strong>避免拖拽</strong>：拖拽操作识别困难，尽量使用点击替代</li><li><strong>一致的窗口状态</strong>：保持窗口最大化，避免尺寸变化</li></ol><h3 id=分析阶段>分析阶段</h3><ol><li><strong>提供业务上下文</strong>：让 AI 理解操作的业务意义</li><li><strong>验证生成的流程</strong>：人工检查 AI 生成的步骤是否完整</li><li><strong>添加异常处理</strong>：为可能失败的步骤定义降级策略</li></ol><h3 id=执行阶段>执行阶段</h3><ol><li><strong>智能等待</strong>：使用页面稳定检测而非固定延时</li><li><strong>多策略定位</strong>：结合文本、视觉、语义多种方式</li><li><strong>错误恢复</strong>：实现断点续执行能力</li><li><strong>日志记录</strong>：详细记录每步执行情况</li></ol><h3 id=运维阶段>运维阶段</h3><ol><li><strong>监控告警</strong>：实时监控执行状态，失败时及时告警</li><li><strong>版本管理</strong>：工作流定义纳入版本控制</li><li><strong>定期校验</strong>：UI 变化后及时更新工作流</li><li><strong>性能优化</strong>：分析执行日志，优化慢操作</li></ol><h2 id=结语>结语</h2><p>通过桌面录屏实现 RPA 自动化，本质上是将人类的操作经验转化为可执行的自动化流程。这种方式结合了多模态 AI 的理解能力和传统 RPA 的执行能力，让自动化变得更加智能和易用。</p><p>随着视觉语言模型的发展，未来的 RPA 系统将能够：</p><ul><li>理解更复杂的操作意图</li><li>自动适应 UI 变化</li><li>处理更多异常情况</li><li>实现真正的"所见即所得"自动化</li></ul><p>这不仅降低了自动化的技术门槛，也为企业数字化转型提供了新的可能。</p><div class=blog-tags><a href=https://hugozhu.site/tags/rpa/>RPA</a>&nbsp;
<a href=https://hugozhu.site/tags/ai/>AI</a>&nbsp;
<a href=https://hugozhu.site/tags/automation/>automation</a>&nbsp;
<a href=https://hugozhu.site/tags/computer-vision/>computer-vision</a>&nbsp;
<a href=https://hugozhu.site/tags/multimodal/>multimodal</a>&nbsp;
<a href=https://hugozhu.site/tags/screen-recording/>screen-recording</a>&nbsp;</div><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fhugozhu.site%2fpost%2f2026%2f121-desktop-screen-recording-rpa-best-practices%2f&amp;text=%e9%80%9a%e8%bf%87%e6%a1%8c%e9%9d%a2%e5%bd%95%e5%b1%8f%e5%ae%9e%e7%8e%b0%e8%87%aa%e5%8a%a8%e5%8c%96%20RPA%20%e7%9a%84%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5&amp;via=" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fhugozhu.site%2fpost%2f2026%2f121-desktop-screen-recording-rpa-best-practices%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fhugozhu.site%2fpost%2f2026%2f121-desktop-screen-recording-rpa-best-practices%2f&amp;title=%e9%80%9a%e8%bf%87%e6%a1%8c%e9%9d%a2%e5%bd%95%e5%b1%8f%e5%ae%9e%e7%8e%b0%e8%87%aa%e5%8a%a8%e5%8c%96%20RPA%20%e7%9a%84%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fhugozhu.site%2fpost%2f2026%2f121-desktop-screen-recording-rpa-best-practices%2f&amp;title=%e9%80%9a%e8%bf%87%e6%a1%8c%e9%9d%a2%e5%bd%95%e5%b1%8f%e5%ae%9e%e7%8e%b0%e8%87%aa%e5%8a%a8%e5%8c%96%20RPA%20%e7%9a%84%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fhugozhu.site%2fpost%2f2026%2f121-desktop-screen-recording-rpa-best-practices%2f&amp;title=%e9%80%9a%e8%bf%87%e6%a1%8c%e9%9d%a2%e5%bd%95%e5%b1%8f%e5%ae%9e%e7%8e%b0%e8%87%aa%e5%8a%a8%e5%8c%96%20RPA%20%e7%9a%84%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fhugozhu.site%2fpost%2f2026%2f121-desktop-screen-recording-rpa-best-practices%2f&amp;description=%e9%80%9a%e8%bf%87%e6%a1%8c%e9%9d%a2%e5%bd%95%e5%b1%8f%e5%ae%9e%e7%8e%b0%e8%87%aa%e5%8a%a8%e5%8c%96%20RPA%20%e7%9a%84%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" target=_blank title="Share on Pinterest"><i class="fab fa-pinterest"></i></a></li></ul></div></div></section><h4 class=see-also>See also</h4><ul><li><a href=/post/2026/118-clawdbot-personal-ai-assistant/>Clawdbot：运行在你自己设备上的个人AI助手</a></li><li><a href=/post/2026/117-how-to-benchmark-meeting-minutes-agent/>如何对会议纪要 Agent 进行 Benchmark？完整指南与实践</a></li><li><a href=/post/2026/114-agent-reinforcement-learning-best-practices/>Agent强化学习的最佳实践：并行任务处理与性能优化</a></li><li><a href=/post/2026/116-notebooklm-key-capabilities-and-architecture/>NotebookLM的核心能力与构建之道</a></li><li><a href=/post/2026/115-zhipu-slime-enterprise-ai-value/>智谱开源Slime：企业AI应用的强化学习利器</a></li></ul></article><ul class="pager blog-pager"><li class=previous><a href=https://hugozhu.site/post/2026/119-building-pwa-notepad-with-claude-code/ data-toggle=tooltip data-placement=top title="用 Claude Code 从零构建离线记事本 PWA 应用">&larr; Previous Post</a></li><li class=next><a href=https://hugozhu.site/post/2026/120-build-code-llm-from-scratch/ data-toggle=tooltip data-placement=top title="Step-by-Step 实现一个能编程的大模型">Next Post &rarr;</a></li></ul><div class=disqus-comments><button id=show-comments class="btn btn-default" type=button>Show <span class=disqus-comment-count data-disqus-url=https://hugozhu.site/post/2026/121-desktop-screen-recording-rpa-best-practices>comments</span></button><div id=disqus_thread></div><script type=text/javascript>var disqus_config=function(){this.page.url="https://hugozhu.site/post/2026/121-desktop-screen-recording-rpa-best-practices"}</script></div></div></div></div><footer><div class=container><div class=row><div class=disclaimer><b>Disclaimer:</b> The opinions expressed herein are my own personal opinions and do not represent my company’s view in any way.</div></div><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"></ul><p class="credits copyright text-muted">&nbsp;&bull;&nbsp;&copy;
2026
&nbsp;&bull;&nbsp;
<a href=https://hugozhu.site/>All about Raspberry Pi</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.145.0</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js integrity=sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script><script src=https://code.jquery.com/jquery-3.7.0.slim.min.js integrity=sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js integrity=sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd crossorigin=anonymous></script><script src=https://hugozhu.site/js/main.js></script><script src=https://hugozhu.site/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0")})</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://hugozhu.site/js/load-photoswipe.js></script><script>(function(){var t,n="617d351a633194d48",e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://cse.google.com/cse.js?cx="+n,t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script><script type=text/javascript>$(function(){$("#show-comments").on("click",function(){var e="hugozhu";(function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="//"+e+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(t)})(),$(this).hide()})})</script><script id=dsq-count-scr src=//hugozhu.disqus.com/count.js async></script></body></html>