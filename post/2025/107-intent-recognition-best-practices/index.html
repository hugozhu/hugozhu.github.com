<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>意图识别模块实现的最佳实践 - Hugo Zhu's Blog</title>
<meta name=description content="构建高效、可扩展的 AI 意图识别系统"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"All about Raspberry Pi","url":"https:\/\/blog.hugozhu.site\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/blog.hugozhu.site\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/blog.hugozhu.site\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/blog.hugozhu.site\/post\/2025\/107-intent-recognition-best-practices\/","name":"意图识别模块实现的最佳实践"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":""},"headline":"意图识别模块实现的最佳实践","description":"在构建智能对话系统、聊天机器人或语音助手时，意图识别（Intent Recognition）是最核心的组件之一。一个设计良好的意图识别模块不仅能准确理解用户需求，还能随着业务发展灵活扩展。本文将深入探讨意图识别模块实现的最佳实践，帮助你构建生产级的意图识别系统。\n","inLanguage":"en","wordCount":1644,"datePublished":"2025-12-19T00:00:00\u002b00:00","dateModified":"2025-12-19T00:00:00\u002b00:00","image":"https:\/\/blog.hugozhu.site\/img\/pi.png","keywords":["AI, NLP, intent-recognition, machine-learning, LLM, best-practices"],"mainEntityOfPage":"https:\/\/blog.hugozhu.site\/post\/2025\/107-intent-recognition-best-practices\/","publisher":{"@type":"Organization","name":"https:\/\/blog.hugozhu.site\/","logo":{"@type":"ImageObject","url":"https:\/\/blog.hugozhu.site\/img\/pi.png","height":60,"width":60}}}</script><meta property="og:title" content="意图识别模块实现的最佳实践"><meta property="og:description" content="构建高效、可扩展的 AI 意图识别系统"><meta property="og:image" content="https://blog.hugozhu.site/img/pi.png"><meta property="og:url" content="https://blog.hugozhu.site/post/2025/107-intent-recognition-best-practices/"><meta property="og:type" content="website"><meta property="og:site_name" content="All about Raspberry Pi"><meta name=twitter:title content="意图识别模块实现的最佳实践"><meta name=twitter:description content="构建高效、可扩展的 AI 意图识别系统"><meta name=twitter:image content="https://blog.hugozhu.site/img/pi.png"><meta name=twitter:card content="summary_large_image"><link href=https://blog.hugozhu.site/img/pi.ico rel=icon type=image/x-icon><meta name=generator content="Hugo 0.145.0"><link rel=alternate href=https://blog.hugozhu.site/index.xml type=application/rss+xml title="All about Raspberry Pi"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css integrity=sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v6.6.0/css/all.css integrity=sha384-h/hnnw1Bi4nbpD6kE7nYfCXzovi622sY5WBxww8ARKwpdLj5kUWjRuyiXaD1U2JT crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css integrity=sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu crossorigin=anonymous><link rel=stylesheet href=https://blog.hugozhu.site/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://blog.hugozhu.site/css/highlight.min.css><link rel=stylesheet href=https://blog.hugozhu.site/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><script async src="https://www.googletagmanager.com/gtag/js?id=GTM-W88HDMN"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","GTM-W88HDMN")}</script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=https://blog.hugozhu.site/>All about Raspberry Pi</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Blog href=/>Blog</a></li><li class=navlinks-container><a class=navlinks-parent role=button tabindex=0>Tools</a><div class=navlinks-children><a href=https://nddapp.com/json-encoder.html>HTML Tools</a>
<a href=https://www.birme.net/>Imaeg Resizing</a>
<a href=https://jwt.io/>JWT Token Tool</a></div></li><li><a title=About href=/page/about/>About</a></li><li><a title=Tags href=/tags>Tags</a></li><li><a href=#modalSearch data-toggle=modal data-target=#modalSearch style=outline:none><span class="hidden-sm hidden-md hidden-lg">Search</span> <span id=searchGlyph class="glyphicon glyphicon-search"></span></a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title="All about Raspberry Pi" href=https://blog.hugozhu.site/><img class=avatar-img src=https://blog.hugozhu.site/img/pi.png alt="All about Raspberry Pi"></a></div></div></div></nav><div id=modalSearch class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><button type=button class=close data-dismiss=modal>&#215;</button><h4 class=modal-title>Search All about Raspberry Pi</h4></div><div class=modal-body><gcse:search></gcse:search></div><div class=modal-footer><button type=button class="btn btn-default" data-dismiss=modal>Close</button></div></div></div></div><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>意图识别模块实现的最佳实践</h1><h2 class=post-subheading>构建高效、可扩展的 AI 意图识别系统</h2><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on December 19, 2025
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;8&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;1644&nbsp;words</span></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><h4><i>目录:</i></h4><nav id=TableOfContents><ul><li><a href=#为什么意图识别如此重要>为什么意图识别如此重要？</a></li><li><a href=#核心架构设计>核心架构设计</a><ul><li><a href=#1-分层架构模式>1. 分层架构模式</a></li><li><a href=#2-接口设计示例>2. 接口设计示例</a></li></ul></li><li><a href=#技术实现方案选择>技术实现方案选择</a><ul><li><a href=#方案一基于规则的方法>方案一：基于规则的方法</a></li><li><a href=#方案二基于传统机器学习>方案二：基于传统机器学习</a></li><li><a href=#方案三基于深度学习推荐>方案三：基于深度学习（推荐）</a></li><li><a href=#方案四基于大语言模型llm>方案四：基于大语言模型（LLM）</a></li></ul></li><li><a href=#生产环境最佳实践>生产环境最佳实践</a><ul><li><a href=#1-混合策略多模型融合>1. 混合策略：多模型融合</a></li><li><a href=#2-置信度阈值和回退策略>2. 置信度阈值和回退策略</a></li><li><a href=#3-槽位提取集成>3. 槽位提取集成</a></li><li><a href=#4-性能优化>4. 性能优化</a></li><li><a href=#5-监控和日志>5. 监控和日志</a></li></ul></li><li><a href=#评估和持续优化>评估和持续优化</a><ul><li><a href=#1-评估指标>1. 评估指标</a></li><li><a href=#2-ab测试框架>2. A/B测试框架</a></li></ul></li><li><a href=#常见陷阱和解决方案>常见陷阱和解决方案</a><ul><li><a href=#陷阱1过度依赖准确率>陷阱1：过度依赖准确率</a></li><li><a href=#陷阱2忽视长尾意图>陷阱2：忽视长尾意图</a></li><li><a href=#陷阱3静态模型不更新>陷阱3：静态模型不更新</a></li><li><a href=#陷阱4忽视延迟优化>陷阱4：忽视延迟优化</a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav><p>在构建智能对话系统、聊天机器人或语音助手时，意图识别（Intent Recognition）是最核心的组件之一。一个设计良好的意图识别模块不仅能准确理解用户需求，还能随着业务发展灵活扩展。本文将深入探讨意图识别模块实现的最佳实践，帮助你构建生产级的意图识别系统。</p><h2 id=为什么意图识别如此重要>为什么意图识别如此重要？</h2><p>想象用户说"帮我订一张明天去上海的机票"。这句话背后隐藏着明确的意图（book_flight）和多个关键信息（目的地、时间）。意图识别模块的任务就是准确捕获这个意图，并为后续的对话流程和业务逻辑提供基础。</p><p>一个优秀的意图识别系统应该具备：</p><ul><li><strong>高准确率</strong>：正确理解用户真实意图</li><li><strong>低延迟</strong>：快速响应，不影响用户体验</li><li><strong>可扩展性</strong>：轻松添加新意图和场景</li><li><strong>鲁棒性</strong>：处理口语化、有歧义或异常输入</li><li><strong>可解释性</strong>：理解为何做出某个预测</li></ul><h2 id=核心架构设计>核心架构设计</h2><h3 id=1-分层架构模式>1. 分层架构模式</h3><p>一个健壮的意图识别模块应采用分层设计：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>用户输入 → 预处理层 → 意图分类层 → 后处理层 → 意图结果
</span></span><span class=line><span class=cl>              ↓            ↓            ↓
</span></span><span class=line><span class=cl>          文本清洗      模型推理      置信度过滤
</span></span><span class=line><span class=cl>          归一化        特征提取      回退策略
</span></span><span class=line><span class=cl>          槽位提取      多模型融合    上下文融合
</span></span></code></pre></div><p><strong>预处理层</strong>负责：</p><ul><li>文本清洗和归一化</li><li>拼写纠错</li><li>实体识别和槽位提取</li><li>上下文信息整合</li></ul><p><strong>意图分类层</strong>负责：</p><ul><li>模型推理</li><li>特征工程</li><li>多模型集成</li></ul><p><strong>后处理层</strong>负责：</p><ul><li>置信度阈值过滤</li><li>歧义消解</li><li>回退策略</li><li>结果验证</li></ul><h3 id=2-接口设计示例>2. 接口设计示例</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>enum</span> <span class=kn>import</span> <span class=n>Enum</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>IntentType</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;意图类型枚举&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>BOOK_FLIGHT</span> <span class=o>=</span> <span class=s2>&#34;book_flight&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>CHECK_WEATHER</span> <span class=o>=</span> <span class=s2>&#34;check_weather&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>SET_ALARM</span> <span class=o>=</span> <span class=s2>&#34;set_alarm&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>UNKNOWN</span> <span class=o>=</span> <span class=s2>&#34;unknown&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Intent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;意图识别结果&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>intent_type</span><span class=p>:</span> <span class=n>IntentType</span>
</span></span><span class=line><span class=cl>    <span class=n>confidence</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>slots</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>any</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>raw_text</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>alternatives</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=s1>&#39;Intent&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>is_confident</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>threshold</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.8</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;判断置信度是否足够高&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>confidence</span> <span class=o>&gt;=</span> <span class=n>threshold</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>IntentRecognizer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;意图识别器接口&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>config</span><span class=p>:</span> <span class=n>Dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>config</span> <span class=o>=</span> <span class=n>config</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>preprocessor</span> <span class=o>=</span> <span class=n>Preprocessor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>classifier</span> <span class=o>=</span> <span class=n>IntentClassifier</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>postprocessor</span> <span class=o>=</span> <span class=n>Postprocessor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>recognize</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Dict</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Intent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        识别用户输入的意图
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            text: 用户输入文本
</span></span></span><span class=line><span class=cl><span class=s2>            context: 对话上下文信息
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            Intent: 识别的意图结果
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 预处理</span>
</span></span><span class=line><span class=cl>        <span class=n>processed</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>preprocessor</span><span class=o>.</span><span class=n>process</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 意图分类</span>
</span></span><span class=line><span class=cl>        <span class=n>predictions</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>classifier</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>processed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 后处理</span>
</span></span><span class=line><span class=cl>        <span class=n>intent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>postprocessor</span><span class=o>.</span><span class=n>finalize</span><span class=p>(</span><span class=n>predictions</span><span class=p>,</span> <span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>intent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>batch_recognize</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>texts</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Intent</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;批量识别意图，用于提升吞吐量&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>processed_batch</span> <span class=o>=</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>preprocessor</span><span class=o>.</span><span class=n>process</span><span class=p>(</span><span class=n>t</span><span class=p>)</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>texts</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>predictions</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>classifier</span><span class=o>.</span><span class=n>predict_batch</span><span class=p>(</span><span class=n>processed_batch</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>postprocessor</span><span class=o>.</span><span class=n>finalize</span><span class=p>(</span><span class=n>p</span><span class=p>)</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>predictions</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by AI</span>
</span></span></code></pre></div><h2 id=技术实现方案选择>技术实现方案选择</h2><h3 id=方案一基于规则的方法>方案一：基于规则的方法</h3><p>适用场景：意图数量少（&lt;20个）、表达模式固定</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>List</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RuleBasedIntentRecognizer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;基于规则的意图识别&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>rules</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_rules</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_load_rules</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=n>IntentType</span><span class=p>,</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;加载意图规则&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>IntentType</span><span class=o>.</span><span class=n>BOOK_FLIGHT</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=sa>r</span><span class=s1>&#39;订.*机票&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=sa>r</span><span class=s1>&#39;买.*飞机票&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=sa>r</span><span class=s1>&#39;预订.*航班&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=sa>r</span><span class=s1>&#39;book.*flight&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>IntentType</span><span class=o>.</span><span class=n>CHECK_WEATHER</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=sa>r</span><span class=s1>&#39;.*天气.*&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=sa>r</span><span class=s1>&#39;今天.*温度&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=sa>r</span><span class=s1>&#39;weather.*&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>recognize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Intent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;使用正则匹配识别意图&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>text_lower</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>intent_type</span><span class=p>,</span> <span class=n>patterns</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>rules</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>pattern</span> <span class=ow>in</span> <span class=n>patterns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>pattern</span><span class=p>,</span> <span class=n>text_lower</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>Intent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>intent_type</span><span class=o>=</span><span class=n>intent_type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>confidence</span><span class=o>=</span><span class=mf>1.0</span><span class=p>,</span>  <span class=c1># 规则匹配给予高置信度</span>
</span></span><span class=line><span class=cl>                        <span class=n>slots</span><span class=o>=</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>                        <span class=n>raw_text</span><span class=o>=</span><span class=n>text</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Intent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>intent_type</span><span class=o>=</span><span class=n>IntentType</span><span class=o>.</span><span class=n>UNKNOWN</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>confidence</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>slots</span><span class=o>=</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>            <span class=n>raw_text</span><span class=o>=</span><span class=n>text</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by AI</span>
</span></span></code></pre></div><p><strong>优点</strong>：</p><ul><li>实现简单，无需训练</li><li>可解释性强</li><li>零样本学习</li></ul><p><strong>缺点</strong>：</p><ul><li>扩展性差</li><li>难以处理复杂表达</li><li>维护成本高</li></ul><h3 id=方案二基于传统机器学习>方案二：基于传统机器学习</h3><p>适用场景：中等规模（20-100个意图）、有标注数据</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.feature_extraction.text</span> <span class=kn>import</span> <span class=n>TfidfVectorizer</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.linear_model</span> <span class=kn>import</span> <span class=n>LogisticRegression</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.pipeline</span> <span class=kn>import</span> <span class=n>Pipeline</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>joblib</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MLIntentClassifier</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;基于传统机器学习的意图分类器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>pipeline</span> <span class=o>=</span> <span class=n>Pipeline</span><span class=p>([</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=s1>&#39;tfidf&#39;</span><span class=p>,</span> <span class=n>TfidfVectorizer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>ngram_range</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>max_features</span><span class=o>=</span><span class=mi>5000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>analyzer</span><span class=o>=</span><span class=s1>&#39;char_wb&#39;</span>  <span class=c1># 支持中英文</span>
</span></span><span class=line><span class=cl>            <span class=p>)),</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=s1>&#39;classifier&#39;</span><span class=p>,</span> <span class=n>LogisticRegression</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>max_iter</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>class_weight</span><span class=o>=</span><span class=s1>&#39;balanced&#39;</span>
</span></span><span class=line><span class=cl>            <span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>train</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>texts</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span> <span class=n>labels</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;训练模型&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>pipeline</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>texts</span><span class=p>,</span> <span class=n>labels</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>predict</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Intent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;预测意图&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 预测类别和概率</span>
</span></span><span class=line><span class=cl>        <span class=n>intent_label</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>pipeline</span><span class=o>.</span><span class=n>predict</span><span class=p>([</span><span class=n>text</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>proba</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>pipeline</span><span class=o>.</span><span class=n>predict_proba</span><span class=p>([</span><span class=n>text</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>confidence</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>proba</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Intent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>intent_type</span><span class=o>=</span><span class=n>IntentType</span><span class=p>(</span><span class=n>intent_label</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>confidence</span><span class=o>=</span><span class=n>confidence</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>slots</span><span class=o>=</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>            <span class=n>raw_text</span><span class=o>=</span><span class=n>text</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>save</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>path</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;保存模型&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>joblib</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>pipeline</span><span class=p>,</span> <span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>load</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>path</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;加载模型&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>pipeline</span> <span class=o>=</span> <span class=n>joblib</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=n>classifier</span> <span class=o>=</span> <span class=n>MLIntentClassifier</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 训练数据</span>
</span></span><span class=line><span class=cl><span class=n>train_texts</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;我要订明天去北京的机票&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;帮我预订后天飞上海的航班&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;今天天气怎么样&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;明天会下雨吗&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>train_labels</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;book_flight&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;book_flight&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;check_weather&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;check_weather&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>classifier</span><span class=o>.</span><span class=n>train</span><span class=p>(</span><span class=n>train_texts</span><span class=p>,</span> <span class=n>train_labels</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>classifier</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=s2>&#34;intent_model.pkl&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by AI</span>
</span></span></code></pre></div><p><strong>优点</strong>：</p><ul><li>训练快速</li><li>模型体积小</li><li>部署简单</li></ul><p><strong>缺点</strong>：</p><ul><li>需要大量标注数据</li><li>泛化能力有限</li><li>难以捕获复杂语义</li></ul><h3 id=方案三基于深度学习推荐>方案三：基于深度学习（推荐）</h3><p>适用场景：大规模（>100个意图）、复杂语义理解</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch.nn</span> <span class=k>as</span> <span class=nn>nn</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>transformers</span> <span class=kn>import</span> <span class=n>AutoTokenizer</span><span class=p>,</span> <span class=n>AutoModel</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Tuple</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>BERTIntentClassifier</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;基于BERT的意图分类器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>num_intents</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>model_name</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;bert-base-chinese&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>bert</span> <span class=o>=</span> <span class=n>AutoModel</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>model_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>dropout</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Dropout</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>classifier</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>bert</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>hidden_size</span><span class=p>,</span> <span class=n>num_intents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer</span> <span class=o>=</span> <span class=n>AutoTokenizer</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>model_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>input_ids</span><span class=p>,</span> <span class=n>attention_mask</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;前向传播&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>outputs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>bert</span><span class=p>(</span><span class=n>input_ids</span><span class=o>=</span><span class=n>input_ids</span><span class=p>,</span> <span class=n>attention_mask</span><span class=o>=</span><span class=n>attention_mask</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>pooled_output</span> <span class=o>=</span> <span class=n>outputs</span><span class=o>.</span><span class=n>pooler_output</span>
</span></span><span class=line><span class=cl>        <span class=n>pooled_output</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>dropout</span><span class=p>(</span><span class=n>pooled_output</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logits</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>classifier</span><span class=p>(</span><span class=n>pooled_output</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>logits</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>predict</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>device</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;cpu&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>float</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;预测单个文本的意图&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>eval</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>torch</span><span class=o>.</span><span class=n>no_grad</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>encoding</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>text</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>padding</span><span class=o>=</span><span class=s1>&#39;max_length&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>truncation</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>max_length</span><span class=o>=</span><span class=mi>128</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>return_tensors</span><span class=o>=</span><span class=s1>&#39;pt&#39;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>input_ids</span> <span class=o>=</span> <span class=n>encoding</span><span class=p>[</span><span class=s1>&#39;input_ids&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>device</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>attention_mask</span> <span class=o>=</span> <span class=n>encoding</span><span class=p>[</span><span class=s1>&#39;attention_mask&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>device</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>logits</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>forward</span><span class=p>(</span><span class=n>input_ids</span><span class=p>,</span> <span class=n>attention_mask</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>probs</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>softmax</span><span class=p>(</span><span class=n>logits</span><span class=p>,</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>confidence</span><span class=p>,</span> <span class=n>predicted</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>max</span><span class=p>(</span><span class=n>probs</span><span class=p>,</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>predicted</span><span class=o>.</span><span class=n>item</span><span class=p>(),</span> <span class=n>confidence</span><span class=o>.</span><span class=n>item</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DeepLearningIntentRecognizer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;深度学习意图识别器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>model_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>intent_mapping</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=n>IntentType</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>device</span> <span class=o>=</span> <span class=s1>&#39;cuda&#39;</span> <span class=k>if</span> <span class=n>torch</span><span class=o>.</span><span class=n>cuda</span><span class=o>.</span><span class=n>is_available</span><span class=p>()</span> <span class=k>else</span> <span class=s1>&#39;cpu&#39;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>intent_mapping</span> <span class=o>=</span> <span class=n>intent_mapping</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>model</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_model</span><span class=p>(</span><span class=n>model_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_load_model</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>path</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>BERTIntentClassifier</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;加载训练好的模型&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>model</span> <span class=o>=</span> <span class=n>BERTIntentClassifier</span><span class=p>(</span><span class=n>num_intents</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>intent_mapping</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>model</span><span class=o>.</span><span class=n>load_state_dict</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>map_location</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>device</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>model</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>device</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>model</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>recognize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Intent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;异步识别意图&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>predicted_id</span><span class=p>,</span> <span class=n>confidence</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>device</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>intent_type</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>intent_mapping</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>predicted_id</span><span class=p>,</span> <span class=n>IntentType</span><span class=o>.</span><span class=n>UNKNOWN</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Intent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>intent_type</span><span class=o>=</span><span class=n>intent_type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>confidence</span><span class=o>=</span><span class=n>confidence</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>slots</span><span class=o>=</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>            <span class=n>raw_text</span><span class=o>=</span><span class=n>text</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by AI</span>
</span></span></code></pre></div><p><strong>优点</strong>：</p><ul><li>强大的语义理解能力</li><li>优秀的泛化性能</li><li>支持迁移学习</li></ul><p><strong>缺点</strong>：</p><ul><li>需要GPU资源</li><li>推理延迟较高</li><li>模型体积大</li></ul><h3 id=方案四基于大语言模型llm>方案四：基于大语言模型（LLM）</h3><p>适用场景：零样本学习、复杂语义、快速原型</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>anthropic</span> <span class=kn>import</span> <span class=n>Anthropic</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>LLMIntentRecognizer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;基于大语言模型的意图识别器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>api_key</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>client</span> <span class=o>=</span> <span class=n>Anthropic</span><span class=p>(</span><span class=n>api_key</span><span class=o>=</span><span class=n>api_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>intent_definitions</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_intent_definitions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_load_intent_definitions</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;加载意图定义&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        可用意图列表：
</span></span></span><span class=line><span class=cl><span class=s2>        1. book_flight: 预订机票、航班
</span></span></span><span class=line><span class=cl><span class=s2>        2. check_weather: 查询天气、温度
</span></span></span><span class=line><span class=cl><span class=s2>        3. set_alarm: 设置闹钟、提醒
</span></span></span><span class=line><span class=cl><span class=s2>        4. unknown: 无法识别的意图
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>recognize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span> <span class=o>=</span> <span class=kc>None</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Intent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;使用LLM识别意图&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;你是一个意图识别专家。请分析用户输入并返回JSON格式的结果。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>intent_definitions</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>用户输入：</span><span class=si>{</span><span class=n>text</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>请返回JSON格式：
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=se>{{</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;intent&#34;: &#34;意图类型&#34;,
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;confidence&#34;: 0.0-1.0,
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;slots&#34;: </span><span class=se>{{}}</span><span class=s2>,
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;reasoning&#34;: &#34;识别理由&#34;
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=se>}}</span><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>message</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>client</span><span class=o>.</span><span class=n>messages</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=s2>&#34;claude-3-5-sonnet-20241022&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>max_tokens</span><span class=o>=</span><span class=mi>1024</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>messages</span><span class=o>=</span><span class=p>[{</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>prompt</span><span class=p>}]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 解析LLM返回结果</span>
</span></span><span class=line><span class=cl>        <span class=n>response_text</span> <span class=o>=</span> <span class=n>message</span><span class=o>.</span><span class=n>content</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>response_text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Intent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>intent_type</span><span class=o>=</span><span class=n>IntentType</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;intent&#39;</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>            <span class=n>confidence</span><span class=o>=</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;confidence&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>slots</span><span class=o>=</span><span class=n>result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;slots&#39;</span><span class=p>,</span> <span class=p>{}),</span>
</span></span><span class=line><span class=cl>            <span class=n>raw_text</span><span class=o>=</span><span class=n>text</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by AI</span>
</span></span></code></pre></div><p><strong>优点</strong>：</p><ul><li>零样本或少样本学习</li><li>强大的理解能力</li><li>快速迭代</li></ul><p><strong>缺点</strong>：</p><ul><li>API调用成本</li><li>响应延迟</li><li>依赖外部服务</li></ul><h2 id=生产环境最佳实践>生产环境最佳实践</h2><h3 id=1-混合策略多模型融合>1. 混合策略：多模型融合</h3><p>在实际生产中，建议采用混合策略：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>HybridIntentRecognizer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;混合意图识别器：融合多种方法&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>rule_recognizer</span> <span class=o>=</span> <span class=n>RuleBasedIntentRecognizer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ml_recognizer</span> <span class=o>=</span> <span class=n>MLIntentClassifier</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>dl_recognizer</span> <span class=o>=</span> <span class=n>DeepLearningIntentRecognizer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model_path</span><span class=o>=</span><span class=s2>&#34;intent_model.pt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>intent_mapping</span><span class=o>=</span><span class=p>{</span><span class=mi>0</span><span class=p>:</span> <span class=n>IntentType</span><span class=o>.</span><span class=n>BOOK_FLIGHT</span><span class=p>,</span> <span class=mi>1</span><span class=p>:</span> <span class=n>IntentType</span><span class=o>.</span><span class=n>CHECK_WEATHER</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>recognize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Intent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        多级识别策略：
</span></span></span><span class=line><span class=cl><span class=s2>        1. 先用规则快速匹配高置信度case
</span></span></span><span class=line><span class=cl><span class=s2>        2. 规则不匹配则用深度学习模型
</span></span></span><span class=line><span class=cl><span class=s2>        3. 置信度不足时触发回退机制
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 第一级：规则匹配</span>
</span></span><span class=line><span class=cl>        <span class=n>rule_intent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rule_recognizer</span><span class=o>.</span><span class=n>recognize</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>rule_intent</span><span class=o>.</span><span class=n>intent_type</span> <span class=o>!=</span> <span class=n>IntentType</span><span class=o>.</span><span class=n>UNKNOWN</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>rule_intent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 第二级：深度学习模型</span>
</span></span><span class=line><span class=cl>        <span class=n>dl_intent</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>dl_recognizer</span><span class=o>.</span><span class=n>recognize</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>dl_intent</span><span class=o>.</span><span class=n>is_confident</span><span class=p>(</span><span class=n>threshold</span><span class=o>=</span><span class=mf>0.8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>dl_intent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 第三级：置信度不足，触发澄清机制</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Intent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>intent_type</span><span class=o>=</span><span class=n>IntentType</span><span class=o>.</span><span class=n>UNKNOWN</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>confidence</span><span class=o>=</span><span class=n>dl_intent</span><span class=o>.</span><span class=n>confidence</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>slots</span><span class=o>=</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>            <span class=n>raw_text</span><span class=o>=</span><span class=n>text</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>alternatives</span><span class=o>=</span><span class=p>[</span><span class=n>dl_intent</span><span class=p>]</span>  <span class=c1># 保留候选结果</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by AI</span>
</span></span></code></pre></div><h3 id=2-置信度阈值和回退策略>2. 置信度阈值和回退策略</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>IntentPostprocessor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;后处理器：处理置信度和回退&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>confidence_threshold</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.75</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>threshold</span> <span class=o>=</span> <span class=n>confidence_threshold</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>finalize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>intent</span><span class=p>:</span> <span class=n>Intent</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span> <span class=o>=</span> <span class=kc>None</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Intent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;后处理意图结果&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 置信度不足，触发澄清</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>intent</span><span class=o>.</span><span class=n>confidence</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>threshold</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_handle_low_confidence</span><span class=p>(</span><span class=n>intent</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 使用上下文验证意图</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>context</span> <span class=ow>and</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>_validate_with_context</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span> <span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_handle_context_mismatch</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span> <span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>intent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_handle_low_confidence</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>intent</span><span class=p>:</span> <span class=n>Intent</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Intent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理低置信度场景&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 可以返回 CLARIFICATION_NEEDED 类型</span>
</span></span><span class=line><span class=cl>        <span class=c1># 或者返回多个候选意图让用户选择</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Intent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>intent_type</span><span class=o>=</span><span class=n>IntentType</span><span class=o>.</span><span class=n>UNKNOWN</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>confidence</span><span class=o>=</span><span class=n>intent</span><span class=o>.</span><span class=n>confidence</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>slots</span><span class=o>=</span><span class=n>intent</span><span class=o>.</span><span class=n>slots</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>raw_text</span><span class=o>=</span><span class=n>intent</span><span class=o>.</span><span class=n>raw_text</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>alternatives</span><span class=o>=</span><span class=p>[</span><span class=n>intent</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_validate_with_context</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>intent</span><span class=p>:</span> <span class=n>Intent</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;使用对话上下文验证意图合理性&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 例如：在订票流程中突然出现查天气，可能需要确认</span>
</span></span><span class=line><span class=cl>        <span class=n>last_intent</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;last_intent&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>last_intent</span> <span class=o>==</span> <span class=n>IntentType</span><span class=o>.</span><span class=n>BOOK_FLIGHT</span> <span class=ow>and</span> <span class=n>intent</span><span class=o>.</span><span class=n>intent_type</span> <span class=o>==</span> <span class=n>IntentType</span><span class=o>.</span><span class=n>CHECK_WEATHER</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_handle_context_mismatch</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>intent</span><span class=p>:</span> <span class=n>Intent</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Intent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理上下文不匹配&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 可以降低置信度或触发确认</span>
</span></span><span class=line><span class=cl>        <span class=n>intent</span><span class=o>.</span><span class=n>confidence</span> <span class=o>*=</span> <span class=mf>0.8</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>intent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by AI</span>
</span></span></code></pre></div><h3 id=3-槽位提取集成>3. 槽位提取集成</h3><p>意图识别通常需要同时提取槽位（实体）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Slot</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;槽位信息&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>value</span><span class=p>:</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl>    <span class=n>confidence</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>span</span><span class=p>:</span> <span class=nb>tuple</span>  <span class=c1># (start, end) 文本位置</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SlotExtractor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;槽位提取器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>extract</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>intent_type</span><span class=p>:</span> <span class=n>IntentType</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Slot</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;根据意图类型提取相应槽位&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>intent_type</span> <span class=o>==</span> <span class=n>IntentType</span><span class=o>.</span><span class=n>BOOK_FLIGHT</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_extract_flight_slots</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>intent_type</span> <span class=o>==</span> <span class=n>IntentType</span><span class=o>.</span><span class=n>CHECK_WEATHER</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_extract_weather_slots</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_extract_flight_slots</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Slot</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;提取机票预订相关槽位&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>slots</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 提取目的地</span>
</span></span><span class=line><span class=cl>        <span class=n>destination_pattern</span> <span class=o>=</span> <span class=sa>r</span><span class=s1>&#39;去([^\s的]{2,})&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>destination_pattern</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=k>match</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>slots</span><span class=p>[</span><span class=s1>&#39;destination&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>Slot</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>name</span><span class=o>=</span><span class=s1>&#39;destination&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>value</span><span class=o>=</span><span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>confidence</span><span class=o>=</span><span class=mf>0.9</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>span</span><span class=o>=</span><span class=k>match</span><span class=o>.</span><span class=n>span</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 提取时间</span>
</span></span><span class=line><span class=cl>        <span class=n>time_slots</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_extract_time</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>slots</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>time_slots</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>slots</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_extract_time</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Slot</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;提取时间信息&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>slots</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 相对时间：明天、后天</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;明天&#39;</span> <span class=ow>in</span> <span class=n>text</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>tomorrow</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span> <span class=o>+</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>slots</span><span class=p>[</span><span class=s1>&#39;date&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>Slot</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>name</span><span class=o>=</span><span class=s1>&#39;date&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>value</span><span class=o>=</span><span class=n>tomorrow</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1>&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>confidence</span><span class=o>=</span><span class=mf>1.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>span</span><span class=o>=</span><span class=p>(</span><span class=n>text</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=s1>&#39;明天&#39;</span><span class=p>),</span> <span class=n>text</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=s1>&#39;明天&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=s1>&#39;后天&#39;</span> <span class=ow>in</span> <span class=n>text</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>day_after</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span> <span class=o>+</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>slots</span><span class=p>[</span><span class=s1>&#39;date&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>Slot</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>name</span><span class=o>=</span><span class=s1>&#39;date&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>value</span><span class=o>=</span><span class=n>day_after</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1>&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>confidence</span><span class=o>=</span><span class=mf>1.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>span</span><span class=o>=</span><span class=p>(</span><span class=n>text</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=s1>&#39;后天&#39;</span><span class=p>),</span> <span class=n>text</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=s1>&#39;后天&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>slots</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_extract_weather_slots</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Slot</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;提取天气查询相关槽位&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>slots</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 提取地点</span>
</span></span><span class=line><span class=cl>        <span class=n>location_pattern</span> <span class=o>=</span> <span class=sa>r</span><span class=s1>&#39;(北京|上海|深圳|广州|[^\s]{2,}市?)(?:的)?天气&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>location_pattern</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=k>match</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>slots</span><span class=p>[</span><span class=s1>&#39;location&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>Slot</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>name</span><span class=o>=</span><span class=s1>&#39;location&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>value</span><span class=o>=</span><span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>confidence</span><span class=o>=</span><span class=mf>0.85</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>span</span><span class=o>=</span><span class=k>match</span><span class=o>.</span><span class=n>span</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>slots</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 整合到识别器中</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>IntentRecognizerWithSlots</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;带槽位提取的意图识别器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>intent_recognizer</span> <span class=o>=</span> <span class=n>HybridIntentRecognizer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>slot_extractor</span> <span class=o>=</span> <span class=n>SlotExtractor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>recognize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Intent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;识别意图并提取槽位&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>intent</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>intent_recognizer</span><span class=o>.</span><span class=n>recognize</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 提取槽位</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>intent</span><span class=o>.</span><span class=n>intent_type</span> <span class=o>!=</span> <span class=n>IntentType</span><span class=o>.</span><span class=n>UNKNOWN</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>slots</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>slot_extractor</span><span class=o>.</span><span class=n>extract</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=n>intent</span><span class=o>.</span><span class=n>intent_type</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>intent</span><span class=o>.</span><span class=n>slots</span> <span class=o>=</span> <span class=p>{</span><span class=n>k</span><span class=p>:</span> <span class=n>v</span><span class=o>.</span><span class=n>value</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>slots</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>intent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by AI</span>
</span></span></code></pre></div><h3 id=4-性能优化>4. 性能优化</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>lru_cache</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OptimizedIntentRecognizer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;优化的意图识别器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>recognizer</span> <span class=o>=</span> <span class=n>HybridIntentRecognizer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache_ttl</span> <span class=o>=</span> <span class=mi>300</span>  <span class=c1># 5分钟缓存</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@lru_cache</span><span class=p>(</span><span class=n>maxsize</span><span class=o>=</span><span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_get_cache_key</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;生成缓存键&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=n>text</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>recognize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Intent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;带缓存的识别&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>cache_key</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_cache_key</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 检查缓存</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>cache_key</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cached_result</span><span class=p>,</span> <span class=n>timestamp</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=p>[</span><span class=n>cache_key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>get_event_loop</span><span class=p>()</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>timestamp</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache_ttl</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>cached_result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 执行识别</span>
</span></span><span class=line><span class=cl>        <span class=n>intent</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>recognizer</span><span class=o>.</span><span class=n>recognize</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 更新缓存</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=p>[</span><span class=n>cache_key</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>intent</span><span class=p>,</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>get_event_loop</span><span class=p>()</span><span class=o>.</span><span class=n>time</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>intent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>batch_recognize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>texts</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Intent</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;批量识别优化&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>tasks</span> <span class=o>=</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>recognize</span><span class=p>(</span><span class=n>text</span><span class=p>)</span> <span class=k>for</span> <span class=n>text</span> <span class=ow>in</span> <span class=n>texts</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>gather</span><span class=p>(</span><span class=o>*</span><span class=n>tasks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by AI</span>
</span></span></code></pre></div><h3 id=5-监控和日志>5. 监控和日志</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>IntentRecognizerWithMonitoring</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;带监控的意图识别器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>recognizer</span> <span class=o>=</span> <span class=n>OptimizedIntentRecognizer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_requests&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;by_intent&#39;</span><span class=p>:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;low_confidence_count&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;unknown_count&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>recognize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Intent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;带监控的识别&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>start_time</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>intent</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>recognizer</span><span class=o>.</span><span class=n>recognize</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 更新指标</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_update_metrics</span><span class=p>(</span><span class=n>intent</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 记录日志</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_log_intent</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=n>intent</span><span class=p>,</span> <span class=n>start_time</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>intent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Intent recognition failed: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>exc_info</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_update_metrics</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>intent</span><span class=p>:</span> <span class=n>Intent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;更新监控指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;total_requests&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>intent_name</span> <span class=o>=</span> <span class=n>intent</span><span class=o>.</span><span class=n>intent_type</span><span class=o>.</span><span class=n>value</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;by_intent&#39;</span><span class=p>][</span><span class=n>intent_name</span><span class=p>]</span> <span class=o>=</span> \
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;by_intent&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>intent_name</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>intent</span><span class=o>.</span><span class=n>confidence</span> <span class=o>&lt;</span> <span class=mf>0.75</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;low_confidence_count&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>intent</span><span class=o>.</span><span class=n>intent_type</span> <span class=o>==</span> <span class=n>IntentType</span><span class=o>.</span><span class=n>UNKNOWN</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;unknown_count&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_log_intent</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>intent</span><span class=p>:</span> <span class=n>Intent</span><span class=p>,</span> <span class=n>start_time</span><span class=p>:</span> <span class=n>datetime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;记录意图识别日志&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>latency</span> <span class=o>=</span> <span class=p>(</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span><span class=p>)</span><span class=o>.</span><span class=n>total_seconds</span><span class=p>()</span> <span class=o>*</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>log_data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;input&#39;</span><span class=p>:</span> <span class=n>text</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;intent&#39;</span><span class=p>:</span> <span class=n>intent</span><span class=o>.</span><span class=n>intent_type</span><span class=o>.</span><span class=n>value</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;confidence&#39;</span><span class=p>:</span> <span class=n>intent</span><span class=o>.</span><span class=n>confidence</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;slots&#39;</span><span class=p>:</span> <span class=n>intent</span><span class=o>.</span><span class=n>slots</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;latency_ms&#39;</span><span class=p>:</span> <span class=n>latency</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>log_data</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 低置信度警告</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>intent</span><span class=o>.</span><span class=n>confidence</span> <span class=o>&lt;</span> <span class=mf>0.75</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Low confidence intent: </span><span class=si>{</span><span class=n>intent</span><span class=o>.</span><span class=n>confidence</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_metrics</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取监控指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>**</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;unknown_rate&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;unknown_count&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=nb>max</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;total_requests&#39;</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;low_confidence_rate&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;low_confidence_count&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=nb>max</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;total_requests&#39;</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by AI</span>
</span></span></code></pre></div><h2 id=评估和持续优化>评估和持续优化</h2><h3 id=1-评估指标>1. 评估指标</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.metrics</span> <span class=kn>import</span> <span class=n>classification_report</span><span class=p>,</span> <span class=n>confusion_matrix</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>IntentEvaluator</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;意图识别评估器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>evaluate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>recognizer</span><span class=p>:</span> <span class=n>IntentRecognizer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>test_data</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>IntentType</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;评估意图识别器性能&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>y_true</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>y_pred</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>confidences</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>text</span><span class=p>,</span> <span class=n>true_intent</span> <span class=ow>in</span> <span class=n>test_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>predicted_intent</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>recognizer</span><span class=o>.</span><span class=n>recognize</span><span class=p>(</span><span class=n>text</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>y_true</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>true_intent</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>y_pred</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>predicted_intent</span><span class=o>.</span><span class=n>intent_type</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>confidences</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>predicted_intent</span><span class=o>.</span><span class=n>confidence</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 计算指标</span>
</span></span><span class=line><span class=cl>        <span class=n>report</span> <span class=o>=</span> <span class=n>classification_report</span><span class=p>(</span><span class=n>y_true</span><span class=p>,</span> <span class=n>y_pred</span><span class=p>,</span> <span class=n>output_dict</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>cm</span> <span class=o>=</span> <span class=n>confusion_matrix</span><span class=p>(</span><span class=n>y_true</span><span class=p>,</span> <span class=n>y_pred</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;accuracy&#39;</span><span class=p>:</span> <span class=n>report</span><span class=p>[</span><span class=s1>&#39;accuracy&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;macro_f1&#39;</span><span class=p>:</span> <span class=n>report</span><span class=p>[</span><span class=s1>&#39;macro avg&#39;</span><span class=p>][</span><span class=s1>&#39;f1-score&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;weighted_f1&#39;</span><span class=p>:</span> <span class=n>report</span><span class=p>[</span><span class=s1>&#39;weighted avg&#39;</span><span class=p>][</span><span class=s1>&#39;f1-score&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;per_intent_metrics&#39;</span><span class=p>:</span> <span class=n>report</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;confusion_matrix&#39;</span><span class=p>:</span> <span class=n>cm</span><span class=o>.</span><span class=n>tolist</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;avg_confidence&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>confidences</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;confidence_distribution&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>confidences</span><span class=p>,</span> <span class=p>[</span><span class=mi>25</span><span class=p>,</span> <span class=mi>50</span><span class=p>,</span> <span class=mi>75</span><span class=p>,</span> <span class=mi>90</span><span class=p>,</span> <span class=mi>95</span><span class=p>])</span><span class=o>.</span><span class=n>tolist</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by AI</span>
</span></span></code></pre></div><h3 id=2-ab测试框架>2. A/B测试框架</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>enum</span> <span class=kn>import</span> <span class=n>Enum</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ModelVersion</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>VERSION_A</span> <span class=o>=</span> <span class=s2>&#34;model_a&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>VERSION_B</span> <span class=o>=</span> <span class=s2>&#34;model_b&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ABTestIntentRecognizer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;A/B测试意图识别器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>recognizer_a</span><span class=p>,</span> <span class=n>recognizer_b</span><span class=p>,</span> <span class=n>split_ratio</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>recognizer_a</span> <span class=o>=</span> <span class=n>recognizer_a</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>recognizer_b</span> <span class=o>=</span> <span class=n>recognizer_b</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>split_ratio</span> <span class=o>=</span> <span class=n>split_ratio</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>recognize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Intent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;根据用户分流进行A/B测试&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 用户分流</span>
</span></span><span class=line><span class=cl>        <span class=n>version</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_user_version</span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>version</span> <span class=o>==</span> <span class=n>ModelVersion</span><span class=o>.</span><span class=n>VERSION_A</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>intent</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>recognizer_a</span><span class=o>.</span><span class=n>recognize</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>intent</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>recognizer_b</span><span class=o>.</span><span class=n>recognize</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 记录版本信息用于分析</span>
</span></span><span class=line><span class=cl>        <span class=n>intent</span><span class=o>.</span><span class=n>metadata</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;model_version&#39;</span><span class=p>:</span> <span class=n>version</span><span class=o>.</span><span class=n>value</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>intent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_get_user_version</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ModelVersion</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;确定用户使用的模型版本&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>user_id</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 基于用户ID的一致性哈希</span>
</span></span><span class=line><span class=cl>            <span class=n>hash_value</span> <span class=o>=</span> <span class=nb>hash</span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span> <span class=o>%</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>ModelVersion</span><span class=o>.</span><span class=n>VERSION_A</span> <span class=k>if</span> <span class=n>hash_value</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>split_ratio</span> <span class=o>*</span> <span class=mi>100</span> <span class=k>else</span> <span class=n>ModelVersion</span><span class=o>.</span><span class=n>VERSION_B</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 随机分配</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>ModelVersion</span><span class=o>.</span><span class=n>VERSION_A</span> <span class=k>if</span> <span class=n>random</span><span class=o>.</span><span class=n>random</span><span class=p>()</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>split_ratio</span> <span class=k>else</span> <span class=n>ModelVersion</span><span class=o>.</span><span class=n>VERSION_B</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by AI</span>
</span></span></code></pre></div><h2 id=常见陷阱和解决方案>常见陷阱和解决方案</h2><h3 id=陷阱1过度依赖准确率>陷阱1：过度依赖准确率</h3><p>准确率高不代表用户体验好。关注：</p><ul><li>混淆矩阵中的关键错误类型</li><li>置信度分布</li><li>用户反馈和纠正率</li></ul><h3 id=陷阱2忽视长尾意图>陷阱2：忽视长尾意图</h3><p>解决方案：</p><ul><li>设计兜底机制</li><li>提供澄清对话</li><li>人工介入通道</li></ul><h3 id=陷阱3静态模型不更新>陷阱3：静态模型不更新</h3><p>解决方案：</p><ul><li>建立持续学习pipeline</li><li>收集用户反馈</li><li>定期重训练模型</li></ul><h3 id=陷阱4忽视延迟优化>陷阱4：忽视延迟优化</h3><p>解决方案：</p><ul><li>模型量化和剪枝</li><li>批处理推理</li><li>缓存热门查询</li><li>异步处理</li></ul><h2 id=总结>总结</h2><p>构建一个生产级的意图识别模块需要综合考虑多个方面：</p><ol><li><strong>架构设计</strong>：采用分层、模块化设计，便于维护和扩展</li><li><strong>技术选型</strong>：根据业务规模选择合适的方法，混合策略往往效果最好</li><li><strong>工程实践</strong>：关注性能、监控、日志和错误处理</li><li><strong>持续优化</strong>：建立评估体系和反馈循环，不断迭代改进</li></ol><p>记住，没有完美的意图识别系统。关键是在准确率、延迟、成本和可维护性之间找到适合你业务的平衡点。从简单方案开始，根据实际数据和用户反馈逐步优化，才是最明智的做法。</p><p>希望这篇文章能帮助你构建出高效、可靠的意图识别系统！如果你有任何问题或实践经验，欢迎在评论区分享交流。</p><div class=blog-tags><a href=https://blog.hugozhu.site/tags/ai/>AI</a>&nbsp;
<a href=https://blog.hugozhu.site/tags/nlp/>NLP</a>&nbsp;
<a href=https://blog.hugozhu.site/tags/intent-recognition/>intent-recognition</a>&nbsp;
<a href=https://blog.hugozhu.site/tags/machine-learning/>machine-learning</a>&nbsp;
<a href=https://blog.hugozhu.site/tags/llm/>LLM</a>&nbsp;
<a href=https://blog.hugozhu.site/tags/best-practices/>best-practices</a>&nbsp;</div><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fblog.hugozhu.site%2fpost%2f2025%2f107-intent-recognition-best-practices%2f&amp;text=%e6%84%8f%e5%9b%be%e8%af%86%e5%88%ab%e6%a8%a1%e5%9d%97%e5%ae%9e%e7%8e%b0%e7%9a%84%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5&amp;via=" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.hugozhu.site%2fpost%2f2025%2f107-intent-recognition-best-practices%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fblog.hugozhu.site%2fpost%2f2025%2f107-intent-recognition-best-practices%2f&amp;title=%e6%84%8f%e5%9b%be%e8%af%86%e5%88%ab%e6%a8%a1%e5%9d%97%e5%ae%9e%e7%8e%b0%e7%9a%84%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fblog.hugozhu.site%2fpost%2f2025%2f107-intent-recognition-best-practices%2f&amp;title=%e6%84%8f%e5%9b%be%e8%af%86%e5%88%ab%e6%a8%a1%e5%9d%97%e5%ae%9e%e7%8e%b0%e7%9a%84%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fblog.hugozhu.site%2fpost%2f2025%2f107-intent-recognition-best-practices%2f&amp;title=%e6%84%8f%e5%9b%be%e8%af%86%e5%88%ab%e6%a8%a1%e5%9d%97%e5%ae%9e%e7%8e%b0%e7%9a%84%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fblog.hugozhu.site%2fpost%2f2025%2f107-intent-recognition-best-practices%2f&amp;description=%e6%84%8f%e5%9b%be%e8%af%86%e5%88%ab%e6%a8%a1%e5%9d%97%e5%ae%9e%e7%8e%b0%e7%9a%84%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" target=_blank title="Share on Pinterest"><i class="fab fa-pinterest"></i></a></li></ul></div></div></section><h4 class=see-also>See also</h4><ul><li><a href=/post/2025/110-ai-exam-grading-agent-best-practices/>小学标准化试卷AI批改Agent最佳工程实践</a></li><li><a href=/post/2025/109-api-mcp-skills-explained/>API、MCP和Skills：三个概念的本质区别</a></li><li><a href=/post/2025/106-e2b-ai-infrastructure-best-practices/>E2B：构建安全可靠的 AI 代理执行环境最佳实践</a></li><li><a href=/post/2025/108-compression-is-intelligence/>压缩即智能：从信息论看机器学习的本质</a></li><li><a href=/post/2025/105-rag-retrieval-augmented-generation-guide/>深入理解RAG：检索增强生成技术的原理与实践</a></li></ul></article><ul class="pager blog-pager"><li class=previous><a href=https://blog.hugozhu.site/post/2025/105-rag-retrieval-augmented-generation-guide/ data-toggle=tooltip data-placement=top title=深入理解RAG：检索增强生成技术的原理与实践>&larr; Previous Post</a></li><li class=next><a href=https://blog.hugozhu.site/post/2025/108-compression-is-intelligence/ data-toggle=tooltip data-placement=top title=压缩即智能：从信息论看机器学习的本质>Next Post &rarr;</a></li></ul><div class=disqus-comments><button id=show-comments class="btn btn-default" type=button>Show <span class=disqus-comment-count data-disqus-url=https://blog.hugozhu.site/post/2025/107-intent-recognition-best-practices>comments</span></button><div id=disqus_thread></div><script type=text/javascript>var disqus_config=function(){this.page.url="https://blog.hugozhu.site/post/2025/107-intent-recognition-best-practices"}</script></div></div></div></div><footer><div class=container><div class=row><div class=disclaimer><b>Disclaimer:</b> The opinions expressed herein are my own personal opinions and do not represent my company’s view in any way.</div></div><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"></ul><p class="credits copyright text-muted">&nbsp;&bull;&nbsp;&copy;
2025
&nbsp;&bull;&nbsp;
<a href=https://blog.hugozhu.site/>All about Raspberry Pi</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.145.0</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js integrity=sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script><script src=https://code.jquery.com/jquery-3.7.0.slim.min.js integrity=sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js integrity=sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd crossorigin=anonymous></script><script src=https://blog.hugozhu.site/js/main.js></script><script src=https://blog.hugozhu.site/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0")})</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://blog.hugozhu.site/js/load-photoswipe.js></script><script>(function(){var t,n="617d351a633194d48",e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://cse.google.com/cse.js?cx="+n,t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script><script type=text/javascript>$(function(){$("#show-comments").on("click",function(){var e="hugozhu";(function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="//"+e+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(t)})(),$(this).hide()})})</script><script id=dsq-count-scr src=//hugozhu.disqus.com/count.js async></script></body></html>