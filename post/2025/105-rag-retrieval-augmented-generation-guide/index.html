<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>深入理解RAG：检索增强生成技术的原理与实践 - Hugo Zhu's Blog</title>
<meta name=description content="从零开始构建高效的RAG系统"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"All about Raspberry Pi","url":"https:\/\/blog.hugozhu.site\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/blog.hugozhu.site\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/blog.hugozhu.site\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/blog.hugozhu.site\/post\/2025\/105-rag-retrieval-augmented-generation-guide\/","name":"深入理解 rag：检索增强生成技术的原理与实践"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":""},"headline":"深入理解RAG：检索增强生成技术的原理与实践","description":"在大语言模型(LLM)快速发展的今天，我们面临一个核心挑战：如何让模型能够访问和利用实时、专业或私有的知识？纯粹依赖预训练的模型往往会出现知识过时、幻觉问题，或者无法回答特定领域的问题。这就是检索增强生成(Retrieval-Augmented Generation, RAG)技术应运而生的原因。\nRAG通过将外部知识库的检索能力与LLM的生成能力相结合，为这个问题提供了一个优雅的解决方案。它不需要重新训练模型，就能让AI系统访问最新的、特定领域的知识，同时显著降低幻觉问题。本文将深入探讨RAG的核心原理、架构设计以及实际应用中的最佳实践。\n","inLanguage":"en","wordCount":2895,"datePublished":"2025-12-19T00:00:00\u002b00:00","dateModified":"2025-12-19T00:00:00\u002b00:00","image":"https:\/\/blog.hugozhu.site\/img\/pi.png","keywords":["AI, RAG, LLM, machine-learning, NLP, embeddings, vector-database, prompt-engineering"],"mainEntityOfPage":"https:\/\/blog.hugozhu.site\/post\/2025\/105-rag-retrieval-augmented-generation-guide\/","publisher":{"@type":"Organization","name":"https:\/\/blog.hugozhu.site\/","logo":{"@type":"ImageObject","url":"https:\/\/blog.hugozhu.site\/img\/pi.png","height":60,"width":60}}}</script><meta property="og:title" content="深入理解RAG：检索增强生成技术的原理与实践"><meta property="og:description" content="从零开始构建高效的RAG系统"><meta property="og:image" content="https://blog.hugozhu.site/img/pi.png"><meta property="og:url" content="https://blog.hugozhu.site/post/2025/105-rag-retrieval-augmented-generation-guide/"><meta property="og:type" content="website"><meta property="og:site_name" content="All about Raspberry Pi"><meta name=twitter:title content="深入理解RAG：检索增强生成技术的原理与实践"><meta name=twitter:description content="从零开始构建高效的RAG系统"><meta name=twitter:image content="https://blog.hugozhu.site/img/pi.png"><meta name=twitter:card content="summary_large_image"><link href=https://blog.hugozhu.site/img/pi.ico rel=icon type=image/x-icon><meta name=generator content="Hugo 0.145.0"><link rel=alternate href=https://blog.hugozhu.site/index.xml type=application/rss+xml title="All about Raspberry Pi"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css integrity=sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v6.6.0/css/all.css integrity=sha384-h/hnnw1Bi4nbpD6kE7nYfCXzovi622sY5WBxww8ARKwpdLj5kUWjRuyiXaD1U2JT crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css integrity=sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu crossorigin=anonymous><link rel=stylesheet href=https://blog.hugozhu.site/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://blog.hugozhu.site/css/highlight.min.css><link rel=stylesheet href=https://blog.hugozhu.site/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><script async src="https://www.googletagmanager.com/gtag/js?id=GTM-W88HDMN"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","GTM-W88HDMN")}</script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=https://blog.hugozhu.site/>All about Raspberry Pi</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Blog href=/>Blog</a></li><li class=navlinks-container><a class=navlinks-parent role=button tabindex=0>Tools</a><div class=navlinks-children><a href=https://nddapp.com/json-encoder.html>HTML Tools</a>
<a href=https://www.birme.net/>Imaeg Resizing</a>
<a href=https://jwt.io/>JWT Token Tool</a></div></li><li><a title=About href=/page/about/>About</a></li><li><a title=Tags href=/tags>Tags</a></li><li><a href=#modalSearch data-toggle=modal data-target=#modalSearch style=outline:none><span class="hidden-sm hidden-md hidden-lg">Search</span> <span id=searchGlyph class="glyphicon glyphicon-search"></span></a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title="All about Raspberry Pi" href=https://blog.hugozhu.site/><img class=avatar-img src=https://blog.hugozhu.site/img/pi.png alt="All about Raspberry Pi"></a></div></div></div></nav><div id=modalSearch class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><button type=button class=close data-dismiss=modal>&#215;</button><h4 class=modal-title>Search All about Raspberry Pi</h4></div><div class=modal-body><gcse:search></gcse:search></div><div class=modal-footer><button type=button class="btn btn-default" data-dismiss=modal>Close</button></div></div></div></div><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>深入理解RAG：检索增强生成技术的原理与实践</h1><h2 class=post-subheading>从零开始构建高效的RAG系统</h2><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on December 19, 2025
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;14&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;2895&nbsp;words</span></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><h4><i>目录:</i></h4><nav id=TableOfContents><ul><li><a href=#rag的核心思想>RAG的核心思想</a><ul><li><a href=#rag-vs-其他方案>RAG vs 其他方案</a></li></ul></li><li><a href=#rag系统架构>RAG系统架构</a><ul><li><a href=#1-文档索引流程-indexing-pipeline>1. 文档索引流程 (Indexing Pipeline)</a></li><li><a href=#2-检索流程-retrieval-pipeline>2. 检索流程 (Retrieval Pipeline)</a></li><li><a href=#3-生成流程-generation-pipeline>3. 生成流程 (Generation Pipeline)</a></li></ul></li><li><a href=#完整的rag系统实现>完整的RAG系统实现</a></li><li><a href=#rag系统的优化策略>RAG系统的优化策略</a><ul><li><a href=#1-提升检索质量>1. 提升检索质量</a></li><li><a href=#2-优化分块策略>2. 优化分块策略</a></li><li><a href=#3-智能上下文压缩>3. 智能上下文压缩</a></li><li><a href=#4-结果评估与反馈循环>4. 结果评估与反馈循环</a></li></ul></li><li><a href=#rag的高级应用模式>RAG的高级应用模式</a><ul><li><a href=#1-多跳推理-multi-hop-reasoning>1. 多跳推理 (Multi-Hop Reasoning)</a></li><li><a href=#2-self-rag自我反思的rag>2. Self-RAG：自我反思的RAG</a></li><li><a href=#3-对话式rag>3. 对话式RAG</a></li></ul></li><li><a href=#实战案例构建技术文档问答系统>实战案例：构建技术文档问答系统</a></li><li><a href=#常见问题与解决方案>常见问题与解决方案</a><ul><li><a href=#1-检索质量问题>1. 检索质量问题</a></li><li><a href=#2-生成质量问题>2. 生成质量问题</a></li><li><a href=#3-性能问题>3. 性能问题</a></li><li><a href=#4-成本问题>4. 成本问题</a></li></ul></li><li><a href=#评估与监控>评估与监控</a></li><li><a href=#未来方向>未来方向</a></li><li><a href=#总结>总结</a></li></ul></nav><p>在大语言模型(LLM)快速发展的今天，我们面临一个核心挑战：如何让模型能够访问和利用实时、专业或私有的知识？纯粹依赖预训练的模型往往会出现知识过时、幻觉问题，或者无法回答特定领域的问题。这就是检索增强生成(Retrieval-Augmented Generation, RAG)技术应运而生的原因。</p><p>RAG通过将外部知识库的检索能力与LLM的生成能力相结合，为这个问题提供了一个优雅的解决方案。它不需要重新训练模型，就能让AI系统访问最新的、特定领域的知识，同时显著降低幻觉问题。本文将深入探讨RAG的核心原理、架构设计以及实际应用中的最佳实践。</p><h2 id=rag的核心思想>RAG的核心思想</h2><p>RAG的基本思想非常直观：在生成答案之前，先从知识库中检索相关信息，然后将这些信息作为上下文提供给LLM，让模型基于这些事实进行回答。</p><p>这个过程可以类比为开卷考试：传统的LLM就像闭卷考试，只能依赖记忆中的知识；而RAG系统则像开卷考试，可以查阅参考资料后再作答，答案自然更加准确和可靠。</p><h3 id=rag-vs-其他方案>RAG vs 其他方案</h3><p>让我们先比较几种常见的知识增强方案：</p><table><thead><tr><th>方案</th><th>优势</th><th>劣势</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>预训练</strong></td><td>知识内化在模型中，推理速度快</td><td>知识固化，无法更新，成本高昂</td><td>通用知识</td></tr><tr><td><strong>微调(Fine-tuning)</strong></td><td>可以学习特定领域知识和风格</td><td>需要大量数据和计算资源，知识仍会过时</td><td>特定任务或领域</td></tr><tr><td><strong>RAG</strong></td><td>知识可实时更新，成本低，透明可解释</td><td>检索质量影响结果，增加延迟</td><td>动态知识、事实性回答</td></tr><tr><td><strong>长上下文</strong></td><td>简单直接，无需额外系统</td><td>成本高，注意力衰减，token限制</td><td>小规模文档</td></tr></tbody></table><p>RAG的核心优势在于<strong>知识与模型的解耦</strong>：你可以随时更新知识库而无需重新训练模型，这使得系统具有极高的灵活性和可维护性。</p><h2 id=rag系统架构>RAG系统架构</h2><p>一个完整的RAG系统通常包含以下几个核心组件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>graph LR
</span></span><span class=line><span class=cl>    A[用户查询] --&gt; B[查询处理]
</span></span><span class=line><span class=cl>    B --&gt; C[向量检索]
</span></span><span class=line><span class=cl>    C --&gt; D[知识库&lt;br/&gt;Vector DB]
</span></span><span class=line><span class=cl>    D --&gt; E[相关文档]
</span></span><span class=line><span class=cl>    E --&gt; F[上下文构建]
</span></span><span class=line><span class=cl>    B --&gt; F
</span></span><span class=line><span class=cl>    F --&gt; G[LLM生成]
</span></span><span class=line><span class=cl>    G --&gt; H[答案]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    I[文档源] --&gt; J[文档处理]
</span></span><span class=line><span class=cl>    J --&gt; K[文本分块]
</span></span><span class=line><span class=cl>    K --&gt; L[向量化]
</span></span><span class=line><span class=cl>    L --&gt; D
</span></span></code></pre></div><h3 id=1-文档索引流程-indexing-pipeline>1. 文档索引流程 (Indexing Pipeline)</h3><p>这是RAG系统的准备阶段，负责将原始文档转换为可检索的格式。</p><h4 id=文档加载与预处理>文档加载与预处理</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DocumentLoader</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;文档加载器，支持多种格式&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>load_pdf</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>file_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;加载PDF文档&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 使用PyPDF2或pdfplumber</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>pdfplumber</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>text</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>pdfplumber</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span> <span class=k>as</span> <span class=n>pdf</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>page</span> <span class=ow>in</span> <span class=n>pdf</span><span class=o>.</span><span class=n>pages</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>text</span> <span class=o>+=</span> <span class=n>page</span><span class=o>.</span><span class=n>extract_text</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>load_markdown</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>file_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;加载Markdown文档&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_path</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>preprocess</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;文本预处理：清理、标准化&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 移除多余空白</span>
</span></span><span class=line><span class=cl>        <span class=n>text</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;\s+&#39;</span><span class=p>,</span> <span class=s1>&#39; &#39;</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 移除特殊字符</span>
</span></span><span class=line><span class=cl>        <span class=n>text</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;[\x00-\x08\x0b-\x0c\x0e-\x1f\x7f-\x9f]&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>text</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span></code></pre></div><h4 id=文本分块策略>文本分块策略</h4><p>文本分块(Chunking)是RAG系统中最关键的步骤之一。分块策略直接影响检索质量和生成效果。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>TextChunker</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;智能文本分块器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>chunk_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>512</span><span class=p>,</span> <span class=n>chunk_overlap</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>50</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            chunk_size: 每个块的目标大小(tokens)
</span></span></span><span class=line><span class=cl><span class=s2>            chunk_overlap: 块之间的重叠大小，用于保持上下文连贯性
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>chunk_size</span> <span class=o>=</span> <span class=n>chunk_size</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>chunk_overlap</span> <span class=o>=</span> <span class=n>chunk_overlap</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>chunk_by_tokens</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;基于token数量进行分块&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 使用tokenizer计算token数量</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>transformers</span> <span class=kn>import</span> <span class=n>AutoTokenizer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>tokenizer</span> <span class=o>=</span> <span class=n>AutoTokenizer</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=s2>&#34;sentence-transformers/all-MiniLM-L6-v2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>tokens</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>chunks</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>start</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=n>start</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>tokens</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># 提取当前块</span>
</span></span><span class=line><span class=cl>            <span class=n>end</span> <span class=o>=</span> <span class=n>start</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>chunk_size</span>
</span></span><span class=line><span class=cl>            <span class=n>chunk_tokens</span> <span class=o>=</span> <span class=n>tokens</span><span class=p>[</span><span class=n>start</span><span class=p>:</span><span class=n>end</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 解码为文本</span>
</span></span><span class=line><span class=cl>            <span class=n>chunk_text</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>chunk_tokens</span><span class=p>,</span> <span class=n>skip_special_tokens</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>chunks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>chunk_text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 移动到下一个块，考虑重叠</span>
</span></span><span class=line><span class=cl>            <span class=n>start</span> <span class=o>+=</span> <span class=bp>self</span><span class=o>.</span><span class=n>chunk_size</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>chunk_overlap</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>chunks</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>chunk_by_semantic</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;基于语义边界进行分块（更智能）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 按段落分割</span>
</span></span><span class=line><span class=cl>        <span class=n>paragraphs</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>chunks</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>current_chunk</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>current_size</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>para</span> <span class=ow>in</span> <span class=n>paragraphs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>para_size</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>para</span><span class=o>.</span><span class=n>split</span><span class=p>())</span>  <span class=c1># 简化的token估计</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 如果当前块加上新段落不会太大，合并</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>current_size</span> <span class=o>+</span> <span class=n>para_size</span> <span class=o>&lt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>chunk_size</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>current_chunk</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=n>para</span> <span class=k>if</span> <span class=n>current_chunk</span> <span class=k>else</span> <span class=n>para</span>
</span></span><span class=line><span class=cl>                <span class=n>current_size</span> <span class=o>+=</span> <span class=n>para_size</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 保存当前块，开始新块</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>current_chunk</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>chunks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>current_chunk</span><span class=o>.</span><span class=n>strip</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=n>current_chunk</span> <span class=o>=</span> <span class=n>para</span>
</span></span><span class=line><span class=cl>                <span class=n>current_size</span> <span class=o>=</span> <span class=n>para_size</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 添加最后一个块</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>current_chunk</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>chunks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>current_chunk</span><span class=o>.</span><span class=n>strip</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>chunks</span>
</span></span></code></pre></div><p><strong>分块策略的选择</strong>：</p><ul><li><strong>固定大小分块</strong>：简单快速，但可能在句子中间截断</li><li><strong>语义分块</strong>：尊重文档结构（段落、章节），保持语义完整性</li><li><strong>滑动窗口</strong>：使用重叠区域避免信息丢失</li><li><strong>递归分块</strong>：先按大结构（章节）分，再细分，适合长文档</li></ul><h4 id=向量化与索引>向量化与索引</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sentence_transformers</span> <span class=kn>import</span> <span class=n>SentenceTransformer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EmbeddingEngine</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;文本向量化引擎&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>model_name</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;sentence-transformers/all-MiniLM-L6-v2&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        初始化嵌入模型
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        常用模型选择：
</span></span></span><span class=line><span class=cl><span class=s2>        - all-MiniLM-L6-v2: 轻量级，速度快，384维
</span></span></span><span class=line><span class=cl><span class=s2>        - all-mpnet-base-v2: 性能更好，768维
</span></span></span><span class=line><span class=cl><span class=s2>        - text-embedding-ada-002: OpenAI模型，1536维
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>model</span> <span class=o>=</span> <span class=n>SentenceTransformer</span><span class=p>(</span><span class=n>model_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>dimension</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>get_sentence_embedding_dimension</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>embed_documents</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>texts</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;批量向量化文档&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 使用批处理提高效率</span>
</span></span><span class=line><span class=cl>        <span class=n>embeddings</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>texts</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>batch_size</span><span class=o>=</span><span class=mi>32</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>show_progress_bar</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>convert_to_numpy</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>embeddings</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>embed_query</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;向量化查询&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>convert_to_numpy</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=2-检索流程-retrieval-pipeline>2. 检索流程 (Retrieval Pipeline)</h3><p>检索是RAG的核心，目标是找到与用户查询最相关的文档片段。</p><h4 id=向量数据库集成>向量数据库集成</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Tuple</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>chromadb</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>chromadb.config</span> <span class=kn>import</span> <span class=n>Settings</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>VectorStore</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;向量数据库封装&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>collection_name</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;documents&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;初始化Chroma向量数据库&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>client</span> <span class=o>=</span> <span class=n>chromadb</span><span class=o>.</span><span class=n>Client</span><span class=p>(</span><span class=n>Settings</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>chroma_db_impl</span><span class=o>=</span><span class=s2>&#34;duckdb+parquet&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>persist_directory</span><span class=o>=</span><span class=s2>&#34;./chroma_db&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>collection</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>client</span><span class=o>.</span><span class=n>get_or_create_collection</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>name</span><span class=o>=</span><span class=n>collection_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>metadata</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;hnsw:space&#34;</span><span class=p>:</span> <span class=s2>&#34;cosine&#34;</span><span class=p>}</span>  <span class=c1># 使用余弦相似度</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>add_documents</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>texts</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>embeddings</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>metadatas</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;添加文档到向量库&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>ids</span> <span class=o>=</span> <span class=p>[</span><span class=sa>f</span><span class=s2>&#34;doc_</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&#34;</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>texts</span><span class=p>))]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>collection</span><span class=o>.</span><span class=n>add</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>ids</span><span class=o>=</span><span class=n>ids</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>embeddings</span><span class=o>=</span><span class=n>embeddings</span><span class=o>.</span><span class=n>tolist</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>documents</span><span class=o>=</span><span class=n>texts</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>metadatas</span><span class=o>=</span><span class=n>metadatas</span> <span class=ow>or</span> <span class=p>[{}]</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>texts</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>search</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>query_embedding</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>top_k</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Tuple</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span> <span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>],</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        检索最相关的文档
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            documents: 检索到的文本列表
</span></span></span><span class=line><span class=cl><span class=s2>            distances: 相似度分数列表
</span></span></span><span class=line><span class=cl><span class=s2>            metadatas: 元数据列表
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>collection</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>query_embeddings</span><span class=o>=</span><span class=p>[</span><span class=n>query_embedding</span><span class=o>.</span><span class=n>tolist</span><span class=p>()],</span>
</span></span><span class=line><span class=cl>            <span class=n>n_results</span><span class=o>=</span><span class=n>top_k</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span><span class=p>[</span><span class=s1>&#39;documents&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span><span class=p>[</span><span class=s1>&#39;distances&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span><span class=p>[</span><span class=s1>&#39;metadatas&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span></code></pre></div><h4 id=高级检索技术>高级检索技术</h4><h5 id=1-混合检索-hybrid-search>1. 混合检索 (Hybrid Search)</h5><p>结合向量检索和传统关键词检索，可以显著提升检索质量。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>rank_bm25</span> <span class=kn>import</span> <span class=n>BM25Okapi</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>HybridRetriever</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;混合检索器：结合向量检索和BM25&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>vector_store</span><span class=p>:</span> <span class=n>VectorStore</span><span class=p>,</span> <span class=n>documents</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>vector_store</span> <span class=o>=</span> <span class=n>vector_store</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>documents</span> <span class=o>=</span> <span class=n>documents</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 初始化BM25</span>
</span></span><span class=line><span class=cl>        <span class=n>tokenized_docs</span> <span class=o>=</span> <span class=p>[</span><span class=n>doc</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span><span class=o>.</span><span class=n>split</span><span class=p>()</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>documents</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>bm25</span> <span class=o>=</span> <span class=n>BM25Okapi</span><span class=p>(</span><span class=n>tokenized_docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>search</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>query_embedding</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>top_k</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>alpha</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.5</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Tuple</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>float</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        混合检索
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            alpha: 向量检索的权重 (0-1)，1-alpha为BM25权重
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 向量检索</span>
</span></span><span class=line><span class=cl>        <span class=n>vec_docs</span><span class=p>,</span> <span class=n>vec_scores</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>vector_store</span><span class=o>.</span><span class=n>search</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>query_embedding</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>top_k</span><span class=o>=</span><span class=n>top_k</span> <span class=o>*</span> <span class=mi>2</span>  <span class=c1># 检索更多候选</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># BM25检索</span>
</span></span><span class=line><span class=cl>        <span class=n>tokenized_query</span> <span class=o>=</span> <span class=n>query</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span><span class=o>.</span><span class=n>split</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>bm25_scores</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>bm25</span><span class=o>.</span><span class=n>get_scores</span><span class=p>(</span><span class=n>tokenized_query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 归一化分数</span>
</span></span><span class=line><span class=cl>        <span class=n>vec_scores</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>vec_scores</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>vec_scores</span> <span class=o>=</span> <span class=p>(</span><span class=n>vec_scores</span> <span class=o>-</span> <span class=n>vec_scores</span><span class=o>.</span><span class=n>min</span><span class=p>())</span> <span class=o>/</span> <span class=p>(</span><span class=n>vec_scores</span><span class=o>.</span><span class=n>max</span><span class=p>()</span> <span class=o>-</span> <span class=n>vec_scores</span><span class=o>.</span><span class=n>min</span><span class=p>()</span> <span class=o>+</span> <span class=mf>1e-10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>bm25_scores</span> <span class=o>=</span> <span class=p>(</span><span class=n>bm25_scores</span> <span class=o>-</span> <span class=n>bm25_scores</span><span class=o>.</span><span class=n>min</span><span class=p>())</span> <span class=o>/</span> <span class=p>(</span><span class=n>bm25_scores</span><span class=o>.</span><span class=n>max</span><span class=p>()</span> <span class=o>-</span> <span class=n>bm25_scores</span><span class=o>.</span><span class=n>min</span><span class=p>()</span> <span class=o>+</span> <span class=mf>1e-10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 合并分数</span>
</span></span><span class=line><span class=cl>        <span class=n>combined_scores</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>doc</span><span class=p>,</span> <span class=n>score</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>vec_docs</span><span class=p>,</span> <span class=n>vec_scores</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>doc</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>documents</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>idx</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>documents</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>doc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>combined_scores</span><span class=p>[</span><span class=n>doc</span><span class=p>]</span> <span class=o>=</span> <span class=n>alpha</span> <span class=o>*</span> <span class=n>score</span> <span class=o>+</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>alpha</span><span class=p>)</span> <span class=o>*</span> <span class=n>bm25_scores</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 排序并返回top-k</span>
</span></span><span class=line><span class=cl>        <span class=n>sorted_results</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>combined_scores</span><span class=o>.</span><span class=n>items</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=p>)[:</span><span class=n>top_k</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>sorted_results</span>
</span></span></code></pre></div><h5 id=2-重排序-reranking>2. 重排序 (Reranking)</h5><p>使用更强大的模型对初步检索结果进行重新排序。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sentence_transformers</span> <span class=kn>import</span> <span class=n>CrossEncoder</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Reranker</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;重排序器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>model_name</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;cross-encoder/ms-marco-MiniLM-L-6-v2&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        初始化交叉编码器模型
</span></span></span><span class=line><span class=cl><span class=s2>        CrossEncoder直接计算query-document对的相关性分数
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>model</span> <span class=o>=</span> <span class=n>CrossEncoder</span><span class=p>(</span><span class=n>model_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>rerank</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>documents</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>top_k</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Tuple</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>float</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        重排序文档
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            query: 用户查询
</span></span></span><span class=line><span class=cl><span class=s2>            documents: 候选文档列表
</span></span></span><span class=line><span class=cl><span class=s2>            top_k: 返回前k个结果
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 构建query-document对</span>
</span></span><span class=line><span class=cl>        <span class=n>pairs</span> <span class=o>=</span> <span class=p>[[</span><span class=n>query</span><span class=p>,</span> <span class=n>doc</span><span class=p>]</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>documents</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 计算相关性分数</span>
</span></span><span class=line><span class=cl>        <span class=n>scores</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>pairs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 排序</span>
</span></span><span class=line><span class=cl>        <span class=n>ranked_results</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nb>zip</span><span class=p>(</span><span class=n>documents</span><span class=p>,</span> <span class=n>scores</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=p>)[:</span><span class=n>top_k</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ranked_results</span>
</span></span></code></pre></div><h5 id=3-查询改写-query-rewriting>3. 查询改写 (Query Rewriting)</h5><p>优化用户查询以提升检索效果。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>openai</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>QueryRewriter</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;查询改写器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>api_key</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>openai</span><span class=o>.</span><span class=n>api_key</span> <span class=o>=</span> <span class=n>api_key</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>expand_query</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        生成多个查询变体以提高召回率
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        例如：&#34;什么是RAG？&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        可能生成：
</span></span></span><span class=line><span class=cl><span class=s2>        - &#34;RAG的定义是什么&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        - &#34;检索增强生成技术&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        - &#34;Retrieval-Augmented Generation原理&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        Given the user query: &#34;</span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Generate 3 alternative phrasings of this query that would help retrieve relevant information.
</span></span></span><span class=line><span class=cl><span class=s2>        Each alternative should focus on different aspects or use different terminology.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Return only the alternative queries, one per line.
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>openai</span><span class=o>.</span><span class=n>ChatCompletion</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-3.5-turbo&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>messages</span><span class=o>=</span><span class=p>[{</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>prompt</span><span class=p>}],</span>
</span></span><span class=line><span class=cl>            <span class=n>temperature</span><span class=o>=</span><span class=mf>0.7</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>alternatives</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>choices</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>content</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=n>query</span><span class=p>]</span> <span class=o>+</span> <span class=n>alternatives</span>  <span class=c1># 包含原始查询</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>extract_keywords</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;提取关键词用于BM25检索&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 简化版本：可以使用NLP库如spaCy进行更精确的提取</span>
</span></span><span class=line><span class=cl>        <span class=n>stopwords</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;的&#39;</span><span class=p>,</span> <span class=s1>&#39;是&#39;</span><span class=p>,</span> <span class=s1>&#39;在&#39;</span><span class=p>,</span> <span class=s1>&#39;了&#39;</span><span class=p>,</span> <span class=s1>&#39;和&#39;</span><span class=p>,</span> <span class=s1>&#39;与&#39;</span><span class=p>,</span> <span class=s1>&#39;或&#39;</span><span class=p>,</span> <span class=s1>&#39;什么&#39;</span><span class=p>,</span> <span class=s1>&#39;如何&#39;</span><span class=p>,</span> <span class=s1>&#39;为什么&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>words</span> <span class=o>=</span> <span class=n>query</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span><span class=o>.</span><span class=n>split</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>keywords</span> <span class=o>=</span> <span class=p>[</span><span class=n>w</span> <span class=k>for</span> <span class=n>w</span> <span class=ow>in</span> <span class=n>words</span> <span class=k>if</span> <span class=n>w</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>stopwords</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>keywords</span>
</span></span></code></pre></div><h3 id=3-生成流程-generation-pipeline>3. 生成流程 (Generation Pipeline)</h3><p>检索到相关文档后，需要构建合适的prompt并调用LLM生成答案。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>openai</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RAGGenerator</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;RAG生成器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>api_key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>model</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>temperature</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.1</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>openai</span><span class=o>.</span><span class=n>api_key</span> <span class=o>=</span> <span class=n>api_key</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>model</span> <span class=o>=</span> <span class=n>model</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>temperature</span> <span class=o>=</span> <span class=n>temperature</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>build_context</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>documents</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>max_tokens</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>2000</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        构建上下文，控制token数量
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        策略：
</span></span></span><span class=line><span class=cl><span class=s2>        1. 优先包含最相关的文档
</span></span></span><span class=line><span class=cl><span class=s2>        2. 确保不超过max_tokens限制
</span></span></span><span class=line><span class=cl><span class=s2>        3. 保持文档完整性
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>context_parts</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>current_tokens</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>doc</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>documents</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># 简化的token估计</span>
</span></span><span class=line><span class=cl>            <span class=n>doc_tokens</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>doc</span><span class=o>.</span><span class=n>split</span><span class=p>())</span> <span class=o>*</span> <span class=mf>1.3</span>  <span class=c1># 英文约1.3 tokens per word</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>current_tokens</span> <span class=o>+</span> <span class=n>doc_tokens</span> <span class=o>&gt;</span> <span class=n>max_tokens</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>context_parts</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Document </span><span class=si>{</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2>]</span><span class=se>\n</span><span class=si>{</span><span class=n>doc</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>current_tokens</span> <span class=o>+=</span> <span class=n>doc_tokens</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>context_parts</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>retrieved_docs</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>system_prompt</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        生成答案
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            包含answer和metadata的字典
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 构建上下文</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>build_context</span><span class=p>(</span><span class=n>retrieved_docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 默认系统提示</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>system_prompt</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>system_prompt</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;你是一个专业的AI助手。你的任务是基于提供的参考文档回答用户问题。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>重要规则：
</span></span></span><span class=line><span class=cl><span class=s2>1. 只使用参考文档中的信息来回答问题
</span></span></span><span class=line><span class=cl><span class=s2>2. 如果文档中没有相关信息，明确告诉用户&#34;根据提供的文档，我无法回答这个问题&#34;
</span></span></span><span class=line><span class=cl><span class=s2>3. 引用具体的文档内容时，注明来源（例如&#34;根据Document 1...&#34;）
</span></span></span><span class=line><span class=cl><span class=s2>4. 保持回答准确、客观、有条理
</span></span></span><span class=line><span class=cl><span class=s2>5. 不要编造或推测文档中没有的信息&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 构建用户消息</span>
</span></span><span class=line><span class=cl>        <span class=n>user_message</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;参考文档：
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=si>{</span><span class=n>context</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>用户问题：</span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>请基于上述参考文档回答问题。&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 调用LLM</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>openai</span><span class=o>.</span><span class=n>ChatCompletion</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;system&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>system_prompt</span><span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>user_message</span><span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>temperature</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>temperature</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>max_tokens</span><span class=o>=</span><span class=mi>1000</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>answer</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>choices</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=n>answer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;context&#34;</span><span class=p>:</span> <span class=n>context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;model&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;tokens_used&#34;</span><span class=p>:</span> <span class=n>response</span><span class=o>.</span><span class=n>usage</span><span class=o>.</span><span class=n>total_tokens</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_with_citations</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>retrieved_docs</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Tuple</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>float</span><span class=p>]],</span>  <span class=c1># (document, score)</span>
</span></span><span class=line><span class=cl>        <span class=n>metadatas</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        生成带引用的答案
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 构建带编号的上下文</span>
</span></span><span class=line><span class=cl>        <span class=n>context_parts</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=p>((</span><span class=n>doc</span><span class=p>,</span> <span class=n>score</span><span class=p>),</span> <span class=n>metadata</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>retrieved_docs</span><span class=p>,</span> <span class=n>metadatas</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=n>source</span> <span class=o>=</span> <span class=n>metadata</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;source&#39;</span><span class=p>,</span> <span class=s1>&#39;Unknown&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>context_parts</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=sa>f</span><span class=s2>&#34;[</span><span class=si>{</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2>] (Source: </span><span class=si>{</span><span class=n>source</span><span class=si>}</span><span class=s2>, Relevance: </span><span class=si>{</span><span class=n>score</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>)</span><span class=se>\n</span><span class=si>{</span><span class=n>doc</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>context</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>context_parts</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>system_prompt</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;你是一个专业的AI助手。基于提供的参考文档回答问题，并在答案中使用[数字]标注引用来源。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>示例：
</span></span></span><span class=line><span class=cl><span class=s2>问题：RAG有什么优势？
</span></span></span><span class=line><span class=cl><span class=s2>答案：RAG的主要优势包括：1) 可以实时更新知识库而无需重新训练模型[1]，2) 显著降低模型幻觉问题[2]，3) 提供可追溯的信息来源[1]。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>规则：
</span></span></span><span class=line><span class=cl><span class=s2>- 使用[1]、[2]等标注引用的文档编号
</span></span></span><span class=line><span class=cl><span class=s2>- 只使用文档中的信息
</span></span></span><span class=line><span class=cl><span class=s2>- 如果无法回答，明确说明&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>user_message</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;参考文档：
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=si>{</span><span class=n>context</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>用户问题：</span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>请回答问题并标注引用来源。&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>openai</span><span class=o>.</span><span class=n>ChatCompletion</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;system&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>system_prompt</span><span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>user_message</span><span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>temperature</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>temperature</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=n>response</span><span class=o>.</span><span class=n>choices</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>content</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;sources&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>meta</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;source&#39;</span><span class=p>,</span> <span class=s1>&#39;Unknown&#39;</span><span class=p>)</span> <span class=k>for</span> <span class=n>meta</span> <span class=ow>in</span> <span class=n>metadatas</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;relevance_scores&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>score</span> <span class=k>for</span> <span class=n>_</span><span class=p>,</span> <span class=n>score</span> <span class=ow>in</span> <span class=n>retrieved_docs</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></div><h2 id=完整的rag系统实现>完整的RAG系统实现</h2><p>将上述组件整合成一个完整的RAG系统：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>RAGSystem</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;完整的RAG系统&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>embedding_model</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;sentence-transformers/all-MiniLM-L6-v2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>llm_model</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>api_key</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 初始化各个组件</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>loader</span> <span class=o>=</span> <span class=n>DocumentLoader</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>chunker</span> <span class=o>=</span> <span class=n>TextChunker</span><span class=p>(</span><span class=n>chunk_size</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span> <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>50</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>embedder</span> <span class=o>=</span> <span class=n>EmbeddingEngine</span><span class=p>(</span><span class=n>embedding_model</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>vector_store</span> <span class=o>=</span> <span class=n>VectorStore</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>reranker</span> <span class=o>=</span> <span class=n>Reranker</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>generator</span> <span class=o>=</span> <span class=n>RAGGenerator</span><span class=p>(</span><span class=n>api_key</span><span class=p>,</span> <span class=n>llm_model</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>documents</span> <span class=o>=</span> <span class=p>[]</span>  <span class=c1># 存储原始文档</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>ingest_documents</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>file_paths</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        文档摄入流程
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            file_paths: 文档文件路径列表
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Loading documents...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>all_chunks</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>all_metadatas</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>file_path</span> <span class=ow>in</span> <span class=n>file_paths</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 加载文档</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>file_path</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=s1>&#39;.pdf&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>text</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>loader</span><span class=o>.</span><span class=n>load_pdf</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>file_path</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=s1>&#39;.md&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>text</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>loader</span><span class=o>.</span><span class=n>load_markdown</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 预处理</span>
</span></span><span class=line><span class=cl>            <span class=n>text</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>loader</span><span class=o>.</span><span class=n>preprocess</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 分块</span>
</span></span><span class=line><span class=cl>            <span class=n>chunks</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>chunker</span><span class=o>.</span><span class=n>chunk_by_semantic</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 记录元数据</span>
</span></span><span class=line><span class=cl>            <span class=n>metadatas</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span><span class=s2>&#34;source&#34;</span><span class=p>:</span> <span class=n>file_path</span><span class=p>,</span> <span class=s2>&#34;chunk_id&#34;</span><span class=p>:</span> <span class=n>i</span><span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>chunks</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>all_chunks</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>chunks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>all_metadatas</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>metadatas</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>documents</span> <span class=o>=</span> <span class=n>all_chunks</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 向量化</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Embedding </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>all_chunks</span><span class=p>)</span><span class=si>}</span><span class=s2> chunks...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>embeddings</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>embedder</span><span class=o>.</span><span class=n>embed_documents</span><span class=p>(</span><span class=n>all_chunks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 索引</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Indexing to vector store...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>vector_store</span><span class=o>.</span><span class=n>add_documents</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>texts</span><span class=o>=</span><span class=n>all_chunks</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>embeddings</span><span class=o>=</span><span class=n>embeddings</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>metadatas</span><span class=o>=</span><span class=n>all_metadatas</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Successfully ingested </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>file_paths</span><span class=p>)</span><span class=si>}</span><span class=s2> documents!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>query</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>question</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>top_k</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>use_reranking</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        查询RAG系统
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            question: 用户问题
</span></span></span><span class=line><span class=cl><span class=s2>            top_k: 返回的文档数量
</span></span></span><span class=line><span class=cl><span class=s2>            use_reranking: 是否使用重排序
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            包含答案和元数据的字典
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Query: </span><span class=si>{</span><span class=n>question</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 1. 向量化查询</span>
</span></span><span class=line><span class=cl>        <span class=n>query_embedding</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>embedder</span><span class=o>.</span><span class=n>embed_query</span><span class=p>(</span><span class=n>question</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 2. 检索</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Retrieving relevant documents...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>retrieved_docs</span><span class=p>,</span> <span class=n>scores</span><span class=p>,</span> <span class=n>metadatas</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>vector_store</span><span class=o>.</span><span class=n>search</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>query_embedding</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>top_k</span><span class=o>=</span><span class=n>top_k</span> <span class=o>*</span> <span class=mi>2</span> <span class=k>if</span> <span class=n>use_reranking</span> <span class=k>else</span> <span class=n>top_k</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 3. 重排序（可选）</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>use_reranking</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Reranking documents...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>reranked</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>reranker</span><span class=o>.</span><span class=n>rerank</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>question</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>retrieved_docs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>top_k</span><span class=o>=</span><span class=n>top_k</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>retrieved_docs</span> <span class=o>=</span> <span class=p>[</span><span class=n>doc</span> <span class=k>for</span> <span class=n>doc</span><span class=p>,</span> <span class=n>_</span> <span class=ow>in</span> <span class=n>reranked</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>scores</span> <span class=o>=</span> <span class=p>[</span><span class=n>score</span> <span class=k>for</span> <span class=n>_</span><span class=p>,</span> <span class=n>score</span> <span class=ow>in</span> <span class=n>reranked</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 4. 生成答案</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Generating answer...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>generator</span><span class=o>.</span><span class=n>generate_with_citations</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>question</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nb>list</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>retrieved_docs</span><span class=p>,</span> <span class=n>scores</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>            <span class=n>metadatas</span><span class=p>[:</span><span class=nb>len</span><span class=p>(</span><span class=n>retrieved_docs</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 初始化系统</span>
</span></span><span class=line><span class=cl>    <span class=n>rag</span> <span class=o>=</span> <span class=n>RAGSystem</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>api_key</span><span class=o>=</span><span class=s2>&#34;your-openai-api-key&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 摄入文档</span>
</span></span><span class=line><span class=cl>    <span class=n>rag</span><span class=o>.</span><span class=n>ingest_documents</span><span class=p>([</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;./docs/rag_paper.pdf&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;./docs/llm_guide.md&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;./docs/vector_db_intro.pdf&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 查询</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>rag</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;什么是RAG？它解决了什么问题？&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>top_k</span><span class=o>=</span><span class=mi>3</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>Answer:&#34;</span><span class=p>,</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;answer&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>Sources:&#34;</span><span class=p>,</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;sources&#39;</span><span class=p>])</span>
</span></span></code></pre></div><h2 id=rag系统的优化策略>RAG系统的优化策略</h2><h3 id=1-提升检索质量>1. 提升检索质量</h3><h4 id=查询扩展与改写>查询扩展与改写</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>AdvancedQueryProcessor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;高级查询处理器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>hypothetical_document_embeddings</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>llm</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        HyDE (Hypothetical Document Embeddings)技术
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        思路：让LLM生成一个假设性的答案文档，
</span></span></span><span class=line><span class=cl><span class=s2>        然后用这个文档进行检索，往往比直接用query检索效果更好
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;给定问题：</span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>请生成一个详细的、假设性的答案（即使你不确定具体细节）。
</span></span></span><span class=line><span class=cl><span class=s2>这个答案应该包含可能出现在真实答案文档中的关键术语和概念。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>假设性答案：&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>hypothetical_doc</span> <span class=o>=</span> <span class=n>llm</span><span class=o>.</span><span class=n>generate</span><span class=p>(</span><span class=n>prompt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>hypothetical_doc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>multi_query_retrieval</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>llm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>retriever</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        多查询检索：生成多个角度的查询，合并结果
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;给定用户问题：</span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>生成3个不同角度的相关问题，这些问题的答案能够帮助回答原问题。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>问题1：
</span></span></span><span class=line><span class=cl><span class=s2>问题2：
</span></span></span><span class=line><span class=cl><span class=s2>问题3：&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>llm</span><span class=o>.</span><span class=n>generate</span><span class=p>(</span><span class=n>prompt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>queries</span> <span class=o>=</span> <span class=p>[</span><span class=n>query</span><span class=p>]</span> <span class=o>+</span> <span class=n>response</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 对每个查询进行检索</span>
</span></span><span class=line><span class=cl>        <span class=n>all_docs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>q</span> <span class=ow>in</span> <span class=n>queries</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>docs</span> <span class=o>=</span> <span class=n>retriever</span><span class=o>.</span><span class=n>retrieve</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>top_k</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>all_docs</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 去重</span>
</span></span><span class=line><span class=cl>        <span class=n>unique_docs</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>dict</span><span class=o>.</span><span class=n>fromkeys</span><span class=p>(</span><span class=n>all_docs</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>unique_docs</span>
</span></span></code></pre></div><h3 id=2-优化分块策略>2. 优化分块策略</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>AdaptiveChunker</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;自适应分块器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>chunk_with_context</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>chunk_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>512</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        带上下文的分块
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        每个chunk包含：
</span></span></span><span class=line><span class=cl><span class=s2>        - 主要内容
</span></span></span><span class=line><span class=cl><span class=s2>        - 前置上下文（标题、摘要等）
</span></span></span><span class=line><span class=cl><span class=s2>        - 后续上下文预览
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 检测文档结构</span>
</span></span><span class=line><span class=cl>        <span class=n>sections</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_detect_sections</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>chunks</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>section</span> <span class=ow>in</span> <span class=n>sections</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>title</span> <span class=o>=</span> <span class=n>section</span><span class=p>[</span><span class=s1>&#39;title&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=o>=</span> <span class=n>section</span><span class=p>[</span><span class=s1>&#39;content&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 分割section内容</span>
</span></span><span class=line><span class=cl>            <span class=n>sub_chunks</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_split_by_size</span><span class=p>(</span><span class=n>content</span><span class=p>,</span> <span class=n>chunk_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>chunk</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>sub_chunks</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=c1># 添加上下文信息</span>
</span></span><span class=line><span class=cl>                <span class=n>chunk_with_context</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;text&#39;</span><span class=p>:</span> <span class=n>chunk</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;title&#39;</span><span class=p>:</span> <span class=n>title</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;position&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>sub_chunks</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;preview_next&#39;</span><span class=p>:</span> <span class=n>sub_chunks</span><span class=p>[</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>][:</span><span class=mi>100</span><span class=p>]</span> <span class=k>if</span> <span class=n>i</span><span class=o>+</span><span class=mi>1</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>sub_chunks</span><span class=p>)</span> <span class=k>else</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=n>chunks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>chunk_with_context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>chunks</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_detect_sections</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;检测文档的章节结构&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 简化版本：基于标题标记</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 匹配Markdown标题</span>
</span></span><span class=line><span class=cl>        <span class=n>sections</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>current_section</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;Introduction&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>lines</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>re</span><span class=o>.</span><span class=k>match</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;^#{1,3}\s+&#39;</span><span class=p>,</span> <span class=n>line</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=c1># 保存当前section</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>current_section</span><span class=p>[</span><span class=s1>&#39;content&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=n>sections</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>current_section</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 开始新section</span>
</span></span><span class=line><span class=cl>                <span class=n>title</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;^#{1,3}\s+&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>line</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>current_section</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;title&#34;</span><span class=p>:</span> <span class=n>title</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>current_section</span><span class=p>[</span><span class=s1>&#39;content&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=n>line</span> <span class=o>+</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 添加最后一个section</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>current_section</span><span class=p>[</span><span class=s1>&#39;content&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>sections</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>current_section</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>sections</span>
</span></span></code></pre></div><h3 id=3-智能上下文压缩>3. 智能上下文压缩</h3><p>当检索到大量文档时，可能超过LLM的上下文窗口限制。这时需要压缩技术：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>ContextCompressor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;上下文压缩器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>llm</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>llm</span> <span class=o>=</span> <span class=n>llm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>extractive_compression</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>documents</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>max_length</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>2000</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        抽取式压缩：提取最相关的句子
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>all_sentences</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>documents</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>sentences</span> <span class=o>=</span> <span class=n>doc</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>all_sentences</span><span class=o>.</span><span class=n>extend</span><span class=p>([(</span><span class=n>s</span><span class=o>.</span><span class=n>strip</span><span class=p>(),</span> <span class=n>doc</span><span class=p>)</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>sentences</span> <span class=k>if</span> <span class=n>s</span><span class=o>.</span><span class=n>strip</span><span class=p>()])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 计算每个句子与query的相关性</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>sentence_transformers</span> <span class=kn>import</span> <span class=n>util</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>query_emb</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>embedder</span><span class=o>.</span><span class=n>embed_query</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>sentence_embs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>embedder</span><span class=o>.</span><span class=n>embed_documents</span><span class=p>([</span><span class=n>s</span> <span class=k>for</span> <span class=n>s</span><span class=p>,</span> <span class=n>_</span> <span class=ow>in</span> <span class=n>all_sentences</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>similarities</span> <span class=o>=</span> <span class=n>util</span><span class=o>.</span><span class=n>cos_sim</span><span class=p>(</span><span class=n>query_emb</span><span class=p>,</span> <span class=n>sentence_embs</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 选择最相关的句子</span>
</span></span><span class=line><span class=cl>        <span class=n>ranked_sentences</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nb>zip</span><span class=p>(</span><span class=n>all_sentences</span><span class=p>,</span> <span class=n>similarities</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 构建压缩后的上下文</span>
</span></span><span class=line><span class=cl>        <span class=n>compressed</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>current_length</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=n>sentence</span><span class=p>,</span> <span class=n>doc</span><span class=p>),</span> <span class=n>score</span> <span class=ow>in</span> <span class=n>ranked_sentences</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>current_length</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=n>sentence</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>max_length</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>            <span class=n>compressed</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>sentence</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>current_length</span> <span class=o>+=</span> <span class=nb>len</span><span class=p>(</span><span class=n>sentence</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;. &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>compressed</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;.&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>abstractive_compression</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>documents</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        生成式压缩：让LLM总结相关信息
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;给定以下文档和用户问题，提取并总结所有与问题相关的信息。
</span></span></span><span class=line><span class=cl><span class=s2>保持事实准确，使用简洁的语言。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>文档：
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=si>{</span><span class=n>context</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>问题：</span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>相关信息总结：&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>compressed</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span><span class=o>.</span><span class=n>generate</span><span class=p>(</span><span class=n>prompt</span><span class=p>,</span> <span class=n>max_tokens</span><span class=o>=</span><span class=mi>500</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>compressed</span>
</span></span></code></pre></div><h3 id=4-结果评估与反馈循环>4. 结果评估与反馈循环</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>RAGEvaluator</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;RAG系统评估器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>evaluate_retrieval</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>retrieved_docs</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>ground_truth_docs</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>float</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        评估检索质量
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        指标：
</span></span></span><span class=line><span class=cl><span class=s2>        - Precision@K
</span></span></span><span class=line><span class=cl><span class=s2>        - Recall@K
</span></span></span><span class=line><span class=cl><span class=s2>        - MRR (Mean Reciprocal Rank)
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>retrieved_set</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>retrieved_docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>relevant_set</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>ground_truth_docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Precision and Recall</span>
</span></span><span class=line><span class=cl>        <span class=n>true_positives</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>retrieved_set</span> <span class=o>&amp;</span> <span class=n>relevant_set</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>precision</span> <span class=o>=</span> <span class=n>true_positives</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>retrieved_set</span><span class=p>)</span> <span class=k>if</span> <span class=n>retrieved_set</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=n>recall</span> <span class=o>=</span> <span class=n>true_positives</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>relevant_set</span><span class=p>)</span> <span class=k>if</span> <span class=n>relevant_set</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># F1 Score</span>
</span></span><span class=line><span class=cl>        <span class=n>f1</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=p>(</span><span class=n>precision</span> <span class=o>*</span> <span class=n>recall</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>precision</span> <span class=o>+</span> <span class=n>recall</span><span class=p>)</span> <span class=k>if</span> <span class=p>(</span><span class=n>precision</span> <span class=o>+</span> <span class=n>recall</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># MRR</span>
</span></span><span class=line><span class=cl>        <span class=n>mrr</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>doc</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>retrieved_docs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>relevant_set</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>mrr</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=p>(</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;precision&#34;</span><span class=p>:</span> <span class=n>precision</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;recall&#34;</span><span class=p>:</span> <span class=n>recall</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;f1&#34;</span><span class=p>:</span> <span class=n>f1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;mrr&#34;</span><span class=p>:</span> <span class=n>mrr</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>evaluate_generation</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>generated_answer</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>reference_answer</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>float</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        评估生成质量
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        指标：
</span></span></span><span class=line><span class=cl><span class=s2>        - Faithfulness: 答案是否基于context
</span></span></span><span class=line><span class=cl><span class=s2>        - Answer Relevance: 答案是否相关
</span></span></span><span class=line><span class=cl><span class=s2>        - Context Relevance: context是否相关
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 使用LLM进行评估</span>
</span></span><span class=line><span class=cl>        <span class=n>faithfulness_prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;评估答案是否完全基于提供的上下文，没有添加额外信息。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>上下文：</span><span class=si>{</span><span class=n>context</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>答案：</span><span class=si>{</span><span class=n>generated_answer</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>评分(0-1)：&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 这里简化处理，实际应使用专门的评估模型</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;faithfulness&#34;</span><span class=p>:</span> <span class=mf>0.0</span><span class=p>,</span>  <span class=c1># 需要实际实现</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;answer_relevance&#34;</span><span class=p>:</span> <span class=mf>0.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;context_relevance&#34;</span><span class=p>:</span> <span class=mf>0.0</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></div><h2 id=rag的高级应用模式>RAG的高级应用模式</h2><h3 id=1-多跳推理-multi-hop-reasoning>1. 多跳推理 (Multi-Hop Reasoning)</h3><p>对于需要综合多个信息源的复杂问题：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>MultiHopRAG</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;支持多跳推理的RAG系统&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>rag_system</span><span class=p>:</span> <span class=n>RAGSystem</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>rag</span> <span class=o>=</span> <span class=n>rag_system</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>multi_hop_query</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>question</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>max_hops</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>3</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        多跳查询：迭代检索和推理
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        例如：
</span></span></span><span class=line><span class=cl><span class=s2>        Q: &#34;Claude Code的作者创建的其他项目有哪些？&#34;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Hop 1: 检索 &#34;Claude Code的作者&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        -&gt; 得到答案 &#34;Anthropic团队&#34;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Hop 2: 检索 &#34;Anthropic团队的其他项目&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        -&gt; 得到最终答案
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>conversation_history</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>current_query</span> <span class=o>=</span> <span class=n>question</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>hop</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_hops</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>--- Hop </span><span class=si>{</span><span class=n>hop</span> <span class=o>+</span> <span class=mi>1</span><span class=si>}</span><span class=s2> ---&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Query: </span><span class=si>{</span><span class=n>current_query</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 检索和生成</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rag</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>current_query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>answer</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;answer&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>conversation_history</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=n>current_query</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=n>answer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;sources&#34;</span><span class=p>:</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;sources&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 判断是否需要继续</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_is_complete</span><span class=p>(</span><span class=n>answer</span><span class=p>,</span> <span class=n>question</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 生成下一跳的查询</span>
</span></span><span class=line><span class=cl>            <span class=n>current_query</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_generate_followup_query</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>question</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>conversation_history</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>current_query</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 综合所有hops的信息生成最终答案</span>
</span></span><span class=line><span class=cl>        <span class=n>final_answer</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_synthesize_answer</span><span class=p>(</span><span class=n>question</span><span class=p>,</span> <span class=n>conversation_history</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=n>final_answer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;reasoning_chain&#34;</span><span class=p>:</span> <span class=n>conversation_history</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_is_complete</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>answer</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>original_question</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;判断答案是否完整&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 简化版本：可以使用LLM判断</span>
</span></span><span class=line><span class=cl>        <span class=n>incomplete_indicators</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;需要更多信息&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;无法回答&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;不清楚&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;首先需要&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=ow>not</span> <span class=nb>any</span><span class=p>(</span><span class=n>ind</span> <span class=ow>in</span> <span class=n>answer</span> <span class=k>for</span> <span class=n>ind</span> <span class=ow>in</span> <span class=n>incomplete_indicators</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=2-self-rag自我反思的rag>2. Self-RAG：自我反思的RAG</h3><p>让模型评估检索质量并决定是否需要检索：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>SelfRAG</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Self-RAG: 模型自主决定何时检索
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Reference: Self-RAG: Learning to Retrieve, Generate, and Critique
</span></span></span><span class=line><span class=cl><span class=s2>    through Self-Reflection (Asai et al., 2023)
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>rag_system</span><span class=p>:</span> <span class=n>RAGSystem</span><span class=p>,</span> <span class=n>llm</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>rag</span> <span class=o>=</span> <span class=n>rag_system</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>llm</span> <span class=o>=</span> <span class=n>llm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>query_with_reflection</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>question</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;带自我反思的查询&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 步骤1: 判断是否需要检索</span>
</span></span><span class=line><span class=cl>        <span class=n>need_retrieval</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_should_retrieve</span><span class=p>(</span><span class=n>question</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>need_retrieval</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 直接生成答案</span>
</span></span><span class=line><span class=cl>            <span class=n>answer</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span><span class=o>.</span><span class=n>generate</span><span class=p>(</span><span class=n>question</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=n>answer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;used_retrieval&#34;</span><span class=p>:</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 步骤2: 检索</span>
</span></span><span class=line><span class=cl>        <span class=n>retrieval_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rag</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>question</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 步骤3: 评估检索结果的相关性</span>
</span></span><span class=line><span class=cl>        <span class=n>relevance</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_assess_relevance</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>question</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>retrieval_result</span><span class=p>[</span><span class=s1>&#39;context&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>relevance</span> <span class=o>&lt;</span> <span class=mf>0.5</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 检索结果不相关，尝试改写查询或直接生成</span>
</span></span><span class=line><span class=cl>            <span class=n>answer</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span><span class=o>.</span><span class=n>generate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>question</span><span class=si>}</span><span class=se>\n\n</span><span class=s2>注意：相关文档有限，请根据一般知识回答。&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=n>answer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;used_retrieval&#34;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;relevance&#34;</span><span class=p>:</span> <span class=n>relevance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;warning&#34;</span><span class=p>:</span> <span class=s2>&#34;检索结果相关性较低&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 步骤4: 生成答案</span>
</span></span><span class=line><span class=cl>        <span class=n>answer</span> <span class=o>=</span> <span class=n>retrieval_result</span><span class=p>[</span><span class=s1>&#39;answer&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 步骤5: 评估答案的支持度</span>
</span></span><span class=line><span class=cl>        <span class=n>support</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_assess_support</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>answer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>retrieval_result</span><span class=p>[</span><span class=s1>&#39;context&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 步骤6: 评估答案的有用性</span>
</span></span><span class=line><span class=cl>        <span class=n>utility</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_assess_utility</span><span class=p>(</span><span class=n>answer</span><span class=p>,</span> <span class=n>question</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=n>answer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;used_retrieval&#34;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;relevance&#34;</span><span class=p>:</span> <span class=n>relevance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;support&#34;</span><span class=p>:</span> <span class=n>support</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;utility&#34;</span><span class=p>:</span> <span class=n>utility</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;sources&#34;</span><span class=p>:</span> <span class=n>retrieval_result</span><span class=p>[</span><span class=s1>&#39;sources&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_should_retrieve</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>question</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;判断是否需要检索&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;判断以下问题是否需要检索外部知识才能回答（回答&#34;是&#34;或&#34;否&#34;）：
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>问题：</span><span class=si>{</span><span class=n>question</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>需要检索外部知识吗？&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span><span class=o>.</span><span class=n>generate</span><span class=p>(</span><span class=n>prompt</span><span class=p>,</span> <span class=n>max_tokens</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;是&#34;</span> <span class=ow>in</span> <span class=n>response</span> <span class=ow>or</span> <span class=s2>&#34;yes&#34;</span> <span class=ow>in</span> <span class=n>response</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_assess_relevance</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>question</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;评估检索内容的相关性 (0-1)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 可以使用NLI模型或LLM</span>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;评估以下文档对于回答问题的相关性，给出0-1之间的分数。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>问题：</span><span class=si>{</span><span class=n>question</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>文档：</span><span class=si>{</span><span class=n>context</span><span class=p>[:</span><span class=mi>500</span><span class=p>]</span><span class=si>}</span><span class=s2>...
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>相关性分数(0-1)：&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span><span class=o>.</span><span class=n>generate</span><span class=p>(</span><span class=n>prompt</span><span class=p>,</span> <span class=n>max_tokens</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nb>float</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>strip</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=mf>0.5</span>
</span></span></code></pre></div><h3 id=3-对话式rag>3. 对话式RAG</h3><p>支持多轮对话的RAG系统：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>ConversationalRAG</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;对话式RAG系统&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>rag_system</span><span class=p>:</span> <span class=n>RAGSystem</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>rag</span> <span class=o>=</span> <span class=n>rag_system</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conversation_history</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>chat</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_message</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        处理对话消息
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        关键能力：
</span></span></span><span class=line><span class=cl><span class=s2>        1. 理解上下文和指代消解
</span></span></span><span class=line><span class=cl><span class=s2>        2. 维护对话状态
</span></span></span><span class=line><span class=cl><span class=s2>        3. 处理追问和澄清
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 步骤1: 指代消解</span>
</span></span><span class=line><span class=cl>        <span class=n>resolved_query</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_resolve_references</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>user_message</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>conversation_history</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Resolved query: </span><span class=si>{</span><span class=n>resolved_query</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 步骤2: 检索和生成</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rag</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>resolved_query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 步骤3: 更新对话历史</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conversation_history</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;user&#34;</span><span class=p>:</span> <span class=n>user_message</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;assistant&#34;</span><span class=p>:</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;answer&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;sources&#34;</span><span class=p>:</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;sources&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 步骤4: 格式化回复</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_format_response</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_resolve_references</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>current_message</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>history</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        指代消解：处理&#34;它&#34;、&#34;这个&#34;、&#34;上面提到的&#34;等指代
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        例如：
</span></span></span><span class=line><span class=cl><span class=s2>        User: &#34;什么是RAG？&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        Assistant: &#34;RAG是检索增强生成...&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        User: &#34;它有什么优势？&#34;  # &#34;它&#34;指代RAG
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>history</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>current_message</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 使用LLM进行指代消解</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s2>&#34;User: </span><span class=si>{</span><span class=n>turn</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>]</span><span class=si>}</span><span class=se>\n</span><span class=s2>Assistant: </span><span class=si>{</span><span class=n>turn</span><span class=p>[</span><span class=s1>&#39;assistant&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>turn</span> <span class=ow>in</span> <span class=n>history</span><span class=p>[</span><span class=o>-</span><span class=mi>3</span><span class=p>:]</span>  <span class=c1># 只看最近3轮</span>
</span></span><span class=line><span class=cl>        <span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;给定对话历史，将当前消息中的指代词明确化。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>对话历史：
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=si>{</span><span class=n>context</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>当前消息：</span><span class=si>{</span><span class=n>current_message</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>明确化后的消息：&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 这里简化处理，实际应该用专门的消解模型</span>
</span></span><span class=line><span class=cl>        <span class=c1># 或者更智能的LLM调用</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 简单启发式：如果消息很短且有指代词，进行消解</span>
</span></span><span class=line><span class=cl>        <span class=n>pronouns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;它&#39;</span><span class=p>,</span> <span class=s1>&#39;这个&#39;</span><span class=p>,</span> <span class=s1>&#39;那个&#39;</span><span class=p>,</span> <span class=s1>&#39;上述&#39;</span><span class=p>,</span> <span class=s1>&#39;前面&#39;</span><span class=p>,</span> <span class=s1>&#39;it&#39;</span><span class=p>,</span> <span class=s1>&#39;this&#39;</span><span class=p>,</span> <span class=s1>&#39;that&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>current_message</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>50</span> <span class=ow>and</span> <span class=nb>any</span><span class=p>(</span><span class=n>p</span> <span class=ow>in</span> <span class=n>current_message</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>pronouns</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># 调用LLM进行消解</span>
</span></span><span class=line><span class=cl>            <span class=n>resolved</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rag</span><span class=o>.</span><span class=n>generator</span><span class=o>.</span><span class=n>llm</span><span class=o>.</span><span class=n>generate</span><span class=p>(</span><span class=n>prompt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>resolved</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>current_message</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_format_response</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>result</span><span class=p>:</span> <span class=n>Dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;格式化回复，可以添加引用等&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>answer</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;answer&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 添加来源信息</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;sources&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>sources_text</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>📚 参考来源:</span><span class=se>\n</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span>
</span></span><span class=line><span class=cl>                <span class=sa>f</span><span class=s2>&#34;- </span><span class=si>{</span><span class=n>source</span><span class=si>}</span><span class=s2>&#34;</span> <span class=k>for</span> <span class=n>source</span> <span class=ow>in</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;sources&#39;</span><span class=p>][:</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>answer</span> <span class=o>+</span> <span class=n>sources_text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>answer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>reset</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;重置对话&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conversation_history</span> <span class=o>=</span> <span class=p>[]</span>
</span></span></code></pre></div><h2 id=实战案例构建技术文档问答系统>实战案例：构建技术文档问答系统</h2><p>让我们用一个完整的例子来展示如何构建生产级的RAG系统：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TechnicalDocsRAG</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;技术文档问答系统&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>docs_directory</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>index_path</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;./index&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>openai_api_key</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        初始化系统
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            docs_directory: 文档目录路径
</span></span></span><span class=line><span class=cl><span class=s2>            index_path: 索引存储路径
</span></span></span><span class=line><span class=cl><span class=s2>            openai_api_key: OpenAI API密钥
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>docs_dir</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>docs_directory</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>index_path</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>index_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 初始化RAG系统</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>rag</span> <span class=o>=</span> <span class=n>RAGSystem</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>api_key</span><span class=o>=</span><span class=n>openai_api_key</span> <span class=ow>or</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;OPENAI_API_KEY&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 加载或创建索引</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_setup_index</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_setup_index</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;设置索引&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>index_path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Loading existing index...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 加载已有索引（简化）</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Creating new index...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_build_index</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_build_index</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;构建索引&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 收集所有文档</span>
</span></span><span class=line><span class=cl>        <span class=n>doc_files</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>ext</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;*.md&#39;</span><span class=p>,</span> <span class=s1>&#39;*.txt&#39;</span><span class=p>,</span> <span class=s1>&#39;*.pdf&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>doc_files</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>docs_dir</span><span class=o>.</span><span class=n>rglob</span><span class=p>(</span><span class=n>ext</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Found </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>doc_files</span><span class=p>)</span><span class=si>}</span><span class=s2> documents&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 摄入文档</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>rag</span><span class=o>.</span><span class=n>ingest_documents</span><span class=p>([</span><span class=nb>str</span><span class=p>(</span><span class=n>f</span><span class=p>)</span> <span class=k>for</span> <span class=n>f</span> <span class=ow>in</span> <span class=n>doc_files</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Index built successfully!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>ask</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>question</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>show_sources</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        提问
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            question: 用户问题
</span></span></span><span class=line><span class=cl><span class=s2>            show_sources: 是否显示来源
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rag</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>question</span><span class=p>,</span> <span class=n>top_k</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>answer</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;answer&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>show_sources</span> <span class=ow>and</span> <span class=n>result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;sources&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>answer</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=s2>&#34;=&#34;</span><span class=o>*</span><span class=mi>50</span>
</span></span><span class=line><span class=cl>            <span class=n>answer</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>📚 参考文档:</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>source</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;sources&#39;</span><span class=p>][:</span><span class=mi>5</span><span class=p>],</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>answer</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>. </span><span class=si>{</span><span class=n>source</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>answer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>interactive_mode</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;交互式问答模式&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;技术文档问答系统已启动！&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;输入问题开始提问，输入 &#39;quit&#39; 退出。</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>conversational_rag</span> <span class=o>=</span> <span class=n>ConversationalRAG</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>rag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>question</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>🤔 你的问题: &#34;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>question</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;quit&#39;</span><span class=p>,</span> <span class=s1>&#39;exit&#39;</span><span class=p>,</span> <span class=s1>&#39;退出&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;再见！&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=ow>not</span> <span class=n>question</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 生成回答</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>💡 回答:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>answer</span> <span class=o>=</span> <span class=n>conversational_rag</span><span class=o>.</span><span class=n>chat</span><span class=p>(</span><span class=n>question</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=n>answer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>KeyboardInterrupt</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>再见！&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;抱歉，出现错误：</span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 创建系统</span>
</span></span><span class=line><span class=cl>    <span class=n>docs_rag</span> <span class=o>=</span> <span class=n>TechnicalDocsRAG</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>docs_directory</span><span class=o>=</span><span class=s2>&#34;./technical_docs&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>openai_api_key</span><span class=o>=</span><span class=s2>&#34;your-api-key&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 单次问答</span>
</span></span><span class=line><span class=cl>    <span class=n>answer</span> <span class=o>=</span> <span class=n>docs_rag</span><span class=o>.</span><span class=n>ask</span><span class=p>(</span><span class=s2>&#34;如何配置RAG系统的embedding模型？&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>answer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 或者启动交互式模式</span>
</span></span><span class=line><span class=cl>    <span class=n>docs_rag</span><span class=o>.</span><span class=n>interactive_mode</span><span class=p>()</span>
</span></span></code></pre></div><h2 id=常见问题与解决方案>常见问题与解决方案</h2><h3 id=1-检索质量问题>1. 检索质量问题</h3><p><strong>问题</strong>: 检索到的文档不相关</p><p><strong>解决方案</strong>:</p><ul><li>使用混合检索（向量+BM25）</li><li>添加重排序步骤</li><li>优化embedding模型选择</li><li>改进分块策略</li><li>使用query改写技术</li></ul><h3 id=2-生成质量问题>2. 生成质量问题</h3><p><strong>问题</strong>: LLM产生幻觉或忽略检索内容</p><p><strong>解决方案</strong>:</p><ul><li>强化system prompt，明确要求只使用提供的信息</li><li>使用chain-of-thought促使模型引用来源</li><li>添加后处理验证步骤</li><li>使用更强的模型（如GPT-4）</li></ul><h3 id=3-性能问题>3. 性能问题</h3><p><strong>问题</strong>: 响应速度慢</p><p><strong>解决方案</strong>:</p><ul><li>使用更快的embedding模型</li><li>优化向量数据库索引（HNSW, IVF等）</li><li>批量处理和缓存</li><li>异步处理检索和生成</li><li>使用流式输出</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>stream_rag_response</span><span class=p>(</span><span class=n>rag_system</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;流式RAG响应&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 1. 异步检索</span>
</span></span><span class=line><span class=cl>    <span class=n>retrieved_docs</span> <span class=o>=</span> <span class=k>await</span> <span class=n>rag_system</span><span class=o>.</span><span class=n>async_retrieve</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 2. 流式生成</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>for</span> <span class=n>chunk</span> <span class=ow>in</span> <span class=n>rag_system</span><span class=o>.</span><span class=n>async_generate_stream</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>retrieved_docs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=n>chunk</span>
</span></span></code></pre></div><h3 id=4-成本问题>4. 成本问题</h3><p><strong>问题</strong>: API调用成本高</p><p><strong>解决方案</strong>:</p><ul><li>使用开源embedding模型</li><li>缓存常见查询结果</li><li>智能决策何时使用RAG（如Self-RAG）</li><li>使用较小的模型处理简单查询</li><li>上下文压缩减少token使用</li></ul><h2 id=评估与监控>评估与监控</h2><p>生产环境中的RAG系统需要持续监控和优化：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>RAGMonitor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;RAG系统监控&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;queries&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;avg_latency&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;retrieval_failures&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;generation_failures&#34;</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>log_query</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>latency</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>success</span><span class=p>:</span> <span class=nb>bool</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>user_feedback</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># 1-5星评分</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;记录查询指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s2>&#34;queries&#34;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s2>&#34;avg_latency&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s2>&#34;avg_latency&#34;</span><span class=p>]</span> <span class=o>*</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s2>&#34;queries&#34;</span><span class=p>]</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=n>latency</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span> <span class=o>/</span> <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s2>&#34;queries&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>success</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s2>&#34;retrieval_failures&#34;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 记录到日志或监控系统</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Query: </span><span class=si>{</span><span class=n>query</span><span class=p>[:</span><span class=mi>50</span><span class=p>]</span><span class=si>}</span><span class=s2>... | Latency: </span><span class=si>{</span><span class=n>latency</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>s | Success: </span><span class=si>{</span><span class=n>success</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_summary</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取监控摘要&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>**</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;success_rate&#34;</span><span class=p>:</span> <span class=mi>1</span> <span class=o>-</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s2>&#34;retrieval_failures&#34;</span><span class=p>]</span> <span class=o>/</span> <span class=nb>max</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s2>&#34;queries&#34;</span><span class=p>],</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></div><h2 id=未来方向>未来方向</h2><p>RAG技术仍在快速发展，以下是一些值得关注的方向：</p><ol><li><p><strong>Multimodal RAG</strong>: 支持图像、表格、图表等多模态内容的检索和理解</p></li><li><p><strong>GraphRAG</strong>: 利用知识图谱结构改进检索和推理能力</p></li><li><p><strong>Agentic RAG</strong>: 结合agent能力，实现更复杂的任务规划和执行</p></li><li><p><strong>Adaptive RAG</strong>: 根据查询类型和上下文自适应调整检索策略</p></li><li><p><strong>Long-context RAG</strong>: 随着模型上下文窗口扩大，探索新的RAG范式</p></li></ol><h2 id=总结>总结</h2><p>RAG技术为大语言模型提供了获取外部知识的能力，是构建实用AI系统的关键技术。成功的RAG系统需要关注：</p><ol><li><strong>高质量的文档处理</strong>: 合理的分块策略和元数据管理</li><li><strong>精准的检索能力</strong>: 结合多种检索技术和重排序</li><li><strong>可靠的生成质量</strong>: 精心设计的prompt和后处理验证</li><li><strong>系统性的优化</strong>: 持续监控、评估和改进</li></ol><p>从简单的问答系统到复杂的知识助手，RAG都能提供可扩展、可维护的解决方案。希望本文的深入探讨和实践代码能够帮助你构建自己的RAG应用。</p><p>记住，没有一种RAG架构适用于所有场景——根据你的具体需求（文档类型、查询模式、性能要求等）选择和组合合适的技术才是关键。</p><hr><p><strong>关键要点</strong>:</p><ul><li>RAG通过检索+生成解决LLM的知识时效性和领域局限性问题</li><li>核心流程包括文档索引、向量检索、上下文构建和答案生成</li><li>混合检索、重排序、查询改写等技术能显著提升效果</li><li>生产系统需要关注性能优化、成本控制和持续监控</li><li>对话式RAG、多跳推理等高级模式扩展了应用范围</li></ul><p><strong>下一步探索</strong>:</p><ul><li>尝试不同的embedding模型和向量数据库</li><li>实验各种分块和检索策略</li><li>构建自己的评估数据集</li><li>探索GraphRAG和Multimodal RAG等前沿方向</li></ul><div class=blog-tags><a href=https://blog.hugozhu.site/tags/ai/>AI</a>&nbsp;
<a href=https://blog.hugozhu.site/tags/rag/>RAG</a>&nbsp;
<a href=https://blog.hugozhu.site/tags/llm/>LLM</a>&nbsp;
<a href=https://blog.hugozhu.site/tags/machine-learning/>machine-learning</a>&nbsp;
<a href=https://blog.hugozhu.site/tags/nlp/>NLP</a>&nbsp;
<a href=https://blog.hugozhu.site/tags/embeddings/>embeddings</a>&nbsp;
<a href=https://blog.hugozhu.site/tags/vector-database/>vector-database</a>&nbsp;
<a href=https://blog.hugozhu.site/tags/prompt-engineering/>prompt-engineering</a>&nbsp;</div><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fblog.hugozhu.site%2fpost%2f2025%2f105-rag-retrieval-augmented-generation-guide%2f&amp;text=%e6%b7%b1%e5%85%a5%e7%90%86%e8%a7%a3RAG%ef%bc%9a%e6%a3%80%e7%b4%a2%e5%a2%9e%e5%bc%ba%e7%94%9f%e6%88%90%e6%8a%80%e6%9c%af%e7%9a%84%e5%8e%9f%e7%90%86%e4%b8%8e%e5%ae%9e%e8%b7%b5&amp;via=" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.hugozhu.site%2fpost%2f2025%2f105-rag-retrieval-augmented-generation-guide%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fblog.hugozhu.site%2fpost%2f2025%2f105-rag-retrieval-augmented-generation-guide%2f&amp;title=%e6%b7%b1%e5%85%a5%e7%90%86%e8%a7%a3RAG%ef%bc%9a%e6%a3%80%e7%b4%a2%e5%a2%9e%e5%bc%ba%e7%94%9f%e6%88%90%e6%8a%80%e6%9c%af%e7%9a%84%e5%8e%9f%e7%90%86%e4%b8%8e%e5%ae%9e%e8%b7%b5" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fblog.hugozhu.site%2fpost%2f2025%2f105-rag-retrieval-augmented-generation-guide%2f&amp;title=%e6%b7%b1%e5%85%a5%e7%90%86%e8%a7%a3RAG%ef%bc%9a%e6%a3%80%e7%b4%a2%e5%a2%9e%e5%bc%ba%e7%94%9f%e6%88%90%e6%8a%80%e6%9c%af%e7%9a%84%e5%8e%9f%e7%90%86%e4%b8%8e%e5%ae%9e%e8%b7%b5" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fblog.hugozhu.site%2fpost%2f2025%2f105-rag-retrieval-augmented-generation-guide%2f&amp;title=%e6%b7%b1%e5%85%a5%e7%90%86%e8%a7%a3RAG%ef%bc%9a%e6%a3%80%e7%b4%a2%e5%a2%9e%e5%bc%ba%e7%94%9f%e6%88%90%e6%8a%80%e6%9c%af%e7%9a%84%e5%8e%9f%e7%90%86%e4%b8%8e%e5%ae%9e%e8%b7%b5" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fblog.hugozhu.site%2fpost%2f2025%2f105-rag-retrieval-augmented-generation-guide%2f&amp;description=%e6%b7%b1%e5%85%a5%e7%90%86%e8%a7%a3RAG%ef%bc%9a%e6%a3%80%e7%b4%a2%e5%a2%9e%e5%bc%ba%e7%94%9f%e6%88%90%e6%8a%80%e6%9c%af%e7%9a%84%e5%8e%9f%e7%90%86%e4%b8%8e%e5%ae%9e%e8%b7%b5" target=_blank title="Share on Pinterest"><i class="fab fa-pinterest"></i></a></li></ul></div></div></section><h4 class=see-also>See also</h4><ul><li><a href=/post/2025/106-e2b-ai-infrastructure-best-practices/>E2B：构建安全可靠的 AI 代理执行环境最佳实践</a></li></ul></article><ul class="pager blog-pager"><li class=previous><a href=https://blog.hugozhu.site/post/2025/104-e2b-with-self-host-docker-container/ data-toggle=tooltip data-placement=top title=使用docker容器来实现动态执行AI生成的代码>&larr; Previous Post</a></li><li class=next><a href=https://blog.hugozhu.site/post/2025/106-e2b-ai-infrastructure-best-practices/ data-toggle=tooltip data-placement=top title="E2B：构建安全可靠的 AI 代理执行环境最佳实践">Next Post &rarr;</a></li></ul><div class=disqus-comments><button id=show-comments class="btn btn-default" type=button>Show <span class=disqus-comment-count data-disqus-url=https://blog.hugozhu.site/post/2025/105-rag-retrieval-augmented-generation-guide>comments</span></button><div id=disqus_thread></div><script type=text/javascript>var disqus_config=function(){this.page.url="https://blog.hugozhu.site/post/2025/105-rag-retrieval-augmented-generation-guide"}</script></div></div></div></div><footer><div class=container><div class=row><div class=disclaimer><b>Disclaimer:</b> The opinions expressed herein are my own personal opinions and do not represent my company’s view in any way.</div></div><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"></ul><p class="credits copyright text-muted">&nbsp;&bull;&nbsp;&copy;
2025
&nbsp;&bull;&nbsp;
<a href=https://blog.hugozhu.site/>All about Raspberry Pi</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.145.0</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js integrity=sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script><script src=https://code.jquery.com/jquery-3.7.0.slim.min.js integrity=sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js integrity=sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd crossorigin=anonymous></script><script src=https://blog.hugozhu.site/js/main.js></script><script src=https://blog.hugozhu.site/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0")})</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://blog.hugozhu.site/js/load-photoswipe.js></script><script>(function(){var t,n="617d351a633194d48",e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://cse.google.com/cse.js?cx="+n,t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script><script type=text/javascript>$(function(){$("#show-comments").on("click",function(){var e="hugozhu";(function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="//"+e+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(t)})(),$(this).hide()})})</script><script id=dsq-count-scr src=//hugozhu.disqus.com/count.js async></script></body></html>