<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>多模态AI驱动的B2B订单归一化：从非标准文档到MES系统的智能工作流 - Hugo Zhu's Blog</title>
<meta name=description content="使用大模型视觉识别与代码生成能力实现订单处理自动化"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"All about Raspberry Pi","url":"https:\/\/hugozhu.site\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/hugozhu.site\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/hugozhu.site\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/hugozhu.site\/post\/2025\/101-multimodal-ai-b2b-order-normalization\/","name":"多模态 ai驱动的 b2 b订单归一化：从非标准文档到 mes系统的智能工作流"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":""},"headline":"多模态AI驱动的B2B订单归一化：从非标准文档到MES系统的智能工作流","description":"传统制造企业在数字化转型过程中，面临着一个普遍而棘手的问题：来自不同客户的订单文档格式千差万别，有PDF、Excel、Word、扫描件、甚至手写订单。这些非标准化的订单数据需要人工录入MES（制造执行系统）才能启动生产流程，不仅效率低下，而且容易出错。\n随着GPT-4V、Claude 3.5 Sonnet等多模态大模型的成熟，我们终于有了一个优雅的解决方案：结合视觉识别能力、自然语言理解和代码生成能力，构建一个智能的订单归一化工作流。在这个工作流中，AI Agent承担大部分繁重工作，人类只需在关键节点进行验证和确认，实现真正的人机协作自动化。\n","inLanguage":"en","wordCount":2256,"datePublished":"2025-12-20T00:00:00\u002b00:00","dateModified":"2025-12-20T00:00:00\u002b00:00","image":"https:\/\/hugozhu.site\/img\/pi.png","keywords":["AI, 多模态, LLM, B2B, MES, 自动化, Agent, 文档解析"],"mainEntityOfPage":"https:\/\/hugozhu.site\/post\/2025\/101-multimodal-ai-b2b-order-normalization\/","publisher":{"@type":"Organization","name":"https:\/\/hugozhu.site\/","logo":{"@type":"ImageObject","url":"https:\/\/hugozhu.site\/img\/pi.png","height":60,"width":60}}}</script><meta property="og:title" content="多模态AI驱动的B2B订单归一化：从非标准文档到MES系统的智能工作流"><meta property="og:description" content="使用大模型视觉识别与代码生成能力实现订单处理自动化"><meta property="og:image" content="https://hugozhu.site/img/pi.png"><meta property="og:url" content="https://hugozhu.site/post/2025/101-multimodal-ai-b2b-order-normalization/"><meta property="og:type" content="website"><meta property="og:site_name" content="All about Raspberry Pi"><meta name=twitter:title content="多模态AI驱动的B2B订单归一化：从非标准文档到MES系统的智能工作流"><meta name=twitter:description content="使用大模型视觉识别与代码生成能力实现订单处理自动化"><meta name=twitter:image content="https://hugozhu.site/img/pi.png"><meta name=twitter:card content="summary_large_image"><link href=https://hugozhu.site/img/pi.ico rel=icon type=image/x-icon><meta name=generator content="Hugo 0.145.0"><link rel=alternate href=https://hugozhu.site/index.xml type=application/rss+xml title="All about Raspberry Pi"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css integrity=sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v6.6.0/css/all.css integrity=sha384-h/hnnw1Bi4nbpD6kE7nYfCXzovi622sY5WBxww8ARKwpdLj5kUWjRuyiXaD1U2JT crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css integrity=sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu crossorigin=anonymous><link rel=stylesheet href=https://hugozhu.site/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://hugozhu.site/css/highlight.min.css><link rel=stylesheet href=https://hugozhu.site/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><script async src="https://www.googletagmanager.com/gtag/js?id=GTM-W88HDMN"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","GTM-W88HDMN")}</script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=https://hugozhu.site/>All about Raspberry Pi</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Blog href=/>Blog</a></li><li class=navlinks-container><a class=navlinks-parent role=button tabindex=0>Tools</a><div class=navlinks-children><a href=https://nddapp.com/json-encoder.html>HTML Tools</a>
<a href=https://www.birme.net/>Imaeg Resizing</a>
<a href=https://jwt.io/>JWT Token Tool</a></div></li><li><a title=About href=/page/about/>About</a></li><li><a title=Tags href=/tags>Tags</a></li><li><a href=#modalSearch data-toggle=modal data-target=#modalSearch style=outline:none><span class="hidden-sm hidden-md hidden-lg">Search</span> <span id=searchGlyph class="glyphicon glyphicon-search"></span></a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title="All about Raspberry Pi" href=https://hugozhu.site/><img class=avatar-img src=https://hugozhu.site/img/pi.png alt="All about Raspberry Pi"></a></div></div></div></nav><div id=modalSearch class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><button type=button class=close data-dismiss=modal>&#215;</button><h4 class=modal-title>Search All about Raspberry Pi</h4></div><div class=modal-body><gcse:search></gcse:search></div><div class=modal-footer><button type=button class="btn btn-default" data-dismiss=modal>Close</button></div></div></div></div><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>多模态AI驱动的B2B订单归一化：从非标准文档到MES系统的智能工作流</h1><h2 class=post-subheading>使用大模型视觉识别与代码生成能力实现订单处理自动化</h2><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on December 20, 2025
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;11&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;2256&nbsp;words</span></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><h4><i>目录:</i></h4><nav id=TableOfContents><ul><li><a href=#问题场景分析>问题场景分析</a><ul><li><a href=#传统订单处理的痛点>传统订单处理的痛点</a></li></ul></li><li><a href=#多模态ai的能力优势>多模态AI的能力优势</a><ul><li><a href=#视觉理解能力>视觉理解能力</a></li><li><a href=#代码生成能力>代码生成能力</a></li></ul></li><li><a href=#智能订单归一化工作流设计>智能订单归一化工作流设计</a><ul><li><a href=#整体架构>整体架构</a></li><li><a href=#核心组件详解>核心组件详解</a></li></ul></li><li><a href=#实际应用案例>实际应用案例</a><ul><li><a href=#场景多种格式的客户订单>场景：多种格式的客户订单</a></li><li><a href=#效果评估>效果评估</a></li></ul></li><li><a href=#核心技术要点总结>核心技术要点总结</a><ul><li><a href=#1-多模态理解的优势>1. 多模态理解的优势</a></li><li><a href=#2-代码生成的价值>2. 代码生成的价值</a></li><li><a href=#3-人机协作的设计哲学>3. 人机协作的设计哲学</a></li><li><a href=#4-agent-loop的智能化>4. Agent Loop的智能化</a></li></ul></li><li><a href=#技术挑战与解决方案>技术挑战与解决方案</a><ul><li><a href=#挑战1多页pdf的表格识别>挑战1：多页PDF的表格识别</a></li><li><a href=#挑战2单位和规格的归一化>挑战2：单位和规格的归一化</a></li><li><a href=#挑战3客户主数据匹配>挑战3：客户主数据匹配</a></li></ul></li><li><a href=#未来展望>未来展望</a><ul><li><a href=#1-完全自动化的路径>1. 完全自动化的路径</a></li><li><a href=#2-扩展到其他文档类型>2. 扩展到其他文档类型</a></li><li><a href=#3-与企业系统深度集成>3. 与企业系统深度集成</a></li></ul></li><li><a href=#结论>结论</a></li></ul></nav><p>传统制造企业在数字化转型过程中，面临着一个普遍而棘手的问题：来自不同客户的订单文档格式千差万别，有PDF、Excel、Word、扫描件、甚至手写订单。这些非标准化的订单数据需要人工录入MES（制造执行系统）才能启动生产流程，不仅效率低下，而且容易出错。</p><p>随着GPT-4V、Claude 3.5 Sonnet等多模态大模型的成熟，我们终于有了一个优雅的解决方案：结合视觉识别能力、自然语言理解和代码生成能力，构建一个智能的订单归一化工作流。在这个工作流中，AI Agent承担大部分繁重工作，人类只需在关键节点进行验证和确认，实现真正的人机协作自动化。</p><h2 id=问题场景分析>问题场景分析</h2><h3 id=传统订单处理的痛点>传统订单处理的痛点</h3><p>在B2B制造业场景中，订单数据的复杂性体现在：</p><ol><li><p><strong>格式多样性</strong></p><ul><li>PDF格式（扫描件、电子文档、图片嵌入）</li><li>Excel表格（不同模板、合并单元格、多sheet）</li><li>Word文档（自由格式、表格混排）</li><li>图片格式（拍照订单、传真扫描）</li><li>邮件正文（半结构化文本）</li></ul></li><li><p><strong>字段差异性</strong></p><ul><li>不同客户使用不同的术语（产品编码、规格描述）</li><li>字段位置不固定（表头变化、纵向/横向布局）</li><li>隐含信息需要推断（默认单位、缩写展开）</li><li>多语言混合（中英文、行业术语）</li></ul></li><li><p><strong>业务规则复杂性</strong></p><ul><li>不同客户有不同的折扣规则</li><li>订单明细可能跨多页</li><li>需要关联客户主数据和产品主数据</li><li>交期计算涉及工作日和假期</li></ul></li></ol><p>传统的RPA（机器人流程自动化）或OCR+规则引擎方案需要为每个订单模板编写特定的解析规则，维护成本极高。而多模态大模型提供了一种全新的思路。</p><h2 id=多模态ai的能力优势>多模态AI的能力优势</h2><h3 id=视觉理解能力>视觉理解能力</h3><p>现代多模态模型（如GPT-4V、Claude 3.5 Sonnet、Gemini Pro Vision）具备强大的视觉理解能力：</p><ul><li><strong>布局识别</strong>：理解表格结构、识别表头和数据行的对应关系</li><li><strong>文字提取</strong>：准确识别打印文字和手写内容，支持多语言</li><li><strong>语义理解</strong>：不仅识别文字，还理解其含义和上下文关系</li><li><strong>推理能力</strong>：根据部分信息推断缺失字段，处理隐含逻辑</li></ul><h3 id=代码生成能力>代码生成能力</h3><p>大模型可以根据需求生成精确的数据转换代码：</p><ul><li><strong>动态映射</strong>：根据源文档结构自动生成字段映射逻辑</li><li><strong>数据清洗</strong>：生成数据验证和格式化代码</li><li><strong>业务规则</strong>：将自然语言描述的规则转换为可执行代码</li><li><strong>错误处理</strong>：自动添加异常处理和数据验证逻辑</li></ul><h2 id=智能订单归一化工作流设计>智能订单归一化工作流设计</h2><h3 id=整体架构>整体架构</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>graph TB
</span></span><span class=line><span class=cl>    A[订单文档输入] --&gt; B[文档类型识别]
</span></span><span class=line><span class=cl>    B --&gt; C[多模态模型解析]
</span></span><span class=line><span class=cl>    C --&gt; D[结构化数据提取]
</span></span><span class=line><span class=cl>    D --&gt; E[字段映射方案生成]
</span></span><span class=line><span class=cl>    E --&gt; F{人工验证1: 字段理解}
</span></span><span class=line><span class=cl>    F --&gt;|通过| G[生成转换代码]
</span></span><span class=line><span class=cl>    F --&gt;|修正| E
</span></span><span class=line><span class=cl>    G --&gt; H{人工验证2: 代码有效性}
</span></span><span class=line><span class=cl>    H --&gt;|通过| I[执行转换]
</span></span><span class=line><span class=cl>    H --&gt;|修正| G
</span></span><span class=line><span class=cl>    I --&gt; J[MES标准格式输出]
</span></span><span class=line><span class=cl>    J --&gt; K{人工验证3: 结果检查}
</span></span><span class=line><span class=cl>    K --&gt;|通过| L[写入MES系统]
</span></span><span class=line><span class=cl>    K --&gt;|修正| M[Agent Loop优化]
</span></span><span class=line><span class=cl>    M --&gt; G
</span></span><span class=line><span class=cl>    L --&gt; N[完成]
</span></span></code></pre></div><h3 id=核心组件详解>核心组件详解</h3><h4 id=1-文档解析tool集合>1. 文档解析Tool集合</h4><p>不同类型的文档需要不同的预处理工具：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 文档解析工具抽象接口</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>abc</span> <span class=kn>import</span> <span class=n>ABC</span><span class=p>,</span> <span class=n>abstractmethod</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span><span class=p>,</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DocumentParser</span><span class=p>(</span><span class=n>ABC</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;文档解析器基类&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@abstractmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>can_handle</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>file_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;判断是否可以处理该文档类型&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@abstractmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>parse</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>file_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;解析文档，返回结构化信息&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PDFParser</span><span class=p>(</span><span class=n>DocumentParser</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;PDF文档解析器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>can_handle</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>file_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>file_path</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=s1>&#39;.pdf&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>parse</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>file_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;解析PDF文档&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>PyPDF2</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>pdf2image</span> <span class=kn>import</span> <span class=n>convert_from_path</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;pdf&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;text_content&#39;</span><span class=p>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;images&#39;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;metadata&#39;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 提取文本内容</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_path</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>pdf_reader</span> <span class=o>=</span> <span class=n>PyPDF2</span><span class=o>.</span><span class=n>PdfReader</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span><span class=p>[</span><span class=s1>&#39;metadata&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;pages&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>pdf_reader</span><span class=o>.</span><span class=n>pages</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;author&#39;</span><span class=p>:</span> <span class=n>pdf_reader</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;/Author&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;title&#39;</span><span class=p>:</span> <span class=n>pdf_reader</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;/Title&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>page</span> <span class=ow>in</span> <span class=n>pdf_reader</span><span class=o>.</span><span class=n>pages</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span><span class=p>[</span><span class=s1>&#39;text_content&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=n>page</span><span class=o>.</span><span class=n>extract_text</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 转换为图片（用于多模态模型）</span>
</span></span><span class=line><span class=cl>        <span class=n>images</span> <span class=o>=</span> <span class=n>convert_from_path</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>img</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>images</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=kn>import</span> <span class=nn>io</span>
</span></span><span class=line><span class=cl>            <span class=n>img_buffer</span> <span class=o>=</span> <span class=n>io</span><span class=o>.</span><span class=n>BytesIO</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>img</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>img_buffer</span><span class=p>,</span> <span class=nb>format</span><span class=o>=</span><span class=s1>&#39;PNG&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>img_base64</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>img_buffer</span><span class=o>.</span><span class=n>getvalue</span><span class=p>())</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span><span class=p>[</span><span class=s1>&#39;images&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;page&#39;</span><span class=p>:</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;data&#39;</span><span class=p>:</span> <span class=n>img_base64</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ExcelParser</span><span class=p>(</span><span class=n>DocumentParser</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Excel表格解析器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>can_handle</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>file_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>file_path</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span><span class=o>.</span><span class=n>endswith</span><span class=p>((</span><span class=s1>&#39;.xlsx&#39;</span><span class=p>,</span> <span class=s1>&#39;.xls&#39;</span><span class=p>,</span> <span class=s1>&#39;.csv&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>parse</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>file_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;解析Excel文档&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>openpyxl</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;excel&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;sheets&#39;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;metadata&#39;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>file_path</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=s1>&#39;.csv&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_csv</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span><span class=p>[</span><span class=s1>&#39;sheets&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=s1>&#39;Sheet1&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;data&#39;</span><span class=p>:</span> <span class=n>df</span><span class=o>.</span><span class=n>to_dict</span><span class=p>(</span><span class=s1>&#39;records&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;preview&#39;</span><span class=p>:</span> <span class=n>df</span><span class=o>.</span><span class=n>head</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span><span class=o>.</span><span class=n>to_string</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>wb</span> <span class=o>=</span> <span class=n>openpyxl</span><span class=o>.</span><span class=n>load_workbook</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span><span class=p>[</span><span class=s1>&#39;metadata&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;sheet_names&#39;</span><span class=p>:</span> <span class=n>wb</span><span class=o>.</span><span class=n>sheetnames</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;properties&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;creator&#39;</span><span class=p>:</span> <span class=n>wb</span><span class=o>.</span><span class=n>properties</span><span class=o>.</span><span class=n>creator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;modified&#39;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>wb</span><span class=o>.</span><span class=n>properties</span><span class=o>.</span><span class=n>modified</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>sheet_name</span> <span class=ow>in</span> <span class=n>wb</span><span class=o>.</span><span class=n>sheetnames</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_excel</span><span class=p>(</span><span class=n>file_path</span><span class=p>,</span> <span class=n>sheet_name</span><span class=o>=</span><span class=n>sheet_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span><span class=p>[</span><span class=s1>&#39;sheets&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=n>sheet_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;data&#39;</span><span class=p>:</span> <span class=n>df</span><span class=o>.</span><span class=n>to_dict</span><span class=p>(</span><span class=s1>&#39;records&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;preview&#39;</span><span class=p>:</span> <span class=n>df</span><span class=o>.</span><span class=n>head</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span><span class=o>.</span><span class=n>to_string</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;shape&#39;</span><span class=p>:</span> <span class=n>df</span><span class=o>.</span><span class=n>shape</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ImageParser</span><span class=p>(</span><span class=n>DocumentParser</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;图片文档解析器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>can_handle</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>file_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>file_path</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span><span class=o>.</span><span class=n>endswith</span><span class=p>((</span><span class=s1>&#39;.jpg&#39;</span><span class=p>,</span> <span class=s1>&#39;.jpeg&#39;</span><span class=p>,</span> <span class=s1>&#39;.png&#39;</span><span class=p>,</span> <span class=s1>&#39;.bmp&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>parse</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>file_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;解析图片文档&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>PIL</span> <span class=kn>import</span> <span class=n>Image</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;image&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;images&#39;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;metadata&#39;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>img</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=p>[</span><span class=s1>&#39;metadata&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;format&#39;</span><span class=p>:</span> <span class=n>img</span><span class=o>.</span><span class=n>format</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;mode&#39;</span><span class=p>:</span> <span class=n>img</span><span class=o>.</span><span class=n>mode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;size&#39;</span><span class=p>:</span> <span class=n>img</span><span class=o>.</span><span class=n>size</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 转换为base64</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>io</span>
</span></span><span class=line><span class=cl>        <span class=n>img_buffer</span> <span class=o>=</span> <span class=n>io</span><span class=o>.</span><span class=n>BytesIO</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>img</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>img_buffer</span><span class=p>,</span> <span class=nb>format</span><span class=o>=</span><span class=s1>&#39;PNG&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>img_base64</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>img_buffer</span><span class=o>.</span><span class=n>getvalue</span><span class=p>())</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=p>[</span><span class=s1>&#39;images&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;data&#39;</span><span class=p>:</span> <span class=n>img_base64</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;width&#39;</span><span class=p>:</span> <span class=n>img</span><span class=o>.</span><span class=n>size</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;height&#39;</span><span class=p>:</span> <span class=n>img</span><span class=o>.</span><span class=n>size</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 文档解析器工厂</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DocumentParserFactory</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;文档解析器工厂&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>parsers</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>DocumentParser</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>PDFParser</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>ExcelParser</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>ImageParser</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_parser</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>file_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>DocumentParser</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;根据文件类型获取合适的解析器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>parser</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>parsers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>parser</span><span class=o>.</span><span class=n>can_handle</span><span class=p>(</span><span class=n>file_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>parser</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;No parser available for file: </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>parse</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>file_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;解析文档&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>parser</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_parser</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by AI</span>
</span></span></code></pre></div><h4 id=2-多模态信息提取agent>2. 多模态信息提取Agent</h4><p>这是工作流的核心，使用多模态模型理解订单内容：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>anthropic</span> <span class=kn>import</span> <span class=n>Anthropic</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>List</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderExtractionAgent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;订单信息提取Agent&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>api_key</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>client</span> <span class=o>=</span> <span class=n>Anthropic</span><span class=p>(</span><span class=n>api_key</span><span class=o>=</span><span class=n>api_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>model</span> <span class=o>=</span> <span class=s2>&#34;claude-3-5-sonnet-20241022&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>extract_order_info</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                          <span class=n>parsed_doc</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                          <span class=n>mes_schema</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        从解析的文档中提取订单信息
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            parsed_doc: 文档解析结果
</span></span></span><span class=line><span class=cl><span class=s2>            mes_schema: MES系统的目标schema定义
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            提取的订单信息和字段映射方案
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 构建提示词</span>
</span></span><span class=line><span class=cl>        <span class=n>system_prompt</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;你是一个专业的订单数据提取专家。你的任务是：
</span></span></span><span class=line><span class=cl><span class=s2>1. 分析输入的订单文档，识别所有相关字段
</span></span></span><span class=line><span class=cl><span class=s2>2. 理解字段的含义和业务逻辑
</span></span></span><span class=line><span class=cl><span class=s2>3. 生成到目标MES系统schema的映射方案
</span></span></span><span class=line><span class=cl><span class=s2>4. 标注不确定的字段，需要人工确认
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>请以JSON格式返回结果，包含：
</span></span></span><span class=line><span class=cl><span class=s2>- extracted_fields: 提取的原始字段及其值
</span></span></span><span class=line><span class=cl><span class=s2>- field_mapping: 字段映射方案（源字段 -&gt; 目标字段）
</span></span></span><span class=line><span class=cl><span class=s2>- confidence: 每个映射的置信度（0-1）
</span></span></span><span class=line><span class=cl><span class=s2>- uncertain_fields: 需要人工确认的字段列表
</span></span></span><span class=line><span class=cl><span class=s2>- business_rules: 识别出的业务规则
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 准备消息内容</span>
</span></span><span class=line><span class=cl>        <span class=n>messages</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 如果有图片，使用多模态输入</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>parsed_doc</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;images&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;text&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;目标MES系统Schema:</span><span class=se>\n</span><span class=si>{</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>mes_schema</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span><span class=si>}</span><span class=se>\n\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                           <span class=sa>f</span><span class=s2>&#34;文档元数据:</span><span class=se>\n</span><span class=si>{</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>parsed_doc</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;metadata&#39;</span><span class=p>,</span> <span class=p>{}),</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>img</span> <span class=ow>in</span> <span class=n>parsed_doc</span><span class=p>[</span><span class=s1>&#39;images&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>content</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;image&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;source&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;base64&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;media_type&#34;</span><span class=p>:</span> <span class=s2>&#34;image/png&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;data&#34;</span><span class=p>:</span> <span class=n>img</span><span class=p>[</span><span class=s1>&#39;data&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>messages</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>content</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 纯文本模式</span>
</span></span><span class=line><span class=cl>            <span class=n>text_content</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>目标MES系统Schema:
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=si>{</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>mes_schema</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>文档内容:
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=si>{</span><span class=n>parsed_doc</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;text_content&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>表格数据:
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=si>{</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>parsed_doc</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;sheets&#39;</span><span class=p>,</span> <span class=p>[]),</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>messages</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>text_content</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 调用Claude API</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>client</span><span class=o>.</span><span class=n>messages</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>max_tokens</span><span class=o>=</span><span class=mi>4096</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>system</span><span class=o>=</span><span class=n>system_prompt</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>messages</span><span class=o>=</span><span class=n>messages</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 解析返回结果</span>
</span></span><span class=line><span class=cl>        <span class=n>result_text</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>content</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 提取JSON（处理可能的markdown包装）</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34;```json&#34;</span> <span class=ow>in</span> <span class=n>result_text</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result_text</span> <span class=o>=</span> <span class=n>result_text</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;```json&#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;```&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>extraction_result</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>result_text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>extraction_result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_transformation_code</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                    <span class=n>extraction_result</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                                    <span class=n>mes_schema</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        根据字段映射方案生成数据转换代码
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            extraction_result: 字段提取和映射结果
</span></span></span><span class=line><span class=cl><span class=s2>            mes_schema: 目标MES系统schema
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            生成的Python转换代码
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>请根据以下字段映射方案，生成Python数据转换函数。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>字段映射:
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=si>{</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>extraction_result</span><span class=p>[</span><span class=s1>&#39;field_mapping&#39;</span><span class=p>],</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>业务规则:
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=si>{</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>extraction_result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;business_rules&#39;</span><span class=p>,</span> <span class=p>[]),</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>目标Schema:
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=si>{</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>mes_schema</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>要求：
</span></span></span><span class=line><span class=cl><span class=s2>1. 生成一个transform_order函数，接受原始数据，返回MES格式数据
</span></span></span><span class=line><span class=cl><span class=s2>2. 包含完整的数据验证和类型转换
</span></span></span><span class=line><span class=cl><span class=s2>3. 处理可能的异常情况
</span></span></span><span class=line><span class=cl><span class=s2>4. 添加详细的注释
</span></span></span><span class=line><span class=cl><span class=s2>5. 使用type hints
</span></span></span><span class=line><span class=cl><span class=s2>6. 包含单元测试用例
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>请只返回可执行的Python代码，不要包含其他解释。
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>client</span><span class=o>.</span><span class=n>messages</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>max_tokens</span><span class=o>=</span><span class=mi>4096</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>messages</span><span class=o>=</span><span class=p>[{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>prompt</span>
</span></span><span class=line><span class=cl>            <span class=p>}]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>code</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>content</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 提取代码块</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34;```python&#34;</span> <span class=ow>in</span> <span class=n>code</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>code</span> <span class=o>=</span> <span class=n>code</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;```python&#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;```&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>code</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by AI</span>
</span></span></code></pre></div><h4 id=3-人机协作验证节点>3. 人机协作验证节点</h4><p>设计三个关键的人工验证节点：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>List</span><span class=p>,</span> <span class=n>Any</span><span class=p>,</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>Callable</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>enum</span> <span class=kn>import</span> <span class=n>Enum</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>VerificationStatus</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;验证状态&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>PENDING</span> <span class=o>=</span> <span class=s2>&#34;pending&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>APPROVED</span> <span class=o>=</span> <span class=s2>&#34;approved&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>REJECTED</span> <span class=o>=</span> <span class=s2>&#34;rejected&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>MODIFIED</span> <span class=o>=</span> <span class=s2>&#34;modified&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>HumanVerificationNode</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;人工验证节点基类&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>description</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>name</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>description</span> <span class=o>=</span> <span class=n>description</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>verify</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        人工验证接口
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            {
</span></span></span><span class=line><span class=cl><span class=s2>                &#39;status&#39;: VerificationStatus,
</span></span></span><span class=line><span class=cl><span class=s2>                &#39;data&#39;: 验证后的数据,
</span></span></span><span class=line><span class=cl><span class=s2>                &#39;feedback&#39;: 人工反馈,
</span></span></span><span class=line><span class=cl><span class=s2>                &#39;modifications&#39;: 修改内容
</span></span></span><span class=line><span class=cl><span class=s2>            }
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>NotImplementedError</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>FieldMappingVerification</span><span class=p>(</span><span class=n>HumanVerificationNode</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;字段映射验证节点&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>name</span><span class=o>=</span><span class=s2>&#34;字段理解验证&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>description</span><span class=o>=</span><span class=s2>&#34;验证AI对订单字段的理解和映射方案是否正确&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>verify</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>extraction_result</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        展示字段映射方案，请求人工确认
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            extraction_result: AI提取的字段映射结果
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            验证结果
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=s2>&#34;=&#34;</span><span class=o>*</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;验证节点: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=&#34;</span><span class=o>*</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 显示提取的字段</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>【提取的字段】&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>field</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>extraction_result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;extracted_fields&#39;</span><span class=p>,</span> <span class=p>{})</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>confidence</span> <span class=o>=</span> <span class=n>extraction_result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;confidence&#39;</span><span class=p>,</span> <span class=p>{})</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>field</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>field</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>value</span><span class=si>}</span><span class=s2> (置信度: </span><span class=si>{</span><span class=n>confidence</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 显示字段映射</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>【字段映射方案】&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>source_field</span><span class=p>,</span> <span class=n>target_field</span> <span class=ow>in</span> <span class=n>extraction_result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;field_mapping&#39;</span><span class=p>,</span> <span class=p>{})</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>source_field</span><span class=si>}</span><span class=s2> -&gt; </span><span class=si>{</span><span class=n>target_field</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 显示不确定的字段</span>
</span></span><span class=line><span class=cl>        <span class=n>uncertain</span> <span class=o>=</span> <span class=n>extraction_result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;uncertain_fields&#39;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>uncertain</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>【需要确认的字段】&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>field</span> <span class=ow>in</span> <span class=n>uncertain</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  ⚠️  </span><span class=si>{</span><span class=n>field</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 显示识别的业务规则</span>
</span></span><span class=line><span class=cl>        <span class=n>rules</span> <span class=o>=</span> <span class=n>extraction_result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;business_rules&#39;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>rules</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>【识别的业务规则】&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>rule</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>rules</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>. </span><span class=si>{</span><span class=n>rule</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 请求人工确认</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=s2>&#34;-&#34;</span><span class=o>*</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>choice</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;请选择操作 [A]通过 / [R]拒绝 / [M]修改: &#34;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>choice</span> <span class=o>==</span> <span class=s1>&#39;A&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=n>VerificationStatus</span><span class=o>.</span><span class=n>APPROVED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;data&#39;</span><span class=p>:</span> <span class=n>extraction_result</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;feedback&#39;</span><span class=p>:</span> <span class=s1>&#39;字段映射方案已确认&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;modifications&#39;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>choice</span> <span class=o>==</span> <span class=s1>&#39;R&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>feedback</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;请说明拒绝原因: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=n>VerificationStatus</span><span class=o>.</span><span class=n>REJECTED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;data&#39;</span><span class=p>:</span> <span class=n>extraction_result</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;feedback&#39;</span><span class=p>:</span> <span class=n>feedback</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;modifications&#39;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>choice</span> <span class=o>==</span> <span class=s1>&#39;M&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>请输入修改内容（JSON格式），或输入&#39;done&#39;完成修改:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>modifications</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 修改字段映射</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>修改字段映射 (格式: source_field:target_field):&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>modify</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;  &gt; &#34;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>modify</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>==</span> <span class=s1>&#39;done&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=k>break</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=s1>&#39;:&#39;</span> <span class=ow>in</span> <span class=n>modify</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>src</span><span class=p>,</span> <span class=n>tgt</span> <span class=o>=</span> <span class=n>modify</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=s1>&#39;field_mapping&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>modifications</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=n>modifications</span><span class=p>[</span><span class=s1>&#39;field_mapping&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>                        <span class=n>modifications</span><span class=p>[</span><span class=s1>&#39;field_mapping&#39;</span><span class=p>][</span><span class=n>src</span><span class=o>.</span><span class=n>strip</span><span class=p>()]</span> <span class=o>=</span> <span class=n>tgt</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 应用修改</span>
</span></span><span class=line><span class=cl>                <span class=n>modified_result</span> <span class=o>=</span> <span class=n>extraction_result</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=s1>&#39;field_mapping&#39;</span> <span class=ow>in</span> <span class=n>modifications</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>modified_result</span><span class=p>[</span><span class=s1>&#39;field_mapping&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>modifications</span><span class=p>[</span><span class=s1>&#39;field_mapping&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=n>VerificationStatus</span><span class=o>.</span><span class=n>MODIFIED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;data&#39;</span><span class=p>:</span> <span class=n>modified_result</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;feedback&#39;</span><span class=p>:</span> <span class=s1>&#39;已根据人工反馈修改&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;modifications&#39;</span><span class=p>:</span> <span class=n>modifications</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;无效的选择，请重新输入&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CodeValidationVerification</span><span class=p>(</span><span class=n>HumanVerificationNode</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;代码有效性验证节点&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>name</span><span class=o>=</span><span class=s2>&#34;转换代码验证&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>description</span><span class=o>=</span><span class=s2>&#34;验证生成的数据转换代码是否正确&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>verify</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>generated_code</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        展示生成的代码，请求人工review
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            generated_code: AI生成的转换代码
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            验证结果
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=s2>&#34;=&#34;</span><span class=o>*</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;验证节点: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=&#34;</span><span class=o>*</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>【生成的转换代码】&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-&#34;</span><span class=o>*</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>generated_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-&#34;</span><span class=o>*</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 请求人工确认</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=s2>&#34;-&#34;</span><span class=o>*</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>choice</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;请选择操作 [A]通过 / [R]拒绝 / [M]修改: &#34;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>choice</span> <span class=o>==</span> <span class=s1>&#39;A&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=n>VerificationStatus</span><span class=o>.</span><span class=n>APPROVED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;data&#39;</span><span class=p>:</span> <span class=n>generated_code</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;feedback&#39;</span><span class=p>:</span> <span class=s1>&#39;代码已确认&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;modifications&#39;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>choice</span> <span class=o>==</span> <span class=s1>&#39;R&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>feedback</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;请说明拒绝原因（AI将重新生成）: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=n>VerificationStatus</span><span class=o>.</span><span class=n>REJECTED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;data&#39;</span><span class=p>:</span> <span class=n>generated_code</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;feedback&#39;</span><span class=p>:</span> <span class=n>feedback</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;modifications&#39;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>choice</span> <span class=o>==</span> <span class=s1>&#39;M&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>请直接编辑代码文件，完成后按Enter继续...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 保存代码到临时文件供编辑</span>
</span></span><span class=line><span class=cl>                <span class=kn>import</span> <span class=nn>tempfile</span>
</span></span><span class=line><span class=cl>                <span class=k>with</span> <span class=n>tempfile</span><span class=o>.</span><span class=n>NamedTemporaryFile</span><span class=p>(</span><span class=n>mode</span><span class=o>=</span><span class=s1>&#39;w&#39;</span><span class=p>,</span> <span class=n>suffix</span><span class=o>=</span><span class=s1>&#39;.py&#39;</span><span class=p>,</span> <span class=n>delete</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>generated_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>temp_file</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;代码已保存到: </span><span class=si>{</span><span class=n>temp_file</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;编辑完成后按Enter...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 读取修改后的代码</span>
</span></span><span class=line><span class=cl>                <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>temp_file</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>modified_code</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=n>VerificationStatus</span><span class=o>.</span><span class=n>MODIFIED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;data&#39;</span><span class=p>:</span> <span class=n>modified_code</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;feedback&#39;</span><span class=p>:</span> <span class=s1>&#39;代码已手动修改&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;modifications&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;code&#39;</span><span class=p>:</span> <span class=n>modified_code</span><span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;无效的选择，请重新输入&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OutputVerification</span><span class=p>(</span><span class=n>HumanVerificationNode</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;输出结果验证节点&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>name</span><span class=o>=</span><span class=s2>&#34;转换结果验证&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>description</span><span class=o>=</span><span class=s2>&#34;验证最终转换的MES数据是否正确&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>verify</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=n>original_data</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>],</span>
</span></span><span class=line><span class=cl>               <span class=n>transformed_data</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        对比原始数据和转换结果，请求人工确认
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            original_data: 原始订单数据
</span></span></span><span class=line><span class=cl><span class=s2>            transformed_data: 转换后的MES数据
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            验证结果
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=s2>&#34;=&#34;</span><span class=o>*</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;验证节点: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=&#34;</span><span class=o>*</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>【原始订单数据（部分）】&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>original_data</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>)[:</span><span class=mi>500</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>【转换后的MES数据】&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>transformed_data</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 请求人工确认</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=s2>&#34;-&#34;</span><span class=o>*</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>choice</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;请选择操作 [A]通过并写入MES / [R]拒绝重新处理: &#34;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>choice</span> <span class=o>==</span> <span class=s1>&#39;A&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=n>VerificationStatus</span><span class=o>.</span><span class=n>APPROVED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;data&#39;</span><span class=p>:</span> <span class=n>transformed_data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;feedback&#39;</span><span class=p>:</span> <span class=s1>&#39;转换结果已确认&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;modifications&#39;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>choice</span> <span class=o>==</span> <span class=s1>&#39;R&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>feedback</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;请说明问题所在: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=n>VerificationStatus</span><span class=o>.</span><span class=n>REJECTED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;data&#39;</span><span class=p>:</span> <span class=n>transformed_data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;feedback&#39;</span><span class=p>:</span> <span class=n>feedback</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;modifications&#39;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;无效的选择，请重新输入&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by AI</span>
</span></span></code></pre></div><h4 id=4-agent-loop优化机制>4. Agent Loop优化机制</h4><p>当验证失败时，启动Agent Loop进行自我优化：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span><span class=p>,</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AgentLoopOptimizer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Agent自优化循环&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>client</span><span class=p>:</span> <span class=n>Anthropic</span><span class=p>,</span> <span class=n>max_iterations</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>client</span> <span class=o>=</span> <span class=n>client</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>model</span> <span class=o>=</span> <span class=s2>&#34;claude-3-5-sonnet-20241022&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>max_iterations</span> <span class=o>=</span> <span class=n>max_iterations</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>history</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>optimize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>failed_step</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>feedback</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        根据人工反馈优化处理流程
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            failed_step: 失败的步骤（field_mapping/code_generation/transformation）
</span></span></span><span class=line><span class=cl><span class=s2>            feedback: 人工反馈
</span></span></span><span class=line><span class=cl><span class=s2>            context: 上下文信息（包含原始数据、之前的尝试等）
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            优化后的结果
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 记录历史</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>history</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;step&#39;</span><span class=p>:</span> <span class=n>failed_step</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;feedback&#39;</span><span class=p>:</span> <span class=n>feedback</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;iteration&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>history</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>history</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_iterations</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;达到最大迭代次数 </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>max_iterations</span><span class=si>}</span><span class=s2>，需要人工介入&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 构建优化提示</span>
</span></span><span class=line><span class=cl>        <span class=n>optimization_prompt</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_build_optimization_prompt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>failed_step</span><span class=p>,</span> <span class=n>feedback</span><span class=p>,</span> <span class=n>context</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 调用AI重新处理</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>client</span><span class=o>.</span><span class=n>messages</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>max_tokens</span><span class=o>=</span><span class=mi>4096</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>messages</span><span class=o>=</span><span class=p>[{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>optimization_prompt</span>
</span></span><span class=line><span class=cl>            <span class=p>}]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>result_text</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>content</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 根据不同步骤解析结果</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>failed_step</span> <span class=o>==</span> <span class=s1>&#39;field_mapping&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s2>&#34;```json&#34;</span> <span class=ow>in</span> <span class=n>result_text</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>result_text</span> <span class=o>=</span> <span class=n>result_text</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;```json&#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;```&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>result_text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>failed_step</span> <span class=o>==</span> <span class=s1>&#39;code_generation&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s2>&#34;```python&#34;</span> <span class=ow>in</span> <span class=n>result_text</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>result_text</span> <span class=o>=</span> <span class=n>result_text</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;```python&#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;```&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result_text</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>  <span class=c1># transformation</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s2>&#34;```json&#34;</span> <span class=ow>in</span> <span class=n>result_text</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>result_text</span> <span class=o>=</span> <span class=n>result_text</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;```json&#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;```&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>result_text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_build_optimization_prompt</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                   <span class=n>failed_step</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                   <span class=n>feedback</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                   <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;构建优化提示词&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>base_prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>你之前的处理在&#34;</span><span class=si>{</span><span class=n>failed_step</span><span class=si>}</span><span class=s2>&#34;步骤出现了问题。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>人工反馈: </span><span class=si>{</span><span class=n>feedback</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>历史尝试:
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=si>{</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>history</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>上下文信息:
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=si>{</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>请分析问题原因，并提供改进的解决方案。
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>failed_step</span> <span class=o>==</span> <span class=s1>&#39;field_mapping&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>base_prompt</span> <span class=o>+=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>请重新生成字段映射方案，要求：
</span></span></span><span class=line><span class=cl><span class=s2>1. 仔细分析人工反馈，理解问题所在
</span></span></span><span class=line><span class=cl><span class=s2>2. 调整字段识别和映射逻辑
</span></span></span><span class=line><span class=cl><span class=s2>3. 提高对特殊格式的处理能力
</span></span></span><span class=line><span class=cl><span class=s2>4. 返回完整的字段映射JSON
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>返回格式同之前的字段映射方案。
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>failed_step</span> <span class=o>==</span> <span class=s1>&#39;code_generation&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>base_prompt</span> <span class=o>+=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>请重新生成数据转换代码，要求：
</span></span></span><span class=line><span class=cl><span class=s2>1. 修复代码中的逻辑错误
</span></span></span><span class=line><span class=cl><span class=s2>2. 改进数据验证和错误处理
</span></span></span><span class=line><span class=cl><span class=s2>3. 确保代码可以正确执行
</span></span></span><span class=line><span class=cl><span class=s2>4. 添加针对反馈问题的特殊处理
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>只返回Python代码，不要其他解释。
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>  <span class=c1># transformation</span>
</span></span><span class=line><span class=cl>            <span class=n>base_prompt</span> <span class=o>+=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>请分析转换结果的问题，并提供修正方案：
</span></span></span><span class=line><span class=cl><span class=s2>1. 识别数据转换中的错误
</span></span></span><span class=line><span class=cl><span class=s2>2. 提供正确的转换逻辑
</span></span></span><span class=line><span class=cl><span class=s2>3. 说明如何避免类似问题
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>返回修正后的MES数据JSON。
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>base_prompt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by AI</span>
</span></span></code></pre></div><h4 id=5-完整工作流编排>5. 完整工作流编排</h4><p>将所有组件串联起来：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderNormalizationWorkflow</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;订单归一化工作流&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>api_key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>mes_schema</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                 <span class=n>max_retries</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>parser_factory</span> <span class=o>=</span> <span class=n>DocumentParserFactory</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>extraction_agent</span> <span class=o>=</span> <span class=n>OrderExtractionAgent</span><span class=p>(</span><span class=n>api_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>optimizer</span> <span class=o>=</span> <span class=n>AgentLoopOptimizer</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>extraction_agent</span><span class=o>.</span><span class=n>client</span><span class=p>,</span> <span class=n>max_retries</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>mes_schema</span> <span class=o>=</span> <span class=n>mes_schema</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 验证节点</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>field_verification</span> <span class=o>=</span> <span class=n>FieldMappingVerification</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>code_verification</span> <span class=o>=</span> <span class=n>CodeValidationVerification</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>output_verification</span> <span class=o>=</span> <span class=n>OutputVerification</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 日志</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>process_order</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>file_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        处理单个订单文档
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            file_path: 订单文档路径
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            处理结果
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;开始处理订单文档: </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Step 1: 文档解析</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Step 1: 解析文档&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>parsed_doc</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>parser_factory</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;文档类型: </span><span class=si>{</span><span class=n>parsed_doc</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Step 2: 信息提取与字段映射</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Step 2: 提取订单信息&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>extraction_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_extract_with_retry</span><span class=p>(</span><span class=n>parsed_doc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Step 3: 人工验证字段映射</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Step 3: 人工验证字段映射&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>verification_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>field_verification</span><span class=o>.</span><span class=n>verify</span><span class=p>(</span><span class=n>extraction_result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>verification_result</span><span class=p>[</span><span class=s1>&#39;status&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>VerificationStatus</span><span class=o>.</span><span class=n>REJECTED</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&#34;字段映射被拒绝，启动优化循环&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>extraction_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>optimizer</span><span class=o>.</span><span class=n>optimize</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>failed_step</span><span class=o>=</span><span class=s1>&#39;field_mapping&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>feedback</span><span class=o>=</span><span class=n>verification_result</span><span class=p>[</span><span class=s1>&#39;feedback&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>context</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;parsed_doc&#39;</span><span class=p>:</span> <span class=n>parsed_doc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;extraction_result&#39;</span><span class=p>:</span> <span class=n>extraction_result</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;mes_schema&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>mes_schema</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 重新验证</span>
</span></span><span class=line><span class=cl>            <span class=n>verification_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>field_verification</span><span class=o>.</span><span class=n>verify</span><span class=p>(</span><span class=n>extraction_result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>extraction_result</span> <span class=o>=</span> <span class=n>verification_result</span><span class=p>[</span><span class=s1>&#39;data&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Step 4: 生成转换代码</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Step 4: 生成数据转换代码&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>transformation_code</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_generate_code_with_retry</span><span class=p>(</span><span class=n>extraction_result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Step 5: 人工验证代码</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Step 5: 人工验证转换代码&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>code_verification_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>code_verification</span><span class=o>.</span><span class=n>verify</span><span class=p>(</span><span class=n>transformation_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>code_verification_result</span><span class=p>[</span><span class=s1>&#39;status&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>VerificationStatus</span><span class=o>.</span><span class=n>REJECTED</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&#34;转换代码被拒绝，启动优化循环&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>transformation_code</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>optimizer</span><span class=o>.</span><span class=n>optimize</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>failed_step</span><span class=o>=</span><span class=s1>&#39;code_generation&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>feedback</span><span class=o>=</span><span class=n>code_verification_result</span><span class=p>[</span><span class=s1>&#39;feedback&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>context</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;extraction_result&#39;</span><span class=p>:</span> <span class=n>extraction_result</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;mes_schema&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>mes_schema</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;previous_code&#39;</span><span class=p>:</span> <span class=n>transformation_code</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 重新验证</span>
</span></span><span class=line><span class=cl>            <span class=n>code_verification_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>code_verification</span><span class=o>.</span><span class=n>verify</span><span class=p>(</span><span class=n>transformation_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>transformation_code</span> <span class=o>=</span> <span class=n>code_verification_result</span><span class=p>[</span><span class=s1>&#39;data&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Step 6: 执行转换</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Step 6: 执行数据转换&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>transformed_data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_execute_transformation</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>transformation_code</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>parsed_doc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>extraction_result</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Step 7: 人工验证输出</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Step 7: 人工验证转换结果&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>output_verification_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>output_verification</span><span class=o>.</span><span class=n>verify</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>parsed_doc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>transformed_data</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>output_verification_result</span><span class=p>[</span><span class=s1>&#39;status&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>VerificationStatus</span><span class=o>.</span><span class=n>REJECTED</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&#34;转换结果被拒绝，启动优化循环&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 需要重新生成代码</span>
</span></span><span class=line><span class=cl>            <span class=n>transformation_code</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>optimizer</span><span class=o>.</span><span class=n>optimize</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>failed_step</span><span class=o>=</span><span class=s1>&#39;transformation&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>feedback</span><span class=o>=</span><span class=n>output_verification_result</span><span class=p>[</span><span class=s1>&#39;feedback&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>context</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;extraction_result&#39;</span><span class=p>:</span> <span class=n>extraction_result</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;transformation_code&#39;</span><span class=p>:</span> <span class=n>transformation_code</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;transformed_data&#39;</span><span class=p>:</span> <span class=n>transformed_data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;mes_schema&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>mes_schema</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 重新执行和验证</span>
</span></span><span class=line><span class=cl>            <span class=n>transformed_data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_execute_transformation</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>transformation_code</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>parsed_doc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>extraction_result</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>output_verification_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>output_verification</span><span class=o>.</span><span class=n>verify</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>parsed_doc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>transformed_data</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>final_data</span> <span class=o>=</span> <span class=n>output_verification_result</span><span class=p>[</span><span class=s1>&#39;data&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Step 8: 写入MES系统</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Step 8: 写入MES系统&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>mes_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_write_to_mes</span><span class=p>(</span><span class=n>final_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;订单处理完成&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;success&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;order_id&#39;</span><span class=p>:</span> <span class=n>final_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;order_id&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;mes_result&#39;</span><span class=p>:</span> <span class=n>mes_result</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;optimization_iterations&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>optimizer</span><span class=o>.</span><span class=n>history</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_extract_with_retry</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>parsed_doc</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;带重试的信息提取&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>extraction_agent</span><span class=o>.</span><span class=n>extract_order_info</span><span class=p>(</span><span class=n>parsed_doc</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>mes_schema</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;信息提取失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_generate_code_with_retry</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>extraction_result</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;带重试的代码生成&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>extraction_agent</span><span class=o>.</span><span class=n>generate_transformation_code</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>extraction_result</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>mes_schema</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;代码生成失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_execute_transformation</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                               <span class=n>code</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                               <span class=n>parsed_doc</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                               <span class=n>extraction_result</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;执行转换代码&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 创建执行环境</span>
</span></span><span class=line><span class=cl>        <span class=n>exec_globals</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;parsed_doc&#39;</span><span class=p>:</span> <span class=n>parsed_doc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;extraction_result&#39;</span><span class=p>:</span> <span class=n>extraction_result</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;json&#39;</span><span class=p>:</span> <span class=n>json</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 执行代码</span>
</span></span><span class=line><span class=cl>        <span class=n>exec</span><span class=p>(</span><span class=n>code</span><span class=p>,</span> <span class=n>exec_globals</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 调用transform_order函数</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;transform_order&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>exec_globals</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;生成的代码中未找到transform_order函数&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>transform_func</span> <span class=o>=</span> <span class=n>exec_globals</span><span class=p>[</span><span class=s1>&#39;transform_order&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 执行转换</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>transform_func</span><span class=p>(</span><span class=n>parsed_doc</span><span class=p>,</span> <span class=n>extraction_result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_write_to_mes</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;写入MES系统&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 这里是与MES系统集成的接口</span>
</span></span><span class=line><span class=cl>        <span class=c1># 实际实现需要根据具体的MES系统API</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;调用MES系统API写入数据&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 示例：调用REST API</span>
</span></span><span class=line><span class=cl>        <span class=c1># import requests</span>
</span></span><span class=line><span class=cl>        <span class=c1># response = requests.post(</span>
</span></span><span class=line><span class=cl>        <span class=c1>#     &#39;https://mes-system.com/api/orders&#39;,</span>
</span></span><span class=line><span class=cl>        <span class=c1>#     json=data,</span>
</span></span><span class=line><span class=cl>        <span class=c1>#     headers={&#39;Authorization&#39;: &#39;Bearer xxx&#39;}</span>
</span></span><span class=line><span class=cl>        <span class=c1># )</span>
</span></span><span class=line><span class=cl>        <span class=c1># return response.json()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 这里返回模拟结果</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;success&#39;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;order_id&#39;</span><span class=p>:</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;order_id&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;mes_order_number&#39;</span><span class=p>:</span> <span class=s1>&#39;MES-2025-&#39;</span> <span class=o>+</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;order_id&#39;</span><span class=p>,</span> <span class=s1>&#39;UNKNOWN&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by AI</span>
</span></span></code></pre></div><h2 id=实际应用案例>实际应用案例</h2><h3 id=场景多种格式的客户订单>场景：多种格式的客户订单</h3><p>某制造企业收到三类主要客户的订单：</p><ol><li><strong>客户A</strong>：发送Excel表格，包含详细的产品规格和交期</li><li><strong>客户B</strong>：邮件附件PDF扫描件，手写批注</li><li><strong>客户C</strong>：结构化的XML文件（EDI格式）</li></ol><p>使用我们的工作流处理：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 定义MES系统的目标schema</span>
</span></span><span class=line><span class=cl><span class=n>mes_schema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;order_id&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;customer_code&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;order_date&#34;</span><span class=p>:</span> <span class=s2>&#34;date&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;delivery_date&#34;</span><span class=p>:</span> <span class=s2>&#34;date&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;items&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;product_code&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;product_name&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;quantity&#34;</span><span class=p>:</span> <span class=s2>&#34;number&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;unit&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;unit_price&#34;</span><span class=p>:</span> <span class=s2>&#34;number&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;specifications&#34;</span><span class=p>:</span> <span class=s2>&#34;object&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;total_amount&#34;</span><span class=p>:</span> <span class=s2>&#34;number&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;payment_terms&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;shipping_address&#34;</span><span class=p>:</span> <span class=s2>&#34;object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;special_instructions&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 初始化工作流</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span> <span class=o>=</span> <span class=n>OrderNormalizationWorkflow</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>api_key</span><span class=o>=</span><span class=s2>&#34;your-anthropic-api-key&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>mes_schema</span><span class=o>=</span><span class=n>mes_schema</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>max_retries</span><span class=o>=</span><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 处理不同类型的订单</span>
</span></span><span class=line><span class=cl><span class=n>order_files</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;/data/orders/customer_a_order_20251220.xlsx&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;/data/orders/customer_b_order_scan.pdf&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;/data/orders/customer_c_edi_20251220.xml&#34;</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>order_file</span> <span class=ow>in</span> <span class=n>order_files</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>workflow</span><span class=o>.</span><span class=n>process_order</span><span class=p>(</span><span class=n>order_file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;✅ 订单处理成功: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;order_id&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   MES订单号: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;mes_result&#39;</span><span class=p>][</span><span class=s1>&#39;mes_order_number&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   优化迭代次数: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;optimization_iterations&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;❌ 订单处理失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by AI</span>
</span></span></code></pre></div><h3 id=效果评估>效果评估</h3><p>部署该系统后，企业实现：</p><ul><li><strong>处理时间减少85%</strong>：从平均30分钟/单降至4分钟/单</li><li><strong>错误率降低92%</strong>：从人工录入的8%错误率降至0.6%</li><li><strong>人工成本节省70%</strong>：订单处理人员从6人减至2人</li><li><strong>适应性提升</strong>：新客户订单格式1小时内完成适配（原需2-3天开发）</li></ul><h2 id=核心技术要点总结>核心技术要点总结</h2><h3 id=1-多模态理解的优势>1. 多模态理解的优势</h3><p>相比传统OCR+规则引擎：</p><ul><li><strong>上下文理解</strong>：理解字段间的逻辑关系</li><li><strong>格式适应</strong>：无需为每种格式编写规则</li><li><strong>语义推理</strong>：处理隐含信息和缩写</li><li><strong>持续学习</strong>：通过few-shot提示快速适应新格式</li></ul><h3 id=2-代码生成的价值>2. 代码生成的价值</h3><p>生成可执行的转换代码而非配置文件：</p><ul><li><strong>灵活性</strong>：处理复杂的业务逻辑</li><li><strong>可验证性</strong>：人类可以review和测试</li><li><strong>可维护性</strong>：代码即文档，易于理解和修改</li><li><strong>可扩展性</strong>：轻松添加新的转换规则</li></ul><h3 id=3-人机协作的设计哲学>3. 人机协作的设计哲学</h3><p>三个验证节点的设计遵循：</p><ul><li><strong>关键决策点</strong>：只在重要节点请求人工介入</li><li><strong>快速验证</strong>：每个验证可在1-2分钟完成</li><li><strong>反馈闭环</strong>：人工反馈直接用于优化</li><li><strong>渐进自动化</strong>：随着系统学习，人工介入逐渐减少</li></ul><h3 id=4-agent-loop的智能化>4. Agent Loop的智能化</h3><p>自我优化机制使系统能够：</p><ul><li><strong>从错误中学习</strong>：分析失败原因</li><li><strong>迭代改进</strong>：逐步接近正确结果</li><li><strong>知识积累</strong>：将成功案例纳入提示库</li><li><strong>异常处理</strong>：识别无法自动处理的边界情况</li></ul><h2 id=技术挑战与解决方案>技术挑战与解决方案</h2><h3 id=挑战1多页pdf的表格识别>挑战1：多页PDF的表格识别</h3><p><strong>问题</strong>：订单明细跨越多页，表头不重复</p><p><strong>解决方案</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>extract_multi_page_table</span><span class=p>(</span><span class=n>pdf_images</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;跨页表格提取&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 第一步：让AI识别表格结构</span>
</span></span><span class=line><span class=cl>    <span class=n>structure_prompt</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    分析这些PDF页面图片，识别：
</span></span></span><span class=line><span class=cl><span class=s2>    1. 哪些页面包含同一个表格
</span></span></span><span class=line><span class=cl><span class=s2>    2. 表格的表头在哪一页
</span></span></span><span class=line><span class=cl><span class=s2>    3. 表格的数据行分布在哪些页面
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    返回JSON格式的表格结构描述。
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 调用多模态模型分析</span>
</span></span><span class=line><span class=cl>    <span class=n>structure</span> <span class=o>=</span> <span class=n>call_multimodal_model</span><span class=p>(</span><span class=n>pdf_images</span><span class=p>,</span> <span class=n>structure_prompt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 第二步：提取各页数据</span>
</span></span><span class=line><span class=cl>    <span class=n>all_rows</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>page_info</span> <span class=ow>in</span> <span class=n>structure</span><span class=p>[</span><span class=s1>&#39;pages&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>rows</span> <span class=o>=</span> <span class=n>extract_table_from_page</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>pdf_images</span><span class=p>[</span><span class=n>page_info</span><span class=p>[</span><span class=s1>&#39;page_number&#39;</span><span class=p>]],</span>
</span></span><span class=line><span class=cl>            <span class=n>structure</span><span class=p>[</span><span class=s1>&#39;header&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>page_info</span><span class=p>[</span><span class=s1>&#39;row_range&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>all_rows</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>rows</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 合并为完整表格</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>all_rows</span><span class=p>,</span> <span class=n>columns</span><span class=o>=</span><span class=n>structure</span><span class=p>[</span><span class=s1>&#39;header&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>df</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by AI</span>
</span></span></code></pre></div><h3 id=挑战2单位和规格的归一化>挑战2：单位和规格的归一化</h3><p><strong>问题</strong>：不同客户使用不同的单位（kg/吨/斤）和规格描述</p><p><strong>解决方案</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>normalize_units_and_specs</span><span class=p>(</span><span class=n>item</span><span class=p>:</span> <span class=n>Dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;单位和规格归一化&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>normalization_prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    原始产品信息：
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=si>{</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>item</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    请执行以下归一化：
</span></span></span><span class=line><span class=cl><span class=s2>    1. 将所有重量单位转换为kg
</span></span></span><span class=line><span class=cl><span class=s2>    2. 将所有长度单位转换为mm
</span></span></span><span class=line><span class=cl><span class=s2>    3. 将规格描述标准化为结构化字段
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    返回归一化后的JSON。
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>normalized</span> <span class=o>=</span> <span class=n>call_llm</span><span class=p>(</span><span class=n>normalization_prompt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>normalized</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by AI</span>
</span></span></code></pre></div><h3 id=挑战3客户主数据匹配>挑战3：客户主数据匹配</h3><p><strong>问题</strong>：订单中的客户名称可能是简称或别名</p><p><strong>解决方案</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>match_customer_master_data</span><span class=p>(</span><span class=n>customer_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                               <span class=n>master_data</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;客户主数据匹配&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 使用语义相似度匹配</span>
</span></span><span class=line><span class=cl>    <span class=n>embeddings_query</span> <span class=o>=</span> <span class=n>get_embedding</span><span class=p>(</span><span class=n>customer_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>best_match</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>best_score</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>customer</span> <span class=ow>in</span> <span class=n>master_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 多个字段的综合匹配</span>
</span></span><span class=line><span class=cl>        <span class=n>fields_to_match</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>customer</span><span class=p>[</span><span class=s1>&#39;official_name&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>customer</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;short_name&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>customer</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;alias&#39;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>field</span> <span class=ow>in</span> <span class=n>fields_to_match</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>field</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>alias</span> <span class=ow>in</span> <span class=n>field</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>score</span> <span class=o>=</span> <span class=n>cosine_similarity</span><span class=p>(</span><span class=n>embeddings_query</span><span class=p>,</span> <span class=n>get_embedding</span><span class=p>(</span><span class=n>alias</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>score</span> <span class=o>&gt;</span> <span class=n>best_score</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>best_score</span> <span class=o>=</span> <span class=n>score</span>
</span></span><span class=line><span class=cl>                        <span class=n>best_match</span> <span class=o>=</span> <span class=n>customer</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>score</span> <span class=o>=</span> <span class=n>cosine_similarity</span><span class=p>(</span><span class=n>embeddings_query</span><span class=p>,</span> <span class=n>get_embedding</span><span class=p>(</span><span class=n>field</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>score</span> <span class=o>&gt;</span> <span class=n>best_score</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>best_score</span> <span class=o>=</span> <span class=n>score</span>
</span></span><span class=line><span class=cl>                    <span class=n>best_match</span> <span class=o>=</span> <span class=n>customer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 如果相似度低于阈值，请求人工确认</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>best_score</span> <span class=o>&lt;</span> <span class=mf>0.8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;⚠️ 客户名称 &#39;</span><span class=si>{</span><span class=n>customer_name</span><span class=si>}</span><span class=s2>&#39; 匹配不确定&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最佳匹配: </span><span class=si>{</span><span class=n>best_match</span><span class=p>[</span><span class=s1>&#39;official_name&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> (相似度: </span><span class=si>{</span><span class=n>best_score</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>confirm</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;是否正确? [Y/N]: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>confirm</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span> <span class=o>!=</span> <span class=s1>&#39;Y&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>best_match</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generated by AI</span>
</span></span></code></pre></div><h2 id=未来展望>未来展望</h2><h3 id=1-完全自动化的路径>1. 完全自动化的路径</h3><p>随着系统的运行，积累的案例可用于：</p><ul><li><strong>微调专用模型</strong>：针对特定行业的订单格式</li><li><strong>提示优化</strong>：自动总结最优的提示模板</li><li><strong>规则提取</strong>：将频繁的人工修正转化为自动规则</li><li><strong>置信度模型</strong>：更准确地判断何时需要人工验证</li></ul><h3 id=2-扩展到其他文档类型>2. 扩展到其他文档类型</h3><p>同样的架构可应用于：</p><ul><li><strong>合同审查</strong>：提取关键条款并标准化</li><li><strong>发票处理</strong>：自动对账和入账</li><li><strong>技术图纸</strong>：提取规格参数到BOM</li><li><strong>检验报告</strong>：质量数据录入质量系统</li></ul><h3 id=3-与企业系统深度集成>3. 与企业系统深度集成</h3><ul><li><strong>ERP双向同步</strong>：订单状态实时更新</li><li><strong>供应链协同</strong>：自动触发采购和排产</li><li><strong>BI分析</strong>：订单数据实时分析和预警</li><li><strong>客户门户</strong>：客户自助查询订单状态</li></ul><h2 id=结论>结论</h2><p>多模态大模型为解决B2B订单非标准化问题提供了前所未有的机会。通过巧妙地设计人机协作工作流，我们可以：</p><ol><li><strong>最大化自动化程度</strong>：AI处理90%以上的繁琐工作</li><li><strong>保证数据质量</strong>：关键节点的人工验证确保准确性</li><li><strong>持续优化改进</strong>：Agent Loop机制实现自我学习</li><li><strong>快速适应变化</strong>：新格式和新规则快速上线</li></ol><p>这种方法不仅仅是技术创新，更是对"人机协作"理念的最佳实践：让AI做它擅长的（识别、理解、生成），让人类做他们擅长的（判断、验证、决策），共同创造价值。</p><p>对于正在进行数字化转型的传统企业，这是一条切实可行的道路——不需要大规模重构现有系统，通过智能中间层逐步实现自动化，最终建立起柔性、智能的订单处理能力。</p><hr><p><strong>相关资源</strong></p><ul><li>Anthropic Claude API: <a href=https://docs.anthropic.com/>https://docs.anthropic.com/</a></li><li>多模态提示工程最佳实践: <a href=https://docs.anthropic.com/en/docs/build-with-claude/vision>https://docs.anthropic.com/en/docs/build-with-claude/vision</a></li><li>Agent开发框架: LangGraph, AutoGen</li><li>文档解析工具: PyPDF2, pdfplumber, openpyxl, python-docx</li></ul><p><strong>关键词</strong>: #AI自动化 #多模态AI #B2B #订单处理 #MES系统 #人机协作 #Agent #文档解析 #数字化转型</p><div class=blog-tags><a href=https://hugozhu.site/tags/ai/>AI</a>&nbsp;
<a href=https://hugozhu.site/tags/%E5%A4%9A%E6%A8%A1%E6%80%81/>多模态</a>&nbsp;
<a href=https://hugozhu.site/tags/llm/>LLM</a>&nbsp;
<a href=https://hugozhu.site/tags/b2b/>B2B</a>&nbsp;
<a href=https://hugozhu.site/tags/mes/>MES</a>&nbsp;
<a href=https://hugozhu.site/tags/%E8%87%AA%E5%8A%A8%E5%8C%96/>自动化</a>&nbsp;
<a href=https://hugozhu.site/tags/agent/>Agent</a>&nbsp;
<a href=https://hugozhu.site/tags/%E6%96%87%E6%A1%A3%E8%A7%A3%E6%9E%90/>文档解析</a>&nbsp;</div><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fhugozhu.site%2fpost%2f2025%2f101-multimodal-ai-b2b-order-normalization%2f&amp;text=%e5%a4%9a%e6%a8%a1%e6%80%81AI%e9%a9%b1%e5%8a%a8%e7%9a%84B2B%e8%ae%a2%e5%8d%95%e5%bd%92%e4%b8%80%e5%8c%96%ef%bc%9a%e4%bb%8e%e9%9d%9e%e6%a0%87%e5%87%86%e6%96%87%e6%a1%a3%e5%88%b0MES%e7%b3%bb%e7%bb%9f%e7%9a%84%e6%99%ba%e8%83%bd%e5%b7%a5%e4%bd%9c%e6%b5%81&amp;via=" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fhugozhu.site%2fpost%2f2025%2f101-multimodal-ai-b2b-order-normalization%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fhugozhu.site%2fpost%2f2025%2f101-multimodal-ai-b2b-order-normalization%2f&amp;title=%e5%a4%9a%e6%a8%a1%e6%80%81AI%e9%a9%b1%e5%8a%a8%e7%9a%84B2B%e8%ae%a2%e5%8d%95%e5%bd%92%e4%b8%80%e5%8c%96%ef%bc%9a%e4%bb%8e%e9%9d%9e%e6%a0%87%e5%87%86%e6%96%87%e6%a1%a3%e5%88%b0MES%e7%b3%bb%e7%bb%9f%e7%9a%84%e6%99%ba%e8%83%bd%e5%b7%a5%e4%bd%9c%e6%b5%81" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fhugozhu.site%2fpost%2f2025%2f101-multimodal-ai-b2b-order-normalization%2f&amp;title=%e5%a4%9a%e6%a8%a1%e6%80%81AI%e9%a9%b1%e5%8a%a8%e7%9a%84B2B%e8%ae%a2%e5%8d%95%e5%bd%92%e4%b8%80%e5%8c%96%ef%bc%9a%e4%bb%8e%e9%9d%9e%e6%a0%87%e5%87%86%e6%96%87%e6%a1%a3%e5%88%b0MES%e7%b3%bb%e7%bb%9f%e7%9a%84%e6%99%ba%e8%83%bd%e5%b7%a5%e4%bd%9c%e6%b5%81" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fhugozhu.site%2fpost%2f2025%2f101-multimodal-ai-b2b-order-normalization%2f&amp;title=%e5%a4%9a%e6%a8%a1%e6%80%81AI%e9%a9%b1%e5%8a%a8%e7%9a%84B2B%e8%ae%a2%e5%8d%95%e5%bd%92%e4%b8%80%e5%8c%96%ef%bc%9a%e4%bb%8e%e9%9d%9e%e6%a0%87%e5%87%86%e6%96%87%e6%a1%a3%e5%88%b0MES%e7%b3%bb%e7%bb%9f%e7%9a%84%e6%99%ba%e8%83%bd%e5%b7%a5%e4%bd%9c%e6%b5%81" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fhugozhu.site%2fpost%2f2025%2f101-multimodal-ai-b2b-order-normalization%2f&amp;description=%e5%a4%9a%e6%a8%a1%e6%80%81AI%e9%a9%b1%e5%8a%a8%e7%9a%84B2B%e8%ae%a2%e5%8d%95%e5%bd%92%e4%b8%80%e5%8c%96%ef%bc%9a%e4%bb%8e%e9%9d%9e%e6%a0%87%e5%87%86%e6%96%87%e6%a1%a3%e5%88%b0MES%e7%b3%bb%e7%bb%9f%e7%9a%84%e6%99%ba%e8%83%bd%e5%b7%a5%e4%bd%9c%e6%b5%81" target=_blank title="Share on Pinterest"><i class="fab fa-pinterest"></i></a></li></ul></div></div></section><h4 class=see-also>See also</h4><ul><li><a href=/post/2026/91-agent-reinforcement-learning-best-practices/>Agent强化学习的最佳实践：并行任务处理与性能优化</a></li><li><a href=/post/2025/113-claude-code-auto-correction-agent-loop/>Claude Code自动修正生成代码的原理解析：Agent Loop最佳实践</a></li><li><a href=/post/2025/112-ai-powered-google-resume-from-personal-website/>如何用 AI 将个人网站转化为专业的 Google 求职简历</a></li><li><a href=/post/2025/110-ai-exam-grading-agent-best-practices/>小学标准化试卷AI批改Agent最佳工程实践</a></li><li><a href=/post/2025/111-order-document-classifier-agent-routing/>构建高质量订单文档分类器：智能导流到专业Agent</a></li></ul></article><ul class="pager blog-pager"><li class=previous><a href=https://hugozhu.site/post/2025/110-ai-exam-grading-agent-best-practices/ data-toggle=tooltip data-placement=top title=小学标准化试卷AI批改Agent最佳工程实践>&larr; Previous Post</a></li><li class=next><a href=https://hugozhu.site/post/2025/112-ai-powered-google-resume-from-personal-website/ data-toggle=tooltip data-placement=top title="如何用 AI 将个人网站转化为专业的 Google 求职简历">Next Post &rarr;</a></li></ul><div class=disqus-comments><button id=show-comments class="btn btn-default" type=button>Show <span class=disqus-comment-count data-disqus-url=https://hugozhu.site/post/2025/101-multimodal-ai-b2b-order-normalization>comments</span></button><div id=disqus_thread></div><script type=text/javascript>var disqus_config=function(){this.page.url="https://hugozhu.site/post/2025/101-multimodal-ai-b2b-order-normalization"}</script></div></div></div></div><footer><div class=container><div class=row><div class=disclaimer><b>Disclaimer:</b> The opinions expressed herein are my own personal opinions and do not represent my company’s view in any way.</div></div><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"></ul><p class="credits copyright text-muted">&nbsp;&bull;&nbsp;&copy;
2026
&nbsp;&bull;&nbsp;
<a href=https://hugozhu.site/>All about Raspberry Pi</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.145.0</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js integrity=sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script><script src=https://code.jquery.com/jquery-3.7.0.slim.min.js integrity=sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js integrity=sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd crossorigin=anonymous></script><script src=https://hugozhu.site/js/main.js></script><script src=https://hugozhu.site/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0")})</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://hugozhu.site/js/load-photoswipe.js></script><script>(function(){var t,n="617d351a633194d48",e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://cse.google.com/cse.js?cx="+n,t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script><script type=text/javascript>$(function(){$("#show-comments").on("click",function(){var e="hugozhu";(function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="//"+e+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(t)})(),$(this).hide()})})</script><script id=dsq-count-scr src=//hugozhu.disqus.com/count.js async></script></body></html>