<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Android异步编程 - When Go meets Raspberry Pi</title>
  
    <meta name="description" content="Asynchronous Android 树莓派">
  
    <meta name="author" content="Hugo Zhu">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/twitter/stylesheets/bootstrap.min.css" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/stylesheets/style.css" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/widgets/google_prettify/stylesheets/twitter-bootstrap.css" type="text/css" rel="stylesheet" media="all">


  <link rel="shortcut icon" href="http://tp3.sinaimg.cn/1808008002/50/5649301600/1">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>

<a href="https://github.com/hugozhu"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub"></a>

    <div class="navbar">      
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/" style="padding-left:46px;">Hugo Zhu</a>
          <ul class="nav">
            
              


  <li><a href="/posts">Blogs</a></li>


            
              


  <li><a href="/archive">Archive</a></li>


            
              


  <li><a href="/tags">Tags</a></li>


            
              


  <li><a href="/categories">Categories</a></li>


            
              


  <li><a href="/pages">Pages</a></li>


            
              


  <li><a href="/tools">Tools</a></li>


            
              


  <li><a href="/about">About Me</a></li>


            
            <li style="padding-left:10px">
              <form class="navbar-search pull-right" method="GET" action="https://www.google.com/search">
                <input type="text" name="as_q" class="search-query" placeholder=" Search... ">
                <input type="hidden" name="as_sitesearch" value="hugozhu.myalert.info">
              </form>               
            </li>
          </ul>
        </div>
      </div>     
    </div>

    <div class="container">

      <div class="content">
        <div class="page-header">
  <h1>Android异步编程 </h1>
</div>

<div class="row">
  <div class="span8">
    

<p><h1>目录：</h1><nav>
<ul>
<li><a href="#toc_0">Android的线程和内存模型</a></li>
<li><a href="#toc_1">AsyncTask</a>
<ul>
<li><a href="#toc_2">碎片化问题</a></li>
<li><a href="#toc_3">Activity生命周期问题</a></li>
</ul></li>
<li><a href="#toc_4">Handler &amp; HandlerThread</a>
<ul>
<li><a href="#toc_5">Looper</a></li>
</ul></li>
<li><a href="#toc_6">Loader</a>
<ul>
<li><a href="#toc_7">AsyncTaskLoader</a></li>
<li><a href="#toc_8">CursorLoader</a></li>
</ul></li>
<li><a href="#toc_9">IntentService</a></li>
<li><a href="#toc_10">Service</a></li>
<li><a href="#toc_11">AlarmManager</a></li>
<li><a href="#toc_12">参考链接</a></li>
</ul>
</nav></p>

<h1 id="toc_0">Android的线程和内存模型</h1>

<p>Android操作系统在boot后，会启动一个Zygote(受精卵)进程，Zygote进程负责创建大部分应用程序进程。Zygote进程启动加载核心程序库和数据结构到内存后会创建一个Dalvik虚拟机（DVM）进程－-SystemServer，此进程会包含大部分的系统服务（包括管理Activity的服务ActivityManagerService），SystemServer初始化后，Zygote进程会侦听本地的socket端口, 等待进一步的指令。当新的app被启动时，Zygote会为这个app创建一个DVM&mdash;-直接fork出一个子进程，这种架构的好处是同时启动多个App时，多个App进程可以访问共享内存。</p>

<p><img src="https://www.evernote.com/shard/s26/sh/72e630cc-271f-4ecb-8ca0-116101155fc0/e7a978a53e5428fb6feca131e0fca4dc/res/25806df1-87a3-432f-aea9-df02e2535e30/skitch.png?resizeSmall&width=832"/></p>

<p>Android App的进程也是一个DVM，内部有许多线程在执行，比如，主UI线程（Main Thread），垃圾回收线程等。其中主UI线程负责执行我们写的应用代码。对于只做很少的I/O操作或耗时操作的App，单一线程开发模式问题不大，但是如果有大量IO或者CPU计算的任务，我们就必须在其他线程内完成了。因为主UI线程需要根据硬件刷新率[^3]同步用户界面的重绘。手机应用体验流畅要求界面帧率达到每秒60，也就是说每16.67毫秒就需要重绘一帧，这意味着如果我们在主线程上执行的任务超过16毫秒，就会出现丢帧现象，也就是界面会开始变卡。。。</p>

<p>Android异步执行任务的方法有以下几种：</p>

<h1 id="toc_1">AsyncTask</h1>

<p>AsyncTask是最常用的异步方法，功能结构设计的也很丰富，给使用者足够的控制，使用上主要是将异步执行的任务放在下面方法里。</p>

<pre><code>protected Result doInBackground(Params... params)
</code></pre>

<p>然后调用<code>.execute(params)</code>方法即可。</p>

<p>AsyncTask的执行逻辑在API Level 3只能串行执行， 在API Level 4改成了最多128个线程的线程池执行，API Level 11则改成了缺省所有的AsyncTask是在一个线程中顺序执行的，这样可以保证执行和提交的次序一致，如果希望能并发的执行，可以用下面的方法在线程池内执行：</p>

<pre><code>task.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, params);
</code></pre>

<p><code>AsyncTask.THREAD_POOL_EXECUTOR</code>是<code>ThreadPoolExecutor</code>的一个实例，配置是最少5个线程，最多128个。如果需要自己来配置线程池大小，你可以传递自己配置的一个实例到上述方法。</p>

<p>使用AsyncTask需要注意的几个问题：</p>

<h2 id="toc_2">碎片化问题</h2>

<p>因为不同版本的Android AsyncTask缺省执行逻辑并不一样，可能在不同机型上表现不一致。如果要自己控制AsyncTask的并发度，解决这个问题的建议是复制Android SDK的AsyncTask源码自己实现一个AsyncTask。</p>

<h2 id="toc_3">Activity生命周期问题</h2>

<p>Activity可能早于AsyncTask执行完被销毁，如果AsyncTask还继续执行，有可能会浪费资源，并且如果AsyncTask里引用了Activity或部分的View Hierarchy，还会造成引用的对象不会被垃圾回收而引起内存泄漏。通常AsyncTask会定义为Activity的一个匿名inner class，这会建立一个隐式的引用到Activity。</p>

<p>解决的方法是：</p>

<ol>
<li>在Activity里的<code>onPause</code>方法里及时取消不需要再执行的AsyncTask（这种方法在切换到横屏时会重启异步任务，有点浪费）</li>
<li>更好的是使用retained headless fragment来解决生命周期问题，具体演示代码见参考链接</li>
</ol>

<p>Async比较合适的是较短的（1，2秒），CPU密集计算或读写文件等阻塞IO操作。耗时较长的网络调用用Async不是最合适的。</p>

<h1 id="toc_4">Handler &amp; HandlerThread</h1>

<p>Handler的异步编程是基于消息队列模型的。执行任务的线程称之为Looper线程，其他线程则将需要异步执行的任务发送给Looper线程&ndash;插入其消息队列，方法有：post（较方便使用，但每次需要创建新对象）或sendMessage（较高效，复用消息实例，适合执行大量类似的异步任务）</p>

<h2 id="toc_5">Looper</h2>

<p>Looper和它的名字意思一样就是Looper线程会永远循环，当没有消息的时候，Looper线程（消费者）会使用(<code>Object.wait</code>)方法等待其他线程（生产者）插入新的任务消息，这时候其他线程(<code>Object.notify</code>)</p>

<p>Android的主线程其实就是一个Looper线程。</p>

<p>需要注意的是，使用Handler和AsyncTask一样，要注意匿名inner class对Activity的隐式引用而造成内存泄漏，所以使用的时候要记得清理；</p>

<p>解决方法是使用对使用的Activity中的View对象用Weak Reference，并处理当View对象为null的情况。</p>

<p>Handler适合更长一点的（&gt;2秒）的异步任务处理。</p>

<h1 id="toc_6">Loader</h1>

<p>Loader在Android编程框架中被广泛用于后台加载数据（从文件，数据库甚至网络）。</p>

<h2 id="toc_7">AsyncTaskLoader</h2>

<p>具体的Loader实现。</p>

<h2 id="toc_8">CursorLoader</h2>

<p>用户数据库数据后台加载。</p>

<p>Loader在使用上比较大的优势是和Activity的部分解耦，更见到的生命周期管理。</p>

<h1 id="toc_9">IntentService</h1>

<p>IntentService是Service的一个实现类。其内部实现包含了一个HandlerThread，当任务提交给IntentService时，会被加到队列并顺序处理。</p>

<pre><code>public class MyIntentService extends IntentService {
     public MyIntentService() {
       super(&quot;thread-name&quot;);
     }
     protected void onHandleIntent(Intent intent) {
       // executes on the background HandlerThread.
     } 
}

Intent intent = new Intent(context, MyIntentService.class);
intent.setData(uri); intent.putExtra(&quot;param&quot;, &quot;some value&quot;); 

startService(intent);

</code></pre>

<p>IntentService返回任务结果给Activity可以有下面几种方法（Service和Activity的通信方法）：</p>

<ol>
<li>Activity启动IntentService时候，传递一个PendingIntent对象给IntentService，IntentService在处理完任何后调用｀PendingIntent.send()｀通知Activity，Activity在｀onActivityResult｀方法内处理收到的消息。</li>
<li>提交一个系统通知，这样App不在前台，用户也可以知道任务完成，比如下载地图数据。</li>
<li>使用Messenger发送一个消息给Activity里的Handler。</li>
<li>使用广播方式把结果封装在Intent中广播出去， 这样Fragment或Activity都可以通过监听广播获得处理结果。</li>
</ol>

<p>IntentService可以完全和Activity解耦。适合即使App主界面退出情况下也必须完成的任务，比如后台上传日志，图片之类的任务。</p>

<h1 id="toc_10">Service</h1>

<p>Service合适执行独立于任何Activity或Fragment的任务，即使App主界面退出情况下也必须完成的任务；或者需要比IntentService更高或更细致的并发控制。</p>

<h1 id="toc_11">AlarmManager</h1>

<p>AlarmManager可以不在人工干预下定时执行任务，比如定时检查邮件，下载更新，或同步内容到云端。</p>

<h1 id="toc_12">参考链接</h1>

<ol>
<li>Asynchronous Android <a href="http://www.packtpub.com/concurrent-programming-on-android/book">http://www.packtpub.com/concurrent-programming-on-android/book</a></li>
<li>Android内核：http://baike.baidu.com/link?url=syxjYQCIl0gmUPQJGs-oBGffNzRcKNqX4jow2gmUsPhcEH7mSu9dXBijpVglpMBs1iTcUv9Pwm5NEFP_KCSWIq</li>
<li>帧率与刷新率的区别 <a href="http://zhidao.baidu.com/link?url=axWjZPYDt3aRgA4EhoNwicCR5j9hMcRscCNZaVThX-JnbRIcPAH6a_t_BR5lgV9fC8CXQeRLogFLZjLvvy8G_a">http://zhidao.baidu.com/link?url=axWjZPYDt3aRgA4EhoNwicCR5j9hMcRscCNZaVThX-JnbRIcPAH6a_t_BR5lgV9fC8CXQeRLogFLZjLvvy8G_a</a></li>
</ol>

    <hr>
    <div class="pagination">
      <ul>
        <ul>
          
          
            <li class="prev disabled"><a>&larr; Previous</a></li>
          

            <li><a href="/archive">Archive</a></li>

          
            <li class="next"><a href="/2014/02/10/45-android-development-productivity-tips.html" title="提高Android开发效率的小贴士">Next &rarr;</a></li>
          
          
        </ul>
      </ul>
    </div>
    <hr/>
    
<div id="disqus_thread"></div>
<script>
    var disqus_developer = 1;
    var disqus_shortname = 'hugozhu'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

  </div>

  <div style="padding-left:660px">
   <script type="text/javascript" charset="utf-8">
  (function(){
    var _w = 86 , _h = 50;
    var param = {
      url:location.href,
      type:'6',
      count:'1', /**是否显示分享数，1显示(可选)*/
      appkey:'', /**您申请的应用appkey,显示分享来源(可选)*/
      title:'', /**分享的文字内容(可选，默认为所在页面的title)*/
      pic:'', /**分享图片的路径(可选)*/
      ralateUid:'1808008002', /**关联用户的UID，分享微博会@该用户(可选)*/
    language:'zh_cn', /**设置语言，zh_cn|zh_tw(可选)*/
      rnd:new Date().valueOf()
    }
    var temp = [];
    for( var p in param ){
      temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
    }
    document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'"></iframe>')
  })()
  </script>


      <h4>Published</h4>
      <div class="date"><span>2014-06-29</span></div>
      <br>
      <h4>Categories</h4>
      <ul class="tag_box">
      
        <li>
  <a href="/categories/#Blog-ref">Blog <span>46</span></a>
</li>
      
      </ul>
      <br>
      <h4>Tags</h4>
      <ul class="tag_box">
      
        <li>
  <a href="/tags/#Android-ref">Android <span>4</span></a>
</li>
      
      </ul>


    <div style="float:right">
<br/>
</div>

      
    </div>
  
</div>


        <hr/>

        <center>

<a href="http://s.click.taobao.com/t?e=m%3D2%26s%3DIvgifoFnYOEcQipKwQzePCperVdZeJviEViQ0P1Vf2kguMN8XjClAprpiL7eedLBGAcW%2BgUaNBItyCA8kPsK20DQUmvVyfKQaZdJdwyDgalbY%2Bzpq8pT0%2Bdn1BbglxZYxUhy8exlzcq9AmARIwX9K2Zg%2BdzdQFOwfMRvoxSVDSdLyrb2g0H2G5JcxXijM%2BwneEHpPTskRHnPKdU%2FdTrgjbw4MC6y5nKlXF%2B87KN7TKeiZ%2BQMlGz6FQ%3D%3D" target="_blank"><img src="http://gtms01.alicdn.com/tps/i1/T1S.KAFMNbXXcp9.bi-950-90.jpg" /></a>

        </center>

      </div>

      <footer>
        <p>&copy; <a href="http://weibo.com/hugozhu">Hugo Zhu</a> 2014
          Powered by <a href="http://www.raspberrypi.org" target="_blank"><img src="http://retroburngames.com/bytrix/media/images/28_icon.jpg"/> Raspberry Pi</a>
          with help from <a href="http://github.com/wendal/gor" target="_blank" title="Gor -- Fast Blog">Gor</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
		  and Idea from <a href="http://ruhoh.com" target="_blank" title="The Definitive Technical Blogging Framework">ruhoh</a>
       <!--# echo var="remote_addr" default="no" -->
       <br/>
<script src="http://s16.cnzz.com/stat.php?id=5144522&web_id=5144522&online=1&show=line" language="JavaScript"></script>       
      </p>
      </footer>

    </div> <!-- /container -->

    
<script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"></script>
<script>
  var pres = document.getElementsByTagName("pre");
  for (var i=0; i < pres.length; ++i) {
    pres[i].className = "prettyprint linenums";
  }
  prettyPrint();
</script>


<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-37261636-1']);
  _gaq.push(['_setDomainName', 'myalert.info']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

<script type="text/javascript">
(function(win,doc){
var s = doc.createElement("script"), h = doc.getElementsByTagName("head")[0];
if (!win.alimamatk_show) {
s.charset = "gbk";
s.async = true;
s.src = "http://a.alimama.cn/tkapi.js";
h.insertBefore(s, h.firstChild);
}
var o = {
pid: "mm_12926928_3484851_11423971",
appkey: "",
unid: ""
}
win.alimamatk_onload = win.alimamatk_onload || [];
win.alimamatk_onload.push(o);
})(window,document);
</script>
<script>
  var _h=Math.random().toString(36).substring(7)
  document.write('<iframe frameborder=0 height=0 width=0 name="frm_clk"></iframe><img src="http://app.myalert.info/b.gif?r='+encodeURIComponent(document.referrer)
+"&pv="+_h+'"/>')
  function clk_track(nurl){frames["frm_clk"].location.replace("http://app.myalert.info/b.gif?r="+encodeURIComponent(nurl)+"&clk="+_h);}
</script>
</body>
</html>
